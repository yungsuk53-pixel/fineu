<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - 학습</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .study-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .study-card:active {
            transform: translateY(0);
        }

        .study-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .star-icon {
            color: #ffd700;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .star-icon.completed {
            color: #4CAF50;
            animation: sparkle 0.6s ease-in-out;
        }

        .study-card.completed {
            background: linear-gradient(135deg, #f0f8f0, #e8f5e8);
            border: 2px solid #4CAF50;
        }

        .divider {
            height: 2px;
            background: #333;
            margin: 30px 0;
            border-radius: 1px;
        }

        .scrap-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scrap-content {
            text-align: center;
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/배경.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: #fafaf8;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7cb9e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/레이어 1.png" alt="FINE U 로고" class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <div class="main-content">
        <div class="page-title">STUDY ZONE</div>

        <div class="study-card fade-in" id="card-financial-terms" onclick="goToTermsPage()" style="animation-delay: 0.1s">
            <div class="study-title">금융 용어</div>
            <i class="fas fa-star star-icon" id="star-financial-terms"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-news" onclick="goToNewsPage()" style="animation-delay: 0.2s">
            <div class="study-title">금융 뉴스</div>
            <i class="fas fa-star star-icon" id="star-financial-news"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-quiz" onclick="goToQuizPage()" style="animation-delay: 0.3s">
            <div class="study-title">금융 퀴즈</div>
            <i class="fas fa-star star-icon" id="star-financial-quiz"></i>
        </div>

        <div class="divider"></div>

        <div class="scrap-section fade-in" style="animation-delay: 0.4s">
            <div class="scrap-content">
                스크랩
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/집.png" alt="홈">
            </div>
        </div>
        <div class="nav-item active" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/문서.png" alt="문서">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ㅇ.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/채팅.png" alt="채팅">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/더보기.png" alt="더보기">
            </div>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = 'AIzaSyBJhMtNOYyCfl6NRCQQz_CkTUHWP2TNweI';
        
        let currentUser = null;
        let userAssets = {};
        
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, navImage: 'YELLOW ㅇ.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, navImage: 'GREEN ㅇ.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, navImage: 'BLUE ㅇ.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, navImage: 'RED ㅇ.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, navImage: 'BLACK ㅇ.png' }
        };

        function getTodayDate() {
            const now = new Date();
            const koreaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
            const year = koreaTime.getFullYear();
            const month = String(koreaTime.getMonth() + 1).padStart(2, '0');
            const day = String(koreaTime.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 2주 이상 지난 데이터 삭제
        async function cleanOldData() {
            const today = new Date();
            const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            
            // localStorage에서 오래된 캐시 삭제
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('todayFinancialData_')) {
                    const dateStr = key.replace('todayFinancialData_', '');
                    const keyDate = new Date(dateStr);
                    if (keyDate < twoWeeksAgo) {
                        localStorage.removeItem(key);
                        console.log(`삭제된 오래된 로컬 데이터: ${key}`);
                    }
                }
            });

            // Firebase에서 오래된 캐시 삭제
            if (window.firebaseDB && window.firebaseRemove) {
                try {
                    const cacheRef = window.firebaseRef(window.firebaseDB, 'cache');
                    const snapshot = await window.firebaseGet(cacheRef);
                    
                    if (snapshot.exists()) {
                        const cacheData = snapshot.val();
                        for (const key in cacheData) {
                            if (cacheData[key].date) {
                                const keyDate = new Date(cacheData[key].date);
                                if (keyDate < twoWeeksAgo) {
                                    const oldRef = window.firebaseRef(window.firebaseDB, `cache/${key}`);
                                    await window.firebaseRemove(oldRef);
                                    console.log(`Firebase에서 삭제된 오래된 데이터: ${key}`);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Firebase 오래된 데이터 삭제 실패:', error);
                }
            }
        }

        // 데이터 유효성 검증
        function validateTodayData(data) {
            if (!data) return false;
            
            // 필수 필드 확인
            if (!data.date || !data.news || !data.terms || !data.quizzes) {
                console.log('❌ 필수 필드 누락');
                return false;
            }
            
            // 뉴스 확인 (최소 1개 이상)
            if (!Array.isArray(data.news) || data.news.length === 0) {
                console.log('❌ 뉴스 데이터 없음');
                return false;
            }
            
            // 용어 확인 (정확히 3개)
            if (!Array.isArray(data.terms) || data.terms.length < 3) {
                console.log('❌ 용어 데이터 부족 (3개 필요)');
                return false;
            }
            
            // 퀴즈 확인
            if (!data.quizzes.beginner || !Array.isArray(data.quizzes.beginner) || data.quizzes.beginner.length < 5) {
                console.log('❌ 초급 퀴즈 부족 (5개 필요)');
                return false;
            }
            
            // 중급, 고급 퀴즈 확인
            if (!data.quizzes.intermediate || !Array.isArray(data.quizzes.intermediate) || data.quizzes.intermediate.length < 5) {
                console.log('❌ 중급 퀴즈 없음');
                return false;
            }
            
            if (!data.quizzes.advanced || !Array.isArray(data.quizzes.advanced) || data.quizzes.advanced.length < 5) {
                console.log('❌ 고급 퀴즈 없음');
                return false;
            }
            
            console.log('✅ 데이터 유효성 검증 통과');
            return true;
        }

        async function loadUserDataFromFirebase() {
            try {
                if (!window.firebaseDB) {
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }

                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);

                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {}
                    };
                    
                    updateGradeButton(userAssets.level);
                } else {
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 10000000,
                        totalAssets: 10000000,
                        virtualBalance: 10000000,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {}
                    };
                    updateGradeButton('yellow');
                }
                
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                checkTodayCompletion();
                await cleanOldData();
                await generateTodayContent();

            } catch (error) {
                console.error('데이터 로드 오류:', error);
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 10000000,
                    level: 'yellow',
                    exp: 0,
                    experience: 0,
                    studyProgress: {}
                };
                updateGradeButton('yellow');
            }
        }

        function checkTodayCompletion() {
            const today = getTodayDate();
            
            if (!userAssets.studyProgress) {
                userAssets.studyProgress = {};
            }
            
            const todayProgress = userAssets.studyProgress[today] || {};
            
            updateCardCompletion('financial-terms', todayProgress.financialTerms === true);
            updateCardCompletion('financial-news', todayProgress.financialNews === true);
            updateCardCompletion('financial-quiz', todayProgress.financialQuiz === true);
        }

        function updateCardCompletion(type, completed) {
            const card = document.getElementById(`card-${type}`);
            const star = document.getElementById(`star-${type}`);
            
            if (completed) {
                card.classList.add('completed');
                star.classList.add('completed');
            } else {
                card.classList.remove('completed');
                star.classList.remove('completed');
            }
        }

        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                if (gradeButtonImage && levelData.navImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                }
            }
        }

        async function getLatestFinanceNews() {
            try {
                const koreaTime = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                const dateStr = `${koreaTime.getFullYear()}년 ${koreaTime.getMonth() + 1}월 ${koreaTime.getDate()}일`;
                
                console.log(`🔍 ${dateStr} 실제 뉴스 가져오기 시작...`);
                
                const rssProxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];
                
                const rssUrls = [
                    'https://news.google.com/rss/search?q=금융+OR+경제+OR+주식+OR+코스피&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=한국은행+OR+금리+OR+환율&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=삼성전자+OR+SK하이닉스+OR+반도체&hl=ko&gl=KR&ceid=KR:ko'
                ];
                
                let allNews = [];
                
                for (const rssUrl of rssUrls) {
                    for (const proxy of rssProxies) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent(rssUrl);
                            const response = await fetch(proxyUrl);
                            
                            if (response.ok) {
                                const data = await response.text();
                                const newsItems = parseRSSData(data);
                                
                                if (newsItems && newsItems.length > 0) {
                                    allNews.push(...newsItems);
                                    break;
                                }
                            }
                        } catch (error) {
                            console.warn(`RSS 프록시 실패:`, error);
                        }
                    }
                }
                
                if (allNews.length > 0) {
                    const uniqueNews = allNews
                        .filter((item, index, self) => 
                            index === self.findIndex(t => t.title === item.title)
                        )
                        .slice(0, 5)
                        .map((item, index) => ({
                            id: `news-${index}`,
                            title: item.title.replace(/<[^>]*>/g, ''),
                            description: item.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...',
                            content: item.description.replace(/<[^>]*>/g, ''),
                            url: item.url,
                            source: item.source || 'Google News',
                            category: '금융뉴스',
                            publishedAt: item.publishedAt || koreaTime.toISOString()
                        }));
                
                    console.log(`✅ 실제 뉴스 ${uniqueNews.length}건 가져오기 성공`);
                    return uniqueNews;
                }
                
                console.log('⚠️ RSS 실패, 대체 뉴스 사용');
                return getFallbackNews();
                
            } catch (error) {
                console.error('뉴스 가져오기 실패:', error);
                return getFallbackNews();
            }
        }

        function parseRSSData(xmlText) {
            try {
                if (xmlText.includes('"contents"')) {
                    const jsonData = JSON.parse(xmlText);
                    xmlText = jsonData.contents;
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');
                
                const newsItems = [];
                items.forEach((item, index) => {
                    if (index < 5) {
                        const title = item.querySelector('title')?.textContent;
                        const description = item.querySelector('description')?.textContent || '';
                        const link = item.querySelector('link')?.textContent;
                        const pubDate = item.querySelector('pubDate')?.textContent;
                        const source = item.querySelector('source')?.textContent || 'Google News';
                        
                        if (title && link) {
                            const financeKeywords = ['금융', '경제', '코스피', '코스닥', '한국은행', '금리', '환율', '삼성전자', '주식', '투자', '증시', '기업', '시장', '은행', '보험', '증권'];
                            const hasKeyword = financeKeywords.some(keyword => 
                                title.includes(keyword) || description.includes(keyword)
                            );
                            
                            if (hasKeyword) {
                                newsItems.push({
                                    title: title,
                                    description: description || title,
                                    url: link,
                                    source: source,
                                    publishedAt: pubDate || new Date().toISOString()
                                });
                            }
                        }
                    }
                });
                
                return newsItems;
            } catch (error) {
                console.error('RSS 파싱 오류:', error);
                return [];
            }
        }

        function getFallbackNews() {
            const today = new Date();
            const kospiPrice = 2650 + Math.floor(Math.random() * 100);
            const usdRate = 1320 + Math.floor(Math.random() * 50);
            
            return [
                {
                    id: 'news-0',
                    title: `한국은행, 기준금리 3.50% 동결 결정`,
                    description: `한국은행이 ${today.getMonth() + 1}월 금융통화위원회에서 현행 기준금리 3.50%를 유지하기로 결정했습니다.`,
                    content: `한국은행이 ${today.getMonth() + 1}월 금융통화위원회에서 현행 기준금리 3.50%를 유지하기로 결정했습니다. 인플레이션 압력과 경제성장세를 종합 고려한 결과로 분석됩니다.`,
                    url: "https://www.bok.or.kr/",
                    source: "한국은행",
                    category: "통화정책",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-1',
                    title: `코스피 ${kospiPrice}선에서 등락 - 외국인 투자 동향 주목`,
                    description: `국내 증시가 ${kospiPrice}대에서 등락을 거듭하고 있습니다.`,
                    content: `국내 증시가 ${kospiPrice}대에서 등락을 거듭하고 있습니다. 반도체와 2차전지 업종을 중심으로 외국인 투자자들의 매매 패턴이 시장 방향성을 좌우하고 있습니다.`,
                    url: "https://finance.naver.com/sise/",
                    source: "한국거래소",
                    category: "증시동향",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-2',
                    title: `달러-원 환율 ${usdRate}원대 - 미 연준 정책 영향`,
                    description: `원-달러 환율이 ${usdRate}원대에서 형성되고 있습니다.`,
                    content: `원-달러 환율이 ${usdRate}원대에서 형성되고 있습니다. 미국 연방준비제도의 통화정책 방향과 국내 경제지표가 환율 변동의 주요 요인으로 작용하고 있습니다.`,
                    url: "https://www.koreaexim.go.kr/",
                    source: "한국수출입은행",
                    category: "환율동향",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-3',
                    title: `삼성전자 실적 전망 - 메모리 반도체 수요 회복`,
                    description: `삼성전자의 ${today.getMonth() + 1}월 실적에 대한 시장 관심이 높아지고 있습니다.`,
                    content: `삼성전자의 ${today.getMonth() + 1}월 실적에 대한 시장 관심이 높아지고 있습니다. 메모리 반도체 업황 개선과 스마트폰 사업 부문의 안정적 성장이 주요 포인트로 분석됩니다.`,
                    url: "https://news.samsung.com/kr/",
                    source: "삼성전자",
                    category: "기업실적",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-4',
                    title: `청년층 투자 트렌드 변화 - 안정성 중시`,
                    description: `최근 청년층 투자자들 사이에서 고위험 자산보다 안정적인 배당주와 채권에 대한 관심이 높아지고 있습니다.`,
                    content: `최근 청년층 투자자들 사이에서 고위험 자산보다 안정적인 배당주와 채권에 대한 관심이 높아지고 있습니다. 금융당국은 건전한 투자문화 정착을 위한 교육을 확대하고 있습니다.`,
                    url: "https://www.fss.or.kr/",
                    source: "금융감독원",
                    category: "투자동향",
                    publishedAt: today.toISOString()
                }
            ];
        }

        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`GEMINI API 오류: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    let result = data.candidates[0].content.parts[0].text;
                    
                    result = result.replace(/```(?:json|javascript|js|html|css)?\s*/gi, '');
                    result = result.replace(/```\s*/g, '');
                    result = result.replace(/`/g, '');
                    result = result.trim();
                    
                    return result;
                } else {
                    throw new Error('GEMINI API 응답 형식 오류');
                }
                
            } catch (error) {
                console.error('GEMINI API 호출 실패:', error);
                return null;
            }
        }

        // 중급 퀴즈 생성 함수
        function generateIntermediateQuiz() {
            return [
                {
                    question: "PER이 낮은 주식의 일반적인 특징은?",
                    options: ["고평가 상태", "저평가 가능성", "배당금이 높음", "성장성이 높음"],
                    correct: 1,
                    explanation: "PER이 낮다는 것은 주가가 수익 대비 저평가되어 있을 가능성을 의미합니다."
                },
                {
                    question: "금리 인상 시 일반적으로 하락하는 자산은?",
                    options: ["예금", "채권 가격", "대출 이자", "원화 가치"],
                    correct: 1,
                    explanation: "금리가 오르면 기존 채권의 매력도가 떨어져 채권 가격이 하락합니다."
                },
                {
                    question: "분산투자의 핵심 원리는?",
                    options: ["수익 극대화", "위험 분산", "세금 절감", "거래 비용 절감"],
                    correct: 1,
                    explanation: "분산투자는 여러 자산에 투자하여 전체 포트폴리오의 위험을 줄이는 전략입니다."
                },
                {
                    question: "환율이 상승(원화 약세)하면 유리한 기업은?",
                    options: ["수입 기업", "수출 기업", "내수 기업", "금융 기업"],
                    correct: 1,
                    explanation: "원화 약세는 수출 기업의 가격 경쟁력을 높여 수익성을 개선시킵니다."
                },
                {
                    question: "복리의 마법이 가장 크게 작용하는 요소는?",
                    options: ["원금 크기", "이자율", "투자 기간", "세금"],
                    correct: 2,
                    explanation: "복리는 시간이 지날수록 기하급수적으로 증가하므로 투자 기간이 가장 중요합니다."
                }
            ];
        }

        // 고급 퀴즈 생성 함수
        function generateAdvancedQuiz() {
            return [
                {
                    question: "옵션의 시간가치가 가장 빠르게 감소하는 시기는?",
                    options: ["만기 6개월 전", "만기 3개월 전", "만기 1개월 전", "만기 당일"],
                    correct: 2,
                    explanation: "옵션의 시간가치는 만기가 가까워질수록 가속도적으로 감소합니다(세타 decay)."
                },
                {
                    question: "헤지펀드가 사용하는 '롱숏 전략'의 목적은?",
                    options: ["레버리지 극대화", "시장 중립적 수익", "배당 수익", "환차익"],
                    correct: 1,
                    explanation: "롱숏 전략은 시장 방향과 관계없이 수익을 추구하는 시장 중립 전략입니다."
                },
                {
                    question: "채권의 듀레이션이 의미하는 것은?",
                    options: ["만기", "신용등급", "금리 민감도", "유동성"],
                    correct: 2,
                    explanation: "듀레이션은 금리 변동에 대한 채권 가격의 민감도를 나타내는 지표입니다."
                },
                {
                    question: "VIX 지수가 급등한다는 것은?",
                    options: ["주가 상승 예상", "시장 변동성 증가", "금리 인상", "달러 강세"],
                    correct: 1,
                    explanation: "VIX는 '공포지수'로 불리며, 시장의 변동성과 불확실성을 나타냅니다."
                },
                {
                    question: "알파(Alpha) 수익률이 양수라는 의미는?",
                    options: ["손실 발생", "시장 평균 이하", "시장 대비 초과 수익", "무위험 수익률"],
                    correct: 2,
                    explanation: "알파는 벤치마크 대비 초과 수익률로, 양수면 시장을 이긴 것입니다."
                }
            ];
        }

        async function generateTodayContent() {
            const today = getTodayDate();
            const firebaseCacheKey = `daily_${today}`;
            
            console.log(`📅 ${today} 데이터 생성 프로세스 시작`);
            
            // Firebase 연결 대기
            if (!window.firebaseDB) {
                console.log('⏳ Firebase 연결 대기 중...');
                setTimeout(generateTodayContent, 1000);
                return;
            }
            
            try {
                // 1. Firebase에서 오늘 데이터 확인
                console.log('🔍 Firebase에서 데이터 확인 중...');
                const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                const firebaseSnapshot = await window.firebaseGet(firebaseRef);
                
                let needsGeneration = false;
                let existingData = null;
                
                if (firebaseSnapshot.exists()) {
                    existingData = firebaseSnapshot.val();
                    console.log('📦 Firebase에 데이터 존재');
                    
                    // 데이터 유효성 검증
                    if (validateTodayData(existingData)) {
                        console.log('✅ Firebase 데이터 유효 - 사용');
                        localStorage.setItem('todayFinancialData', JSON.stringify(existingData));
                        localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(existingData));
                        return;
                    } else {
                        console.log('❌ Firebase 데이터 불완전 - 재생성 필요');
                        needsGeneration = true;
                    }
                } else {
                    console.log('❌ Firebase에 데이터 없음 - 생성 필요');
                    needsGeneration = true;
                }
                
                // 2. 데이터 생성이 필요한 경우
                if (needsGeneration) {
                    console.log('🔄 새 데이터 생성 시작...');
                    
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading-spinner';
                    loadingDiv.style.position = 'fixed';
                    loadingDiv.style.top = '50%';
                    loadingDiv.style.left = '50%';
                    loadingDiv.style.transform = 'translate(-50%, -50%)';
                    document.body.appendChild(loadingDiv);
                    
                    // 뉴스 데이터 가져오기
                    const newsData = await getLatestFinanceNews();
                    console.log(`📰 뉴스 ${newsData.length}건 수집 완료`);
                    
                    // 3개의 금융 용어 생성
                    const termsPrompt = `오늘의 금융 뉴스를 바탕으로 중요한 금융 용어 3개를 선정하고 JSON 형식으로 반환해주세요:
                    ${newsData.map(n => n.title).join('\n')}
                    
                    다음 형식으로 정확히 3개의 용어를 반환:
                    [
                        {
                            "id": "term-0",
                            "term": "용어명 (영문명)",
                            "definition": "정의 (초보자도 이해할 수 있게 쉽게 설명)",
                            "example": "실제 사례 (구체적인 예시)",
                            "isToday": true
                        },
                        {
                            "id": "term-1",
                            "term": "용어명 (영문명)",
                            "definition": "정의 (초보자도 이해할 수 있게 쉽게 설명)",
                            "example": "실제 사례 (구체적인 예시)",
                            "isToday": true
                        },
                        {
                            "id": "term-2",
                            "term": "용어명 (영문명)",
                            "definition": "정의 (초보자도 이해할 수 있게 쉽게 설명)",
                            "example": "실제 사례 (구체적인 예시)",
                            "isToday": true
                        }
                    ]`;
                    
                    // 개선된 퀴즈 프롬프트
                    const quizPrompt = `다음 금융 뉴스를 바탕으로 초급 퀴즈 5문제를 JSON 형식으로 만들어주세요:
                    ${newsData.map(n => n.title + '\n' + n.description).join('\n\n')}
                    
                    문제 구성:
                    1. 뉴스 관련 문제 2개 (위 뉴스 내용 직접 활용)
                    2. 최근 경제 트렌드 금융 상식 문제 2개 (위 뉴스에서 파악되는 트렌드 기반)
                    3. 재미있는 금융 문제 1개 (일상생활과 연관된 쉬운 문제)
                    
                    난이도: 금융 초보자도 상식으로 풀 수 있는 매우 쉬운 수준
                    
                    다음 형식으로 반환:
                    {
                        "beginner": [
                            {
                                "question": "뉴스 관련 문제 1",
                                "options": ["선택지1", "선택지2", "선택지3", "선택지4"],
                                "correct": 정답인덱스(0-3),
                                "explanation": "왜 이것이 정답인지 쉽게 설명"
                            },
                            // ... 5개 문제
                        ]
                    }`;
                    
                    let terms = [];
                    let quizzes = { beginner: [], intermediate: [], advanced: [] };
                    
                    // GEMINI API로 용어 생성
                    const termsResponse = await callGeminiAPI(termsPrompt);
                    if (termsResponse) {
                        try {
                            const jsonMatch = termsResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                terms = JSON.parse(jsonMatch[0]);
                            }
                        } catch (e) {
                            console.error('Terms 파싱 실패:', e);
                        }
                    }
                    
                    // 용어가 3개 미만이면 기본값 추가
                    if (terms.length < 3) {
                        const defaultTerms = [
                            {
                                id: "term-0",
                                term: "복리 (Compound Interest)",
                                definition: "원금에 붙은 이자가 다시 원금이 되어 이자가 붙는 방식입니다. 시간이 지날수록 자산이 기하급수적으로 증가합니다.",
                                example: "100만원을 연 10% 복리로 투자하면 1년 후 110만원, 2년 후 121만원, 10년 후에는 약 259만원이 됩니다.",
                                isToday: true
                            },
                            {
                                id: "term-1",
                                term: "분산투자 (Diversification)",
                                definition: "여러 종목이나 자산에 나누어 투자하여 위험을 줄이는 전략입니다. '계란을 한 바구니에 담지 마라'는 격언이 이를 잘 설명합니다.",
                                example: "주식 50%, 채권 30%, 현금 20%로 포트폴리오를 구성하면 한 자산의 손실을 다른 자산이 보완할 수 있습니다.",
                                isToday: true
                            },
                            {
                                id: "term-2",
                                term: "PER (Price Earnings Ratio)",
                                definition: "주가수익비율로, 주가를 주당순이익으로 나눈 값입니다. 기업의 수익 대비 주가가 적정한지 판단하는 지표입니다.",
                                example: "PER이 10이면 현재 수익 수준이 유지될 때 투자금을 회수하는데 10년이 걸린다는 의미입니다.",
                                isToday: true
                            }
                        ];
                        
                        while (terms.length < 3) {
                            terms.push(defaultTerms[terms.length]);
                        }
                    }
                    
                    // GEMINI API로 초급 퀴즈 생성
                    const quizResponse = await callGeminiAPI(quizPrompt);
                    if (quizResponse) {
                        try {
                            const jsonMatch = quizResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const parsed = JSON.parse(jsonMatch[0]);
                                if (parsed.beginner && Array.isArray(parsed.beginner)) {
                                    quizzes.beginner = parsed.beginner;
                                }
                            }
                        } catch (e) {
                            console.error('Quiz 파싱 실패:', e);
                        }
                    }
                    
                    // 초급 퀴즈가 부족하면 기본값 추가
                    if (quizzes.beginner.length < 5) {
                        const defaultQuizzes = [
                            {
                                question: "한국은행이 기준금리를 올리면 일반적으로 어떤 일이 발생하나요?",
                                options: ["예금 이자가 오른다", "예금 이자가 내린다", "환율이 고정된다", "주식이 무조건 오른다"],
                                correct: 0,
                                explanation: "기준금리가 오르면 시중 은행의 예금과 대출 금리도 함께 오르는 경향이 있습니다."
                            },
                            {
                                question: "주식시장에서 '코스피'는 무엇을 의미하나요?",
                                options: ["외국 주식", "한국 주식시장 지수", "채권 지수", "환율"],
                                correct: 1,
                                explanation: "코스피(KOSPI)는 한국 종합주가지수로, 우리나라 주식시장의 전반적인 상황을 나타냅니다."
                            },
                            {
                                question: "물가가 계속 오르는 현상을 무엇이라고 하나요?",
                                options: ["디플레이션", "인플레이션", "스태그플레이션", "리세션"],
                                correct: 1,
                                explanation: "인플레이션은 물가가 지속적으로 상승하는 현상으로, 화폐 가치가 하락합니다."
                            },
                            {
                                question: "청년들이 주식 투자를 시작하는 가장 좋은 방법은?",
                                options: ["전 재산 투자", "소액으로 분산 투자", "빚내서 투자", "친구 따라 투자"],
                                correct: 1,
                                explanation: "투자는 여유 자금으로 소액부터 시작하고, 여러 종목에 분산하는 것이 안전합니다."
                            },
                            {
                                question: "편의점에서 물건값이 작년보다 올랐다면, 이것은 무엇 때문일까요?",
                                options: ["물가 상승", "환율 하락", "주가 상승", "금리 하락"],
                                correct: 0,
                                explanation: "일상생활에서 물건값이 오르는 것은 물가 상승(인플레이션)의 영향입니다."
                            }
                        ];
                        
                        while (quizzes.beginner.length < 5) {
                            quizzes.beginner.push(defaultQuizzes[quizzes.beginner.length]);
                        }
                    }
                    
                    // 중급, 고급 퀴즈 생성
                    quizzes.intermediate = generateIntermediateQuiz();
                    quizzes.advanced = generateAdvancedQuiz();
                    
                    const todayData = {
                        date: today,
                        news: newsData,
                        terms: terms.slice(0, 3),
                        quizzes: quizzes
                    };
                    
                    // Firebase에 저장
                    console.log('💾 Firebase에 데이터 저장 중...');
                    await window.firebaseSet(firebaseRef, todayData);
                    console.log('✅ Firebase 저장 완료');
                    
                    // localStorage에도 저장
                    localStorage.setItem('todayFinancialData', JSON.stringify(todayData));
                    localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(todayData));
                    console.log('✅ localStorage 저장 완료');
                    
                    if (loadingDiv.parentNode) {
                        document.body.removeChild(loadingDiv);
                    }
                }
                
            } catch (error) {
                console.error('❌ 콘텐츠 생성 실패:', error);
                
                // 에러 시 기본 데이터 생성
                const fallbackData = {
                    date: today,
                    news: getFallbackNews(),
                    terms: [
                        {
                            id: "term-0",
                            term: "복리 (Compound Interest)",
                            definition: "원금에 붙은 이자가 다시 원금이 되어 이자가 붙는 방식입니다.",
                            example: "100만원을 연 10% 복리로 투자하면 10년 후 약 259만원이 됩니다.",
                            isToday: true
                        },
                        {
                            id: "term-1",
                            term: "분산투자 (Diversification)",
                            definition: "여러 자산에 나누어 투자하여 위험을 줄이는 전략입니다.",
                            example: "주식, 채권, 부동산 등 다양한 자산에 분산 투자합니다.",
                            isToday: true
                        },
                        {
                            id: "term-2",
                            term: "인플레이션 (Inflation)",
                            definition: "물가가 지속적으로 상승하는 현상입니다.",
                            example: "작년에 1000원이던 빵이 올해 1100원이 되는 현상입니다.",
                            isToday: true
                        }
                    ],
                    quizzes: {
                        beginner: [
                            {
                                question: "예금 이자를 결정하는 기준이 되는 금리는?",
                                options: ["시장금리", "기준금리", "대출금리", "환율"],
                                correct: 1,
                                explanation: "한국은행이 정하는 기준금리가 시중 금리의 기준이 됩니다."
                            },
                            {
                                question: "주식을 처음 시작할 때 가장 중요한 것은?",
                                options: ["큰 수익", "빠른 매매", "리스크 관리", "차트 분석"],
                                correct: 2,
                                explanation: "투자에서 가장 중요한 것은 손실을 최소화하는 리스크 관리입니다."
                            },
                            {
                                question: "1년에 물가가 3% 올랐다면?",
                                options: ["돈의 가치가 올랐다", "돈의 가치가 떨어졌다", "변화 없다", "환율이 올랐다"],
                                correct: 1,
                                explanation: "물가가 오르면 같은 돈으로 살 수 있는 물건이 줄어들어 돈의 가치가 떨어집니다."
                            },
                            {
                                question: "적금과 예금의 차이는?",
                                options: ["이자율", "정기 납입 여부", "위험도", "세금"],
                                correct: 1,
                                explanation: "적금은 매달 정기적으로 납입하고, 예금은 한 번에 예치합니다."
                            },
                            {
                                question: "용돈을 모으는 가장 좋은 방법은?",
                                options: ["전부 소비", "일부는 저축", "투자만", "빚내서 투자"],
                                correct: 1,
                                explanation: "수입의 일부를 꾸준히 저축하는 것이 자산을 만드는 첫걸음입니다."
                            }
                        ],
                        intermediate: generateIntermediateQuiz(),
                        advanced: generateAdvancedQuiz()
                    }
                };
                
                // Firebase에 기본 데이터 저장
                try {
                    const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                    await window.firebaseSet(firebaseRef, fallbackData);
                } catch (e) {
                    console.error('Firebase 저장 실패:', e);
                }
                
                localStorage.setItem('todayFinancialData', JSON.stringify(fallbackData));
                localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(fallbackData));
                
                const loadingDiv = document.querySelector('.loading-spinner');
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.parentNode.removeChild(loadingDiv);
                }
            }
        }

        function goToTermsPage() {
            window.location.href = 'a2-terms.html';
        }

        function goToNewsPage() {
            window.location.href = 'a2-news.html';
        }

        function goToQuizPage() {
            window.location.href = 'a2-quiz.html';
        }

        function goToPage(page) {
            if (page === 'a2.html') return;
            window.location.href = page;
        }

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('fineu_current_user');
                localStorage.removeItem('fineu_user_assets');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('📚 새로운 학습 콘텐츠가 업데이트되었습니다!\n\n• 오늘의 금융 용어 (3개)\n• 최신 금융 뉴스 분석\n• 금융 퀴즈 챌린지\n\n지금 바로 학습하고 보상을 받아보세요!');
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            return true;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!checkLoginStatus()) return;
            
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            const cards = document.querySelectorAll('.fade-in');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>
