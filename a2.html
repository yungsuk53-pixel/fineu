<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - í•™ìŠµ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .study-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .study-card:active {
            transform: translateY(0);
        }

        .study-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .star-icon {
            color: #ffd700;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .star-icon.completed {
            color: #4CAF50;
            animation: sparkle 0.6s ease-in-out;
        }

        .study-card.completed {
            background: linear-gradient(135deg, #f0f8f0, #e8f5e8);
            border: 2px solid #4CAF50;
        }

        .divider {
            height: 2px;
            background: #333;
            margin: 30px 0;
            border-radius: 1px;
        }

        .scrap-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scrap-content {
            text-align: center;
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: #fafaf8;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7cb9e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/ë ˆì´ì–´ 1.png" alt="FINE U ë¡œê³ " class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <div class="main-content">
        <div class="page-title">STUDY ZONE</div>

        <div class="study-card fade-in" id="card-financial-terms" onclick="goToTermsPage()" style="animation-delay: 0.1s">
            <div class="study-title">ê¸ˆìœµ ìš©ì–´</div>
            <i class="fas fa-star star-icon" id="star-financial-terms"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-news" onclick="goToNewsPage()" style="animation-delay: 0.2s">
            <div class="study-title">ê¸ˆìœµ ë‰´ìŠ¤</div>
            <i class="fas fa-star star-icon" id="star-financial-news"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-quiz" onclick="goToQuizPage()" style="animation-delay: 0.3s">
            <div class="study-title">ê¸ˆìœµ í€´ì¦ˆ</div>
            <i class="fas fa-star star-icon" id="star-financial-quiz"></i>
        </div>

        <div class="divider"></div>

        <div class="scrap-section fade-in" style="animation-delay: 0.4s">
            <div class="scrap-content">
                ìŠ¤í¬ë©
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/ì§‘.png" alt="í™ˆ">
            </div>
        </div>
        <div class="nav-item active" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/ë¬¸ì„œ.png" alt="ë¬¸ì„œ">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ã…‡.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/ì±„íŒ….png" alt="ì±„íŒ…">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ë”ë³´ê¸°.png" alt="ë”ë³´ê¸°">
            </div>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = 'AIzaSyBJhMtNOYyCfl6NRCQQz_CkTUHWP2TNweI';
        
        let currentUser = null;
        let userAssets = {};
        
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, navImage: 'YELLOW ã…‡.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, navImage: 'GREEN ã…‡.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, navImage: 'BLUE ã…‡.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, navImage: 'RED ã…‡.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, navImage: 'BLACK ã…‡.png' }
        };

        function getTodayDate() {
            const now = new Date();
            const koreaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
            const year = koreaTime.getFullYear();
            const month = String(koreaTime.getMonth() + 1).padStart(2, '0');
            const day = String(koreaTime.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 2ì£¼ ì´ìƒ ì§€ë‚œ ë°ì´í„° ì‚­ì œ
        async function cleanOldData() {
            const today = new Date();
            const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            
            // localStorageì—ì„œ ì˜¤ë˜ëœ ìºì‹œ ì‚­ì œ
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('todayFinancialData_')) {
                    const dateStr = key.replace('todayFinancialData_', '');
                    const keyDate = new Date(dateStr);
                    if (keyDate < twoWeeksAgo) {
                        localStorage.removeItem(key);
                        console.log(`ì‚­ì œëœ ì˜¤ë˜ëœ ë¡œì»¬ ë°ì´í„°: ${key}`);
                    }
                }
            });

            // Firebaseì—ì„œ ì˜¤ë˜ëœ ìºì‹œ ì‚­ì œ
            if (window.firebaseDB && window.firebaseRemove) {
                try {
                    const cacheRef = window.firebaseRef(window.firebaseDB, 'cache');
                    const snapshot = await window.firebaseGet(cacheRef);
                    
                    if (snapshot.exists()) {
                        const cacheData = snapshot.val();
                        for (const key in cacheData) {
                            if (cacheData[key].date) {
                                const keyDate = new Date(cacheData[key].date);
                                if (keyDate < twoWeeksAgo) {
                                    const oldRef = window.firebaseRef(window.firebaseDB, `cache/${key}`);
                                    await window.firebaseRemove(oldRef);
                                    console.log(`Firebaseì—ì„œ ì‚­ì œëœ ì˜¤ë˜ëœ ë°ì´í„°: ${key}`);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Firebase ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                }
            }
        }

        // ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
        function validateTodayData(data) {
            if (!data) return false;
            
            // í•„ìˆ˜ í•„ë“œ í™•ì¸
            if (!data.date || !data.news || !data.terms || !data.quizzes) {
                console.log('âŒ í•„ìˆ˜ í•„ë“œ ëˆ„ë½');
                return false;
            }
            
            // ë‰´ìŠ¤ í™•ì¸ (ìµœì†Œ 1ê°œ ì´ìƒ)
            if (!Array.isArray(data.news) || data.news.length === 0) {
                console.log('âŒ ë‰´ìŠ¤ ë°ì´í„° ì—†ìŒ');
                return false;
            }
            
            // ìš©ì–´ í™•ì¸ (ì •í™•íˆ 3ê°œ)
            if (!Array.isArray(data.terms) || data.terms.length < 3) {
                console.log('âŒ ìš©ì–´ ë°ì´í„° ë¶€ì¡± (3ê°œ í•„ìš”)');
                return false;
            }
            
            // í€´ì¦ˆ í™•ì¸
            if (!data.quizzes.beginner || !Array.isArray(data.quizzes.beginner) || data.quizzes.beginner.length < 5) {
                console.log('âŒ ì´ˆê¸‰ í€´ì¦ˆ ë¶€ì¡± (5ê°œ í•„ìš”)');
                return false;
            }
            
            // ì¤‘ê¸‰, ê³ ê¸‰ í€´ì¦ˆ í™•ì¸
            if (!data.quizzes.intermediate || !Array.isArray(data.quizzes.intermediate) || data.quizzes.intermediate.length < 5) {
                console.log('âŒ ì¤‘ê¸‰ í€´ì¦ˆ ì—†ìŒ');
                return false;
            }
            
            if (!data.quizzes.advanced || !Array.isArray(data.quizzes.advanced) || data.quizzes.advanced.length < 5) {
                console.log('âŒ ê³ ê¸‰ í€´ì¦ˆ ì—†ìŒ');
                return false;
            }
            
            console.log('âœ… ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ í†µê³¼');
            return true;
        }

        async function loadUserDataFromFirebase() {
            try {
                if (!window.firebaseDB) {
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }

                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);

                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {}
                    };
                    
                    updateGradeButton(userAssets.level);
                } else {
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 10000000,
                        totalAssets: 10000000,
                        virtualBalance: 10000000,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {}
                    };
                    updateGradeButton('yellow');
                }
                
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                checkTodayCompletion();
                await cleanOldData();
                await generateTodayContent();

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 10000000,
                    level: 'yellow',
                    exp: 0,
                    experience: 0,
                    studyProgress: {}
                };
                updateGradeButton('yellow');
            }
        }

        function checkTodayCompletion() {
            const today = getTodayDate();
            
            if (!userAssets.studyProgress) {
                userAssets.studyProgress = {};
            }
            
            const todayProgress = userAssets.studyProgress[today] || {};
            
            updateCardCompletion('financial-terms', todayProgress.financialTerms === true);
            updateCardCompletion('financial-news', todayProgress.financialNews === true);
            updateCardCompletion('financial-quiz', todayProgress.financialQuiz === true);
        }

        function updateCardCompletion(type, completed) {
            const card = document.getElementById(`card-${type}`);
            const star = document.getElementById(`star-${type}`);
            
            if (completed) {
                card.classList.add('completed');
                star.classList.add('completed');
            } else {
                card.classList.remove('completed');
                star.classList.remove('completed');
            }
        }

        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                if (gradeButtonImage && levelData.navImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                }
            }
        }

        async function getLatestFinanceNews() {
            try {
                const koreaTime = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                const dateStr = `${koreaTime.getFullYear()}ë…„ ${koreaTime.getMonth() + 1}ì›” ${koreaTime.getDate()}ì¼`;
                
                console.log(`ğŸ” ${dateStr} ì‹¤ì œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
                
                const rssProxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];
                
                const rssUrls = [
                    'https://news.google.com/rss/search?q=ê¸ˆìœµ+OR+ê²½ì œ+OR+ì£¼ì‹+OR+ì½”ìŠ¤í”¼&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=í•œêµ­ì€í–‰+OR+ê¸ˆë¦¬+OR+í™˜ìœ¨&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=ì‚¼ì„±ì „ì+OR+SKí•˜ì´ë‹‰ìŠ¤+OR+ë°˜ë„ì²´&hl=ko&gl=KR&ceid=KR:ko'
                ];
                
                let allNews = [];
                
                for (const rssUrl of rssUrls) {
                    for (const proxy of rssProxies) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent(rssUrl);
                            const response = await fetch(proxyUrl);
                            
                            if (response.ok) {
                                const data = await response.text();
                                const newsItems = parseRSSData(data);
                                
                                if (newsItems && newsItems.length > 0) {
                                    allNews.push(...newsItems);
                                    break;
                                }
                            }
                        } catch (error) {
                            console.warn(`RSS í”„ë¡ì‹œ ì‹¤íŒ¨:`, error);
                        }
                    }
                }
                
                if (allNews.length > 0) {
                    const uniqueNews = allNews
                        .filter((item, index, self) => 
                            index === self.findIndex(t => t.title === item.title)
                        )
                        .slice(0, 5)
                        .map((item, index) => ({
                            id: `news-${index}`,
                            title: item.title.replace(/<[^>]*>/g, ''),
                            description: item.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...',
                            content: item.description.replace(/<[^>]*>/g, ''),
                            url: item.url,
                            source: item.source || 'Google News',
                            category: 'ê¸ˆìœµë‰´ìŠ¤',
                            publishedAt: item.publishedAt || koreaTime.toISOString()
                        }));
                
                    console.log(`âœ… ì‹¤ì œ ë‰´ìŠ¤ ${uniqueNews.length}ê±´ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ`);
                    return uniqueNews;
                }
                
                console.log('âš ï¸ RSS ì‹¤íŒ¨, ëŒ€ì²´ ë‰´ìŠ¤ ì‚¬ìš©');
                return getFallbackNews();
                
            } catch (error) {
                console.error('ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return getFallbackNews();
            }
        }

        function parseRSSData(xmlText) {
            try {
                if (xmlText.includes('"contents"')) {
                    const jsonData = JSON.parse(xmlText);
                    xmlText = jsonData.contents;
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');
                
                const newsItems = [];
                items.forEach((item, index) => {
                    if (index < 5) {
                        const title = item.querySelector('title')?.textContent;
                        const description = item.querySelector('description')?.textContent || '';
                        const link = item.querySelector('link')?.textContent;
                        const pubDate = item.querySelector('pubDate')?.textContent;
                        const source = item.querySelector('source')?.textContent || 'Google News';
                        
                        if (title && link) {
                            const financeKeywords = ['ê¸ˆìœµ', 'ê²½ì œ', 'ì½”ìŠ¤í”¼', 'ì½”ìŠ¤ë‹¥', 'í•œêµ­ì€í–‰', 'ê¸ˆë¦¬', 'í™˜ìœ¨', 'ì‚¼ì„±ì „ì', 'ì£¼ì‹', 'íˆ¬ì', 'ì¦ì‹œ', 'ê¸°ì—…', 'ì‹œì¥', 'ì€í–‰', 'ë³´í—˜', 'ì¦ê¶Œ'];
                            const hasKeyword = financeKeywords.some(keyword => 
                                title.includes(keyword) || description.includes(keyword)
                            );
                            
                            if (hasKeyword) {
                                newsItems.push({
                                    title: title,
                                    description: description || title,
                                    url: link,
                                    source: source,
                                    publishedAt: pubDate || new Date().toISOString()
                                });
                            }
                        }
                    }
                });
                
                return newsItems;
            } catch (error) {
                console.error('RSS íŒŒì‹± ì˜¤ë¥˜:', error);
                return [];
            }
        }

        function getFallbackNews() {
            const today = new Date();
            const kospiPrice = 2650 + Math.floor(Math.random() * 100);
            const usdRate = 1320 + Math.floor(Math.random() * 50);
            
            return [
                {
                    id: 'news-0',
                    title: `í•œêµ­ì€í–‰, ê¸°ì¤€ê¸ˆë¦¬ 3.50% ë™ê²° ê²°ì •`,
                    description: `í•œêµ­ì€í–‰ì´ ${today.getMonth() + 1}ì›” ê¸ˆìœµí†µí™”ìœ„ì›íšŒì—ì„œ í˜„í–‰ ê¸°ì¤€ê¸ˆë¦¬ 3.50%ë¥¼ ìœ ì§€í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.`,
                    content: `í•œêµ­ì€í–‰ì´ ${today.getMonth() + 1}ì›” ê¸ˆìœµí†µí™”ìœ„ì›íšŒì—ì„œ í˜„í–‰ ê¸°ì¤€ê¸ˆë¦¬ 3.50%ë¥¼ ìœ ì§€í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤. ì¸í”Œë ˆì´ì…˜ ì••ë ¥ê³¼ ê²½ì œì„±ì¥ì„¸ë¥¼ ì¢…í•© ê³ ë ¤í•œ ê²°ê³¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`,
                    url: "https://www.bok.or.kr/",
                    source: "í•œêµ­ì€í–‰",
                    category: "í†µí™”ì •ì±…",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-1',
                    title: `ì½”ìŠ¤í”¼ ${kospiPrice}ì„ ì—ì„œ ë“±ë½ - ì™¸êµ­ì¸ íˆ¬ì ë™í–¥ ì£¼ëª©`,
                    description: `êµ­ë‚´ ì¦ì‹œê°€ ${kospiPrice}ëŒ€ì—ì„œ ë“±ë½ì„ ê±°ë“­í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    content: `êµ­ë‚´ ì¦ì‹œê°€ ${kospiPrice}ëŒ€ì—ì„œ ë“±ë½ì„ ê±°ë“­í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë°˜ë„ì²´ì™€ 2ì°¨ì „ì§€ ì—…ì¢…ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì™¸êµ­ì¸ íˆ¬ììë“¤ì˜ ë§¤ë§¤ íŒ¨í„´ì´ ì‹œì¥ ë°©í–¥ì„±ì„ ì¢Œìš°í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    url: "https://finance.naver.com/sise/",
                    source: "í•œêµ­ê±°ë˜ì†Œ",
                    category: "ì¦ì‹œë™í–¥",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-2',
                    title: `ë‹¬ëŸ¬-ì› í™˜ìœ¨ ${usdRate}ì›ëŒ€ - ë¯¸ ì—°ì¤€ ì •ì±… ì˜í–¥`,
                    description: `ì›-ë‹¬ëŸ¬ í™˜ìœ¨ì´ ${usdRate}ì›ëŒ€ì—ì„œ í˜•ì„±ë˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    content: `ì›-ë‹¬ëŸ¬ í™˜ìœ¨ì´ ${usdRate}ì›ëŒ€ì—ì„œ í˜•ì„±ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë¯¸êµ­ ì—°ë°©ì¤€ë¹„ì œë„ì˜ í†µí™”ì •ì±… ë°©í–¥ê³¼ êµ­ë‚´ ê²½ì œì§€í‘œê°€ í™˜ìœ¨ ë³€ë™ì˜ ì£¼ìš” ìš”ì¸ìœ¼ë¡œ ì‘ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    url: "https://www.koreaexim.go.kr/",
                    source: "í•œêµ­ìˆ˜ì¶œì…ì€í–‰",
                    category: "í™˜ìœ¨ë™í–¥",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-3',
                    title: `ì‚¼ì„±ì „ì ì‹¤ì  ì „ë§ - ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ìˆ˜ìš” íšŒë³µ`,
                    description: `ì‚¼ì„±ì „ìì˜ ${today.getMonth() + 1}ì›” ì‹¤ì ì— ëŒ€í•œ ì‹œì¥ ê´€ì‹¬ì´ ë†’ì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤.`,
                    content: `ì‚¼ì„±ì „ìì˜ ${today.getMonth() + 1}ì›” ì‹¤ì ì— ëŒ€í•œ ì‹œì¥ ê´€ì‹¬ì´ ë†’ì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ì—…í™© ê°œì„ ê³¼ ìŠ¤ë§ˆíŠ¸í° ì‚¬ì—… ë¶€ë¬¸ì˜ ì•ˆì •ì  ì„±ì¥ì´ ì£¼ìš” í¬ì¸íŠ¸ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`,
                    url: "https://news.samsung.com/kr/",
                    source: "ì‚¼ì„±ì „ì",
                    category: "ê¸°ì—…ì‹¤ì ",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-4',
                    title: `ì²­ë…„ì¸µ íˆ¬ì íŠ¸ë Œë“œ ë³€í™” - ì•ˆì •ì„± ì¤‘ì‹œ`,
                    description: `ìµœê·¼ ì²­ë…„ì¸µ íˆ¬ììë“¤ ì‚¬ì´ì—ì„œ ê³ ìœ„í—˜ ìì‚°ë³´ë‹¤ ì•ˆì •ì ì¸ ë°°ë‹¹ì£¼ì™€ ì±„ê¶Œì— ëŒ€í•œ ê´€ì‹¬ì´ ë†’ì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤.`,
                    content: `ìµœê·¼ ì²­ë…„ì¸µ íˆ¬ììë“¤ ì‚¬ì´ì—ì„œ ê³ ìœ„í—˜ ìì‚°ë³´ë‹¤ ì•ˆì •ì ì¸ ë°°ë‹¹ì£¼ì™€ ì±„ê¶Œì— ëŒ€í•œ ê´€ì‹¬ì´ ë†’ì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤. ê¸ˆìœµë‹¹êµ­ì€ ê±´ì „í•œ íˆ¬ìë¬¸í™” ì •ì°©ì„ ìœ„í•œ êµìœ¡ì„ í™•ëŒ€í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    url: "https://www.fss.or.kr/",
                    source: "ê¸ˆìœµê°ë…ì›",
                    category: "íˆ¬ìë™í–¥",
                    publishedAt: today.toISOString()
                }
            ];
        }

        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`GEMINI API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    let result = data.candidates[0].content.parts[0].text;
                    
                    result = result.replace(/```(?:json|javascript|js|html|css)?\s*/gi, '');
                    result = result.replace(/```\s*/g, '');
                    result = result.replace(/`/g, '');
                    result = result.trim();
                    
                    return result;
                } else {
                    throw new Error('GEMINI API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
                }
                
            } catch (error) {
                console.error('GEMINI API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ì¤‘ê¸‰ í€´ì¦ˆ ìƒì„± í•¨ìˆ˜
        function generateIntermediateQuiz() {
            return [
                {
                    question: "PERì´ ë‚®ì€ ì£¼ì‹ì˜ ì¼ë°˜ì ì¸ íŠ¹ì§•ì€?",
                    options: ["ê³ í‰ê°€ ìƒíƒœ", "ì €í‰ê°€ ê°€ëŠ¥ì„±", "ë°°ë‹¹ê¸ˆì´ ë†’ìŒ", "ì„±ì¥ì„±ì´ ë†’ìŒ"],
                    correct: 1,
                    explanation: "PERì´ ë‚®ë‹¤ëŠ” ê²ƒì€ ì£¼ê°€ê°€ ìˆ˜ìµ ëŒ€ë¹„ ì €í‰ê°€ë˜ì–´ ìˆì„ ê°€ëŠ¥ì„±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤."
                },
                {
                    question: "ê¸ˆë¦¬ ì¸ìƒ ì‹œ ì¼ë°˜ì ìœ¼ë¡œ í•˜ë½í•˜ëŠ” ìì‚°ì€?",
                    options: ["ì˜ˆê¸ˆ", "ì±„ê¶Œ ê°€ê²©", "ëŒ€ì¶œ ì´ì", "ì›í™” ê°€ì¹˜"],
                    correct: 1,
                    explanation: "ê¸ˆë¦¬ê°€ ì˜¤ë¥´ë©´ ê¸°ì¡´ ì±„ê¶Œì˜ ë§¤ë ¥ë„ê°€ ë–¨ì–´ì ¸ ì±„ê¶Œ ê°€ê²©ì´ í•˜ë½í•©ë‹ˆë‹¤."
                },
                {
                    question: "ë¶„ì‚°íˆ¬ìì˜ í•µì‹¬ ì›ë¦¬ëŠ”?",
                    options: ["ìˆ˜ìµ ê·¹ëŒ€í™”", "ìœ„í—˜ ë¶„ì‚°", "ì„¸ê¸ˆ ì ˆê°", "ê±°ë˜ ë¹„ìš© ì ˆê°"],
                    correct: 1,
                    explanation: "ë¶„ì‚°íˆ¬ìëŠ” ì—¬ëŸ¬ ìì‚°ì— íˆ¬ìí•˜ì—¬ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ìœ„í—˜ì„ ì¤„ì´ëŠ” ì „ëµì…ë‹ˆë‹¤."
                },
                {
                    question: "í™˜ìœ¨ì´ ìƒìŠ¹(ì›í™” ì•½ì„¸)í•˜ë©´ ìœ ë¦¬í•œ ê¸°ì—…ì€?",
                    options: ["ìˆ˜ì… ê¸°ì—…", "ìˆ˜ì¶œ ê¸°ì—…", "ë‚´ìˆ˜ ê¸°ì—…", "ê¸ˆìœµ ê¸°ì—…"],
                    correct: 1,
                    explanation: "ì›í™” ì•½ì„¸ëŠ” ìˆ˜ì¶œ ê¸°ì—…ì˜ ê°€ê²© ê²½ìŸë ¥ì„ ë†’ì—¬ ìˆ˜ìµì„±ì„ ê°œì„ ì‹œí‚µë‹ˆë‹¤."
                },
                {
                    question: "ë³µë¦¬ì˜ ë§ˆë²•ì´ ê°€ì¥ í¬ê²Œ ì‘ìš©í•˜ëŠ” ìš”ì†ŒëŠ”?",
                    options: ["ì›ê¸ˆ í¬ê¸°", "ì´ììœ¨", "íˆ¬ì ê¸°ê°„", "ì„¸ê¸ˆ"],
                    correct: 2,
                    explanation: "ë³µë¦¬ëŠ” ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€í•˜ë¯€ë¡œ íˆ¬ì ê¸°ê°„ì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤."
                }
            ];
        }

        // ê³ ê¸‰ í€´ì¦ˆ ìƒì„± í•¨ìˆ˜
        function generateAdvancedQuiz() {
            return [
                {
                    question: "ì˜µì…˜ì˜ ì‹œê°„ê°€ì¹˜ê°€ ê°€ì¥ ë¹ ë¥´ê²Œ ê°ì†Œí•˜ëŠ” ì‹œê¸°ëŠ”?",
                    options: ["ë§Œê¸° 6ê°œì›” ì „", "ë§Œê¸° 3ê°œì›” ì „", "ë§Œê¸° 1ê°œì›” ì „", "ë§Œê¸° ë‹¹ì¼"],
                    correct: 2,
                    explanation: "ì˜µì…˜ì˜ ì‹œê°„ê°€ì¹˜ëŠ” ë§Œê¸°ê°€ ê°€ê¹Œì›Œì§ˆìˆ˜ë¡ ê°€ì†ë„ì ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤(ì„¸íƒ€ decay)."
                },
                {
                    question: "í—¤ì§€í€ë“œê°€ ì‚¬ìš©í•˜ëŠ” 'ë¡±ìˆ ì „ëµ'ì˜ ëª©ì ì€?",
                    options: ["ë ˆë²„ë¦¬ì§€ ê·¹ëŒ€í™”", "ì‹œì¥ ì¤‘ë¦½ì  ìˆ˜ìµ", "ë°°ë‹¹ ìˆ˜ìµ", "í™˜ì°¨ìµ"],
                    correct: 1,
                    explanation: "ë¡±ìˆ ì „ëµì€ ì‹œì¥ ë°©í–¥ê³¼ ê´€ê³„ì—†ì´ ìˆ˜ìµì„ ì¶”êµ¬í•˜ëŠ” ì‹œì¥ ì¤‘ë¦½ ì „ëµì…ë‹ˆë‹¤."
                },
                {
                    question: "ì±„ê¶Œì˜ ë“€ë ˆì´ì…˜ì´ ì˜ë¯¸í•˜ëŠ” ê²ƒì€?",
                    options: ["ë§Œê¸°", "ì‹ ìš©ë“±ê¸‰", "ê¸ˆë¦¬ ë¯¼ê°ë„", "ìœ ë™ì„±"],
                    correct: 2,
                    explanation: "ë“€ë ˆì´ì…˜ì€ ê¸ˆë¦¬ ë³€ë™ì— ëŒ€í•œ ì±„ê¶Œ ê°€ê²©ì˜ ë¯¼ê°ë„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œì…ë‹ˆë‹¤."
                },
                {
                    question: "VIX ì§€ìˆ˜ê°€ ê¸‰ë“±í•œë‹¤ëŠ” ê²ƒì€?",
                    options: ["ì£¼ê°€ ìƒìŠ¹ ì˜ˆìƒ", "ì‹œì¥ ë³€ë™ì„± ì¦ê°€", "ê¸ˆë¦¬ ì¸ìƒ", "ë‹¬ëŸ¬ ê°•ì„¸"],
                    correct: 1,
                    explanation: "VIXëŠ” 'ê³µí¬ì§€ìˆ˜'ë¡œ ë¶ˆë¦¬ë©°, ì‹œì¥ì˜ ë³€ë™ì„±ê³¼ ë¶ˆí™•ì‹¤ì„±ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤."
                },
                {
                    question: "ì•ŒíŒŒ(Alpha) ìˆ˜ìµë¥ ì´ ì–‘ìˆ˜ë¼ëŠ” ì˜ë¯¸ëŠ”?",
                    options: ["ì†ì‹¤ ë°œìƒ", "ì‹œì¥ í‰ê·  ì´í•˜", "ì‹œì¥ ëŒ€ë¹„ ì´ˆê³¼ ìˆ˜ìµ", "ë¬´ìœ„í—˜ ìˆ˜ìµë¥ "],
                    correct: 2,
                    explanation: "ì•ŒíŒŒëŠ” ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„ ì´ˆê³¼ ìˆ˜ìµë¥ ë¡œ, ì–‘ìˆ˜ë©´ ì‹œì¥ì„ ì´ê¸´ ê²ƒì…ë‹ˆë‹¤."
                }
            ];
        }

        async function generateTodayContent() {
            const today = getTodayDate();
            const firebaseCacheKey = `daily_${today}`;
            
            console.log(`ğŸ“… ${today} ë°ì´í„° ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘`);
            
            // Firebase ì—°ê²° ëŒ€ê¸°
            if (!window.firebaseDB) {
                console.log('â³ Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...');
                setTimeout(generateTodayContent, 1000);
                return;
            }
            
            try {
                // 1. Firebaseì—ì„œ ì˜¤ëŠ˜ ë°ì´í„° í™•ì¸
                console.log('ğŸ” Firebaseì—ì„œ ë°ì´í„° í™•ì¸ ì¤‘...');
                const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                const firebaseSnapshot = await window.firebaseGet(firebaseRef);
                
                let needsGeneration = false;
                let existingData = null;
                
                if (firebaseSnapshot.exists()) {
                    existingData = firebaseSnapshot.val();
                    console.log('ğŸ“¦ Firebaseì— ë°ì´í„° ì¡´ì¬');
                    
                    // ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
                    if (validateTodayData(existingData)) {
                        console.log('âœ… Firebase ë°ì´í„° ìœ íš¨ - ì‚¬ìš©');
                        localStorage.setItem('todayFinancialData', JSON.stringify(existingData));
                        localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(existingData));
                        return;
                    } else {
                        console.log('âŒ Firebase ë°ì´í„° ë¶ˆì™„ì „ - ì¬ìƒì„± í•„ìš”');
                        needsGeneration = true;
                    }
                } else {
                    console.log('âŒ Firebaseì— ë°ì´í„° ì—†ìŒ - ìƒì„± í•„ìš”');
                    needsGeneration = true;
                }
                
                // 2. ë°ì´í„° ìƒì„±ì´ í•„ìš”í•œ ê²½ìš°
                if (needsGeneration) {
                    console.log('ğŸ”„ ìƒˆ ë°ì´í„° ìƒì„± ì‹œì‘...');
                    
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading-spinner';
                    loadingDiv.style.position = 'fixed';
                    loadingDiv.style.top = '50%';
                    loadingDiv.style.left = '50%';
                    loadingDiv.style.transform = 'translate(-50%, -50%)';
                    document.body.appendChild(loadingDiv);
                    
                    // ë‰´ìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const newsData = await getLatestFinanceNews();
                    console.log(`ğŸ“° ë‰´ìŠ¤ ${newsData.length}ê±´ ìˆ˜ì§‘ ì™„ë£Œ`);
                    
                    // 3ê°œì˜ ê¸ˆìœµ ìš©ì–´ ìƒì„±
                    const termsPrompt = `ì˜¤ëŠ˜ì˜ ê¸ˆìœµ ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¤‘ìš”í•œ ê¸ˆìœµ ìš©ì–´ 3ê°œë¥¼ ì„ ì •í•˜ê³  JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”:
                    ${newsData.map(n => n.title).join('\n')}
                    
                    ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ 3ê°œì˜ ìš©ì–´ë¥¼ ë°˜í™˜:
                    [
                        {
                            "id": "term-0",
                            "term": "ìš©ì–´ëª… (ì˜ë¬¸ëª…)",
                            "definition": "ì •ì˜ (ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì‰½ê²Œ ì„¤ëª…)",
                            "example": "ì‹¤ì œ ì‚¬ë¡€ (êµ¬ì²´ì ì¸ ì˜ˆì‹œ)",
                            "isToday": true
                        },
                        {
                            "id": "term-1",
                            "term": "ìš©ì–´ëª… (ì˜ë¬¸ëª…)",
                            "definition": "ì •ì˜ (ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì‰½ê²Œ ì„¤ëª…)",
                            "example": "ì‹¤ì œ ì‚¬ë¡€ (êµ¬ì²´ì ì¸ ì˜ˆì‹œ)",
                            "isToday": true
                        },
                        {
                            "id": "term-2",
                            "term": "ìš©ì–´ëª… (ì˜ë¬¸ëª…)",
                            "definition": "ì •ì˜ (ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì‰½ê²Œ ì„¤ëª…)",
                            "example": "ì‹¤ì œ ì‚¬ë¡€ (êµ¬ì²´ì ì¸ ì˜ˆì‹œ)",
                            "isToday": true
                        }
                    ]`;
                    
                    // ê°œì„ ëœ í€´ì¦ˆ í”„ë¡¬í”„íŠ¸
                    const quizPrompt = `ë‹¤ìŒ ê¸ˆìœµ ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ˆê¸‰ í€´ì¦ˆ 5ë¬¸ì œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”:
                    ${newsData.map(n => n.title + '\n' + n.description).join('\n\n')}
                    
                    ë¬¸ì œ êµ¬ì„±:
                    1. ë‰´ìŠ¤ ê´€ë ¨ ë¬¸ì œ 2ê°œ (ìœ„ ë‰´ìŠ¤ ë‚´ìš© ì§ì ‘ í™œìš©)
                    2. ìµœê·¼ ê²½ì œ íŠ¸ë Œë“œ ê¸ˆìœµ ìƒì‹ ë¬¸ì œ 2ê°œ (ìœ„ ë‰´ìŠ¤ì—ì„œ íŒŒì•…ë˜ëŠ” íŠ¸ë Œë“œ ê¸°ë°˜)
                    3. ì¬ë¯¸ìˆëŠ” ê¸ˆìœµ ë¬¸ì œ 1ê°œ (ì¼ìƒìƒí™œê³¼ ì—°ê´€ëœ ì‰¬ìš´ ë¬¸ì œ)
                    
                    ë‚œì´ë„: ê¸ˆìœµ ì´ˆë³´ìë„ ìƒì‹ìœ¼ë¡œ í’€ ìˆ˜ ìˆëŠ” ë§¤ìš° ì‰¬ìš´ ìˆ˜ì¤€
                    
                    ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:
                    {
                        "beginner": [
                            {
                                "question": "ë‰´ìŠ¤ ê´€ë ¨ ë¬¸ì œ 1",
                                "options": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3", "ì„ íƒì§€4"],
                                "correct": ì •ë‹µì¸ë±ìŠ¤(0-3),
                                "explanation": "ì™œ ì´ê²ƒì´ ì •ë‹µì¸ì§€ ì‰½ê²Œ ì„¤ëª…"
                            },
                            // ... 5ê°œ ë¬¸ì œ
                        ]
                    }`;
                    
                    let terms = [];
                    let quizzes = { beginner: [], intermediate: [], advanced: [] };
                    
                    // GEMINI APIë¡œ ìš©ì–´ ìƒì„±
                    const termsResponse = await callGeminiAPI(termsPrompt);
                    if (termsResponse) {
                        try {
                            const jsonMatch = termsResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                terms = JSON.parse(jsonMatch[0]);
                            }
                        } catch (e) {
                            console.error('Terms íŒŒì‹± ì‹¤íŒ¨:', e);
                        }
                    }
                    
                    // ìš©ì–´ê°€ 3ê°œ ë¯¸ë§Œì´ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
                    if (terms.length < 3) {
                        const defaultTerms = [
                            {
                                id: "term-0",
                                term: "ë³µë¦¬ (Compound Interest)",
                                definition: "ì›ê¸ˆì— ë¶™ì€ ì´ìê°€ ë‹¤ì‹œ ì›ê¸ˆì´ ë˜ì–´ ì´ìê°€ ë¶™ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ìì‚°ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.",
                                example: "100ë§Œì›ì„ ì—° 10% ë³µë¦¬ë¡œ íˆ¬ìí•˜ë©´ 1ë…„ í›„ 110ë§Œì›, 2ë…„ í›„ 121ë§Œì›, 10ë…„ í›„ì—ëŠ” ì•½ 259ë§Œì›ì´ ë©ë‹ˆë‹¤.",
                                isToday: true
                            },
                            {
                                id: "term-1",
                                term: "ë¶„ì‚°íˆ¬ì (Diversification)",
                                definition: "ì—¬ëŸ¬ ì¢…ëª©ì´ë‚˜ ìì‚°ì— ë‚˜ëˆ„ì–´ íˆ¬ìí•˜ì—¬ ìœ„í—˜ì„ ì¤„ì´ëŠ” ì „ëµì…ë‹ˆë‹¤. 'ê³„ë€ì„ í•œ ë°”êµ¬ë‹ˆì— ë‹´ì§€ ë§ˆë¼'ëŠ” ê²©ì–¸ì´ ì´ë¥¼ ì˜ ì„¤ëª…í•©ë‹ˆë‹¤.",
                                example: "ì£¼ì‹ 50%, ì±„ê¶Œ 30%, í˜„ê¸ˆ 20%ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ êµ¬ì„±í•˜ë©´ í•œ ìì‚°ì˜ ì†ì‹¤ì„ ë‹¤ë¥¸ ìì‚°ì´ ë³´ì™„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                                isToday: true
                            },
                            {
                                id: "term-2",
                                term: "PER (Price Earnings Ratio)",
                                definition: "ì£¼ê°€ìˆ˜ìµë¹„ìœ¨ë¡œ, ì£¼ê°€ë¥¼ ì£¼ë‹¹ìˆœì´ìµìœ¼ë¡œ ë‚˜ëˆˆ ê°’ì…ë‹ˆë‹¤. ê¸°ì—…ì˜ ìˆ˜ìµ ëŒ€ë¹„ ì£¼ê°€ê°€ ì ì •í•œì§€ íŒë‹¨í•˜ëŠ” ì§€í‘œì…ë‹ˆë‹¤.",
                                example: "PERì´ 10ì´ë©´ í˜„ì¬ ìˆ˜ìµ ìˆ˜ì¤€ì´ ìœ ì§€ë  ë•Œ íˆ¬ìê¸ˆì„ íšŒìˆ˜í•˜ëŠ”ë° 10ë…„ì´ ê±¸ë¦°ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.",
                                isToday: true
                            }
                        ];
                        
                        while (terms.length < 3) {
                            terms.push(defaultTerms[terms.length]);
                        }
                    }
                    
                    // GEMINI APIë¡œ ì´ˆê¸‰ í€´ì¦ˆ ìƒì„±
                    const quizResponse = await callGeminiAPI(quizPrompt);
                    if (quizResponse) {
                        try {
                            const jsonMatch = quizResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const parsed = JSON.parse(jsonMatch[0]);
                                if (parsed.beginner && Array.isArray(parsed.beginner)) {
                                    quizzes.beginner = parsed.beginner;
                                }
                            }
                        } catch (e) {
                            console.error('Quiz íŒŒì‹± ì‹¤íŒ¨:', e);
                        }
                    }
                    
                    // ì´ˆê¸‰ í€´ì¦ˆê°€ ë¶€ì¡±í•˜ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
                    if (quizzes.beginner.length < 5) {
                        const defaultQuizzes = [
                            {
                                question: "í•œêµ­ì€í–‰ì´ ê¸°ì¤€ê¸ˆë¦¬ë¥¼ ì˜¬ë¦¬ë©´ ì¼ë°˜ì ìœ¼ë¡œ ì–´ë–¤ ì¼ì´ ë°œìƒí•˜ë‚˜ìš”?",
                                options: ["ì˜ˆê¸ˆ ì´ìê°€ ì˜¤ë¥¸ë‹¤", "ì˜ˆê¸ˆ ì´ìê°€ ë‚´ë¦°ë‹¤", "í™˜ìœ¨ì´ ê³ ì •ëœë‹¤", "ì£¼ì‹ì´ ë¬´ì¡°ê±´ ì˜¤ë¥¸ë‹¤"],
                                correct: 0,
                                explanation: "ê¸°ì¤€ê¸ˆë¦¬ê°€ ì˜¤ë¥´ë©´ ì‹œì¤‘ ì€í–‰ì˜ ì˜ˆê¸ˆê³¼ ëŒ€ì¶œ ê¸ˆë¦¬ë„ í•¨ê»˜ ì˜¤ë¥´ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤."
                            },
                            {
                                question: "ì£¼ì‹ì‹œì¥ì—ì„œ 'ì½”ìŠ¤í”¼'ëŠ” ë¬´ì—‡ì„ ì˜ë¯¸í•˜ë‚˜ìš”?",
                                options: ["ì™¸êµ­ ì£¼ì‹", "í•œêµ­ ì£¼ì‹ì‹œì¥ ì§€ìˆ˜", "ì±„ê¶Œ ì§€ìˆ˜", "í™˜ìœ¨"],
                                correct: 1,
                                explanation: "ì½”ìŠ¤í”¼(KOSPI)ëŠ” í•œêµ­ ì¢…í•©ì£¼ê°€ì§€ìˆ˜ë¡œ, ìš°ë¦¬ë‚˜ë¼ ì£¼ì‹ì‹œì¥ì˜ ì „ë°˜ì ì¸ ìƒí™©ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤."
                            },
                            {
                                question: "ë¬¼ê°€ê°€ ê³„ì† ì˜¤ë¥´ëŠ” í˜„ìƒì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?",
                                options: ["ë””í”Œë ˆì´ì…˜", "ì¸í”Œë ˆì´ì…˜", "ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜", "ë¦¬ì„¸ì…˜"],
                                correct: 1,
                                explanation: "ì¸í”Œë ˆì´ì…˜ì€ ë¬¼ê°€ê°€ ì§€ì†ì ìœ¼ë¡œ ìƒìŠ¹í•˜ëŠ” í˜„ìƒìœ¼ë¡œ, í™”í ê°€ì¹˜ê°€ í•˜ë½í•©ë‹ˆë‹¤."
                            },
                            {
                                question: "ì²­ë…„ë“¤ì´ ì£¼ì‹ íˆ¬ìë¥¼ ì‹œì‘í•˜ëŠ” ê°€ì¥ ì¢‹ì€ ë°©ë²•ì€?",
                                options: ["ì „ ì¬ì‚° íˆ¬ì", "ì†Œì•¡ìœ¼ë¡œ ë¶„ì‚° íˆ¬ì", "ë¹šë‚´ì„œ íˆ¬ì", "ì¹œêµ¬ ë”°ë¼ íˆ¬ì"],
                                correct: 1,
                                explanation: "íˆ¬ìëŠ” ì—¬ìœ  ìê¸ˆìœ¼ë¡œ ì†Œì•¡ë¶€í„° ì‹œì‘í•˜ê³ , ì—¬ëŸ¬ ì¢…ëª©ì— ë¶„ì‚°í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤."
                            },
                            {
                                question: "í¸ì˜ì ì—ì„œ ë¬¼ê±´ê°’ì´ ì‘ë…„ë³´ë‹¤ ì˜¬ëë‹¤ë©´, ì´ê²ƒì€ ë¬´ì—‡ ë•Œë¬¸ì¼ê¹Œìš”?",
                                options: ["ë¬¼ê°€ ìƒìŠ¹", "í™˜ìœ¨ í•˜ë½", "ì£¼ê°€ ìƒìŠ¹", "ê¸ˆë¦¬ í•˜ë½"],
                                correct: 0,
                                explanation: "ì¼ìƒìƒí™œì—ì„œ ë¬¼ê±´ê°’ì´ ì˜¤ë¥´ëŠ” ê²ƒì€ ë¬¼ê°€ ìƒìŠ¹(ì¸í”Œë ˆì´ì…˜)ì˜ ì˜í–¥ì…ë‹ˆë‹¤."
                            }
                        ];
                        
                        while (quizzes.beginner.length < 5) {
                            quizzes.beginner.push(defaultQuizzes[quizzes.beginner.length]);
                        }
                    }
                    
                    // ì¤‘ê¸‰, ê³ ê¸‰ í€´ì¦ˆ ìƒì„±
                    quizzes.intermediate = generateIntermediateQuiz();
                    quizzes.advanced = generateAdvancedQuiz();
                    
                    const todayData = {
                        date: today,
                        news: newsData,
                        terms: terms.slice(0, 3),
                        quizzes: quizzes
                    };
                    
                    // Firebaseì— ì €ì¥
                    console.log('ğŸ’¾ Firebaseì— ë°ì´í„° ì €ì¥ ì¤‘...');
                    await window.firebaseSet(firebaseRef, todayData);
                    console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ');
                    
                    // localStorageì—ë„ ì €ì¥
                    localStorage.setItem('todayFinancialData', JSON.stringify(todayData));
                    localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(todayData));
                    console.log('âœ… localStorage ì €ì¥ ì™„ë£Œ');
                    
                    if (loadingDiv.parentNode) {
                        document.body.removeChild(loadingDiv);
                    }
                }
                
            } catch (error) {
                console.error('âŒ ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨:', error);
                
                // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ë°ì´í„° ìƒì„±
                const fallbackData = {
                    date: today,
                    news: getFallbackNews(),
                    terms: [
                        {
                            id: "term-0",
                            term: "ë³µë¦¬ (Compound Interest)",
                            definition: "ì›ê¸ˆì— ë¶™ì€ ì´ìê°€ ë‹¤ì‹œ ì›ê¸ˆì´ ë˜ì–´ ì´ìê°€ ë¶™ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.",
                            example: "100ë§Œì›ì„ ì—° 10% ë³µë¦¬ë¡œ íˆ¬ìí•˜ë©´ 10ë…„ í›„ ì•½ 259ë§Œì›ì´ ë©ë‹ˆë‹¤.",
                            isToday: true
                        },
                        {
                            id: "term-1",
                            term: "ë¶„ì‚°íˆ¬ì (Diversification)",
                            definition: "ì—¬ëŸ¬ ìì‚°ì— ë‚˜ëˆ„ì–´ íˆ¬ìí•˜ì—¬ ìœ„í—˜ì„ ì¤„ì´ëŠ” ì „ëµì…ë‹ˆë‹¤.",
                            example: "ì£¼ì‹, ì±„ê¶Œ, ë¶€ë™ì‚° ë“± ë‹¤ì–‘í•œ ìì‚°ì— ë¶„ì‚° íˆ¬ìí•©ë‹ˆë‹¤.",
                            isToday: true
                        },
                        {
                            id: "term-2",
                            term: "ì¸í”Œë ˆì´ì…˜ (Inflation)",
                            definition: "ë¬¼ê°€ê°€ ì§€ì†ì ìœ¼ë¡œ ìƒìŠ¹í•˜ëŠ” í˜„ìƒì…ë‹ˆë‹¤.",
                            example: "ì‘ë…„ì— 1000ì›ì´ë˜ ë¹µì´ ì˜¬í•´ 1100ì›ì´ ë˜ëŠ” í˜„ìƒì…ë‹ˆë‹¤.",
                            isToday: true
                        }
                    ],
                    quizzes: {
                        beginner: [
                            {
                                question: "ì˜ˆê¸ˆ ì´ìë¥¼ ê²°ì •í•˜ëŠ” ê¸°ì¤€ì´ ë˜ëŠ” ê¸ˆë¦¬ëŠ”?",
                                options: ["ì‹œì¥ê¸ˆë¦¬", "ê¸°ì¤€ê¸ˆë¦¬", "ëŒ€ì¶œê¸ˆë¦¬", "í™˜ìœ¨"],
                                correct: 1,
                                explanation: "í•œêµ­ì€í–‰ì´ ì •í•˜ëŠ” ê¸°ì¤€ê¸ˆë¦¬ê°€ ì‹œì¤‘ ê¸ˆë¦¬ì˜ ê¸°ì¤€ì´ ë©ë‹ˆë‹¤."
                            },
                            {
                                question: "ì£¼ì‹ì„ ì²˜ìŒ ì‹œì‘í•  ë•Œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€?",
                                options: ["í° ìˆ˜ìµ", "ë¹ ë¥¸ ë§¤ë§¤", "ë¦¬ìŠ¤í¬ ê´€ë¦¬", "ì°¨íŠ¸ ë¶„ì„"],
                                correct: 2,
                                explanation: "íˆ¬ìì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ì†ì‹¤ì„ ìµœì†Œí™”í•˜ëŠ” ë¦¬ìŠ¤í¬ ê´€ë¦¬ì…ë‹ˆë‹¤."
                            },
                            {
                                question: "1ë…„ì— ë¬¼ê°€ê°€ 3% ì˜¬ëë‹¤ë©´?",
                                options: ["ëˆì˜ ê°€ì¹˜ê°€ ì˜¬ëë‹¤", "ëˆì˜ ê°€ì¹˜ê°€ ë–¨ì–´ì¡Œë‹¤", "ë³€í™” ì—†ë‹¤", "í™˜ìœ¨ì´ ì˜¬ëë‹¤"],
                                correct: 1,
                                explanation: "ë¬¼ê°€ê°€ ì˜¤ë¥´ë©´ ê°™ì€ ëˆìœ¼ë¡œ ì‚´ ìˆ˜ ìˆëŠ” ë¬¼ê±´ì´ ì¤„ì–´ë“¤ì–´ ëˆì˜ ê°€ì¹˜ê°€ ë–¨ì–´ì§‘ë‹ˆë‹¤."
                            },
                            {
                                question: "ì ê¸ˆê³¼ ì˜ˆê¸ˆì˜ ì°¨ì´ëŠ”?",
                                options: ["ì´ììœ¨", "ì •ê¸° ë‚©ì… ì—¬ë¶€", "ìœ„í—˜ë„", "ì„¸ê¸ˆ"],
                                correct: 1,
                                explanation: "ì ê¸ˆì€ ë§¤ë‹¬ ì •ê¸°ì ìœ¼ë¡œ ë‚©ì…í•˜ê³ , ì˜ˆê¸ˆì€ í•œ ë²ˆì— ì˜ˆì¹˜í•©ë‹ˆë‹¤."
                            },
                            {
                                question: "ìš©ëˆì„ ëª¨ìœ¼ëŠ” ê°€ì¥ ì¢‹ì€ ë°©ë²•ì€?",
                                options: ["ì „ë¶€ ì†Œë¹„", "ì¼ë¶€ëŠ” ì €ì¶•", "íˆ¬ìë§Œ", "ë¹šë‚´ì„œ íˆ¬ì"],
                                correct: 1,
                                explanation: "ìˆ˜ì…ì˜ ì¼ë¶€ë¥¼ ê¾¸ì¤€íˆ ì €ì¶•í•˜ëŠ” ê²ƒì´ ìì‚°ì„ ë§Œë“œëŠ” ì²«ê±¸ìŒì…ë‹ˆë‹¤."
                            }
                        ],
                        intermediate: generateIntermediateQuiz(),
                        advanced: generateAdvancedQuiz()
                    }
                };
                
                // Firebaseì— ê¸°ë³¸ ë°ì´í„° ì €ì¥
                try {
                    const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                    await window.firebaseSet(firebaseRef, fallbackData);
                } catch (e) {
                    console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', e);
                }
                
                localStorage.setItem('todayFinancialData', JSON.stringify(fallbackData));
                localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(fallbackData));
                
                const loadingDiv = document.querySelector('.loading-spinner');
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.parentNode.removeChild(loadingDiv);
                }
            }
        }

        function goToTermsPage() {
            window.location.href = 'a2-terms.html';
        }

        function goToNewsPage() {
            window.location.href = 'a2-news.html';
        }

        function goToQuizPage() {
            window.location.href = 'a2-quiz.html';
        }

        function goToPage(page) {
            if (page === 'a2.html') return;
            window.location.href = page;
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('fineu_current_user');
                localStorage.removeItem('fineu_user_assets');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('ğŸ“š ìƒˆë¡œìš´ í•™ìŠµ ì½˜í…ì¸ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâ€¢ ì˜¤ëŠ˜ì˜ ê¸ˆìœµ ìš©ì–´ (3ê°œ)\nâ€¢ ìµœì‹  ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„\nâ€¢ ê¸ˆìœµ í€´ì¦ˆ ì±Œë¦°ì§€\n\nì§€ê¸ˆ ë°”ë¡œ í•™ìŠµí•˜ê³  ë³´ìƒì„ ë°›ì•„ë³´ì„¸ìš”!');
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            return true;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!checkLoginStatus()) return;
            
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            const cards = document.querySelectorAll('.fade-in');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>
