<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - 학습</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .study-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .study-card:active {
            transform: translateY(0);
        }

        .study-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .study-card.disabled:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .study-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .star-icon {
            color: #ffd700;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .star-icon.completed {
            color: #4CAF50;
            animation: sparkle 0.6s ease-in-out;
        }

        .study-card.completed {
            background: linear-gradient(135deg, #f0f8f0, #e8f5e8);
            border: 2px solid #4CAF50;
        }

        .divider {
            height: 2px;
            background: #333;
            margin: 30px 0;
            border-radius: 1px;
        }

        .scrap-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scrap-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .scrap-content {
            text-align: center;
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }

        /* 하단 네비게이션 - a1과 동일 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/배경.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* 중앙 반원 돌출 부분 - a1과 동일 */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/배경.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: #fafaf8;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7cb9e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/레이어 1.png" alt="FINE U 로고" class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <div class="main-content">
        <div class="page-title">STUDY ZONE</div>

        <div class="study-card fade-in" id="card-financial-terms" style="animation-delay: 0.1s">
            <div class="study-title">금융 용어</div>
            <i class="fas fa-star star-icon" id="star-financial-terms"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-news" style="animation-delay: 0.2s">
            <div class="study-title">금융 뉴스</div>
            <i class="fas fa-star star-icon" id="star-financial-news"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-quiz" style="animation-delay: 0.3s">
            <div class="study-title">금융 퀴즈</div>
            <i class="fas fa-star star-icon" id="star-financial-quiz"></i>
        </div>

        <div class="divider"></div>

        <div class="scrap-section fade-in" style="animation-delay: 0.4s" onclick="goToScrapPage()">
            <div class="scrap-content">
                스크랩
            </div>
        </div>
    </div>

    <!-- 하단 네비게이션 - a1과 동일한 구조 -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/집.png" alt="홈">
            </div>
        </div>
        <div class="nav-item active" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/문서.png" alt="문서">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ㅇ.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/채팅.png" alt="채팅">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/더보기.png" alt="더보기">
            </div>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = 'AIzaSyBJhMtNOYyCfl6NRCQQz_CkTUHWP2TNweI';
        
        let currentUser = null;
        let userAssets = {};
        let isTodayDataReady = false;
        let contentHistory = {
            news: [],
            terms: [],
            quizzes: []
        };
        
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, navImage: 'YELLOW ㅇ.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, navImage: 'GREEN ㅇ.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, navImage: 'BLUE ㅇ.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, navImage: 'RED ㅇ.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, navImage: 'BLACK ㅇ.png' }
        };

        // 다양한 금융 용어 풀
        const financialTermsPool = [
            { term: "ETF (Exchange Traded Fund)", definition: "거래소에서 주식처럼 거래되는 펀드입니다.", example: "KODEX 200 ETF를 사면 코스피 200 기업에 분산투자하는 효과가 있습니다." },
            { term: "배당수익률 (Dividend Yield)", definition: "주가 대비 배당금의 비율입니다.", example: "주가 10만원, 연 배당 3천원이면 배당수익률은 3%입니다." },
            { term: "매매차익 (Capital Gain)", definition: "자산을 매입한 가격보다 높은 가격에 매도하여 얻는 이익입니다.", example: "100만원에 산 주식을 150만원에 팔면 50만원의 매매차익이 발생합니다." },
            { term: "손절매 (Stop Loss)", definition: "손실을 제한하기 위해 일정 손실에서 매도하는 전략입니다.", example: "10% 하락 시 자동 매도 설정으로 추가 손실을 방지합니다." },
            { term: "리밸런싱 (Rebalancing)", definition: "포트폴리오의 자산 비중을 원래 목표대로 재조정하는 것입니다.", example: "주식 70%, 채권 30% 비율을 유지하기 위해 정기적으로 조정합니다." },
            { term: "펀더멘털 (Fundamental)", definition: "기업의 재무상태, 실적 등 기본적 가치를 나타내는 지표입니다.", example: "매출, 영업이익, 부채비율 등을 분석하여 기업가치를 평가합니다." },
            { term: "테크니컬 분석 (Technical Analysis)", definition: "차트와 거래량 등을 분석하여 주가를 예측하는 방법입니다.", example: "이동평균선, RSI 등의 지표를 활용하여 매매 시점을 결정합니다." },
            { term: "공매도 (Short Selling)", definition: "주식을 빌려서 팔고 나중에 싸게 사서 갚는 투자 전략입니다.", example: "주가 하락을 예상하고 10만원에 빌려 판 주식을 8만원에 사서 갚아 2만원 수익을 얻습니다." },
            { term: "IPO (Initial Public Offering)", definition: "기업이 처음으로 주식시장에 상장하는 것입니다.", example: "카카오뱅크가 2021년 코스피에 IPO하여 일반 투자자도 주식을 살 수 있게 되었습니다." },
            { term: "블루칩 (Blue Chip)", definition: "재무구조가 건전하고 수익성이 높은 우량 대기업 주식입니다.", example: "삼성전자, SK하이닉스 같은 대표 우량주를 블루칩이라고 합니다." }
        ];

        // 다양한 퀴즈 문제 풀
        const beginnerQuizPool = [
            { question: "ISA 계좌의 가장 큰 장점은?", options: ["높은 수익률", "세금 혜택", "무제한 입금", "해외투자 전용"], correct: 1, explanation: "ISA는 개인종합자산관리계좌로, 일정 한도 내에서 세금 혜택을 받을 수 있습니다." },
            { question: "코스닥은 주로 어떤 기업들이 상장되어 있나요?", options: ["대기업", "중소·벤처기업", "외국기업", "공기업"], correct: 1, explanation: "코스닥은 주로 성장 가능성이 높은 중소·벤처기업들이 상장되어 있습니다." },
            { question: "펀드 투자의 장점은?", options: ["보장된 수익", "전문가 운용", "세금 면제", "원금 보장"], correct: 1, explanation: "펀드는 전문 펀드매니저가 운용하여 개인이 직접 투자하기 어려운 분산투자가 가능합니다." },
            { question: "신용카드 리볼빙의 위험성은?", options: ["낮은 한도", "높은 이자", "사용 불편", "포인트 없음"], correct: 1, explanation: "리볼빙은 매우 높은 이자율(연 15-20%)이 적용되어 빚이 늘어날 수 있습니다." },
            { question: "예금자보호제도의 보호 한도는?", options: ["1천만원", "3천만원", "5천만원", "1억원"], correct: 2, explanation: "예금자보호제도는 금융기관별로 원금과 이자를 합쳐 1인당 5천만원까지 보호합니다." },
            { question: "주식 배당금은 언제 받나요?", options: ["매일", "매주", "매월", "연 1-4회"], correct: 3, explanation: "대부분의 기업은 연 1-2회, 일부는 분기별로 배당금을 지급합니다." },
            { question: "적립식 펀드의 장점은?", options: ["일시 투자", "평균 매입 단가", "높은 수익 보장", "세금 면제"], correct: 1, explanation: "적립식은 정기적으로 투자하여 평균 매입 단가를 낮추는 효과가 있습니다." },
            { question: "환율이 오르면 유리한 사람은?", options: ["수입업자", "해외여행객", "수출업자", "유학생"], correct: 2, explanation: "환율이 오르면 달러를 받는 수출업자가 더 많은 원화를 받게 되어 유리합니다." },
            { question: "주가지수란 무엇인가요?", options: ["개별 주가", "시장 전체 동향", "거래량", "환율"], correct: 1, explanation: "주가지수는 주식시장 전체의 가격 변동을 나타내는 지표입니다." },
            { question: "은행 예금과 적금의 차이는?", options: ["은행이 다름", "입금 방식", "이자율 동일", "위험도"], correct: 1, explanation: "예금은 목돈을 한번에, 적금은 매달 일정액을 납입합니다." }
        ];

        const intermediateQuizPool = [
            { question: "PER이 낮은 주식의 일반적인 특징은?", options: ["고평가 상태", "저평가 가능성", "배당금이 높음", "성장성이 높음"], correct: 1, explanation: "PER이 낮다는 것은 주가가 수익 대비 저평가되어 있을 가능성을 의미합니다." },
            { question: "ROE가 높은 기업의 특징은?", options: ["부채가 많음", "자기자본 수익률이 높음", "매출이 적음", "성장성이 낮음"], correct: 1, explanation: "ROE는 자기자본 대비 순이익 비율로, 높을수록 효율적으로 수익을 창출합니다." },
            { question: "인플레이션 헤지에 유리한 자산은?", options: ["현금", "부동산", "장기채권", "정기예금"], correct: 1, explanation: "부동산은 물가상승과 함께 가치가 오르는 경향이 있어 인플레이션 헤지에 유리합니다." },
            { question: "EPS가 증가한다는 의미는?", options: ["주가 하락", "주당 순이익 증가", "배당 감소", "부채 증가"], correct: 1, explanation: "EPS(주당순이익)가 증가하면 기업의 수익성이 개선되고 있음을 의미합니다." },
            { question: "달러 코스트 애버리징의 효과는?", options: ["수익률 보장", "평균 매입가 하락", "세금 절감", "배당 증가"], correct: 1, explanation: "정기적으로 일정 금액을 투자하여 평균 매입 단가를 낮추는 효과가 있습니다." },
            { question: "신용등급이 하락하면?", options: ["대출금리 하락", "대출금리 상승", "대출한도 증가", "상관없음"], correct: 1, explanation: "신용등급이 낮아지면 위험도가 높아져 더 높은 금리를 적용받게 됩니다." },
            { question: "유동성이 높은 자산의 특징은?", options: ["거래 어려움", "현금화 용이", "수익률 높음", "위험도 높음"], correct: 1, explanation: "유동성이 높으면 필요시 빠르게 현금으로 전환할 수 있습니다." },
            { question: "복리 효과가 극대화되는 조건은?", options: ["단기 투자", "장기 투자", "고위험 투자", "분산 투자"], correct: 1, explanation: "복리는 시간이 지날수록 기하급수적으로 증가하므로 장기투자에 유리합니다." },
            { question: "베타(Beta) 값이 1보다 크면?", options: ["시장보다 안정적", "시장보다 변동성 큼", "무위험 자산", "채권형 자산"], correct: 1, explanation: "베타가 1보다 크면 시장 평균보다 가격 변동성이 큰 것을 의미합니다." },
            { question: "매크로 헤지펀드의 주요 전략은?", options: ["개별 종목 투자", "경제 전반 예측", "부동산 투자", "원자재 투자"], correct: 1, explanation: "매크로 헤지펀드는 거시경제 동향을 예측하여 다양한 자산에 투자합니다." }
        ];

        const advancedQuizPool = [
            { question: "샤프 비율(Sharpe Ratio)이 측정하는 것은?", options: ["절대 수익률", "위험 조정 수익률", "변동성", "최대 손실"], correct: 1, explanation: "샤프 비율은 위험 단위당 초과 수익률을 측정하는 지표입니다." },
            { question: "컨탱고(Contango) 시장의 특징은?", options: ["현물가격 > 선물가격", "선물가격 > 현물가격", "가격 동일", "변동성 없음"], correct: 1, explanation: "컨탱고는 선물가격이 현물가격보다 높은 정상적인 시장 상황입니다." },
            { question: "델타 헤징의 목적은?", options: ["수익 극대화", "방향성 위험 제거", "레버리지 증가", "배당 수취"], correct: 1, explanation: "델타 헤징은 기초자산 가격 변동에 대한 옵션 포지션의 민감도를 중립화합니다." },
            { question: "VaR(Value at Risk)가 나타내는 것은?", options: ["최대 수익", "최대 손실 가능액", "평균 수익률", "변동성"], correct: 1, explanation: "VaR는 특정 신뢰수준에서 일정 기간 동안 발생 가능한 최대 손실액을 나타냅니다." },
            { question: "백워데이션(Backwardation) 발생 원인은?", options: ["공급 과잉", "현물 수요 급증", "금리 상승", "환율 하락"], correct: 1, explanation: "현물 수요가 급증하여 현물가격이 선물가격보다 높아지는 현상입니다." },
            { question: "소버린 리스크(Sovereign Risk)란?", options: ["기업 부도 위험", "국가 채무불이행 위험", "환율 변동 위험", "금리 변동 위험"], correct: 1, explanation: "국가가 채무를 이행하지 못할 위험을 의미합니다." },
            { question: "콜 스프레드 전략의 목적은?", options: ["무제한 수익", "제한적 수익과 손실", "헤지 전용", "배당 수취"], correct: 1, explanation: "콜 스프레드는 수익과 손실을 제한하면서 프리미엄 비용을 줄이는 전략입니다." },
            { question: "트레이딩 볼륨이 급증하면?", options: ["관심 감소", "가격 변동 임박", "시장 안정", "거래 중단"], correct: 1, explanation: "거래량 급증은 큰 가격 변동이 일어날 가능성이 높음을 시사합니다." },
            { question: "알파 수익의 원천은?", options: ["시장 수익률", "초과 수익 능력", "무위험 수익률", "환차익"], correct: 1, explanation: "알파는 펀드매니저의 종목선택 능력으로 얻는 시장 초과 수익입니다." },
            { question: "듀레이션 매칭의 목적은?", options: ["수익 극대화", "금리위험 헤지", "신용위험 제거", "환위험 헤지"], correct: 1, explanation: "자산과 부채의 듀레이션을 일치시켜 금리변동 위험을 최소화합니다." }
        ];

        function calculateLevelFromExp(exp) {
            if (exp >= 50000) return 'black';
            if (exp >= 30000) return 'red';
            if (exp >= 15000) return 'blue';
            if (exp >= 5000) return 'green';
            return 'yellow';
        }
        
        function getTodayDate() {
            const now = new Date();
            const koreaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
            const year = koreaTime.getFullYear();
            const month = String(koreaTime.getMonth() + 1).padStart(2, '0');
            const day = String(koreaTime.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 콘텐츠 히스토리 로드
        async function loadContentHistory() {
            try {
                if (!window.firebaseDB) return;
                
                const historyRef = window.firebaseRef(window.firebaseDB, 'contentHistory');
                const snapshot = await window.firebaseGet(historyRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    contentHistory = {
                        news: data.news || [],
                        terms: data.terms || [],
                        quizzes: data.quizzes || []
                    };
                    console.log('📚 콘텐츠 히스토리 로드:', {
                        뉴스: contentHistory.news.length,
                        용어: contentHistory.terms.length,
                        퀴즈: contentHistory.quizzes.length
                    });
                }
            } catch (error) {
                console.error('히스토리 로드 실패:', error);
            }
        }

        // 콘텐츠 히스토리 저장
        async function saveContentHistory(type, items) {
            try {
                if (!window.firebaseDB) return;
                
                // 기존 히스토리에 추가
                if (type === 'news') {
                    items.forEach(item => {
                        if (!contentHistory.news.some(n => n.title === item.title)) {
                            contentHistory.news.push({
                                title: item.title,
                                date: getTodayDate()
                            });
                        }
                    });
                } else if (type === 'terms') {
                    items.forEach(item => {
                        if (!contentHistory.terms.some(t => t.term === item.term)) {
                            contentHistory.terms.push({
                                term: item.term,
                                date: getTodayDate()
                            });
                        }
                    });
                } else if (type === 'quizzes') {
                    items.forEach(item => {
                        if (!contentHistory.quizzes.some(q => q.question === item.question)) {
                            contentHistory.quizzes.push({
                                question: item.question,
                                date: getTodayDate()
                            });
                        }
                    });
                }
                
                // 최근 항목만 유지 (메모리 관리)
                contentHistory.news = contentHistory.news.slice(-200);
                contentHistory.terms = contentHistory.terms.slice(-150);
                contentHistory.quizzes = contentHistory.quizzes.slice(-500);
                
                const historyRef = window.firebaseRef(window.firebaseDB, 'contentHistory');
                await window.firebaseSet(historyRef, contentHistory);
                
                console.log('✅ 콘텐츠 히스토리 업데이트');
            } catch (error) {
                console.error('히스토리 저장 실패:', error);
            }
        }

        // 중복 체크 함수
        function isContentDuplicate(type, item) {
            if (type === 'news') {
                return contentHistory.news.some(n => n.title === item.title);
            } else if (type === 'terms') {
                return contentHistory.terms.some(t => t.term === item.term);
            } else if (type === 'quiz') {
                return contentHistory.quizzes.some(q => q.question === item.question);
            }
            return false;
        }

        // 중복되지 않은 용어 선택
        function selectUniqueTerms(count = 3) {
            const availableTerms = financialTermsPool.filter(term => 
                !contentHistory.terms.some(t => t.term === term.term)
            );
            
            const selected = [];
            const shuffled = [...availableTerms].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < Math.min(count, shuffled.length); i++) {
                selected.push({
                    id: `term-${i}`,
                    ...shuffled[i],
                    isToday: true
                });
            }
            
            return selected;
        }

        // 중복되지 않은 퀴즈 선택
        function selectUniqueQuizzes(pool, count = 5) {
            const availableQuizzes = pool.filter(quiz => 
                !contentHistory.quizzes.some(q => q.question === quiz.question)
            );
            
            const shuffled = [...availableQuizzes].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }

        async function cleanOldData() {
            const today = new Date();
            const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('todayFinancialData_')) {
                    const dateStr = key.replace('todayFinancialData_', '');
                    const keyDate = new Date(dateStr);
                    if (keyDate < twoWeeksAgo) {
                        localStorage.removeItem(key);
                        console.log(`삭제된 오래된 로컬 데이터: ${key}`);
                    }
                }
            });

            if (window.firebaseDB && window.firebaseRemove) {
                try {
                    const cacheRef = window.firebaseRef(window.firebaseDB, 'cache');
                    const snapshot = await window.firebaseGet(cacheRef);
                    
                    if (snapshot.exists()) {
                        const cacheData = snapshot.val();
                        for (const key in cacheData) {
                            if (cacheData[key].date) {
                                const keyDate = new Date(cacheData[key].date);
                                if (keyDate < twoWeeksAgo) {
                                    const oldRef = window.firebaseRef(window.firebaseDB, `cache/${key}`);
                                    await window.firebaseRemove(oldRef);
                                    console.log(`Firebase에서 삭제된 오래된 데이터: ${key}`);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Firebase 오래된 데이터 삭제 실패:', error);
                }
            }
        }

        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        function validateTodayData(data) {
            if (!data) return false;
            
            if (!data.date || !data.news || !data.terms || !data.quizzes) {
                console.log('❌ 필수 필드 누락');
                return false;
            }
            
            if (!Array.isArray(data.news) || data.news.length === 0) {
                console.log('❌ 뉴스 데이터 없음');
                return false;
            }
            
            if (!Array.isArray(data.terms) || data.terms.length < 3) {
                console.log('❌ 용어 데이터 부족 (3개 필요)');
                return false;
            }
            
            if (!data.quizzes.beginner || !Array.isArray(data.quizzes.beginner) || data.quizzes.beginner.length < 5) {
                console.log('❌ 초급 퀴즈 부족 (5개 필요)');
                return false;
            }
            
            if (!data.quizzes.intermediate || !Array.isArray(data.quizzes.intermediate) || data.quizzes.intermediate.length < 5) {
                console.log('❌ 중급 퀴즈 없음');
                return false;
            }
            
            if (!data.quizzes.advanced || !Array.isArray(data.quizzes.advanced) || data.quizzes.advanced.length < 5) {
                console.log('❌ 고급 퀴즈 없음');
                return false;
            }
            
            console.log('✅ 데이터 유효성 검증 통과');
            return true;
        }

        function updateStudyCardsStatus(status) {
            const cards = [
                { id: 'card-financial-terms', title: '금융 용어', func: 'goToTermsPage' },
                { id: 'card-financial-news', title: '금융 뉴스', func: 'goToNewsPage' },
                { id: 'card-financial-quiz', title: '금융 퀴즈', func: 'goToQuizPage' }
            ];
            
            cards.forEach(card => {
                const cardElement = document.getElementById(card.id);
                if (!cardElement) return;
                
                if (status === 'loading') {
                    cardElement.classList.add('disabled');
                    cardElement.style.opacity = '0.5';
                    cardElement.style.cursor = 'not-allowed';
                    cardElement.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('📊 데이터를 생성 중입니다.\n잠시만 기다려주세요...');
                        return false;
                    };
                    
                    const starIcon = document.getElementById(`star-${card.id.replace('card-', '')}`);
                    if (starIcon) {
                        starIcon.className = 'fas fa-spinner fa-spin';
                        starIcon.style.color = '#999';
                    }
                } else if (status === 'ready') {
                    cardElement.classList.remove('disabled');
                    cardElement.style.opacity = '1';
                    cardElement.style.cursor = 'pointer';
                    
                    if (card.func === 'goToTermsPage') {
                        cardElement.onclick = function() { goToTermsPage(); };
                    } else if (card.func === 'goToNewsPage') {
                        cardElement.onclick = function() { goToNewsPage(); };
                    } else if (card.func === 'goToQuizPage') {
                        cardElement.onclick = function() { goToQuizPage(); };
                    }
                    
                    const starIcon = document.getElementById(`star-${card.id.replace('card-', '')}`);
                    if (starIcon) {
                        starIcon.className = 'fas fa-star star-icon';
                        starIcon.style.color = '#ffd700';
                    }
                    
                    checkTodayCompletion();
                }
            });
        }

        function showLoadingOverlay() {
            const existingOverlay = document.getElementById('loadingOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            overlay.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 16px; text-align: center;">
                    <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                    <h3 style="margin-bottom: 10px; color: #333;">오늘의 학습 콘텐츠 생성 중</h3>
                    <p style="color: #666; font-size: 14px;">최신 금융 뉴스와 용어를 준비하고 있습니다...</p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">최대 30초 정도 소요될 수 있습니다</p>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        async function loadUserDataFromFirebase() {
            try {
                if (!window.firebaseDB) {
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }

                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);

                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {},
                        scrappedItems: firebaseData.scrappedItems || []
                    };

                    const exp = userAssets.exp || 0;
                    let determinedLevel = 'yellow';
                    if (exp >= 50000) {
                        determinedLevel = 'black';
                    } else if (exp >= 30000) {
                        determinedLevel = 'red';
                    } else if (exp >= 15000) {
                        determinedLevel = 'blue';
                    } else if (exp >= 5000) {
                        determinedLevel = 'green';
                    }
                    userAssets.level = determinedLevel;
                    updateGradeButton(determinedLevel);
                } else {
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 10000000,
                        totalAssets: 10000000,
                        virtualBalance: 10000000,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {},
                        scrappedItems: []
                    };
                    updateGradeButton('yellow');
                }
                
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                checkTodayCompletion();
                
                // 히스토리 로드 후 콘텐츠 생성
                await loadContentHistory();
                await cleanOldData();
                await generateTodayContent();

            } catch (error) {
                console.error('데이터 로드 오류:', error);
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 10000000,
                    level: 'yellow',
                    exp: 0,
                    experience: 0,
                    studyProgress: {},
                    scrappedItems: []
                };
                updateGradeButton('yellow');
            }
        }

        function checkTodayCompletion() {
            const today = getTodayDate();
            
            if (!userAssets.studyProgress) {
                userAssets.studyProgress = {};
            }
            
            const todayProgress = userAssets.studyProgress[today] || {};
            
            updateCardCompletion('financial-terms', todayProgress.financialTerms === true);
            updateCardCompletion('financial-news', todayProgress.financialNews === true);
            updateCardCompletion('financial-quiz', todayProgress.financialQuiz === true);
        }

        function updateCardCompletion(type, completed) {
            const card = document.getElementById(`card-${type}`);
            const star = document.getElementById(`star-${type}`);
            
            if (completed) {
                card.classList.add('completed');
                star.classList.add('completed');
            } else {
                card.classList.remove('completed');
                star.classList.remove('completed');
            }
        }

        function updateGradeButton(grade) {
            const upperGrade = (grade || 'yellow').toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                if (gradeButtonImage && levelData.navImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    console.log('✅ 그레이드 버튼 업데이트:', levelData.name);
                }
                const gradeButton = document.getElementById('gradeButton');
                if (gradeButton) {
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                }
            }
        }
        
        function updateLevelFromExp() {
            const exp = userAssets.exp || userAssets.experience || 0;
            let level = 'yellow';
            
            if (exp >= 50000) {
                level = 'black';
            } else if (exp >= 30000) {
                level = 'red';
            } else if (exp >= 15000) {
                level = 'blue';
            } else if (exp >= 5000) {
                level = 'green';
            }
            
            userAssets.level = level;
            updateGradeButton(level);
            return level;
        }

        async function getLatestFinanceNews() {
            try {
                const koreaTime = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                const dateStr = `${koreaTime.getFullYear()}년 ${koreaTime.getMonth() + 1}월 ${koreaTime.getDate()}일`;
                
                console.log(`🔍 ${dateStr} 실제 뉴스 가져오기 시작...`);
                
                const rssProxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];
                
                // 더 많은 RSS 소스 추가
                const rssUrls = [
                    'https://news.google.com/rss/search?q=금융+OR+경제+OR+주식+OR+코스피&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=한국은행+OR+금리+OR+환율&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=삼성전자+OR+SK하이닉스+OR+반도체&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=코스닥+OR+IPO+OR+상장&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=부동산+OR+아파트+OR+금융정책&hl=ko&gl=KR&ceid=KR:ko'
                ];
                
                let allNews = [];
                
                for (const rssUrl of rssUrls) {
                    for (const proxy of rssProxies) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent(rssUrl);
                            const response = await fetch(proxyUrl);
                            
                            if (response.ok) {
                                const data = await response.text();
                                const newsItems = parseRSSData(data);
                                
                                if (newsItems && newsItems.length > 0) {
                                    allNews.push(...newsItems);
                                    if (allNews.length > 50) break; // 충분한 뉴스 수집
                                }
                            }
                        } catch (error) {
                            console.warn(`RSS 프록시 실패:`, error);
                        }
                    }
                    if (allNews.length > 50) break;
                }
                
                // 중복 제거 및 필터링
                const uniqueNews = [];
                const seenTitles = new Set();
                
                for (const item of allNews) {
                    // 제목 중복 체크 및 히스토리 체크
                    if (!seenTitles.has(item.title) && !isContentDuplicate('news', item)) {
                        uniqueNews.push({
                            id: `news-${uniqueNews.length}`,
                            title: item.title.replace(/<[^>]*>/g, ''),
                            description: item.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...',
                            content: item.description.replace(/<[^>]*>/g, ''),
                            url: item.url,
                            source: item.source || 'Google News',
                            category: '금융뉴스',
                            publishedAt: item.publishedAt || koreaTime.toISOString()
                        });
                        seenTitles.add(item.title);
                        
                        if (uniqueNews.length >= 5) break;
                    }
                }
                
                // 뉴스가 부족하면 대체 뉴스 추가
                if (uniqueNews.length < 5) {
                    const fallbackNews = getFallbackNews();
                    for (const news of fallbackNews) {
                        if (!isContentDuplicate('news', news) && uniqueNews.length < 5) {
                            uniqueNews.push(news);
                        }
                    }
                }
                
                if (uniqueNews.length > 0) {
                    console.log(`✅ 새로운 뉴스 ${uniqueNews.length}건 가져오기 성공`);
                    await saveContentHistory('news', uniqueNews);
                    return uniqueNews;
                }
                
                console.log('⚠️ RSS 실패, 대체 뉴스 사용');
                return getFallbackNews();
                
            } catch (error) {
                console.error('뉴스 가져오기 실패:', error);
                return getFallbackNews();
            }
        }

        function parseRSSData(xmlText) {
            try {
                if (xmlText.includes('"contents"')) {
                    const jsonData = JSON.parse(xmlText);
                    xmlText = jsonData.contents;
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');
                
                const newsItems = [];
                items.forEach((item, index) => {
                    if (index < 20) { // 더 많은 아이템 파싱
                        const title = item.querySelector('title')?.textContent;
                        const description = item.querySelector('description')?.textContent || '';
                        const link = item.querySelector('link')?.textContent;
                        const pubDate = item.querySelector('pubDate')?.textContent;
                        const source = item.querySelector('source')?.textContent || 'Google News';
                        
                        if (title && link) {
                            const financeKeywords = ['금융', '경제', '코스피', '코스닥', '한국은행', '금리', '환율', '삼성전자', '주식', '투자', '증시', '기업', '시장', '은행', '보험', '증권', '펀드', 'ETF', '채권', '부동산'];
                            const hasKeyword = financeKeywords.some(keyword => 
                                title.includes(keyword) || description.includes(keyword)
                            );
                            
                            if (hasKeyword) {
                                newsItems.push({
                                    title: title,
                                    description: description || title,
                                    url: link,
                                    source: source,
                                    publishedAt: pubDate || new Date().toISOString()
                                });
                            }
                        }
                    }
                });
                
                return newsItems;
            } catch (error) {
                console.error('RSS 파싱 오류:', error);
                return [];
            }
        }

        function getFallbackNews() {
            const today = new Date();
            const kospiPrice = 2650 + Math.floor(Math.random() * 100);
            const usdRate = 1320 + Math.floor(Math.random() * 50);
            
            const fallbackNewsList = [
                {
                    id: 'news-0',
                    title: `한국은행, ${today.getMonth() + 1}월 기준금리 동결 결정`,
                    description: `한국은행이 ${today.getMonth() + 1}월 금융통화위원회에서 현행 기준금리를 유지하기로 결정했습니다.`,
                    content: `한국은행이 ${today.getMonth() + 1}월 금융통화위원회에서 현행 기준금리를 유지하기로 결정했습니다.`,
                    url: "https://www.bok.or.kr/",
                    source: "한국은행",
                    category: "통화정책",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-1',
                    title: `코스피 ${kospiPrice}선 마감 - 외국인 순매수 지속`,
                    description: `코스피가 ${kospiPrice}대에서 마감했습니다. 외국인 투자자들의 순매수가 이어지고 있습니다.`,
                    content: `코스피가 ${kospiPrice}대에서 마감했습니다.`,
                    url: "https://finance.naver.com/",
                    source: "한국거래소",
                    category: "증시",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-2',
                    title: `원-달러 환율 ${usdRate}원대 유지`,
                    description: `원-달러 환율이 ${usdRate}원대를 유지하고 있습니다.`,
                    content: `원-달러 환율이 ${usdRate}원대를 유지하고 있습니다.`,
                    url: "https://www.koreaexim.go.kr/",
                    source: "한국수출입은행",
                    category: "환율",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-3',
                    title: `국내 ETF 시장 100조원 돌파 임박`,
                    description: `국내 ETF 시장 규모가 100조원 돌파를 앞두고 있습니다.`,
                    content: `국내 ETF 시장이 빠르게 성장하고 있습니다.`,
                    url: "https://www.krx.co.kr/",
                    source: "한국거래소",
                    category: "ETF",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-4',
                    title: `청년층 주식투자 비중 역대 최고`,
                    description: `20-30대 청년층의 주식투자 참여율이 역대 최고 수준을 기록했습니다.`,
                    content: `청년층의 투자 관심이 높아지고 있습니다.`,
                    url: "https://www.fss.or.kr/",
                    source: "금융감독원",
                    category: "투자동향",
                    publishedAt: today.toISOString()
                }
            ];
            
            // 중복되지 않은 뉴스만 반환
            const uniqueFallback = fallbackNewsList.filter(news => !isContentDuplicate('news', news));
            if (uniqueFallback.length > 0) {
                saveContentHistory('news', uniqueFallback);
            }
            return uniqueFallback.slice(0, 5);
        }

        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`GEMINI API 오류: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    let result = data.candidates[0].content.parts[0].text;
                    
                    result = result.replace(/```(?:json|javascript|js|html|css)?\s*/gi, '');
                    result = result.replace(/```\s*/g, '');
                    result = result.replace(/`/g, '');
                    result = result.trim();
                    
                    return result;
                } else {
                    throw new Error('GEMINI API 응답 형식 오류');
                }
                
            } catch (error) {
                console.error('GEMINI API 호출 실패:', error);
                return null;
            }
        }

        async function generateTodayContent() {
            const today = getTodayDate();
            const firebaseCacheKey = `daily_${today}`;
            
            console.log(`📅 ${today} 데이터 생성 프로세스 시작`);
            
            updateStudyCardsStatus('loading');
            
            if (!window.firebaseDB) {
                console.log('⏳ Firebase 연결 대기 중...');
                setTimeout(generateTodayContent, 1000);
                return;
            }
            
            try {
                console.log('🔍 Firebase에서 데이터 확인 중...');
                const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                const firebaseSnapshot = await window.firebaseGet(firebaseRef);
                
                let needsGeneration = false;
                let existingData = null;
                
                if (firebaseSnapshot.exists()) {
                    existingData = firebaseSnapshot.val();
                    console.log('📦 Firebase에 데이터 존재');
                    
                    if (validateTodayData(existingData)) {
                        console.log('✅ Firebase 데이터 유효 - 사용');
                        localStorage.setItem('todayFinancialData', JSON.stringify(existingData));
                        localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(existingData));
                        isTodayDataReady = true;
                        updateStudyCardsStatus('ready');
                        return;
                    } else {
                        console.log('❌ Firebase 데이터 불완전 - 재생성 필요');
                        needsGeneration = true;
                    }
                } else {
                    console.log('❌ Firebase에 데이터 없음 - 생성 필요');
                    needsGeneration = true;
                }
                
                if (needsGeneration) {
                    console.log('🔄 새 데이터 생성 시작...');
                    
                    showLoadingOverlay();
                    
                    // 뉴스 수집
                    const newsData = await getLatestFinanceNews();
                    console.log(`📰 뉴스 ${newsData.length}건 수집 완료`);
                    
                    // AI로 용어 생성 (중복 제외)
                    let terms = [];
                    const excludedTerms = contentHistory.terms.slice(-50).map(t => t.term).join(', ');
                    
                    const termsPrompt = `오늘의 금융 뉴스를 바탕으로 중요한 금융 용어 5개를 선정하고 JSON 형식으로 반환해주세요:
                    ${newsData.map(n => n.title).join('\n')}
                    
                    다음 용어들은 이미 학습했으므로 절대 포함하지 마세요: ${excludedTerms}
                    
                    다음과 같은 새로운 용어들을 고려해주세요: 블록체인, NFT, 메타버스, ESG, 리츠(REITs), 스팩(SPAC), 밈주식, 로보어드바이저, 핀테크, 디파이(DeFi), 스테이블코인, 알고리즘 트레이딩, 다크풀, 양적완화, 테이퍼링
                    
                    다음 형식으로 정확히 5개의 새로운 용어를 반환:
                    [
                        {
                            "term": "용어명 (영문명)",
                            "definition": "정의 (초보자도 이해할 수 있게 쉽게 설명)",
                            "example": "실제 사례 (구체적인 예시)"
                        }
                    ]`;
                    
                    const termsResponse = await callGeminiAPI(termsPrompt);
                    if (termsResponse) {
                        try {
                            const jsonMatch = termsResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                const parsedTerms = JSON.parse(jsonMatch[0]);
                                // 중복 체크 후 추가
                                parsedTerms.forEach((term, index) => {
                                    if (!isContentDuplicate('terms', term) && terms.length < 3) {
                                        terms.push({
                                            id: `term-${index}`,
                                            ...term,
                                            isToday: true
                                        });
                                    }
                                });
                            }
                        } catch (e) {
                            console.error('Terms 파싱 실패:', e);
                        }
                    }
                    
                    // 부족하면 미리 준비된 용어에서 선택
                    if (terms.length < 3) {
                        const additionalTerms = selectUniqueTerms(3 - terms.length);
                        terms = [...terms, ...additionalTerms];
                    }
                    
                    await saveContentHistory('terms', terms);
                    
                    // AI로 퀴즈 생성 (중복 제외)
                    let quizzes = { beginner: [], intermediate: [], advanced: [] };
                    const excludedQuestions = contentHistory.quizzes.slice(-30).map(q => q.question.substring(0, 20)).join(', ');
                    
                    const quizPrompt = `다음 금융 뉴스를 바탕으로 초급 퀴즈 7문제를 JSON 형식으로 만들어주세요:
                    ${newsData.map(n => n.title + '\n' + n.description).join('\n\n')}
                    
                    다음과 유사한 문제는 제외해주세요: ${excludedQuestions}
                    
                    문제는 다양한 주제로 구성해주세요:
                    - 뉴스 내용 직접 활용 (2문제)
                    - 기본 금융 상식 (2문제)
                    - 투자 기초 (2문제)
                    - 일상 금융 (1문제)
                    
                    다음 형식으로 반환:
                    {
                        "beginner": [
                            {
                                "question": "문제",
                                "options": ["선택지1", "선택지2", "선택지3", "선택지4"],
                                "correct": 정답인덱스(0-3),
                                "explanation": "설명"
                            }
                        ]
                    }`;
                    
                    const quizResponse = await callGeminiAPI(quizPrompt);
                    if (quizResponse) {
                        try {
                            const jsonMatch = quizResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const parsed = JSON.parse(jsonMatch[0]);
                                if (parsed.beginner && Array.isArray(parsed.beginner)) {
                                    // 중복 체크 후 추가
                                    parsed.beginner.forEach(quiz => {
                                        if (!isContentDuplicate('quiz', quiz) && quizzes.beginner.length < 5) {
                                            quizzes.beginner.push(quiz);
                                        }
                                    });
                                }
                            }
                        } catch (e) {
                            console.error('Quiz 파싱 실패:', e);
                        }
                    }
                    
                    // 부족하면 미리 준비된 퀴즈에서 선택
                    if (quizzes.beginner.length < 5) {
                        const additionalQuizzes = selectUniqueQuizzes(beginnerQuizPool, 5 - quizzes.beginner.length);
                        quizzes.beginner = [...quizzes.beginner, ...additionalQuizzes];
                    }
                    
                    await saveContentHistory('quizzes', quizzes.beginner);
                    
                    // 중급, 고급 퀴즈 추가
                    quizzes.intermediate = selectUniqueQuizzes(intermediateQuizPool, 5);
                    quizzes.advanced = selectUniqueQuizzes(advancedQuizPool, 5);
                    
                    await saveContentHistory('quizzes', [...quizzes.intermediate, ...quizzes.advanced]);
                    
                    const todayData = {
                        date: today,
                        news: newsData,
                        terms: terms.slice(0, 3),
                        quizzes: quizzes
                    };
                    
                    console.log('💾 Firebase에 데이터 저장 중...');
                    await window.firebaseSet(firebaseRef, todayData);
                    console.log('✅ Firebase 저장 완료');
                    
                    localStorage.setItem('todayFinancialData', JSON.stringify(todayData));
                    localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(todayData));
                    console.log('✅ localStorage 저장 완료');
                    
                    hideLoadingOverlay();
                    isTodayDataReady = true;
                    updateStudyCardsStatus('ready');
                }
                
            } catch (error) {
                console.error('❌ 콘텐츠 생성 실패:', error);
                
                // 에러 시 대체 콘텐츠 제공
                const fallbackTerms = selectUniqueTerms(3);
                const fallbackBeginnerQuiz = selectUniqueQuizzes(beginnerQuizPool, 5);
                const fallbackIntermediateQuiz = selectUniqueQuizzes(intermediateQuizPool, 5);
                const fallbackAdvancedQuiz = selectUniqueQuizzes(advancedQuizPool, 5);
                
                const fallbackData = {
                    date: today,
                    news: getFallbackNews(),
                    terms: fallbackTerms,
                    quizzes: {
                        beginner: fallbackBeginnerQuiz,
                        intermediate: fallbackIntermediateQuiz,
                        advanced: fallbackAdvancedQuiz
                    }
                };
                
                await saveContentHistory('terms', fallbackData.terms);
                await saveContentHistory('quizzes', [
                    ...fallbackData.quizzes.beginner,
                    ...fallbackData.quizzes.intermediate,
                    ...fallbackData.quizzes.advanced
                ]);
                
                try {
                    const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                    await window.firebaseSet(firebaseRef, fallbackData);
                } catch (e) {
                    console.error('Firebase 저장 실패:', e);
                }
                
                localStorage.setItem('todayFinancialData', JSON.stringify(fallbackData));
                localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(fallbackData));
                
                hideLoadingOverlay();
                isTodayDataReady = true;
                updateStudyCardsStatus('ready');
            }
        }

        function goToTermsPage() {
            if (!isTodayDataReady) {
                alert('📚 학습 데이터를 준비 중입니다.\n잠시 후 다시 시도해주세요.');
                return;
            }
            window.location.href = 'a2-terms.html';
        }

        function goToNewsPage() {
            if (!isTodayDataReady) {
                alert('📰 뉴스 데이터를 준비 중입니다.\n잠시 후 다시 시도해주세요.');
                return;
            }
            window.location.href = 'a2-news.html';
        }

        function goToQuizPage() {
            if (!isTodayDataReady) {
                alert('❓ 퀴즈 데이터를 준비 중입니다.\n잠시 후 다시 시도해주세요.');
                return;
            }
            window.location.href = 'a2-quiz.html';
        }

        function goToScrapPage() {
            window.location.href = 'a2-scrap.html';
        }

        function goToPage(page) {
            if (page === 'a2.html') return;
            window.location.href = page;
        }

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('fineu_current_user');
                localStorage.removeItem('fineu_user_assets');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('📚 새로운 학습 콘텐츠가 업데이트되었습니다!\n\n• 오늘의 금융 용어 (3개)\n• 최신 금융 뉴스 분석\n• 금융 퀴즈 챌린지\n\n지금 바로 학습하고 보상을 받아보세요!');
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            return true;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!checkLoginStatus()) return;
            
            updateStudyCardsStatus('loading');
            
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            const cards = document.querySelectorAll('.fade-in');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>
