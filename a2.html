<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - ë”ë³´ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        console.log('ğŸ”¥ A2 Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        
        // ì „ì—­ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        console.log('ğŸ”¥ A2 Firebase ì „ì—­ ì„¤ì • ì™„ë£Œ');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* ê³µí†µ í—¤ë” */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        /* í•™ìŠµ ì¹´ë“œ */
        .study-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .study-card:active {
            transform: translateY(0);
        }

        .study-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .star-icon {
            color: #ffd700;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .star-icon.completed {
            color: #4CAF50;
            animation: sparkle 0.6s ease-in-out;
        }

        .study-card.completed {
            background: linear-gradient(135deg, #f0f8f0, #e8f5e8);
            border: 2px solid #4CAF50;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            line-height: 1.6;
            color: #333;
        }

        .content-section {
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .content-text {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* í€´ì¦ˆ ìŠ¤íƒ€ì¼ */
        .quiz-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .quiz-question {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quiz-option {
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .quiz-option:hover {
            border-color: #7cb9e8;
            background: #f0f8ff;
        }

        .quiz-option.selected {
            border-color: #7cb9e8;
            background: #e6f3ff;
        }

        .quiz-option.correct {
            border-color: #4CAF50;
            background: #e8f5e8;
            color: #2e7d32;
        }

        .quiz-option.incorrect {
            border-color: #f44336;
            background: #ffebee;
            color: #c62828;
        }

        .quiz-submit {
            width: 100%;
            padding: 12px;
            background: #7cb9e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-submit:hover {
            background: #5da8d4;
        }

        .quiz-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7cb9e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        /* ë³´ìƒ ì• ë‹ˆë©”ì´ì…˜ */
        .reward-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 20px 30px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
            animation: rewardPop 2s ease-in-out forwards;
        }

        .star-fly {
            position: absolute;
            color: #ffd700;
            font-size: 24px;
            pointer-events: none;
            animation: starFly 1.5s ease-out forwards;
        }

        /* êµ¬ë¶„ì„  */
        .divider {
            height: 2px;
            background: #333;
            margin: 30px 0;
            border-radius: 1px;
        }

        /* ìŠ¤í¬ë© ì˜ì—­ */
        .scrap-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scrap-content {
            text-align: center;
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* ì¤‘ì•™ ë°˜ì› ëŒì¶œ ë¶€ë¶„ ì¶”ê°€ */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .black-button {
            width: 55px;
            height: 55px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 150;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: #fafaf8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 150;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }
        
        .black-button:hover {
            transform: scale(1.1);
        }

        /* ë“±ê¸‰ë³„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .yellow-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .green-button {
            background: linear-gradient(45deg, #32CD32, #228B22);
            color: white;
        }
        
        .blue-button {
            background: linear-gradient(45deg, #1E90FF, #0066CC);
            color: white;
        }
        
        .red-button {
            background: linear-gradient(45deg, #FF4444, #CC0000);
            color: white;
        }
        
        .black-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes rewardPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        @keyframes starFly {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.5);
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/ë ˆì´ì–´ 1.png" alt="FINE U ë¡œê³ " class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <div class="page-title">STUDY ZONE</div>

        <!-- í•™ìŠµ ë©”ë‰´ë“¤ -->
        <div class="study-card fade-in" id="card-financial-terms" onclick="openStudyContent('ê¸ˆìœµ ìš©ì–´')" style="animation-delay: 0.1s">
            <div class="study-title">ê¸ˆìœµ ìš©ì–´</div>
            <i class="fas fa-star star-icon" id="star-financial-terms"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-news" onclick="openStudyContent('ê¸ˆìœµ ë‰´ìŠ¤')" style="animation-delay: 0.2s">
            <div class="study-title">ê¸ˆìœµ ë‰´ìŠ¤</div>
            <i class="fas fa-star star-icon" id="star-financial-news"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-quiz" onclick="openStudyContent('ê¸ˆìœµ í€´ì¦ˆ')" style="animation-delay: 0.3s">
            <div class="study-title">ê¸ˆìœµ í€´ì¦ˆ</div>
            <i class="fas fa-star star-icon" id="star-financial-quiz"></i>
        </div>

        <!-- êµ¬ë¶„ì„  -->
        <div class="divider"></div>

        <!-- ìŠ¤í¬ë© ì˜ì—­ -->
        <div class="scrap-section fade-in" style="animation-delay: 0.4s">
            <div class="scrap-content">
                ìŠ¤í¬ë©
            </div>
        </div>
    </div>

    <!-- ì½˜í…ì¸  ëª¨ë‹¬ -->
    <div class="modal" id="contentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ê¸ˆìœµ ì½˜í…ì¸ </div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/ì§‘.png" alt="í™ˆ">
            </div>
        </div>
        <div class="nav-item active" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/ë¬¸ì„œ.png" alt="ë¬¸ì„œ">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ã…‡.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/ì±„íŒ….png" alt="ì±„íŒ…">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ë”ë³´ê¸°.png" alt="ë”ë³´ê¸°">
            </div>
        </div>
    </div>

    <script>
        // API í‚¤ë“¤
        const GEMINI_API_KEY = 'AIzaSyBJhMtNOYyCfl6NRCQQz_CkTUHWP2TNweI';
        
        // Firebase ì‚¬ìš©ì ë° ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let userAssets = {};
        let todayContent = {};
        
        // ë¡œê·¸ì¸ í™•ì¸ ë° Firebase ì—°ê²°
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                console.log('âŒ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ - index.htmlë¡œ ì´ë™');
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            console.log('âœ… A2 ë¡œê·¸ì¸ ì‚¬ìš©ì:', currentUser.id);
            return true;
        }
        
        // Firebaseì—ì„œ ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (a1ê³¼ ë™ì¼)
        async function loadUserDataFromFirebase() {
            console.log('=== A2 ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');
            
            try {
                // 1. Firebase ì—°ê²° í™•ì¸
                if (!window.firebaseDB) {
                    console.log('A2 Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...');
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }
                console.log('âœ… A2 Firebase ì—°ê²° í™•ì¸ë¨');

                // 2. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('ğŸ‘¤ A2 ì‚¬ìš©ì ID:', userId);
                
                // 3. Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);
                console.log('ğŸ“Š A2 ë°ì´í„° ìŠ¤ëƒ…ìƒ· í™•ì¸:', snapshot.exists());

                if (snapshot.exists()) {
                    // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ
                    const firebaseData = snapshot.val();
                    console.log('âœ… A2 Firebase ë°ì´í„° ë¡œë“œ ì„±ê³µ:', firebaseData);
                    
                    // userAssetsì— ë°ì´í„° ì„¤ì •
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {}
                    };
                    
                    console.log('âœ… A2 userAssets ì„¤ì • ì™„ë£Œ:', userAssets);
                    
                    // ë“±ê¸‰ ì—…ë°ì´íŠ¸
                    const currentLevel = calculateUserLevel(userAssets.exp || userAssets.experience || 0);
                    userAssets.level = currentLevel.toLowerCase();
                    updateGradeButton(userAssets.level);
                    
                } else {
                    // Firebaseì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„° ì„¤ì •
                    console.log('âŒ A2 Firebaseì— ë°ì´í„° ì—†ìŒ - ê¸°ë³¸ ë°ì´í„° ì„¤ì •');
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 10000000,
                        totalAssets: 10000000,
                        virtualBalance: 10000000,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {}
                    };
                    updateGradeButton('yellow');
                }
                
                // 5. localStorageì— ë°±ì—… ì €ì¥
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                console.log('âœ… A2 localStorage ë°±ì—… ì™„ë£Œ');

                // 6. ì˜¤ëŠ˜ì˜ ì™„ë£Œ ìƒíƒœ í™•ì¸
                checkTodayCompletion();

            } catch (error) {
                console.error('âŒ A2 ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 10000000,
                    level: 'yellow',
                    exp: 0,
                    experience: 0,
                    studyProgress: {}
                };
                updateGradeButton('yellow');
            }
        }

        // Firebaseì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë™ê¸°í™” (í˜¸í™˜ì„± ìœ ì§€)
        async function syncUserData() {
            return await loadUserDataFromFirebase();
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // ì˜¤ëŠ˜ì˜ ì™„ë£Œ ìƒíƒœ í™•ì¸
        function checkTodayCompletion() {
            const today = getTodayDate();
            if (!userAssets.studyProgress) userAssets.studyProgress = {};
            if (!userAssets.studyProgress[today]) userAssets.studyProgress[today] = {};

            const todayProgress = userAssets.studyProgress[today];
            
            // ê° ì½˜í…ì¸ ë³„ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateCardCompletion('financial-terms', todayProgress.financialTerms || false);
            updateCardCompletion('financial-news', todayProgress.financialNews || false);
            updateCardCompletion('financial-quiz', todayProgress.financialQuiz || false);
        }

        // ì¹´ë“œ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateCardCompletion(type, completed) {
            const card = document.getElementById(`card-${type}`);
            const star = document.getElementById(`star-${type}`);
            
            if (completed) {
                card.classList.add('completed');
                star.classList.add('completed');
            } else {
                card.classList.remove('completed');
                star.classList.remove('completed');
            }
        }

        // RSSë¥¼ í†µí•œ ì‹¤ì œ í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ë‹¤ì¤‘ í”„ë¡ì‹œ ë°©ë²•)
        async function getLatestFinanceNews() {
            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;
                
                console.log(`ğŸ” RSSë¡œ ${dateStr} í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ ê²€ìƒ‰ ì¤‘...`);
                
                // ì—¬ëŸ¬ RSS í”„ë¡ì‹œ ì„œë¹„ìŠ¤ ì‹œë„
                const rssProxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];
                
                // Google News RSS URLë“¤ (í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤)
                const rssUrls = [
                    'https://news.google.com/rss/search?q=ê¸ˆìœµ+site:yna.co.kr&hl=ko&gl=KR',
                    'https://news.google.com/rss/search?q=ì½”ìŠ¤í”¼+site:mk.co.kr&hl=ko&gl=KR',
                    'https://news.google.com/rss/search?q=í•œêµ­ì€í–‰+site:hankyung.com&hl=ko&gl=KR',
                    'https://news.google.com/rss/search?q=ê²½ì œ+site:chosun.com&hl=ko&gl=KR'
                ];
                
                let allNews = [];
                
                for (const rssUrl of rssUrls) {
                    let success = false;
                    
                    for (const proxy of rssProxies) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent(rssUrl);
                            const response = await fetch(proxyUrl);
                            
                            if (response.ok) {
                                const data = await response.text();
                                const newsItems = parseRSSData(data);
                                
                                if (newsItems && newsItems.length > 0) {
                                    allNews.push(...newsItems.slice(0, 2)); // ê° RSSë‹¹ ìµœëŒ€ 2ê°œ
                                    success = true;
                                    console.log(`âœ… RSS ì„±ê³µ: ${newsItems.length}ê±´ ê°€ì ¸ì˜´`);
                                    break; // ì„±ê³µí•˜ë©´ ë‹¤ìŒ RSSë¡œ
                                }
                            }
                        } catch (error) {
                            console.warn(`RSS í”„ë¡ì‹œ ì‹¤íŒ¨ (${proxy}):`, error);
                        }
                    }
                    
                    if (!success) {
                        console.warn(`ëª¨ë“  í”„ë¡ì‹œì—ì„œ RSS ì‹¤íŒ¨: ${rssUrl}`);
                    }
                }
                
                if (allNews.length > 0) {
                    // ì¤‘ë³µ ì œê±° ë° ì •ë¦¬
                    const uniqueNews = allNews
                        .filter((item, index, self) => 
                            index === self.findIndex(t => t.title === item.title)
                        )
                        .slice(0, 4)
                        .map(item => ({
                            title: item.title.replace(/<[^>]*>/g, ''), // HTML íƒœê·¸ ì œê±°
                            description: item.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...', // HTML íƒœê·¸ ì œê±° ë° ê¸¸ì´ ì œí•œ
                            url: item.url,
                            source: item.source || 'Google News',
                            category: 'ê¸ˆìœµë‰´ìŠ¤',
                            publishedAt: item.publishedAt || today.toISOString()
                        }));
                
                    if (uniqueNews.length > 0) {
                        console.log(`âœ… RSS í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ ${uniqueNews.length}ê±´ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`);
                        return uniqueNews;
                    }
                }
                
                console.log('RSS ë‰´ìŠ¤ ë°ì´í„° ì—†ìŒ, GEMINIë¡œ ìƒì„±');
                return await generateNewsWithGemini();
                
            } catch (error) {
                console.error('âŒ RSS ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                // RSS ì‹¤íŒ¨ ì‹œ GEMINI AIë¡œ ë‰´ìŠ¤ ìƒì„±
                return await generateNewsWithGemini();
            }
        }

        // RSS XML ë°ì´í„° íŒŒì‹± í•¨ìˆ˜
        function parseRSSData(xmlText) {
            try {
                // AllOriginsì˜ ê²½ìš° JSONìœ¼ë¡œ ë˜í•‘ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ
                if (xmlText.includes('"contents"')) {
                    const jsonData = JSON.parse(xmlText);
                    xmlText = jsonData.contents;
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');
                
                const newsItems = [];
                items.forEach((item, index) => {
                    if (index < 3) { // ìµœëŒ€ 3ê°œë§Œ
                        const title = item.querySelector('title')?.textContent;
                        const description = item.querySelector('description')?.textContent;
                        const link = item.querySelector('link')?.textContent;
                        const pubDate = item.querySelector('pubDate')?.textContent;
                        
                        if (title && description && link) {
                            // ê¸ˆìœµ ê´€ë ¨ ë‰´ìŠ¤ë§Œ í•„í„°ë§
                            if (title.includes('ê¸ˆìœµ') || 
                                title.includes('ê²½ì œ') || 
                                title.includes('ì½”ìŠ¤í”¼') || 
                                title.includes('ì½”ìŠ¤ë‹¥') || 
                                title.includes('í•œêµ­ì€í–‰') || 
                                title.includes('ê¸ˆë¦¬') || 
                                title.includes('í™˜ìœ¨') || 
                                title.includes('ì‚¼ì„±ì „ì') ||
                                title.includes('ì£¼ì‹') ||
                                title.includes('íˆ¬ì') ||
                                title.includes('ì¦ì‹œ') ||
                                title.includes('ê¸°ì—…') ||
                                title.includes('ì‹œì¥')) {
                                
                                newsItems.push({
                                    title: title,
                                    description: description,
                                    url: link,
                                    source: 'Google News',
                                    publishedAt: pubDate || new Date().toISOString()
                                });
                            }
                        }
                    }
                });
                
                return newsItems;
            } catch (error) {
                console.error('RSS íŒŒì‹± ì˜¤ë¥˜:', error);
                return [];
            }
        }

        // GEMINI AIë¡œ ë‰´ìŠ¤ ìƒì„± (RSS ëŒ€ì²´)
        async function generateNewsWithGemini() {
            try {
                const currentDate = new Date();
                const currentDateStr = `${currentDate.getFullYear()}ë…„ ${currentDate.getMonth() + 1}ì›” ${currentDate.getDate()}ì¼`;
                
                const prompt = `Generate 4 realistic Korean financial news items for ${currentDateStr}. Return only valid JSON array:

[
    {
        "title": "ì‹¤ì œ ê°™ì€ í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ ì œëª© 1",
        "description": "ë‰´ìŠ¤ ë‚´ìš© ì„¤ëª… (2-3ì¤„)",
        "url": "https://news.google.com/articles/article1",
        "source": "Google News",
        "category": "ê¸ˆìœµë‰´ìŠ¤",
        "publishedAt": "${currentDate.toISOString()}"
    },
    {
        "title": "ì‹¤ì œ ê°™ì€ í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ ì œëª© 2",
        "description": "ë‰´ìŠ¤ ë‚´ìš© ì„¤ëª… (2-3ì¤„)",
        "url": "https://news.google.com/articles/article2",
        "source": "Google News",
        "category": "ê¸ˆìœµë‰´ìŠ¤",
        "publishedAt": "${currentDate.toISOString()}"
    },
    {
        "title": "ì‹¤ì œ ê°™ì€ í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ ì œëª© 3",
        "description": "ë‰´ìŠ¤ ë‚´ìš© ì„¤ëª… (2-3ì¤„)",
        "url": "https://news.google.com/articles/article3",
        "source": "Google News",
        "category": "ê¸ˆìœµë‰´ìŠ¤",
        "publishedAt": "${currentDate.toISOString()}"
    },
    {
        "title": "ì‹¤ì œ ê°™ì€ í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ ì œëª© 4",
        "description": "ë‰´ìŠ¤ ë‚´ìš© ì„¤ëª… (2-3ì¤„)",
        "url": "https://news.google.com/articles/article4",
        "source": "Google News",
        "category": "ê¸ˆìœµë‰´ìŠ¤",
        "publishedAt": "${currentDate.toISOString()}"
    }
]

Topics: í•œêµ­ì€í–‰ ê¸°ì¤€ê¸ˆë¦¬, ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ë™í–¥, í™˜ìœ¨, ì£¼ìš” ê¸°ì—… ì‹¤ì , ë¶€ë™ì‚° ê¸ˆìœµ ë“±
Return ONLY the JSON array. No explanations.`;

                console.log(`ğŸ¤– GEMINI AIë¡œ ${currentDateStr} ë‰´ìŠ¤ ìƒì„± ì¤‘...`);
                const geminiResponse = await callGeminiAPI(prompt);
                
                if (geminiResponse) {
                    try {
                        let cleanResponse = geminiResponse.trim();
                        cleanResponse = cleanResponse.replace(/```json\s*/gi, '');
                        cleanResponse = cleanResponse.replace(/```\s*/g, '');
                        cleanResponse = cleanResponse.replace(/`/g, '');
                        
                        if (!cleanResponse.startsWith('[')) {
                            const jsonStart = cleanResponse.indexOf('[');
                            if (jsonStart > -1) {
                                cleanResponse = cleanResponse.substring(jsonStart);
                            }
                        }
                        
                        if (!cleanResponse.endsWith(']')) {
                            const jsonEnd = cleanResponse.lastIndexOf(']');
                            if (jsonEnd > -1) {
                                cleanResponse = cleanResponse.substring(0, jsonEnd + 1);
                            }
                        }
                        
                        const newsData = JSON.parse(cleanResponse);
                        
                        if (Array.isArray(newsData) && newsData.length > 0) {
                            console.log(`âœ… GEMINI AI ë‰´ìŠ¤ ìƒì„± ì™„ë£Œ: ${newsData.length}ê±´`);
                            return newsData;
                        }
                    } catch (parseError) {
                        console.warn('âš ï¸ GEMINI ë‰´ìŠ¤ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                    }
                }
                
                // GEMINIë„ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë‰´ìŠ¤
                console.log('âŒ GEMINI ë‰´ìŠ¤ ìƒì„± ì‹¤íŒ¨, ëŒ€ì²´ ë‰´ìŠ¤ ì‚¬ìš©');
                const fallbackDate = new Date();
                const fallbackDateStr = `${fallbackDate.getFullYear()}ë…„ ${fallbackDate.getMonth() + 1}ì›” ${fallbackDate.getDate()}ì¼`;
                return getFallbackNews(fallbackDateStr);
                
            } catch (error) {
                console.error('GEMINI ë‰´ìŠ¤ ìƒì„± ì˜¤ë¥˜:', error);
                const errorDate = new Date();
                const errorDateStr = `${errorDate.getFullYear()}ë…„ ${errorDate.getMonth() + 1}ì›” ${errorDate.getDate()}ì¼`;
                return getFallbackNews(errorDateStr);
            }
        }

        // ëŒ€ì²´ ë‰´ìŠ¤ ìƒì„± (NewsAPI ì‹¤íŒ¨ ì‹œ)
        function getFallbackNews(dateStr) {
            const today = new Date();
            const kospiPrice = 2650 + Math.floor(Math.random() * 100); // 2650-2750 ì‚¬ì´
            const usdRate = 1320 + Math.floor(Math.random() * 50); // 1320-1370 ì‚¬ì´
            
            return [
                {
                    title: `${dateStr} í•œêµ­ì€í–‰ í†µí™”ì •ì±… í˜„í™© - ê¸°ì¤€ê¸ˆë¦¬ 3.50% ìœ ì§€`,
                    description: `í•œêµ­ì€í–‰ì´ ${today.getMonth() + 1}ì›” ê¸ˆìœµí†µí™”ìœ„ì›íšŒì—ì„œ í˜„í–‰ ê¸°ì¤€ê¸ˆë¦¬ 3.50%ë¥¼ ìœ ì§€í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤. ì¸í”Œë ˆì´ì…˜ ì••ë ¥ê³¼ ê²½ì œì„±ì¥ì„¸ë¥¼ ì¢…í•© ê³ ë ¤í•œ ê²°ê³¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`,
                    url: "https://www.bok.or.kr/",
                    source: "í•œêµ­ì€í–‰",
                    category: "í†µí™”ì •ì±…",
                    publishedAt: today.toISOString()
                },
                {
                    title: `ì½”ìŠ¤í”¼ ${kospiPrice}ì„ ì—ì„œ ë“±ë½ - ì™¸êµ­ì¸ íˆ¬ì ë™í–¥ ì£¼ëª©`,
                    description: `${dateStr} êµ­ë‚´ ì¦ì‹œê°€ ${kospiPrice}ëŒ€ì—ì„œ ë“±ë½ì„ ê±°ë“­í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë°˜ë„ì²´ì™€ 2ì°¨ì „ì§€ ì—…ì¢…ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì™¸êµ­ì¸ íˆ¬ììë“¤ì˜ ë§¤ë§¤ íŒ¨í„´ì´ ì‹œì¥ ë°©í–¥ì„±ì„ ì¢Œìš°í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    url: "https://finance.naver.com/sise/",
                    source: "í•œêµ­ê±°ë˜ì†Œ",
                    category: "ì¦ì‹œë™í–¥",
                    publishedAt: today.toISOString()
                },
                {
                    title: `ë‹¬ëŸ¬-ì› í™˜ìœ¨ ${usdRate}ì›ëŒ€ - ë¯¸ ì—°ì¤€ ì •ì±… ì˜í–¥`,
                    description: `${dateStr} ì›-ë‹¬ëŸ¬ í™˜ìœ¨ì´ ${usdRate}ì›ëŒ€ì—ì„œ í˜•ì„±ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë¯¸êµ­ ì—°ë°©ì¤€ë¹„ì œë„ì˜ í†µí™”ì •ì±… ë°©í–¥ê³¼ êµ­ë‚´ ê²½ì œì§€í‘œê°€ í™˜ìœ¨ ë³€ë™ì˜ ì£¼ìš” ìš”ì¸ìœ¼ë¡œ ì‘ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    url: "https://www.koreaexim.go.kr/",
                    source: "í•œêµ­ìˆ˜ì¶œì…ì€í–‰",
                    category: "í™˜ìœ¨ë™í–¥",
                    publishedAt: today.toISOString()
                },
                {
                    title: `ì‚¼ì„±ì „ì ${today.getMonth() + 1}ì›” ì‹¤ì  ì „ë§ - ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ìˆ˜ìš” íšŒë³µ`,
                    description: `ì‚¼ì„±ì „ìì˜ ${today.getMonth() + 1}ì›” ì‹¤ì ì— ëŒ€í•œ ì‹œì¥ ê´€ì‹¬ì´ ë†’ì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë©”ëª¨ë¦¬ ë°˜ë„ì²´ ì—…í™© ê°œì„ ê³¼ ìŠ¤ë§ˆíŠ¸í° ì‚¬ì—… ë¶€ë¬¸ì˜ ì•ˆì •ì  ì„±ì¥ì´ ì£¼ìš” í¬ì¸íŠ¸ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`,
                    url: "https://news.samsung.com/kr/",
                    source: "ì‚¼ì„±ì „ì",
                    category: "ê¸°ì—…ì‹¤ì ",
                    publishedAt: today.toISOString()
                }
            ];
        }

        // ì‹¤ì œ GEMINI AI API í˜¸ì¶œ
        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`GEMINI API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    let result = data.candidates[0].content.parts[0].text;
                    
                    // ëª¨ë“  ì¢…ë¥˜ì˜ ì½”ë“œ ë¸”ë¡ ì œê±° (ë” ê°•ë ¥í•œ íŒ¨í„´)
                    result = result.replace(/```html\s*/gi, '');
                    result = result.replace(/```javascript\s*/gi, '');
                    result = result.replace(/```css\s*/gi, '');
                    result = result.replace(/```json\s*/gi, '');
                    result = result.replace(/```\s*/g, '');
                    result = result.replace(/`{3,}/g, '');
                    
                    // ì‹œì‘ê³¼ ëì˜ ë°±í‹± ì œê±°
                    result = result.replace(/^`+/gm, '');
                    result = result.replace(/`+$/gm, '');
                    
                    // ë¶ˆí•„ìš”í•œ ê³µë°± ì •ë¦¬
                    result = result.trim();
                    
                    console.log('ğŸ§¹ HTML ë¸”ë¡ ì œê±° ì™„ë£Œ');
                    return result;
                } else {
                    throw new Error('GEMINI API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
                }
                
            } catch (error) {
                console.error('GEMINI API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // GEMINI AIë¡œ NewsAPI ë‰´ìŠ¤ ì •ë¦¬ ë° ë¶„ì„
        async function generateContentWithGemini(type, newsData = null) {
            try {
                let prompt = '';
                let newsLinks = '';
                
                switch(type) {
                    case 'ê¸ˆìœµ ìš©ì–´':
                        // NewsAPIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê¸ˆìœµ ìš©ì–´ ì„¤ëª…
                        const termNewsData = newsData || await getLatestFinanceNews();
                        prompt = 'ë‹¤ìŒì€ NewsAPIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ìµœì‹  í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ì…ë‹ˆë‹¤. ì´ ë‰´ìŠ¤ë“¤ì—ì„œ ì–¸ê¸‰ëœ ê¸ˆìœµ ìš©ì–´ë“¤ì„ ì°¾ì•„ì„œ 3ê°œë¥¼ ì„ ë³„í•˜ì—¬ ì„¤ëª…í•´ì£¼ì„¸ìš”:\n\n' +
                        (termNewsData ? termNewsData.map(n => 'ì œëª©: ' + n.title + '\në‚´ìš©: ' + n.description + '\nì¶œì²˜: ' + n.source + '\në°œí–‰ì¼: ' + n.publishedAt).join('\n\n') : '') +
                        '\n\në‹¤ìŒê³¼ ê°™ì€ ì •í™•í•œ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš” (ì½”ë“œ ë¸”ë¡ ì—†ì´):\n\n' +
                        '<div class="content-section">\n' +
                        '<div class="content-title">ğŸ“š ' + new Date().toLocaleDateString('ko-KR') + ' ì‹¤ì œ ë‰´ìŠ¤ ê¸°ë°˜ ê¸ˆìœµìš©ì–´</div>\n' +
                        '<div class="content-text">\n' +
                        '<strong>1. [ì‹¤ì œ ë‰´ìŠ¤ì—ì„œ ì–¸ê¸‰ëœ ìš©ì–´1] ([ì˜ë¬¸ëª…])</strong><br>\n' +
                        '[ìœ„ ë‰´ìŠ¤ì—ì„œ ì–¸ê¸‰ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì •ì˜ ì„¤ëª…]<br>\n' +
                        '<strong>ì‹¤ì œ ì‚¬ë¡€:</strong> [ìœ„ ë‰´ìŠ¤ ë‚´ìš©ê³¼ ì—°ê´€ëœ êµ¬ì²´ì  ì˜ˆì‹œ]<br><br>\n\n' +
                        '<strong>2. [ì‹¤ì œ ë‰´ìŠ¤ì—ì„œ ì–¸ê¸‰ëœ ìš©ì–´2] ([ì˜ë¬¸ëª…])</strong><br>\n' +
                        '[ìœ„ ë‰´ìŠ¤ì—ì„œ ì–¸ê¸‰ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì •ì˜ ì„¤ëª…]<br>\n' +
                        '<strong>ì‹¤ì œ ì‚¬ë¡€:</strong> [ìœ„ ë‰´ìŠ¤ ë‚´ìš©ê³¼ ì—°ê´€ëœ êµ¬ì²´ì  ì˜ˆì‹œ]<br><br>\n\n' +
                        '<strong>3. [ì‹¤ì œ ë‰´ìŠ¤ì—ì„œ ì–¸ê¸‰ëœ ìš©ì–´3] ([ì˜ë¬¸ëª…])</strong><br>\n' +
                        '[ìœ„ ë‰´ìŠ¤ì—ì„œ ì–¸ê¸‰ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì •ì˜ ì„¤ëª…]<br>\n' +
                        '<strong>ì‹¤ì œ ì‚¬ë¡€:</strong> [ìœ„ ë‰´ìŠ¤ ë‚´ìš©ê³¼ ì—°ê´€ëœ êµ¬ì²´ì  ì˜ˆì‹œ]\n' +
                        '</div>\n' +
                        '</div>\n\n' +
                        'ì¤‘ìš”: ë°˜ë“œì‹œ ì œê³µëœ ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ë‚´ìš©ì—ì„œë§Œ ê¸ˆìœµìš©ì–´ë¥¼ ì¶”ì¶œí•˜ê³ , HTML íƒœê·¸ëŠ” <strong>, <br> ë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”. ì½”ë“œ ë¸”ë¡ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.';
                        break;
                        
                    case 'ê¸ˆìœµ ë‰´ìŠ¤':
                        // NewsAPI ë‰´ìŠ¤ë¥¼ GEMINIê°€ ë¶„ì„í•˜ì—¬ ì •ë¦¬
                        const newsText = newsData ? newsData.map(n => 'ì œëª©: ' + n.title + '\në‚´ìš©: ' + n.description + '\nì¶œì²˜: ' + n.source + '\në°œí–‰ì¼: ' + n.publishedAt + '\nì¹´í…Œê³ ë¦¬: ' + (n.category || 'ê¸ˆìœµ')).join('\n\n') : '';
                        newsLinks = newsData ? newsData.map(n => '<a href="' + n.url + '" target="_blank" style="color: #7cb9e8; text-decoration: none; display: block; margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #7cb9e8;">ğŸ“° ' + n.title + '</a>').join('') : '';
                        prompt = 'ë‹¤ìŒì€ NewsAPIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ìµœì‹  í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ë“¤ì…ë‹ˆë‹¤. ì´ë¥¼ ì „ë¬¸ê°€ ê´€ì ì—ì„œ ë¶„ì„í•˜ê³  ì •ë¦¬í•´ì£¼ì„¸ìš”:\n\n' +
                        newsText + '\n\n' +
                        'ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìƒì„¸ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\n' +
                        '<div class="content-section">\n' +
                        '<div class="content-title">ğŸ“ˆ ' + new Date().toLocaleDateString('ko-KR') + ' ì‹¤ì œ ê¸ˆìœµë‰´ìŠ¤ ë¶„ì„</div>\n' +
                        '<div class="content-text">\n' +
                        '<strong>ğŸ” ì£¼ìš” ë‰´ìŠ¤ í•µì‹¬ ìš”ì•½</strong><br>\n' +
                        '[ê° ì‹¤ì œ ë‰´ìŠ¤ì˜ í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ë²ˆí˜¸ë³„ë¡œ ìš”ì•½]<br><br>\n\n' +
                        '<strong>ğŸ’¼ ê°œì¸ íˆ¬ìì ì˜í–¥ ë¶„ì„</strong><br>\n' +
                        '[ì‹¤ì œ ë‰´ìŠ¤ê°€ ê°œì¸ íˆ¬ììì—ê²Œ ì–´ë–¤ ì˜í–¥ì„ ì¤„ì§€ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„]<br><br>\n\n' +
                        '<strong>ğŸ“Š ì‹¤ìš©ì  íˆ¬ì ì „ëµ</strong><br>\n' +
                        '[ì‹¤ì œ ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ êµ¬ì²´ì ì¸ íˆ¬ì ì „ëµ ì œì•ˆ]<br><br>\n\n' +
                        '<strong>âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ë¦¬ìŠ¤í¬</strong><br>\n' +
                        '[ì‹¤ì œ ë‰´ìŠ¤ì—ì„œ íŒŒì•…ë˜ëŠ” ìœ„í—˜ ìš”ì†Œë“¤]<br><br>\n\n' +
                        '<strong>ğŸ“… í–¥í›„ ê´€ì‹¬ í¬ì¸íŠ¸</strong><br>\n' +
                        '[ì‹¤ì œ ë‰´ìŠ¤ë¥¼ í†µí•´ ì˜ˆìƒë˜ëŠ” í–¥í›„ ì´ë²¤íŠ¸ë‚˜ ì§€í‘œ]\n' +
                        '</div>\n' +
                        '</div>\n\n' +
                        'ì¤‘ìš”: ì œê³µëœ ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ë‚´ìš©ë§Œì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•˜ê³ , ì „ë¬¸ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì½”ë“œ ë¸”ë¡ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.';
                        break;
                        
                    case 'ê¸ˆìœµ í€´ì¦ˆ':
                        // NewsAPI ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ í€´ì¦ˆ ìƒì„±
                        prompt = 'ë‹¤ìŒì€ NewsAPIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ìµœì‹  í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ë“¤ì…ë‹ˆë‹¤. ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹¤ë¬´ì— ë„ì›€ë˜ëŠ” ê¸ˆìœµ í€´ì¦ˆë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”:\n\n' +
                        (newsData ? newsData.map(n => 'ì œëª©: ' + n.title + '\në‚´ìš©: ' + n.description + '\nì¶œì²˜: ' + n.source + '\në°œí–‰ì¼: ' + n.publishedAt).join('\n\n') : '') + '\n\n' +
                        'í€´ì¦ˆ ìš”êµ¬ì‚¬í•­:\n' +
                        '- ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì‚¬ì§€ì„ ë‹¤ ë¬¸ì œ 3ê°œ\n' +
                        '- ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€\n' +
                        '- ì‹¤ë¬´ì— ë„ì›€ë˜ëŠ” ê¸ˆìœµ ì§€ì‹ í¬í•¨\n' +
                        '- ê° ë¬¸ì œë§ˆë‹¤ ìì„¸í•œ í•´ì„¤ ì œê³µ\n\n' +
                        'ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:\n' +
                        '1. í€´ì¦ˆ ì†Œê°œ (ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ì´ë¼ëŠ” ì  ì–¸ê¸‰)\n' +
                        '2. 4ì§€ì„ ë‹¤ ë¬¸ì œ 3ê°œ (ì •ë‹µ í¬í•¨)\n' +
                        '3. ê° ë¬¸ì œë³„ ìƒì„¸ í•´ì„¤\n' +
                        '4. ì¶”ê°€ í•™ìŠµ íŒ\n\n' +
                        'ì½”ë“œ ë¸”ë¡ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.';
                        break;
                }

                // ì‹¤ì œ GEMINI API í˜¸ì¶œ
                console.log('ğŸ¤– GEMINI AI NewsAPI ë‰´ìŠ¤ ë¶„ì„ ì‹œì‘:', type);
                const geminiResponse = await callGeminiAPI(prompt);
                
                if (geminiResponse) {
                    console.log('âœ… GEMINI AI NewsAPI ë‰´ìŠ¤ ë¶„ì„ ì™„ë£Œ');
                    
                    // ë‰´ìŠ¤ì˜ ê²½ìš° ë§í¬ ì„¹ì…˜ ì¶”ê°€
                    if (type === 'ê¸ˆìœµ ë‰´ìŠ¤' && newsLinks) {
                        return geminiResponse + `
                            <div class="content-section">
                                <div class="content-title">ğŸ”— ì‹¤ì œ ë‰´ìŠ¤ ê¸°ì‚¬ ë°”ë¡œê°€ê¸°</div>
                                <div style="margin-top: 15px;">
                                    ${newsLinks}
                                </div>
                            </div>
                        `;
                    }
                    
                    return geminiResponse;
                } else {
                    // GEMINI API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì½˜í…ì¸ 
                    console.log('âŒ GEMINI API ì‹¤íŒ¨, ëŒ€ì²´ ì½˜í…ì¸  ì‚¬ìš©');
                    return getFallbackContent(type, newsLinks);
                }
                
            } catch (error) {
                console.error('GEMINI API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                return getFallbackContent(type, newsLinks);
            }
        }

        // GEMINI API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì½˜í…ì¸ 
        function getFallbackContent(type, newsLinks = '') {
            const fallbackResponses = {
                'ê¸ˆìœµ ìš©ì–´': `
                    <div class="content-section">
                        <div class="content-title">ğŸ“š ì˜¤ëŠ˜ì˜ í•µì‹¬ ê¸ˆìœµìš©ì–´</div>
                        <div class="content-text">
                            <strong>1. ë³µë¦¬ (Compound Interest)</strong><br>
                            ì›ê¸ˆì— ë¶™ì€ ì´ìê°€ ë‹¤ì‹œ ì›ê¸ˆì´ ë˜ì–´ ì´ìê°€ ë¶™ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. 
                            "ëˆì´ ëˆì„ ë‚³ëŠ”ë‹¤"ëŠ” ë§ì˜ í•µì‹¬ ì›ë¦¬ì£ !
                            
                            <br><br><strong>ì˜ˆì‹œ:</strong> 100ë§Œì›ì„ ì—° 10% ë³µë¦¬ë¡œ íˆ¬ìí•˜ë©´
                            - 1ë…„ í›„: 110ë§Œì›
                            - 2ë…„ í›„: 121ë§Œì› (110ë§Œì›ì˜ 10%)
                            
                            <br><br><strong>2. ë¶„ì‚°íˆ¬ì (Diversification)</strong><br>
                            ì—¬ëŸ¬ ì¢…ëª©ì´ë‚˜ ìì‚°ì— íˆ¬ìí•˜ì—¬ ìœ„í—˜ì„ ì¤„ì´ëŠ” ì „ëµì…ë‹ˆë‹¤.
                            "ê³„ë€ì„ í•œ ë°”êµ¬ë‹ˆì— ë‹´ì§€ ë§ˆë¼"ëŠ” íˆ¬ìì˜ ê¸°ë³¸ ì›ì¹™ì´ì—ìš”.
                            
                            <br><br><strong>3. ë‹¬ëŸ¬ ì½”ìŠ¤íŠ¸ í‰ê· ë²• (Dollar Cost Averaging)</strong><br>
                            ì •ê¸°ì ìœ¼ë¡œ ì¼ì • ê¸ˆì•¡ì„ íˆ¬ìí•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. 
                            ê°€ê²©ì´ ë†’ì„ ë•ŒëŠ” ì ê²Œ, ë‚®ì„ ë•ŒëŠ” ë§ì´ ì‚¬ê²Œ ë˜ì–´ í‰ê·  ë§¤ì…ë‹¨ê°€ë¥¼ ë‚®ì¶œ ìˆ˜ ìˆì–´ìš”.
                        </div>
                    </div>
                `,
                'ê¸ˆìœµ ë‰´ìŠ¤': `
                    <div class="content-section">
                        <div class="content-title">ğŸ“° ì˜¤ëŠ˜ì˜ ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„</div>
                        <div class="content-text">
                            <strong>ğŸ›ï¸ í•œêµ­ì€í–‰ ê¸°ì¤€ê¸ˆë¦¬ ì •ì±…</strong><br>
                            í˜„ì¬ ê¸ˆë¦¬ ì •ì±…ì€ ì¸í”Œë ˆì´ì…˜ê³¼ ê²½ì œ ì„±ì¥ì˜ ê· í˜•ì„ ë§ì¶”ëŠ” ë°©í–¥ìœ¼ë¡œ ì„¤ì •ë˜ê³  ìˆìŠµë‹ˆë‹¤.
                            
                            <br><br><strong>ğŸ’¼ ê°œì¸ íˆ¬ìì ì˜í–¥:</strong><br>
                            â€¢ ì˜ˆê¸ˆ ê¸ˆë¦¬ ë³€ë™ â†’ ì•ˆì „ ìì‚° ìˆ˜ìµë¥  ì˜í–¥<br>
                            â€¢ ëŒ€ì¶œ ê¸ˆë¦¬ ë³€í™” â†’ ë¶€ë™ì‚° ë° ì†Œë¹„ íŒ¨í„´ ë³€í™”<br>
                            â€¢ ì£¼ì‹ ì‹œì¥ â†’ ê¸ˆë¦¬ ì •ì±…ì— ë”°ë¥¸ ìê¸ˆ ì´ë™
                            
                            <br><br><strong>ğŸ“ˆ ì¦ì‹œ ë™í–¥</strong><br>
                            ì™¸êµ­ì¸ íˆ¬ì íŒ¨í„´ê³¼ ì£¼ìš” ì—…ì¢…ë³„ ì‹¤ì ì´ ì‹œì¥ íë¦„ì„ ì¢Œìš°í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                            
                            <br><br><strong>ğŸ’¡ íˆ¬ì ì „ëµ ì œì•ˆ:</strong><br>
                            1. ê¸ˆë¦¬ ë³€ë™ì— ë¯¼ê°í•œ ì„¹í„° ê´€ì°°<br>
                            2. ê¸°ìˆ ì£¼ì™€ ì „í†µ ì‚°ì—…ì˜ ê· í˜• ê³ ë ¤<br>
                            3. ë¶„ì‚°íˆ¬ìë¥¼ í†µí•œ ë¦¬ìŠ¤í¬ ê´€ë¦¬
                        </div>
                        ${newsLinks ? `
                        <div class="content-section">
                            <div class="content-title">ğŸ”— ê´€ë ¨ ê¸°ì‚¬ ë°”ë¡œê°€ê¸°</div>
                            <div style="margin-top: 15px;">
                                ${newsLinks}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `,
                'ê¸ˆìœµ í€´ì¦ˆ': `
                    <div class="content-section">
                        <div class="content-title">ğŸ§© ì˜¤ëŠ˜ì˜ ê¸ˆìœµ í€´ì¦ˆ</div>
                        <div class="content-text">
                            ê¸ˆìœµ ì§€ì‹ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”! 70% ì´ìƒ ë§íˆë©´ ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.<br>
                            ë³µë¦¬, ë¶„ì‚°íˆ¬ì, ì£¼ì‹ ì§€í‘œ ë“± ì‹¤ìš©ì ì¸ ê¸ˆìœµ ì§€ì‹ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                `
            };

            return fallbackResponses[type] || 'ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
        }

        // ì¼ì¼ ìºì‹± ì‹œìŠ¤í…œ
        function getTodayKey(type) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
            return `daily_${type}_${today}`;
        }

        async function getCachedDataOrUpdate(type, generateFunction) {
            const cacheKey = getTodayKey(type);
            
            try {
                // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
                if (!window.firebaseDB) {
                    console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
                    await new Promise(resolve => {
                        const checkFirebase = () => {
                            if (window.firebaseDB) {
                                resolve();
                            } else {
                                setTimeout(checkFirebase, 100);
                            }
                        };
                        checkFirebase();
                    });
                }
                
                // window.firebaseDB ì‚¬ìš©
                const cacheRef = window.firebaseRef(window.firebaseDB, `cache/${cacheKey}`);
                const snapshot = await window.firebaseGet(cacheRef);
                const cachedData = snapshot.val();
                
                if (cachedData && cachedData.data) {
                    console.log(`${type} ìºì‹œëœ ë°ì´í„° ì‚¬ìš© (${cachedData.timestamp})`);
                    return cachedData.data;
                }
                
                // ìºì‹œëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                console.log(`${type} ìƒˆ ë°ì´í„° ìƒì„± ì¤‘...`);
                const newData = await generateFunction();
                
                // Firebaseì— ì €ì¥
                await window.firebaseSet(cacheRef, {
                    data: newData,
                    timestamp: new Date().toISOString(),
                    type: type
                });
                
                console.log(`${type} ìƒˆ ë°ì´í„° ì €ì¥ ì™„ë£Œ`);
                return newData;
                
            } catch (error) {
                console.error(`${type} ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:`, error);
                return await generateFunction(); // ì—ëŸ¬ ì‹œ ì§ì ‘ ìƒì„±
            }
        }

        // NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ í€´ì¦ˆ ë°ì´í„° ìƒì„±
        async function generateQuizData(newsData = null) {
            try {
                if (!newsData) {
                    newsData = await getLatestFinanceNews();
                }
                
                const prompt = 'ë‹¤ìŒì€ NewsAPIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ìµœì‹  í•œêµ­ ê¸ˆìœµ ë‰´ìŠ¤ë“¤ì…ë‹ˆë‹¤. ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ì§€ì„ ë‹¤ ê¸ˆìœµ í€´ì¦ˆ 3ë¬¸ì œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”:\n\n' +
                (newsData ? newsData.map(n => 'ì œëª©: ' + n.title + '\në‚´ìš©: ' + n.description + '\nì¶œì²˜: ' + n.source + '\në°œí–‰ì¼: ' + n.publishedAt).join('\n\n') : '') +
                '\n\në‹¤ìŒê³¼ ê°™ì€ ì •í™•í•œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš” (ì½”ë“œ ë¸”ë¡ ì—†ì´):\n\n' +
                '[\n' +
                '    {\n' +
                '        "question": "ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸ì œ 1",\n' +
                '        "options": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3", "ì„ íƒì§€4"],\n' +
                '        "correct": 0,\n' +
                '        "explanation": "ì‹¤ì œ ë‰´ìŠ¤ì™€ ì—°ê´€ëœ ì •ë‹µ ì„¤ëª…"\n' +
                '    },\n' +
                '    {\n' +
                '        "question": "ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸ì œ 2",\n' + 
                '        "options": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3", "ì„ íƒì§€4"],\n' +
                '        "correct": 1,\n' +
                '        "explanation": "ì‹¤ì œ ë‰´ìŠ¤ì™€ ì—°ê´€ëœ ì •ë‹µ ì„¤ëª…"\n' +
                '    },\n' +
                '    {\n' +
                '        "question": "ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸ì œ 3",\n' +
                '        "options": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3", "ì„ íƒì§€4"],\n' +
                '        "correct": 2,\n' +
                '        "explanation": "ì‹¤ì œ ë‰´ìŠ¤ì™€ ì—°ê´€ëœ ì •ë‹µ ì„¤ëª…"\n' +
                '    }\n' +
                ']\n\n' +
                'ì£¼ì˜ì‚¬í•­:\n' +
                '- ë¬¸ì œëŠ” ë°˜ë“œì‹œ ì œê³µëœ ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±\n' +
                '- ê° ë¬¸ì œë§ˆë‹¤ ì •í™•íˆ 4ê°œì˜ ì„ íƒì§€ ì œê³µ\n' +
                '- correctëŠ” ì •ë‹µ ì¸ë±ìŠ¤ (0, 1, 2, 3 ì¤‘ í•˜ë‚˜)\n' +
                '- ì„¤ëª…ì€ ì‹¤ì œ ë‰´ìŠ¤ì™€ ì—°ê´€ì§€ì–´ ì„¤ëª…\n' +
                '- ìˆœìˆ˜ JSONë§Œ ì‘ë‹µí•˜ê³  ì½”ë“œ ë¸”ë¡ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”\n' +
                '- ë°±í‹±(`)ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”';

                console.log('ğŸ§© ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ í€´ì¦ˆ ìƒì„± ì¤‘...');
                const geminiResponse = await callGeminiAPI(prompt);
                
                if (geminiResponse) {
                    try {
                        // JSON ë¸”ë¡ ì œê±° (```json ê³¼ ``` ì œê±°) - ë” ê°•ë ¥í•œ íŒ¨í„´
                        let cleanResponse = geminiResponse;
                        
                        // ë‹¤ì–‘í•œ ë§ˆí¬ë‹¤ìš´ ë¸”ë¡ ì œê±°
                        cleanResponse = cleanResponse.replace(/```json\s*/g, '');
                        cleanResponse = cleanResponse.replace(/```javascript\s*/g, '');
                        cleanResponse = cleanResponse.replace(/```\s*/g, '');
                        cleanResponse = cleanResponse.replace(/`/g, '');
                        
                        // ì•ë’¤ ê³µë°± ì œê±°
                        cleanResponse = cleanResponse.trim();
                        
                        // JSON ì‹œì‘ê³¼ ë í™•ì¸
                        if (!cleanResponse.startsWith('[')) {
                            const jsonStart = cleanResponse.indexOf('[');
                            if (jsonStart > -1) {
                                cleanResponse = cleanResponse.substring(jsonStart);
                            }
                        }
                        
                        if (!cleanResponse.endsWith(']')) {
                            const jsonEnd = cleanResponse.lastIndexOf(']');
                            if (jsonEnd > -1) {
                                cleanResponse = cleanResponse.substring(0, jsonEnd + 1);
                            }
                        }
                        
                        console.log('ğŸ” ì •ë¦¬ëœ JSON:', cleanResponse.substring(0, 100) + '...');
                        
                        // JSON íŒŒì‹± ì‹œë„
                        const quizData = JSON.parse(cleanResponse);
                        if (Array.isArray(quizData) && quizData.length === 3) {
                            console.log('âœ… ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ í€´ì¦ˆ ìƒì„± ì™„ë£Œ');
                            return quizData;
                        }
                    } catch (parseError) {
                        console.warn('âš ï¸ GEMINI ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                        console.log('ğŸ“ ì›ë³¸ ì‘ë‹µ:', geminiResponse.substring(0, 200) + '...');
                    }
                }
                
                console.log('âŒ ì‹¤ì œ NewsAPI ë‰´ìŠ¤ ê¸°ë°˜ í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨, ëŒ€ì²´ í€´ì¦ˆ ì‚¬ìš©');
                return getFallbackQuizData();
                
            } catch (error) {
                console.error('í€´ì¦ˆ ìƒì„± ì˜¤ë¥˜:', error);
                return getFallbackQuizData();
            }
        }

        // ëŒ€ì²´ í€´ì¦ˆ ë°ì´í„°
        function getFallbackQuizData() {
            return [
                {
                    question: "ìµœê·¼ í•œêµ­ì€í–‰ì˜ ê¸°ì¤€ê¸ˆë¦¬ ì •ì±… ë°©í–¥ì€?",
                    options: ["ì§€ì†ì  ì¸ìƒ", "ë™ê²° ìœ ì§€", "ì§€ì†ì  ì¸í•˜", "ë³€ë™ì„± í™•ëŒ€"],
                    correct: 1,
                    explanation: "ìµœê·¼ í•œêµ­ì€í–‰ì€ ì¸í”Œë ˆì´ì…˜ê³¼ ê²½ì œì„±ì¥ ê· í˜•ì„ ìœ„í•´ ê¸°ì¤€ê¸ˆë¦¬ë¥¼ ë™ê²° ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤."
                },
                {
                    question: "ë¶„ì‚°íˆ¬ìì˜ ì£¼ìš” ëª©ì ì€?",
                    options: ["ìˆ˜ìµë¥  ê·¹ëŒ€í™”", "ìœ„í—˜ ë¶„ì‚°", "ê±°ë˜ë¹„ìš© ì ˆì•½", "ì„¸ê¸ˆ ì ˆì•½"],
                    correct: 1,
                    explanation: "ë¶„ì‚°íˆ¬ìëŠ” ì—¬ëŸ¬ ìì‚°ì— íˆ¬ìí•˜ì—¬ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ìœ„í—˜ì„ ì¤„ì´ëŠ” ê²ƒì´ ì£¼ëª©ì ì…ë‹ˆë‹¤."
                },
                {
                    question: "ì£¼ì‹ íˆ¬ìì‹œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€?",
                    options: ["ë‹¨ê¸° ìˆ˜ìµ", "ê¸°ì—… ë¶„ì„", "ì‹œì¥ íƒ€ì´ë°", "ì†Œë¬¸ê³¼ ì¶”ì²œ"],
                    correct: 1,
                    explanation: "ì£¼ì‹ íˆ¬ìëŠ” ê¸°ì—…ì˜ ì¬ë¬´ìƒíƒœ, ì„±ì¥ì„±, ê²½ìŸë ¥ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤."
                }
            ];
        }

        // í•™ìŠµ ì½˜í…ì¸  ì—´ê¸° (ì¼ì¼ ìºì‹± ì‹œìŠ¤í…œ ì ìš©)
        async function openStudyContent(type) {
            const modal = document.getElementById('contentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = type;
            modalBody.innerHTML = '<div class="loading-spinner"></div><div style="text-align: center;">ì˜¤ëŠ˜ì˜ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>';
            
            modal.classList.add('show');
            
            try {
                let content;
                
                if (type === 'ê¸ˆìœµ ë‰´ìŠ¤') {
                    // ë‰´ìŠ¤ëŠ” ìºì‹±ëœ ë°ì´í„° ë˜ëŠ” ìƒˆë¡œ ìƒì„±
                    content = await getCachedDataOrUpdate('news', async () => {
                        const newsData = await getLatestFinanceNews();
                        return await generateFormattedNews(newsData);
                    });
                } else if (type === 'ê¸ˆìœµ ìš©ì–´') {
                    // ê¸ˆìœµ ìš©ì–´ëŠ” ìºì‹±ëœ ë°ì´í„° ë˜ëŠ” ìƒˆë¡œ ìƒì„±
                    content = await getCachedDataOrUpdate('terms', async () => {
                        const newsData = await getLatestFinanceNews();
                        return await generateContentWithGemini(type, newsData);
                    });
                } else if (type === 'ê¸ˆìœµ í€´ì¦ˆ') {
                    // í€´ì¦ˆëŠ” ìºì‹±ëœ ë°ì´í„° ë˜ëŠ” ìƒˆë¡œ ìƒì„±
                    const quizData = await getCachedDataOrUpdate('quiz', async () => {
                        const newsData = await getLatestFinanceNews();
                        return await generateQuizData(newsData);
                    });
                    content = await generateQuizInterface(quizData);
                } else {
                    // ê¸°íƒ€ ì½˜í…ì¸ 
                    const newsData = await getLatestFinanceNews();
                    content = await generateContentWithGemini(type, newsData);
                }
                
                modalBody.innerHTML = content;
                
                // í€´ì¦ˆê°€ ì•„ë‹Œ ê²½ìš° í•™ìŠµ ì™„ë£Œ ë²„íŠ¼ ì¶”ê°€
                if (type !== 'ê¸ˆìœµ í€´ì¦ˆ') {
                    addCompletionInterface(type);
                }
                
            } catch (error) {
                console.error('ì½˜í…ì¸  ë¡œë“œ ì‹¤íŒ¨:', error);
                modalBody.innerHTML = '<div style="text-align: center; color: red;">ì½˜í…ì¸  ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // í¬ë§·ëœ ë‰´ìŠ¤ ìƒì„± (ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ í˜•íƒœ)
        async function generateFormattedNews(newsData) {
            try {
                if (!newsData || newsData.length === 0) {
                    return '<div style="text-align: center; color: #666;">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }

                const today = new Date();
                const dateStr = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

                const prompt = 
                    'ë‹¤ìŒ ' + dateStr + ' ìµœì‹  ê¸ˆìœµ ë‰´ìŠ¤ë“¤ì„ ë¶„ì„í•˜ì—¬ ì£¼ìš” ë‚´ìš©ì„ ë²ˆí˜¸ë³„ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”:\n\n' +
                    newsData.map(n => 'ì œëª©: ' + n.title + '\në‚´ìš©: ' + n.description + '\nì¶œì²˜: ' + n.source + '\nì¹´í…Œê³ ë¦¬: ' + (n.category || 'ì¼ë°˜') + '\në§í¬: ' + n.url).join('\n\n') +
                    '\n\në‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš” (ì½”ë“œ ë¸”ë¡ ì—†ì´ ìˆœìˆ˜ HTMLë§Œ):\n\n' +
                    '<div style="padding: 20px; line-height: 1.6;">\n' +
                    '<h3 style="color: #333; margin-bottom: 20px;">ğŸ“ˆ ' + dateStr + ' ì£¼ìš” ê¸ˆìœµë‰´ìŠ¤</h3>\n\n' +
                    '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">\n' +
                    '<strong style="color: #007bff;"><a href="[ë‰´ìŠ¤ë§í¬]" target="_blank" style="color: #007bff; text-decoration: none;">1. [ì²« ë²ˆì§¸ ì£¼ìš” ë‰´ìŠ¤ ì œëª©]</a></strong><br>\n' +
                    '<span style="color: #666; font-size: 14px;">[í•µì‹¬ ë‚´ìš© ìš”ì•½ - 1-2ì¤„]</span><br>\n' +
                    '<small style="color: #999; font-size: 12px;">ì¶œì²˜: [ì¶œì²˜] | [ì¹´í…Œê³ ë¦¬]</small>\n' +
                    '</div>\n\n' +
                    '(ë‚˜ë¨¸ì§€ ë‰´ìŠ¤ë“¤ë„ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ...)\n\n' +
                    '<div style="background: #e8f4fd; padding: 15px; border-radius: 10px; margin-top: 20px;">\n' +
                    '<strong style="color: #0056b3;">ğŸ’¡ ' + dateStr + ' ê¸ˆìœµ í¬ì¸íŠ¸</strong><br>\n' +
                    '<span style="color: #666; font-size: 14px;">[ì˜¤ëŠ˜ ë‰´ìŠ¤ë“¤ì˜ ì „ì²´ì ì¸ ì‹œì¥ ì˜í–¥ì´ë‚˜ ì£¼ëª©í•  ì ]</span>\n' +
                    '</div>\n' +
                    '</div>\n\n' +
                    'ì£¼ì˜ì‚¬í•­:\n' +
                    '- ê° ë‰´ìŠ¤ ì œëª©ì€ ë°˜ë“œì‹œ <a> íƒœê·¸ë¡œ í´ë¦­ ê°€ëŠ¥í•œ ë§í¬ë¡œ ë§Œë“¤ê¸°\n' +
                    '- ì œê³µëœ ì‹¤ì œ ë‰´ìŠ¤ ë§í¬ë¥¼ hrefì— í¬í•¨\n' +
                    '- ë²ˆí˜¸ë¥¼ ë§¤ê²¨ì„œ ì½ê¸° ì‰½ê²Œ êµ¬ì„±\n' +
                    '- ì¶œì²˜ì™€ ì¹´í…Œê³ ë¦¬ ì •ë³´ í¬í•¨\n' +
                    '- ìˆœìˆ˜ HTMLë§Œ ì‘ë‹µí•˜ê³  ì½”ë“œ ë¸”ë¡(```html)ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”\n' +
                    '- ë°±í‹±(`)ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”';

                console.log(`ğŸ“° ${dateStr} ë‰´ìŠ¤ í¬ë§·íŒ… ì¤‘...`);
                const response = await callGeminiAPI(prompt);
                
                if (response && response.trim()) {
                    return response.trim();
                } else {
                    throw new Error('ë¹ˆ ì‘ë‹µ');
                }
                
            } catch (error) {
                console.error('ë‰´ìŠ¤ í¬ë§·íŒ… ì‹¤íŒ¨:', error);
                // ê¸°ë³¸ ë‰´ìŠ¤ í¬ë§· ë°˜í™˜ (ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨)
                const today = new Date();
                const dateStr = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;
                
                return `<div style="padding: 20px; line-height: 1.6;">
                    <h3 style="color: #333; margin-bottom: 20px;">ğŸ“ˆ ${dateStr} ì£¼ìš” ê¸ˆìœµë‰´ìŠ¤</h3>` +
                    newsData.slice(0, 4).map((news, index) => 
                        `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong style="color: #007bff;">
                                <a href="${news.url}" target="_blank" style="color: #007bff; text-decoration: none; cursor: pointer;" 
                                   onmouseover="this.style.textDecoration='underline'" 
                                   onmouseout="this.style.textDecoration='none'">
                                   ${index + 1}. ${news.title}
                                </a>
                            </strong><br>
                            <span style="color: #666; font-size: 14px;">${news.description}</span><br>
                            <small style="color: #999; font-size: 12px;">ì¶œì²˜: ${news.source} | ${news.category}</small>
                        </div>`
                    ).join('') +
                    `<div style="background: #e8f4fd; padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <strong style="color: #0056b3;">ğŸ’¡ ${dateStr} ê¸ˆìœµ í¬ì¸íŠ¸</strong><br>
                        <span style="color: #666; font-size: 14px;">ì˜¤ëŠ˜ì˜ ì£¼ìš” ê¸ˆìœµ ì´ìŠˆë“¤ì„ í†µí•´ ì‹œì¥ ë™í–¥ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                    </div>
                </div>`;
            }
        }

        // í€´ì¦ˆ ì¸í„°í˜ì´ìŠ¤ ìƒì„±
        async function generateQuizInterface(quizData) {
            if (!quizData || !Array.isArray(quizData) || quizData.length === 0) {
                return '<div style="text-align: center; color: #666;">í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            let quizHTML = '<div class="quiz-container">';
            quizHTML += '<h3 style="margin-bottom: 20px;">ğŸ“ ì˜¤ëŠ˜ì˜ ê¸ˆìœµ í€´ì¦ˆ</h3>';
            
            quizData.forEach((quiz, index) => {
                quizHTML += `
                    <div class="quiz-section" style="margin-bottom: 30px;">
                        <div class="quiz-question">${index + 1}. ${quiz.question}</div>
                        <div class="quiz-options" id="quiz-${index}">
                `;
                
                quiz.options.forEach((option, optionIndex) => {
                    quizHTML += `
                        <div class="quiz-option" 
                             data-quiz="${index}" 
                             data-option="${optionIndex}"
                             onclick="selectQuizOption(${index}, ${optionIndex})">
                            ${option}
                        </div>
                    `;
                });
                
                quizHTML += `
                        </div>
                        <div id="explanation-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; color: #333;">
                            ${quiz.explanation}
                        </div>
                    </div>
                `;
            });
            
            quizHTML += `
                <button class="quiz-submit" onclick="submitQuiz()">í€´ì¦ˆ ì œì¶œí•˜ê¸°</button>
                <div style="margin-top: 10px; text-align: center; font-size: 12px; color: #999;">
                    ë³´ìƒ: 50,000ì› + 100 EXP (70% ì´ìƒ ì •ë‹µ ì‹œ)
                </div>
            </div>`;
            
            // í€´ì¦ˆ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.currentQuizData = quizData;
            
            return quizHTML;
        }

        // í€´ì¦ˆ ì˜µì…˜ ì„ íƒ
        function selectQuizOption(quizIndex, optionIndex) {
            const options = document.querySelectorAll(`[data-quiz="${quizIndex}"]`);
            options.forEach(opt => opt.classList.remove('selected'));
            options[optionIndex].classList.add('selected');
        }

        // í€´ì¦ˆ ì œì¶œ
        function submitQuiz() {
            if (!window.currentQuizData) return;
            
            let correctCount = 0;
            const totalQuestions = window.currentQuizData.length;
            
            window.currentQuizData.forEach((quiz, index) => {
                const selectedOption = document.querySelector(`[data-quiz="${index}"].selected`);
                if (selectedOption) {
                    const selectedIndex = parseInt(selectedOption.dataset.option);
                    const options = document.querySelectorAll(`[data-quiz="${index}"]`);
                    
                    if (selectedIndex === quiz.correct) {
                        correctCount++;
                        selectedOption.classList.add('correct');
                    } else {
                        selectedOption.classList.add('incorrect');
                        options[quiz.correct].classList.add('correct');
                    }
                    
                    // ì„¤ëª… í‘œì‹œ
                    document.getElementById(`explanation-${index}`).style.display = 'block';
                }
            });
            
            const percentage = (correctCount / totalQuestions) * 100;
            
            // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelector('.quiz-submit').disabled = true;
            
            // 70% ì´ìƒ ë§ì·„ì„ ë•Œ ë³´ìƒ
            if (percentage >= 70) {
                setTimeout(() => {
                    completeStudy('ê¸ˆìœµ í€´ì¦ˆ', 50000, 100);
                }, 1500);
            } else {
                setTimeout(() => {
                    alert(`${correctCount}/${totalQuestions}ê°œ ì •ë‹µ! (${percentage.toFixed(0)}%)\n70% ì´ìƒ ë§ì¶°ì•¼ ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    closeModal();
                }, 1500);
            }
        }

        // í€´ì¦ˆ ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€ (ë‰´ìŠ¤ ê¸°ë°˜)
        // í•™ìŠµ ì™„ë£Œ ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€
        function addCompletionInterface(type) {
            const modalBody = document.getElementById('modalBody');
            const completionDiv = document.createElement('div');
            completionDiv.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px; border-top: 1px solid #eee;';
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 15px; color: #666;';
            messageDiv.textContent = 'í•™ìŠµì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            
            const button = document.createElement('button');
            button.className = 'quiz-submit';
            button.textContent = 'í•™ìŠµ ì™„ë£Œí•˜ê¸°';
            button.onclick = function() { completeStudy(type, 30000, 50); };
            
            const rewardDiv = document.createElement('div');
            rewardDiv.style.cssText = 'margin-top: 10px; font-size: 12px; color: #999;';
            rewardDiv.textContent = 'ë³´ìƒ: 30,000ì› + 50 EXP';
            
            completionDiv.appendChild(messageDiv);
            completionDiv.appendChild(button);
            completionDiv.appendChild(rewardDiv);
            modalBody.appendChild(completionDiv);
        }

        // í•™ìŠµ ì™„ë£Œ ì²˜ë¦¬
        async function completeStudy(type, cashReward, expReward) {
            try {
                const today = getTodayDate();
                if (!userAssets.studyProgress) userAssets.studyProgress = {};
                if (!userAssets.studyProgress[today]) userAssets.studyProgress[today] = {};
                
                // ì´ë¯¸ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸
                const typeKey = type === 'ê¸ˆìœµ ìš©ì–´' ? 'financialTerms' : 
                              type === 'ê¸ˆìœµ ë‰´ìŠ¤' ? 'financialNews' : 'financialQuiz';
                
                if (userAssets.studyProgress[today][typeKey]) {
                    alert('ì´ë¯¸ ì˜¤ëŠ˜ ì™„ë£Œí•œ ì½˜í…ì¸ ì…ë‹ˆë‹¤!');
                    return;
                }
                
                // ë³´ìƒ ì§€ê¸‰
                userAssets.cash = (userAssets.cash || 0) + cashReward;
                userAssets.totalAssets = (userAssets.totalAssets || 0) + cashReward;
                userAssets.virtualBalance = (userAssets.virtualBalance || 0) + cashReward;
                userAssets.exp = (userAssets.exp || 0) + expReward;
                
                // ë ˆë²¨ ì—… ì²´í¬
                const oldLevel = userAssets.level;
                userAssets.level = calculateUserLevel(userAssets.exp);
                
                // ì™„ë£Œ ìƒíƒœ ì €ì¥
                userAssets.studyProgress[today][typeKey] = true;
                userAssets.lastUpdated = new Date().toISOString();
                
                // Firebaseì— ì €ì¥
                const userRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}`);
                await window.firebaseSet(userRef, userAssets);
                
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                
                // ë³´ìƒ ì• ë‹ˆë©”ì´ì…˜
                showRewardAnimation(cashReward, expReward);
                
                // ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateCardCompletion(typeKey.replace(/([A-Z])/g, '-$1').toLowerCase().replace(/^-/, ''), true);
                
                // ë ˆë²¨ì—… ì²´í¬
                if (oldLevel !== userAssets.level) {
                    setTimeout(() => {
                        alert('ğŸ‰ ë ˆë²¨ ì—…! ' + oldLevel.toUpperCase() + ' â†’ ' + userAssets.level.toUpperCase());
                    }, 2000);
                }
                
                // ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeModal();
                }, 2000);
                
            } catch (error) {
                console.error('í•™ìŠµ ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ë³´ìƒ ì§€ê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ë“±ê¸‰ ì‹œìŠ¤í…œ ì„¤ì • (a1ê³¼ ë™ì¼)
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW ã….png', nav: 'YELLOW ã…‡', navImage: 'YELLOW ã…‡.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN ã….png', nav: 'GREEN ã…‡', navImage: 'GREEN ã…‡.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE ã….png', nav: 'BLUE ã…‡', navImage: 'BLUE ã…‡.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED ã….png', nav: 'RED ã…‡', navImage: 'RED ã…‡.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK ã….png', nav: 'BLACK ã…‡', navImage: 'BLACK ã…‡.png' }
        };

        // ì‚¬ìš©ì ë“±ê¸‰ ê³„ì‚° (a1ê³¼ ë™ì¼)
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK'; // ìµœê³  ë“±ê¸‰
        }

        // ë“±ê¸‰ë³„ ìƒ‰ìƒ ë°˜í™˜ (a1ê³¼ ë™ì¼)
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­
        function calculateUserGrade(exp) {
            return calculateUserLevel(exp).toLowerCase();
        }

        // ë³´ìƒ ì• ë‹ˆë©”ì´ì…˜
        function showRewardAnimation(cash, exp) {
            // ë³„ ë‚ ë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜
            const starPositions = [
                { x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight },
                { x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight },
                { x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight }
            ];
            
            starPositions.forEach((pos, i) => {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'star-fly';
                    star.innerHTML = 'â­';
                    star.style.left = pos.x + 'px';
                    star.style.top = pos.y + 'px';
                    document.body.appendChild(star);
                    
                    setTimeout(() => {
                        document.body.removeChild(star);
                    }, 1500);
                }, i * 200);
            });
            
            // ë³´ìƒ íŒì—…
            const rewardDiv = document.createElement('div');
            rewardDiv.className = 'reward-animation';
            rewardDiv.innerHTML = 'ğŸ‰ í•™ìŠµ ì™„ë£Œ!<br>ğŸ’° ' + cash.toLocaleString() + 'ì›<br>â­ ' + exp + ' EXP';
            document.body.appendChild(rewardDiv);
            
            setTimeout(() => {
                document.body.removeChild(rewardDiv);
            }, 2000);
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('contentModal').classList.remove('show');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“š A2 í˜ì´ì§€ ë¡œë“œë¨');
            
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!checkLoginStatus()) return;
            
            // Firebase ë°ì´í„° ë¡œë“œ
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            // ìˆœì°¨ì ìœ¼ë¡œ ìš”ì†Œë“¤ì´ ë‚˜íƒ€ë‚˜ë„ë¡ ì„¤ì •
            const cards = document.querySelectorAll('.fade-in');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });

        // ì‚¬ìš©ì ë“±ê¸‰ ë¡œë“œ ë° í‘œì‹œ
        async function loadUserGrade() {
            try {
                if (!window.firebaseDB || !currentUser) {
                    console.log('ğŸ”¥ Firebase ë˜ëŠ” ì‚¬ìš©ì ì •ë³´ ëŒ€ê¸° ì¤‘...');
                    setTimeout(loadUserGrade, 500);
                    return;
                }
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}`);
                const snapshot = await window.firebaseGet(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const experience = userData.experience || 0;
                    const grade = calculateUserGrade(experience);
                    
                    // ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                    updateGradeButton(grade);
                }
            } catch (error) {
                console.error('A2 ë“±ê¸‰ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (a1ê³¼ ë™ì¼í•œ ë¡œì§)
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                // ë“±ê¸‰ ë²„íŠ¼ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                if (gradeButtonImage && levelData.navImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    console.log('ğŸ–ï¸ A2 ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸:', upperGrade, levelData.navImage);
                }
            }
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
        function goToPage(page) {
            console.log('ğŸ”„ A2ì—ì„œ í˜ì´ì§€ ì´ë™:', page);
            
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // í˜ì´ì§€ ì´ë™
            if (page !== 'a2.html') {
                window.location.href = page;
            } else {
                // í˜„ì¬ í˜ì´ì§€ë©´ í™œì„± ìƒíƒœ ìœ ì§€
                const currentNavItem = document.querySelector('.nav-item[onclick*="a2.html"]');
                if (currentNavItem) {
                    currentNavItem.classList.add('active');
                }
            }
        }

        // ê¸°íƒ€ í•¨ìˆ˜ë“¤
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('fineu_current_user');
                localStorage.removeItem('fineu_user_assets');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('ğŸ“š ìƒˆë¡œìš´ í•™ìŠµ ì½˜í…ì¸ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâ€¢ ì˜¤ëŠ˜ì˜ ê¸ˆìœµ ìš©ì–´\nâ€¢ ìµœì‹  ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„\nâ€¢ ê¸ˆìœµ í€´ì¦ˆ ì±Œë¦°ì§€\n\nì§€ê¸ˆ ë°”ë¡œ í•™ìŠµí•˜ê³  ë³´ìƒì„ ë°›ì•„ë³´ì„¸ìš”!');
        }
    </script>
</body>
</html>