<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - ÎçîÎ≥¥Í∏∞</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        // Firebase Ï¥àÍ∏∞Ìôî
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        console.log('üî• A2 Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        
        // Ï†ÑÏó≠ÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù ÏÑ§Ï†ï
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        console.log('üî• A2 Firebase Ï†ÑÏó≠ ÏÑ§Ï†ï ÏôÑÎ£å');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Í≥µÌÜµ Ìó§Îçî */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        /* ÌïôÏäµ Ïπ¥Îìú */
        .study-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .study-card:active {
            transform: translateY(0);
        }

        .study-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .star-icon {
            color: #ffd700;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .star-icon.completed {
            color: #4CAF50;
            animation: sparkle 0.6s ease-in-out;
        }

        .study-card.completed {
            background: linear-gradient(135deg, #f0f8f0, #e8f5e8);
            border: 2px solid #4CAF50;
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            line-height: 1.6;
            color: #333;
        }

        .content-section {
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .content-text {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* ÌÄ¥Ï¶à Ïä§ÌÉÄÏùº */
        .quiz-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .quiz-question {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quiz-option {
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .quiz-option:hover {
            border-color: #7cb9e8;
            background: #f0f8ff;
        }

        .quiz-option.selected {
            border-color: #7cb9e8;
            background: #e6f3ff;
        }

        .quiz-option.correct {
            border-color: #4CAF50;
            background: #e8f5e8;
            color: #2e7d32;
        }

        .quiz-option.incorrect {
            border-color: #f44336;
            background: #ffebee;
            color: #c62828;
        }

        .quiz-submit {
            width: 100%;
            padding: 12px;
            background: #7cb9e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-submit:hover {
            background: #5da8d4;
        }

        .quiz-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7cb9e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        /* Î≥¥ÏÉÅ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .reward-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 20px 30px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
            animation: rewardPop 2s ease-in-out forwards;
        }

        .star-fly {
            position: absolute;
            color: #ffd700;
            font-size: 24px;
            pointer-events: none;
            animation: starFly 1.5s ease-out forwards;
        }

        /* Íµ¨Î∂ÑÏÑ† */
        .divider {
            height: 2px;
            background: #333;
            margin: 30px 0;
            border-radius: 1px;
        }

        /* Ïä§ÌÅ¨Îû© ÏòÅÏó≠ */
        .scrap-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scrap-content {
            text-align: center;
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }

        /* ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/Î∞∞Í≤Ω.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* Ï§ëÏïô Î∞òÏõê ÎèåÏ∂ú Î∂ÄÎ∂Ñ Ï∂îÍ∞Ä */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/Î∞∞Í≤Ω.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .black-button {
            width: 55px;
            height: 55px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 150;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: #fafaf8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 150;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }
        
        .black-button:hover {
            transform: scale(1.1);
        }

        /* Îì±Í∏âÎ≥Ñ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .yellow-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .green-button {
            background: linear-gradient(45deg, #32CD32, #228B22);
            color: white;
        }
        
        .blue-button {
            background: linear-gradient(45deg, #1E90FF, #0066CC);
            color: white;
        }
        
        .red-button {
            background: linear-gradient(45deg, #FF4444, #CC0000);
            color: white;
        }
        
        .black-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes rewardPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        @keyframes starFly {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.5);
            }
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/Î†àÏù¥Ïñ¥ 1.png" alt="FINE U Î°úÍ≥†" class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
    <div class="main-content">
        <div class="page-title">STUDY ZONE</div>

        <!-- ÌïôÏäµ Î©îÎâ¥Îì§ -->
        <div class="study-card fade-in" id="card-financial-terms" onclick="openStudyContent('Í∏àÏúµ Ïö©Ïñ¥')" style="animation-delay: 0.1s">
            <div class="study-title">Í∏àÏúµ Ïö©Ïñ¥</div>
            <i class="fas fa-star star-icon" id="star-financial-terms"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-news" onclick="openStudyContent('Í∏àÏúµ Îâ¥Ïä§')" style="animation-delay: 0.2s">
            <div class="study-title">Í∏àÏúµ Îâ¥Ïä§</div>
            <i class="fas fa-star star-icon" id="star-financial-news"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-quiz" onclick="openStudyContent('Í∏àÏúµ ÌÄ¥Ï¶à')" style="animation-delay: 0.3s">
            <div class="study-title">Í∏àÏúµ ÌÄ¥Ï¶à</div>
            <i class="fas fa-star star-icon" id="star-financial-quiz"></i>
        </div>

        <!-- Íµ¨Î∂ÑÏÑ† -->
        <div class="divider"></div>

        <!-- Ïä§ÌÅ¨Îû© ÏòÅÏó≠ -->
        <div class="scrap-section fade-in" style="animation-delay: 0.4s">
            <div class="scrap-content">
                Ïä§ÌÅ¨Îû©
            </div>
        </div>
    </div>

    <!-- ÏΩòÌÖêÏ∏† Î™®Îã¨ -->
    <div class="modal" id="contentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Í∏àÏúµ ÏΩòÌÖêÏ∏†</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ÏΩòÌÖêÏ∏†Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/Ïßë.png" alt="Ìôà">
            </div>
        </div>
        <div class="nav-item active" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/Î¨∏ÏÑú.png" alt="Î¨∏ÏÑú">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW „Öá.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/Ï±ÑÌåÖ.png" alt="Ï±ÑÌåÖ">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ÎçîÎ≥¥Í∏∞.png" alt="ÎçîÎ≥¥Í∏∞">
            </div>
        </div>
    </div>

    <script>
        // API ÌÇ§Îì§
        const GEMINI_API_KEY = 'AIzaSyBJhMtNOYyCfl6NRCQQz_CkTUHWP2TNweI';
        
        // Firebase ÏÇ¨Ïö©Ïûê Î∞è Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let userAssets = {};
        let todayContent = {};
        
        // Î°úÍ∑∏Ïù∏ ÌôïÏù∏ Î∞è Firebase Ïó∞Í≤∞
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                console.log('‚ùå Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏóÜÏùå - index.htmlÎ°ú Ïù¥Îèô');
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            console.log('‚úÖ A2 Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê:', currentUser.id);
            return true;
        }
        
        // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (a1Í≥º ÎèôÏùº)
        async function loadUserDataFromFirebase() {
            console.log('=== A2 Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë ===');
            
            try {
                // 1. Firebase Ïó∞Í≤∞ ÌôïÏù∏
                if (!window.firebaseDB) {
                    console.log('A2 Firebase Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...');
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }
                console.log('‚úÖ A2 Firebase Ïó∞Í≤∞ ÌôïÏù∏Îê®');

                // 2. Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò§Í∏∞ ÎòêÎäî Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('üë§ A2 ÏÇ¨Ïö©Ïûê ID:', userId);
                
                // 3. FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);
                console.log('üìä A2 Îç∞Ïù¥ÌÑ∞ Ïä§ÎÉÖÏÉ∑ ÌôïÏù∏:', snapshot.exists());

                if (snapshot.exists()) {
                    // FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ
                    const firebaseData = snapshot.val();
                    console.log('‚úÖ A2 Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:', firebaseData);
                    
                    // userAssetsÏóê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {}
                    };
                    
                    console.log('‚úÖ A2 userAssets ÏÑ§Ï†ï ÏôÑÎ£å:', userAssets);
                    
                    // Îì±Í∏â ÏóÖÎç∞Ïù¥Ìä∏
                    const currentLevel = calculateUserLevel(userAssets.exp || userAssets.experience || 0);
                    userAssets.level = currentLevel.toLowerCase();
                    updateGradeButton(userAssets.level);
                    
                } else {
                    // FirebaseÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                    console.log('‚ùå A2 FirebaseÏóê Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå - Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï');
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 10000000,
                        totalAssets: 10000000,
                        virtualBalance: 10000000,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {}
                    };
                    updateGradeButton('yellow');
                }
                
                // 5. localStorageÏóê Î∞±ÏóÖ Ï†ÄÏû•
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                console.log('‚úÖ A2 localStorage Î∞±ÏóÖ ÏôÑÎ£å');

                // 6. Ïò§ÎäòÏùò ÏôÑÎ£å ÏÉÅÌÉú ÌôïÏù∏
                checkTodayCompletion();

            } catch (error) {
                console.error('‚ùå A2 Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 10000000,
                    level: 'yellow',
                    exp: 0,
                    experience: 0,
                    studyProgress: {}
                };
                updateGradeButton('yellow');
            }
        }

        // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî (Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
        async function syncUserData() {
            return await loadUserDataFromFirebase();
        }

        // Ïò§Îäò ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // Ïò§ÎäòÏùò ÏôÑÎ£å ÏÉÅÌÉú ÌôïÏù∏
        function checkTodayCompletion() {
            const today = getTodayDate();
            if (!userAssets.studyProgress) userAssets.studyProgress = {};
            if (!userAssets.studyProgress[today]) userAssets.studyProgress[today] = {};

            const todayProgress = userAssets.studyProgress[today];
            
            // Í∞Å ÏΩòÌÖêÏ∏†Î≥Ñ ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updateCardCompletion('financial-terms', todayProgress.financialTerms || false);
            updateCardCompletion('financial-news', todayProgress.financialNews || false);
            updateCardCompletion('financial-quiz', todayProgress.financialQuiz || false);
        }

        // Ïπ¥Îìú ÏôÑÎ£å ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateCardCompletion(type, completed) {
            const card = document.getElementById(`card-${type}`);
            const star = document.getElementById(`star-${type}`);
            
            if (completed) {
                card.classList.add('completed');
                star.classList.add('completed');
            } else {
                card.classList.remove('completed');
                star.classList.remove('completed');
            }
        }

        // RSSÎ•º ÌÜµÌïú Ïã§Ï†ú ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ Í∞ÄÏ†∏Ïò§Í∏∞ (Îã§Ï§ë ÌîÑÎ°ùÏãú Î∞©Î≤ï)
        async function getLatestFinanceNews() {
            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}ÎÖÑ ${today.getMonth() + 1}Ïõî ${today.getDate()}Ïùº`;
                
                console.log(`üîç RSSÎ°ú ${dateStr} ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ Í≤ÄÏÉâ Ï§ë...`);
                
                // Ïó¨Îü¨ RSS ÌîÑÎ°ùÏãú ÏÑúÎπÑÏä§ ÏãúÎèÑ
                const rssProxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];
                
                // Google News RSS URLÎì§ (ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§)
                const rssUrls = [
                    'https://news.google.com/rss/search?q=Í∏àÏúµ+site:yna.co.kr&hl=ko&gl=KR',
                    'https://news.google.com/rss/search?q=ÏΩîÏä§Ìîº+site:mk.co.kr&hl=ko&gl=KR',
                    'https://news.google.com/rss/search?q=ÌïúÍµ≠ÏùÄÌñâ+site:hankyung.com&hl=ko&gl=KR',
                    'https://news.google.com/rss/search?q=Í≤ΩÏ†ú+site:chosun.com&hl=ko&gl=KR'
                ];
                
                let allNews = [];
                
                for (const rssUrl of rssUrls) {
                    let success = false;
                    
                    for (const proxy of rssProxies) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent(rssUrl);
                            const response = await fetch(proxyUrl);
                            
                            if (response.ok) {
                                const data = await response.text();
                                const newsItems = parseRSSData(data);
                                
                                if (newsItems && newsItems.length > 0) {
                                    allNews.push(...newsItems.slice(0, 2)); // Í∞Å RSSÎãπ ÏµúÎåÄ 2Í∞ú
                                    success = true;
                                    console.log(`‚úÖ RSS ÏÑ±Í≥µ: ${newsItems.length}Í±¥ Í∞ÄÏ†∏Ïò¥`);
                                    break; // ÏÑ±Í≥µÌïòÎ©¥ Îã§Ïùå RSSÎ°ú
                                }
                            }
                        } catch (error) {
                            console.warn(`RSS ÌîÑÎ°ùÏãú Ïã§Ìå® (${proxy}):`, error);
                        }
                    }
                    
                    if (!success) {
                        console.warn(`Î™®Îì† ÌîÑÎ°ùÏãúÏóêÏÑú RSS Ïã§Ìå®: ${rssUrl}`);
                    }
                }
                
                if (allNews.length > 0) {
                    // Ï§ëÎ≥µ Ï†úÍ±∞ Î∞è Ï†ïÎ¶¨
                    const uniqueNews = allNews
                        .filter((item, index, self) => 
                            index === self.findIndex(t => t.title === item.title)
                        )
                        .slice(0, 4)
                        .map(item => ({
                            title: item.title.replace(/<[^>]*>/g, ''), // HTML ÌÉúÍ∑∏ Ï†úÍ±∞
                            description: item.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...', // HTML ÌÉúÍ∑∏ Ï†úÍ±∞ Î∞è Í∏∏Ïù¥ Ï†úÌïú
                            url: item.url,
                            source: item.source || 'Google News',
                            category: 'Í∏àÏúµÎâ¥Ïä§',
                            publishedAt: item.publishedAt || today.toISOString()
                        }));
                
                    if (uniqueNews.length > 0) {
                        console.log(`‚úÖ RSS ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ ${uniqueNews.length}Í±¥ Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å`);
                        return uniqueNews;
                    }
                }
                
                console.log('RSS Îâ¥Ïä§ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå, GEMINIÎ°ú ÏÉùÏÑ±');
                return await generateNewsWithGemini();
                
            } catch (error) {
                console.error('‚ùå RSS Îâ¥Ïä§ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
                // RSS Ïã§Ìå® Ïãú GEMINI AIÎ°ú Îâ¥Ïä§ ÏÉùÏÑ±
                return await generateNewsWithGemini();
            }
        }

        // RSS XML Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ìï®Ïàò
        function parseRSSData(xmlText) {
            try {
                // AllOriginsÏùò Í≤ΩÏö∞ JSONÏúºÎ°ú ÎûòÌïëÎêòÏñ¥ ÏûàÏùÑ Ïàò ÏûàÏùå
                if (xmlText.includes('"contents"')) {
                    const jsonData = JSON.parse(xmlText);
                    xmlText = jsonData.contents;
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');
                
                const newsItems = [];
                items.forEach((item, index) => {
                    if (index < 3) { // ÏµúÎåÄ 3Í∞úÎßå
                        const title = item.querySelector('title')?.textContent;
                        const description = item.querySelector('description')?.textContent;
                        const link = item.querySelector('link')?.textContent;
                        const pubDate = item.querySelector('pubDate')?.textContent;
                        
                        if (title && description && link) {
                            // Í∏àÏúµ Í¥ÄÎ†® Îâ¥Ïä§Îßå ÌïÑÌÑ∞ÎßÅ
                            if (title.includes('Í∏àÏúµ') || 
                                title.includes('Í≤ΩÏ†ú') || 
                                title.includes('ÏΩîÏä§Ìîº') || 
                                title.includes('ÏΩîÏä§Îã•') || 
                                title.includes('ÌïúÍµ≠ÏùÄÌñâ') || 
                                title.includes('Í∏àÎ¶¨') || 
                                title.includes('ÌôòÏú®') || 
                                title.includes('ÏÇºÏÑ±Ï†ÑÏûê') ||
                                title.includes('Ï£ºÏãù') ||
                                title.includes('Ìà¨Ïûê') ||
                                title.includes('Ï¶ùÏãú') ||
                                title.includes('Í∏∞ÏóÖ') ||
                                title.includes('ÏãúÏû•')) {
                                
                                newsItems.push({
                                    title: title,
                                    description: description,
                                    url: link,
                                    source: 'Google News',
                                    publishedAt: pubDate || new Date().toISOString()
                                });
                            }
                        }
                    }
                });
                
                return newsItems;
            } catch (error) {
                console.error('RSS ÌååÏã± Ïò§Î•ò:', error);
                return [];
            }
        }

        // GEMINI AIÎ°ú Îâ¥Ïä§ ÏÉùÏÑ± (RSS ÎåÄÏ≤¥)
        async function generateNewsWithGemini() {
            try {
                const currentDate = new Date();
                const currentDateStr = `${currentDate.getFullYear()}ÎÖÑ ${currentDate.getMonth() + 1}Ïõî ${currentDate.getDate()}Ïùº`;
                
                const prompt = `Generate 4 realistic Korean financial news items for ${currentDateStr}. Return only valid JSON array:

[
    {
        "title": "Ïã§Ï†ú Í∞ôÏùÄ ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ Ï†úÎ™© 1",
        "description": "Îâ¥Ïä§ ÎÇ¥Ïö© ÏÑ§Î™Ö (2-3Ï§Ñ)",
        "url": "https://news.google.com/articles/article1",
        "source": "Google News",
        "category": "Í∏àÏúµÎâ¥Ïä§",
        "publishedAt": "${currentDate.toISOString()}"
    },
    {
        "title": "Ïã§Ï†ú Í∞ôÏùÄ ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ Ï†úÎ™© 2",
        "description": "Îâ¥Ïä§ ÎÇ¥Ïö© ÏÑ§Î™Ö (2-3Ï§Ñ)",
        "url": "https://news.google.com/articles/article2",
        "source": "Google News",
        "category": "Í∏àÏúµÎâ¥Ïä§",
        "publishedAt": "${currentDate.toISOString()}"
    },
    {
        "title": "Ïã§Ï†ú Í∞ôÏùÄ ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ Ï†úÎ™© 3",
        "description": "Îâ¥Ïä§ ÎÇ¥Ïö© ÏÑ§Î™Ö (2-3Ï§Ñ)",
        "url": "https://news.google.com/articles/article3",
        "source": "Google News",
        "category": "Í∏àÏúµÎâ¥Ïä§",
        "publishedAt": "${currentDate.toISOString()}"
    },
    {
        "title": "Ïã§Ï†ú Í∞ôÏùÄ ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ Ï†úÎ™© 4",
        "description": "Îâ¥Ïä§ ÎÇ¥Ïö© ÏÑ§Î™Ö (2-3Ï§Ñ)",
        "url": "https://news.google.com/articles/article4",
        "source": "Google News",
        "category": "Í∏àÏúµÎâ¥Ïä§",
        "publishedAt": "${currentDate.toISOString()}"
    }
]

Topics: ÌïúÍµ≠ÏùÄÌñâ Í∏∞Ï§ÄÍ∏àÎ¶¨, ÏΩîÏä§Ìîº/ÏΩîÏä§Îã• ÎèôÌñ•, ÌôòÏú®, Ï£ºÏöî Í∏∞ÏóÖ Ïã§Ï†Å, Î∂ÄÎèôÏÇ∞ Í∏àÏúµ Îì±
Return ONLY the JSON array. No explanations.`;

                console.log(`ü§ñ GEMINI AIÎ°ú ${currentDateStr} Îâ¥Ïä§ ÏÉùÏÑ± Ï§ë...`);
                const geminiResponse = await callGeminiAPI(prompt);
                
                if (geminiResponse) {
                    try {
                        let cleanResponse = geminiResponse.trim();
                        cleanResponse = cleanResponse.replace(/```json\s*/gi, '');
                        cleanResponse = cleanResponse.replace(/```\s*/g, '');
                        cleanResponse = cleanResponse.replace(/`/g, '');
                        
                        if (!cleanResponse.startsWith('[')) {
                            const jsonStart = cleanResponse.indexOf('[');
                            if (jsonStart > -1) {
                                cleanResponse = cleanResponse.substring(jsonStart);
                            }
                        }
                        
                        if (!cleanResponse.endsWith(']')) {
                            const jsonEnd = cleanResponse.lastIndexOf(']');
                            if (jsonEnd > -1) {
                                cleanResponse = cleanResponse.substring(0, jsonEnd + 1);
                            }
                        }
                        
                        const newsData = JSON.parse(cleanResponse);
                        
                        if (Array.isArray(newsData) && newsData.length > 0) {
                            console.log(`‚úÖ GEMINI AI Îâ¥Ïä§ ÏÉùÏÑ± ÏôÑÎ£å: ${newsData.length}Í±¥`);
                            return newsData;
                        }
                    } catch (parseError) {
                        console.warn('‚ö†Ô∏è GEMINI Îâ¥Ïä§ JSON ÌååÏã± Ïã§Ìå®:', parseError);
                    }
                }
                
                // GEMINIÎèÑ Ïã§Ìå® Ïãú ÎåÄÏ≤¥ Îâ¥Ïä§
                console.log('‚ùå GEMINI Îâ¥Ïä§ ÏÉùÏÑ± Ïã§Ìå®, ÎåÄÏ≤¥ Îâ¥Ïä§ ÏÇ¨Ïö©');
                const fallbackDate = new Date();
                const fallbackDateStr = `${fallbackDate.getFullYear()}ÎÖÑ ${fallbackDate.getMonth() + 1}Ïõî ${fallbackDate.getDate()}Ïùº`;
                return getFallbackNews(fallbackDateStr);
                
            } catch (error) {
                console.error('GEMINI Îâ¥Ïä§ ÏÉùÏÑ± Ïò§Î•ò:', error);
                const errorDate = new Date();
                const errorDateStr = `${errorDate.getFullYear()}ÎÖÑ ${errorDate.getMonth() + 1}Ïõî ${errorDate.getDate()}Ïùº`;
                return getFallbackNews(errorDateStr);
            }
        }

        // ÎåÄÏ≤¥ Îâ¥Ïä§ ÏÉùÏÑ± (NewsAPI Ïã§Ìå® Ïãú)
        function getFallbackNews(dateStr) {
            const today = new Date();
            const kospiPrice = 2650 + Math.floor(Math.random() * 100); // 2650-2750 ÏÇ¨Ïù¥
            const usdRate = 1320 + Math.floor(Math.random() * 50); // 1320-1370 ÏÇ¨Ïù¥
            
            return [
                {
                    title: `${dateStr} ÌïúÍµ≠ÏùÄÌñâ ÌÜµÌôîÏ†ïÏ±Ö ÌòÑÌô© - Í∏∞Ï§ÄÍ∏àÎ¶¨ 3.50% Ïú†ÏßÄ`,
                    description: `ÌïúÍµ≠ÏùÄÌñâÏù¥ ${today.getMonth() + 1}Ïõî Í∏àÏúµÌÜµÌôîÏúÑÏõêÌöåÏóêÏÑú ÌòÑÌñâ Í∏∞Ï§ÄÍ∏àÎ¶¨ 3.50%Î•º Ïú†ÏßÄÌïòÍ∏∞Î°ú Í≤∞Ï†ïÌñàÏäµÎãàÎã§. Ïù∏ÌîåÎ†àÏù¥ÏÖò ÏïïÎ†•Í≥º Í≤ΩÏ†úÏÑ±Ïû•ÏÑ∏Î•º Ï¢ÖÌï© Í≥†Î†§Ìïú Í≤∞Í≥ºÎ°ú Î∂ÑÏÑùÎê©ÎãàÎã§.`,
                    url: "https://www.bok.or.kr/",
                    source: "ÌïúÍµ≠ÏùÄÌñâ",
                    category: "ÌÜµÌôîÏ†ïÏ±Ö",
                    publishedAt: today.toISOString()
                },
                {
                    title: `ÏΩîÏä§Ìîº ${kospiPrice}ÏÑ†ÏóêÏÑú Îì±ÎùΩ - Ïô∏Íµ≠Ïù∏ Ìà¨Ïûê ÎèôÌñ• Ï£ºÎ™©`,
                    description: `${dateStr} Íµ≠ÎÇ¥ Ï¶ùÏãúÍ∞Ä ${kospiPrice}ÎåÄÏóêÏÑú Îì±ÎùΩÏùÑ Í±∞Îì≠ÌïòÍ≥† ÏûàÏäµÎãàÎã§. Î∞òÎèÑÏ≤¥ÏôÄ 2Ï∞®Ï†ÑÏßÄ ÏóÖÏ¢ÖÏùÑ Ï§ëÏã¨ÏúºÎ°ú Ïô∏Íµ≠Ïù∏ Ìà¨ÏûêÏûêÎì§Ïùò Îß§Îß§ Ìå®ÌÑ¥Ïù¥ ÏãúÏû• Î∞©Ìñ•ÏÑ±ÏùÑ Ï¢åÏö∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§.`,
                    url: "https://finance.naver.com/sise/",
                    source: "ÌïúÍµ≠Í±∞ÎûòÏÜå",
                    category: "Ï¶ùÏãúÎèôÌñ•",
                    publishedAt: today.toISOString()
                },
                {
                    title: `Îã¨Îü¨-Ïõê ÌôòÏú® ${usdRate}ÏõêÎåÄ - ÎØ∏ Ïó∞Ï§Ä Ï†ïÏ±Ö ÏòÅÌñ•`,
                    description: `${dateStr} Ïõê-Îã¨Îü¨ ÌôòÏú®Ïù¥ ${usdRate}ÏõêÎåÄÏóêÏÑú ÌòïÏÑ±ÎêòÍ≥† ÏûàÏäµÎãàÎã§. ÎØ∏Íµ≠ Ïó∞Î∞©Ï§ÄÎπÑÏ†úÎèÑÏùò ÌÜµÌôîÏ†ïÏ±Ö Î∞©Ìñ•Í≥º Íµ≠ÎÇ¥ Í≤ΩÏ†úÏßÄÌëúÍ∞Ä ÌôòÏú® Î≥ÄÎèôÏùò Ï£ºÏöî ÏöîÏù∏ÏúºÎ°ú ÏûëÏö©ÌïòÍ≥† ÏûàÏäµÎãàÎã§.`,
                    url: "https://www.koreaexim.go.kr/",
                    source: "ÌïúÍµ≠ÏàòÏ∂úÏûÖÏùÄÌñâ",
                    category: "ÌôòÏú®ÎèôÌñ•",
                    publishedAt: today.toISOString()
                },
                {
                    title: `ÏÇºÏÑ±Ï†ÑÏûê ${today.getMonth() + 1}Ïõî Ïã§Ï†Å Ï†ÑÎßù - Î©îÎ™®Î¶¨ Î∞òÎèÑÏ≤¥ ÏàòÏöî ÌöåÎ≥µ`,
                    description: `ÏÇºÏÑ±Ï†ÑÏûêÏùò ${today.getMonth() + 1}Ïõî Ïã§Ï†ÅÏóê ÎåÄÌïú ÏãúÏû• Í¥ÄÏã¨Ïù¥ ÎÜíÏïÑÏßÄÍ≥† ÏûàÏäµÎãàÎã§. Î©îÎ™®Î¶¨ Î∞òÎèÑÏ≤¥ ÏóÖÌô© Í∞úÏÑ†Í≥º Ïä§ÎßàÌä∏Ìè∞ ÏÇ¨ÏóÖ Î∂ÄÎ¨∏Ïùò ÏïàÏ†ïÏ†Å ÏÑ±Ïû•Ïù¥ Ï£ºÏöî Ìè¨Ïù∏Ìä∏Î°ú Î∂ÑÏÑùÎê©ÎãàÎã§.`,
                    url: "https://news.samsung.com/kr/",
                    source: "ÏÇºÏÑ±Ï†ÑÏûê",
                    category: "Í∏∞ÏóÖÏã§Ï†Å",
                    publishedAt: today.toISOString()
                }
            ];
        }

        // Ïã§Ï†ú GEMINI AI API Ìò∏Ï∂ú
        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`GEMINI API Ïò§Î•ò: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    let result = data.candidates[0].content.parts[0].text;
                    
                    // Î™®Îì† Ï¢ÖÎ•òÏùò ÏΩîÎìú Î∏îÎ°ù Ï†úÍ±∞ (Îçî Í∞ïÎ†•Ìïú Ìå®ÌÑ¥)
                    result = result.replace(/```html\s*/gi, '');
                    result = result.replace(/```javascript\s*/gi, '');
                    result = result.replace(/```css\s*/gi, '');
                    result = result.replace(/```json\s*/gi, '');
                    result = result.replace(/```\s*/g, '');
                    result = result.replace(/`{3,}/g, '');
                    
                    // ÏãúÏûëÍ≥º ÎÅùÏùò Î∞±Ìã± Ï†úÍ±∞
                    result = result.replace(/^`+/gm, '');
                    result = result.replace(/`+$/gm, '');
                    
                    // Î∂àÌïÑÏöîÌïú Í≥µÎ∞± Ï†ïÎ¶¨
                    result = result.trim();
                    
                    console.log('üßπ HTML Î∏îÎ°ù Ï†úÍ±∞ ÏôÑÎ£å');
                    return result;
                } else {
                    throw new Error('GEMINI API ÏùëÎãµ ÌòïÏãù Ïò§Î•ò');
                }
                
            } catch (error) {
                console.error('GEMINI API Ìò∏Ï∂ú Ïã§Ìå®:', error);
                return null;
            }
        }

        // GEMINI AIÎ°ú NewsAPI Îâ¥Ïä§ Ï†ïÎ¶¨ Î∞è Î∂ÑÏÑù
        async function generateContentWithGemini(type, newsData = null) {
            try {
                let prompt = '';
                let newsLinks = '';
                
                switch(type) {
                    case 'Í∏àÏúµ Ïö©Ïñ¥':
                        // NewsAPIÏóêÏÑú Í∞ÄÏ†∏Ïò® Ïã§Ï†ú Îâ¥Ïä§Î•º Î∞îÌÉïÏúºÎ°ú Í∏àÏúµ Ïö©Ïñ¥ ÏÑ§Î™Ö
                        const termNewsData = newsData || await getLatestFinanceNews();
                        prompt = 'Îã§ÏùåÏùÄ NewsAPIÏóêÏÑú Í∞ÄÏ†∏Ïò® Ïã§Ï†ú ÏµúÏã† ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§ÏûÖÎãàÎã§. Ïù¥ Îâ¥Ïä§Îì§ÏóêÏÑú Ïñ∏Í∏âÎêú Í∏àÏúµ Ïö©Ïñ¥Îì§ÏùÑ Ï∞æÏïÑÏÑú 3Í∞úÎ•º ÏÑ†Î≥ÑÌïòÏó¨ ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî:\n\n' +
                        (termNewsData ? termNewsData.map(n => 'Ï†úÎ™©: ' + n.title + '\nÎÇ¥Ïö©: ' + n.description + '\nÏ∂úÏ≤ò: ' + n.source + '\nÎ∞úÌñâÏùº: ' + n.publishedAt).join('\n\n') : '') +
                        '\n\nÎã§ÏùåÍ≥º Í∞ôÏùÄ Ï†ïÌôïÌïú ÌòïÏãùÏúºÎ°úÎßå ÏùëÎãµÌï¥Ï£ºÏÑ∏Ïöî (ÏΩîÎìú Î∏îÎ°ù ÏóÜÏù¥):\n\n' +
                        '<div class="content-section">\n' +
                        '<div class="content-title">üìö ' + new Date().toLocaleDateString('ko-KR') + ' Ïã§Ï†ú Îâ¥Ïä§ Í∏∞Î∞ò Í∏àÏúµÏö©Ïñ¥</div>\n' +
                        '<div class="content-text">\n' +
                        '<strong>1. [Ïã§Ï†ú Îâ¥Ïä§ÏóêÏÑú Ïñ∏Í∏âÎêú Ïö©Ïñ¥1] ([ÏòÅÎ¨∏Î™Ö])</strong><br>\n' +
                        '[ÏúÑ Îâ¥Ïä§ÏóêÏÑú Ïñ∏Í∏âÎêú ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú Ìïú Ï†ïÏùò ÏÑ§Î™Ö]<br>\n' +
                        '<strong>Ïã§Ï†ú ÏÇ¨Î°Ä:</strong> [ÏúÑ Îâ¥Ïä§ ÎÇ¥Ïö©Í≥º Ïó∞Í¥ÄÎêú Íµ¨Ï≤¥Ï†Å ÏòàÏãú]<br><br>\n\n' +
                        '<strong>2. [Ïã§Ï†ú Îâ¥Ïä§ÏóêÏÑú Ïñ∏Í∏âÎêú Ïö©Ïñ¥2] ([ÏòÅÎ¨∏Î™Ö])</strong><br>\n' +
                        '[ÏúÑ Îâ¥Ïä§ÏóêÏÑú Ïñ∏Í∏âÎêú ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú Ìïú Ï†ïÏùò ÏÑ§Î™Ö]<br>\n' +
                        '<strong>Ïã§Ï†ú ÏÇ¨Î°Ä:</strong> [ÏúÑ Îâ¥Ïä§ ÎÇ¥Ïö©Í≥º Ïó∞Í¥ÄÎêú Íµ¨Ï≤¥Ï†Å ÏòàÏãú]<br><br>\n\n' +
                        '<strong>3. [Ïã§Ï†ú Îâ¥Ïä§ÏóêÏÑú Ïñ∏Í∏âÎêú Ïö©Ïñ¥3] ([ÏòÅÎ¨∏Î™Ö])</strong><br>\n' +
                        '[ÏúÑ Îâ¥Ïä§ÏóêÏÑú Ïñ∏Í∏âÎêú ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú Ìïú Ï†ïÏùò ÏÑ§Î™Ö]<br>\n' +
                        '<strong>Ïã§Ï†ú ÏÇ¨Î°Ä:</strong> [ÏúÑ Îâ¥Ïä§ ÎÇ¥Ïö©Í≥º Ïó∞Í¥ÄÎêú Íµ¨Ï≤¥Ï†Å ÏòàÏãú]\n' +
                        '</div>\n' +
                        '</div>\n\n' +
                        'Ï§ëÏöî: Î∞òÎìúÏãú Ï†úÍ≥µÎêú Ïã§Ï†ú NewsAPI Îâ¥Ïä§ ÎÇ¥Ïö©ÏóêÏÑúÎßå Í∏àÏúµÏö©Ïñ¥Î•º Ï∂îÏ∂úÌïòÍ≥†, HTML ÌÉúÍ∑∏Îäî <strong>, <br> Îßå ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî. ÏΩîÎìú Î∏îÎ°ùÏùÄ Ï†àÎåÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî.';
                        break;
                        
                    case 'Í∏àÏúµ Îâ¥Ïä§':
                        // NewsAPI Îâ¥Ïä§Î•º GEMINIÍ∞Ä Î∂ÑÏÑùÌïòÏó¨ Ï†ïÎ¶¨
                        const newsText = newsData ? newsData.map(n => 'Ï†úÎ™©: ' + n.title + '\nÎÇ¥Ïö©: ' + n.description + '\nÏ∂úÏ≤ò: ' + n.source + '\nÎ∞úÌñâÏùº: ' + n.publishedAt + '\nÏπ¥ÌÖåÍ≥†Î¶¨: ' + (n.category || 'Í∏àÏúµ')).join('\n\n') : '';
                        newsLinks = newsData ? newsData.map(n => '<a href="' + n.url + '" target="_blank" style="color: #7cb9e8; text-decoration: none; display: block; margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #7cb9e8;">üì∞ ' + n.title + '</a>').join('') : '';
                        prompt = 'Îã§ÏùåÏùÄ NewsAPIÏóêÏÑú Í∞ÄÏ†∏Ïò® Ïã§Ï†ú ÏµúÏã† ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§Îì§ÏûÖÎãàÎã§. Ïù¥Î•º Ï†ÑÎ¨∏Í∞Ä Í¥ÄÏ†êÏóêÏÑú Î∂ÑÏÑùÌïòÍ≥† Ï†ïÎ¶¨Ìï¥Ï£ºÏÑ∏Ïöî:\n\n' +
                        newsText + '\n\n' +
                        'Îã§Ïùå ÌòïÏãùÏúºÎ°ú ÏÉÅÏÑ∏ Î∂ÑÏÑùÌï¥Ï£ºÏÑ∏Ïöî:\n\n' +
                        '<div class="content-section">\n' +
                        '<div class="content-title">üìà ' + new Date().toLocaleDateString('ko-KR') + ' Ïã§Ï†ú Í∏àÏúµÎâ¥Ïä§ Î∂ÑÏÑù</div>\n' +
                        '<div class="content-text">\n' +
                        '<strong>üîç Ï£ºÏöî Îâ¥Ïä§ ÌïµÏã¨ ÏöîÏïΩ</strong><br>\n' +
                        '[Í∞Å Ïã§Ï†ú Îâ¥Ïä§Ïùò ÌïµÏã¨ Ìè¨Ïù∏Ìä∏Î•º Î≤àÌò∏Î≥ÑÎ°ú ÏöîÏïΩ]<br><br>\n\n' +
                        '<strong>üíº Í∞úÏù∏ Ìà¨ÏûêÏûê ÏòÅÌñ• Î∂ÑÏÑù</strong><br>\n' +
                        '[Ïã§Ï†ú Îâ¥Ïä§Í∞Ä Í∞úÏù∏ Ìà¨ÏûêÏûêÏóêÍ≤å Ïñ¥Îñ§ ÏòÅÌñ•ÏùÑ Ï§ÑÏßÄ Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Î∂ÑÏÑù]<br><br>\n\n' +
                        '<strong>üìä Ïã§Ïö©Ï†Å Ìà¨Ïûê Ï†ÑÎûµ</strong><br>\n' +
                        '[Ïã§Ï†ú Îâ¥Ïä§Î•º Î∞îÌÉïÏúºÎ°ú Ìïú Íµ¨Ï≤¥Ï†ÅÏù∏ Ìà¨Ïûê Ï†ÑÎûµ Ï†úÏïà]<br><br>\n\n' +
                        '<strong>‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠ Î∞è Î¶¨Ïä§ÌÅ¨</strong><br>\n' +
                        '[Ïã§Ï†ú Îâ¥Ïä§ÏóêÏÑú ÌååÏïÖÎêòÎäî ÏúÑÌóò ÏöîÏÜåÎì§]<br><br>\n\n' +
                        '<strong>üìÖ Ìñ•ÌõÑ Í¥ÄÏã¨ Ìè¨Ïù∏Ìä∏</strong><br>\n' +
                        '[Ïã§Ï†ú Îâ¥Ïä§Î•º ÌÜµÌï¥ ÏòàÏÉÅÎêòÎäî Ìñ•ÌõÑ Ïù¥Î≤§Ìä∏ÎÇò ÏßÄÌëú]\n' +
                        '</div>\n' +
                        '</div>\n\n' +
                        'Ï§ëÏöî: Ï†úÍ≥µÎêú Ïã§Ï†ú NewsAPI Îâ¥Ïä§ ÎÇ¥Ïö©ÎßåÏùÑ Î∞îÌÉïÏúºÎ°ú Î∂ÑÏÑùÌïòÍ≥†, Ï†ÑÎ¨∏Ïö©Ïñ¥Îäî ÏâΩÍ≤å ÌíÄÏñ¥ÏÑú ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî. ÏΩîÎìú Î∏îÎ°ùÏùÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî.';
                        break;
                        
                    case 'Í∏àÏúµ ÌÄ¥Ï¶à':
                        // NewsAPI Îâ¥Ïä§Î•º Î∞îÌÉïÏúºÎ°ú ÌÄ¥Ï¶à ÏÉùÏÑ±
                        prompt = 'Îã§ÏùåÏùÄ NewsAPIÏóêÏÑú Í∞ÄÏ†∏Ïò® Ïã§Ï†ú ÏµúÏã† ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§Îì§ÏûÖÎãàÎã§. Ïù¥Î•º Î∞îÌÉïÏúºÎ°ú Ïã§Î¨¥Ïóê ÎèÑÏõÄÎêòÎäî Í∏àÏúµ ÌÄ¥Ï¶àÎ•º ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî:\n\n' +
                        (newsData ? newsData.map(n => 'Ï†úÎ™©: ' + n.title + '\nÎÇ¥Ïö©: ' + n.description + '\nÏ∂úÏ≤ò: ' + n.source + '\nÎ∞úÌñâÏùº: ' + n.publishedAt).join('\n\n') : '') + '\n\n' +
                        'ÌÄ¥Ï¶à ÏöîÍµ¨ÏÇ¨Ìï≠:\n' +
                        '- Ïã§Ï†ú NewsAPI Îâ¥Ïä§ ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú Ìïú ÏÇ¨ÏßÄÏÑ†Îã§ Î¨∏Ï†ú 3Í∞ú\n' +
                        '- Ï¥àÎ≥¥ÏûêÎèÑ Ïù¥Ìï¥Ìï† Ïàò ÏûàÎäî ÏàòÏ§Ä\n' +
                        '- Ïã§Î¨¥Ïóê ÎèÑÏõÄÎêòÎäî Í∏àÏúµ ÏßÄÏãù Ìè¨Ìï®\n' +
                        '- Í∞Å Î¨∏Ï†úÎßàÎã§ ÏûêÏÑ∏Ìïú Ìï¥ÏÑ§ Ï†úÍ≥µ\n\n' +
                        'Îã§Ïùå ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî:\n' +
                        '1. ÌÄ¥Ï¶à ÏÜåÍ∞ú (Ïã§Ï†ú NewsAPI Îâ¥Ïä§ Í∏∞Î∞òÏù¥ÎùºÎäî Ï†ê Ïñ∏Í∏â)\n' +
                        '2. 4ÏßÄÏÑ†Îã§ Î¨∏Ï†ú 3Í∞ú (Ï†ïÎãµ Ìè¨Ìï®)\n' +
                        '3. Í∞Å Î¨∏Ï†úÎ≥Ñ ÏÉÅÏÑ∏ Ìï¥ÏÑ§\n' +
                        '4. Ï∂îÍ∞Ä ÌïôÏäµ ÌåÅ\n\n' +
                        'ÏΩîÎìú Î∏îÎ°ùÏùÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî.';
                        break;
                }

                // Ïã§Ï†ú GEMINI API Ìò∏Ï∂ú
                console.log('ü§ñ GEMINI AI NewsAPI Îâ¥Ïä§ Î∂ÑÏÑù ÏãúÏûë:', type);
                const geminiResponse = await callGeminiAPI(prompt);
                
                if (geminiResponse) {
                    console.log('‚úÖ GEMINI AI NewsAPI Îâ¥Ïä§ Î∂ÑÏÑù ÏôÑÎ£å');
                    
                    // Îâ¥Ïä§Ïùò Í≤ΩÏö∞ ÎßÅÌÅ¨ ÏÑπÏÖò Ï∂îÍ∞Ä
                    if (type === 'Í∏àÏúµ Îâ¥Ïä§' && newsLinks) {
                        return geminiResponse + `
                            <div class="content-section">
                                <div class="content-title">üîó Ïã§Ï†ú Îâ¥Ïä§ Í∏∞ÏÇ¨ Î∞îÎ°úÍ∞ÄÍ∏∞</div>
                                <div style="margin-top: 15px;">
                                    ${newsLinks}
                                </div>
                            </div>
                        `;
                    }
                    
                    return geminiResponse;
                } else {
                    // GEMINI API Ïã§Ìå® Ïãú ÎåÄÏ≤¥ ÏΩòÌÖêÏ∏†
                    console.log('‚ùå GEMINI API Ïã§Ìå®, ÎåÄÏ≤¥ ÏΩòÌÖêÏ∏† ÏÇ¨Ïö©');
                    return getFallbackContent(type, newsLinks);
                }
                
            } catch (error) {
                console.error('GEMINI API Ìò∏Ï∂ú Ïã§Ìå®:', error);
                return getFallbackContent(type, newsLinks);
            }
        }

        // GEMINI API Ïã§Ìå® Ïãú ÎåÄÏ≤¥ ÏΩòÌÖêÏ∏†
        function getFallbackContent(type, newsLinks = '') {
            const fallbackResponses = {
                'Í∏àÏúµ Ïö©Ïñ¥': `
                    <div class="content-section">
                        <div class="content-title">üìö Ïò§ÎäòÏùò ÌïµÏã¨ Í∏àÏúµÏö©Ïñ¥</div>
                        <div class="content-text">
                            <strong>1. Î≥µÎ¶¨ (Compound Interest)</strong><br>
                            ÏõêÍ∏àÏóê Î∂ôÏùÄ Ïù¥ÏûêÍ∞Ä Îã§Ïãú ÏõêÍ∏àÏù¥ ÎêòÏñ¥ Ïù¥ÏûêÍ∞Ä Î∂ôÎäî Î∞©ÏãùÏûÖÎãàÎã§. 
                            "ÎèàÏù¥ ÎèàÏùÑ ÎÇ≥ÎäîÎã§"Îäî ÎßêÏùò ÌïµÏã¨ ÏõêÎ¶¨Ï£†!
                            
                            <br><br><strong>ÏòàÏãú:</strong> 100ÎßåÏõêÏùÑ Ïó∞ 10% Î≥µÎ¶¨Î°ú Ìà¨ÏûêÌïòÎ©¥
                            - 1ÎÖÑ ÌõÑ: 110ÎßåÏõê
                            - 2ÎÖÑ ÌõÑ: 121ÎßåÏõê (110ÎßåÏõêÏùò 10%)
                            
                            <br><br><strong>2. Î∂ÑÏÇ∞Ìà¨Ïûê (Diversification)</strong><br>
                            Ïó¨Îü¨ Ï¢ÖÎ™©Ïù¥ÎÇò ÏûêÏÇ∞Ïóê Ìà¨ÏûêÌïòÏó¨ ÏúÑÌóòÏùÑ Ï§ÑÏù¥Îäî Ï†ÑÎûµÏûÖÎãàÎã§.
                            "Í≥ÑÎûÄÏùÑ Ìïú Î∞îÍµ¨ÎãàÏóê Îã¥ÏßÄ ÎßàÎùº"Îäî Ìà¨ÏûêÏùò Í∏∞Î≥∏ ÏõêÏπôÏù¥ÏóêÏöî.
                            
                            <br><br><strong>3. Îã¨Îü¨ ÏΩîÏä§Ìä∏ ÌèâÍ∑†Î≤ï (Dollar Cost Averaging)</strong><br>
                            Ï†ïÍ∏∞Ï†ÅÏúºÎ°ú ÏùºÏ†ï Í∏àÏï°ÏùÑ Ìà¨ÏûêÌïòÎäî Î∞©Î≤ïÏûÖÎãàÎã§. 
                            Í∞ÄÍ≤©Ïù¥ ÎÜíÏùÑ ÎïåÎäî Ï†ÅÍ≤å, ÎÇÆÏùÑ ÎïåÎäî ÎßéÏù¥ ÏÇ¨Í≤å ÎêòÏñ¥ ÌèâÍ∑† Îß§ÏûÖÎã®Í∞ÄÎ•º ÎÇÆÏ∂ú Ïàò ÏûàÏñ¥Ïöî.
                        </div>
                    </div>
                `,
                'Í∏àÏúµ Îâ¥Ïä§': `
                    <div class="content-section">
                        <div class="content-title">üì∞ Ïò§ÎäòÏùò Í∏àÏúµ Îâ¥Ïä§ Î∂ÑÏÑù</div>
                        <div class="content-text">
                            <strong>üèõÔ∏è ÌïúÍµ≠ÏùÄÌñâ Í∏∞Ï§ÄÍ∏àÎ¶¨ Ï†ïÏ±Ö</strong><br>
                            ÌòÑÏû¨ Í∏àÎ¶¨ Ï†ïÏ±ÖÏùÄ Ïù∏ÌîåÎ†àÏù¥ÏÖòÍ≥º Í≤ΩÏ†ú ÏÑ±Ïû•Ïùò Í∑†ÌòïÏùÑ ÎßûÏ∂îÎäî Î∞©Ìñ•ÏúºÎ°ú ÏÑ§Ï†ïÎêòÍ≥† ÏûàÏäµÎãàÎã§.
                            
                            <br><br><strong>üíº Í∞úÏù∏ Ìà¨ÏûêÏûê ÏòÅÌñ•:</strong><br>
                            ‚Ä¢ ÏòàÍ∏à Í∏àÎ¶¨ Î≥ÄÎèô ‚Üí ÏïàÏ†Ñ ÏûêÏÇ∞ ÏàòÏùµÎ•† ÏòÅÌñ•<br>
                            ‚Ä¢ ÎåÄÏ∂ú Í∏àÎ¶¨ Î≥ÄÌôî ‚Üí Î∂ÄÎèôÏÇ∞ Î∞è ÏÜåÎπÑ Ìå®ÌÑ¥ Î≥ÄÌôî<br>
                            ‚Ä¢ Ï£ºÏãù ÏãúÏû• ‚Üí Í∏àÎ¶¨ Ï†ïÏ±ÖÏóê Îî∞Î•∏ ÏûêÍ∏à Ïù¥Îèô
                            
                            <br><br><strong>üìà Ï¶ùÏãú ÎèôÌñ•</strong><br>
                            Ïô∏Íµ≠Ïù∏ Ìà¨Ïûê Ìå®ÌÑ¥Í≥º Ï£ºÏöî ÏóÖÏ¢ÖÎ≥Ñ Ïã§Ï†ÅÏù¥ ÏãúÏû• ÌùêÎ¶ÑÏùÑ Ï¢åÏö∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§.
                            
                            <br><br><strong>üí° Ìà¨Ïûê Ï†ÑÎûµ Ï†úÏïà:</strong><br>
                            1. Í∏àÎ¶¨ Î≥ÄÎèôÏóê ÎØºÍ∞êÌïú ÏÑπÌÑ∞ Í¥ÄÏ∞∞<br>
                            2. Í∏∞Ïà†Ï£ºÏôÄ Ï†ÑÌÜµ ÏÇ∞ÏóÖÏùò Í∑†Ìòï Í≥†Î†§<br>
                            3. Î∂ÑÏÇ∞Ìà¨ÏûêÎ•º ÌÜµÌïú Î¶¨Ïä§ÌÅ¨ Í¥ÄÎ¶¨
                        </div>
                        ${newsLinks ? `
                        <div class="content-section">
                            <div class="content-title">üîó Í¥ÄÎ†® Í∏∞ÏÇ¨ Î∞îÎ°úÍ∞ÄÍ∏∞</div>
                            <div style="margin-top: 15px;">
                                ${newsLinks}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `,
                'Í∏àÏúµ ÌÄ¥Ï¶à': `
                    <div class="content-section">
                        <div class="content-title">üß© Ïò§ÎäòÏùò Í∏àÏúµ ÌÄ¥Ï¶à</div>
                        <div class="content-text">
                            Í∏àÏúµ ÏßÄÏãùÏùÑ ÌÖåÏä§Ìä∏Ìï¥Î≥¥ÏÑ∏Ïöî! 70% Ïù¥ÏÉÅ ÎßûÌûàÎ©¥ Î≥¥ÏÉÅÏùÑ Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî.<br>
                            Î≥µÎ¶¨, Î∂ÑÏÇ∞Ìà¨Ïûê, Ï£ºÏãù ÏßÄÌëú Îì± Ïã§Ïö©Ï†ÅÏù∏ Í∏àÏúµ ÏßÄÏãùÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                        </div>
                    </div>
                `
            };

            return fallbackResponses[type] || 'ÏΩòÌÖêÏ∏†Î•º ÏÉùÏÑ±ÌïòÎäî Ï§ëÏûÖÎãàÎã§...';
        }

        // ÏùºÏùº Ï∫êÏã± ÏãúÏä§ÌÖú
        function getTodayKey(type) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD ÌòïÏãù
            return `daily_${type}_${today}`;
        }

        async function getCachedDataOrUpdate(type, generateFunction) {
            const cacheKey = getTodayKey(type);
            
            try {
                // Firebase Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
                if (!window.firebaseDB) {
                    console.log('üî• Firebase Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë...');
                    await new Promise(resolve => {
                        const checkFirebase = () => {
                            if (window.firebaseDB) {
                                resolve();
                            } else {
                                setTimeout(checkFirebase, 100);
                            }
                        };
                        checkFirebase();
                    });
                }
                
                // window.firebaseDB ÏÇ¨Ïö©
                const cacheRef = window.firebaseRef(window.firebaseDB, `cache/${cacheKey}`);
                const snapshot = await window.firebaseGet(cacheRef);
                const cachedData = snapshot.val();
                
                if (cachedData && cachedData.data) {
                    console.log(`${type} Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© (${cachedData.timestamp})`);
                    return cachedData.data;
                }
                
                // Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
                console.log(`${type} ÏÉà Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ï§ë...`);
                const newData = await generateFunction();
                
                // FirebaseÏóê Ï†ÄÏû•
                await window.firebaseSet(cacheRef, {
                    data: newData,
                    timestamp: new Date().toISOString(),
                    type: type
                });
                
                console.log(`${type} ÏÉà Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å`);
                return newData;
                
            } catch (error) {
                console.error(`${type} Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïò§Î•ò:`, error);
                return await generateFunction(); // ÏóêÎü¨ Ïãú ÏßÅÏ†ë ÏÉùÏÑ±
            }
        }

        // NewsAPI Îâ¥Ïä§ Í∏∞Î∞ò ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        async function generateQuizData(newsData = null) {
            try {
                if (!newsData) {
                    newsData = await getLatestFinanceNews();
                }
                
                const prompt = 'Îã§ÏùåÏùÄ NewsAPIÏóêÏÑú Í∞ÄÏ†∏Ïò® Ïã§Ï†ú ÏµúÏã† ÌïúÍµ≠ Í∏àÏúµ Îâ¥Ïä§Îì§ÏûÖÎãàÎã§. Ïù¥Î•º Î∞îÌÉïÏúºÎ°ú ÏÇ¨ÏßÄÏÑ†Îã§ Í∏àÏúµ ÌÄ¥Ï¶à 3Î¨∏Ï†úÎ•º JSON ÌòïÏãùÏúºÎ°ú ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî:\n\n' +
                (newsData ? newsData.map(n => 'Ï†úÎ™©: ' + n.title + '\nÎÇ¥Ïö©: ' + n.description + '\nÏ∂úÏ≤ò: ' + n.source + '\nÎ∞úÌñâÏùº: ' + n.publishedAt).join('\n\n') : '') +
                '\n\nÎã§ÏùåÍ≥º Í∞ôÏùÄ Ï†ïÌôïÌïú JSON ÌòïÏãùÏúºÎ°úÎßå ÏùëÎãµÌï¥Ï£ºÏÑ∏Ïöî (ÏΩîÎìú Î∏îÎ°ù ÏóÜÏù¥):\n\n' +
                '[\n' +
                '    {\n' +
                '        "question": "Ïã§Ï†ú NewsAPI Îâ¥Ïä§ Í∏∞Î∞ò Î¨∏Ï†ú 1",\n' +
                '        "options": ["ÏÑ†ÌÉùÏßÄ1", "ÏÑ†ÌÉùÏßÄ2", "ÏÑ†ÌÉùÏßÄ3", "ÏÑ†ÌÉùÏßÄ4"],\n' +
                '        "correct": 0,\n' +
                '        "explanation": "Ïã§Ï†ú Îâ¥Ïä§ÏôÄ Ïó∞Í¥ÄÎêú Ï†ïÎãµ ÏÑ§Î™Ö"\n' +
                '    },\n' +
                '    {\n' +
                '        "question": "Ïã§Ï†ú NewsAPI Îâ¥Ïä§ Í∏∞Î∞ò Î¨∏Ï†ú 2",\n' + 
                '        "options": ["ÏÑ†ÌÉùÏßÄ1", "ÏÑ†ÌÉùÏßÄ2", "ÏÑ†ÌÉùÏßÄ3", "ÏÑ†ÌÉùÏßÄ4"],\n' +
                '        "correct": 1,\n' +
                '        "explanation": "Ïã§Ï†ú Îâ¥Ïä§ÏôÄ Ïó∞Í¥ÄÎêú Ï†ïÎãµ ÏÑ§Î™Ö"\n' +
                '    },\n' +
                '    {\n' +
                '        "question": "Ïã§Ï†ú NewsAPI Îâ¥Ïä§ Í∏∞Î∞ò Î¨∏Ï†ú 3",\n' +
                '        "options": ["ÏÑ†ÌÉùÏßÄ1", "ÏÑ†ÌÉùÏßÄ2", "ÏÑ†ÌÉùÏßÄ3", "ÏÑ†ÌÉùÏßÄ4"],\n' +
                '        "correct": 2,\n' +
                '        "explanation": "Ïã§Ï†ú Îâ¥Ïä§ÏôÄ Ïó∞Í¥ÄÎêú Ï†ïÎãµ ÏÑ§Î™Ö"\n' +
                '    }\n' +
                ']\n\n' +
                'Ï£ºÏùòÏÇ¨Ìï≠:\n' +
                '- Î¨∏Ï†úÎäî Î∞òÎìúÏãú Ï†úÍ≥µÎêú Ïã§Ï†ú NewsAPI Îâ¥Ïä§ ÎÇ¥Ïö©ÏùÑ Î∞îÌÉïÏúºÎ°ú ÏûëÏÑ±\n' +
                '- Í∞Å Î¨∏Ï†úÎßàÎã§ Ï†ïÌôïÌûà 4Í∞úÏùò ÏÑ†ÌÉùÏßÄ Ï†úÍ≥µ\n' +
                '- correctÎäî Ï†ïÎãµ Ïù∏Îç±Ïä§ (0, 1, 2, 3 Ï§ë ÌïòÎÇò)\n' +
                '- ÏÑ§Î™ÖÏùÄ Ïã§Ï†ú Îâ¥Ïä§ÏôÄ Ïó∞Í¥ÄÏßÄÏñ¥ ÏÑ§Î™Ö\n' +
                '- ÏàúÏàò JSONÎßå ÏùëÎãµÌïòÍ≥† ÏΩîÎìú Î∏îÎ°ùÏùÄ Ï†àÎåÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî\n' +
                '- Î∞±Ìã±(`)ÏùÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî';

                console.log('üß© Ïã§Ï†ú NewsAPI Îâ¥Ïä§ Í∏∞Î∞ò ÌÄ¥Ï¶à ÏÉùÏÑ± Ï§ë...');
                const geminiResponse = await callGeminiAPI(prompt);
                
                if (geminiResponse) {
                    try {
                        // JSON Î∏îÎ°ù Ï†úÍ±∞ (```json Í≥º ``` Ï†úÍ±∞) - Îçî Í∞ïÎ†•Ìïú Ìå®ÌÑ¥
                        let cleanResponse = geminiResponse;
                        
                        // Îã§ÏñëÌïú ÎßàÌÅ¨Îã§Ïö¥ Î∏îÎ°ù Ï†úÍ±∞
                        cleanResponse = cleanResponse.replace(/```json\s*/g, '');
                        cleanResponse = cleanResponse.replace(/```javascript\s*/g, '');
                        cleanResponse = cleanResponse.replace(/```\s*/g, '');
                        cleanResponse = cleanResponse.replace(/`/g, '');
                        
                        // ÏïûÎí§ Í≥µÎ∞± Ï†úÍ±∞
                        cleanResponse = cleanResponse.trim();
                        
                        // JSON ÏãúÏûëÍ≥º ÎÅù ÌôïÏù∏
                        if (!cleanResponse.startsWith('[')) {
                            const jsonStart = cleanResponse.indexOf('[');
                            if (jsonStart > -1) {
                                cleanResponse = cleanResponse.substring(jsonStart);
                            }
                        }
                        
                        if (!cleanResponse.endsWith(']')) {
                            const jsonEnd = cleanResponse.lastIndexOf(']');
                            if (jsonEnd > -1) {
                                cleanResponse = cleanResponse.substring(0, jsonEnd + 1);
                            }
                        }
                        
                        console.log('üîç Ï†ïÎ¶¨Îêú JSON:', cleanResponse.substring(0, 100) + '...');
                        
                        // JSON ÌååÏã± ÏãúÎèÑ
                        const quizData = JSON.parse(cleanResponse);
                        if (Array.isArray(quizData) && quizData.length === 3) {
                            console.log('‚úÖ Ïã§Ï†ú NewsAPI Îâ¥Ïä§ Í∏∞Î∞ò ÌÄ¥Ï¶à ÏÉùÏÑ± ÏôÑÎ£å');
                            return quizData;
                        }
                    } catch (parseError) {
                        console.warn('‚ö†Ô∏è GEMINI ÏùëÎãµ JSON ÌååÏã± Ïã§Ìå®:', parseError);
                        console.log('üìù ÏõêÎ≥∏ ÏùëÎãµ:', geminiResponse.substring(0, 200) + '...');
                    }
                }
                
                console.log('‚ùå Ïã§Ï†ú NewsAPI Îâ¥Ïä§ Í∏∞Î∞ò ÌÄ¥Ï¶à ÏÉùÏÑ± Ïã§Ìå®, ÎåÄÏ≤¥ ÌÄ¥Ï¶à ÏÇ¨Ïö©');
                return getFallbackQuizData();
                
            } catch (error) {
                console.error('ÌÄ¥Ï¶à ÏÉùÏÑ± Ïò§Î•ò:', error);
                return getFallbackQuizData();
            }
        }

        // ÎåÄÏ≤¥ ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞
        function getFallbackQuizData() {
            return [
                {
                    question: "ÏµúÍ∑º ÌïúÍµ≠ÏùÄÌñâÏùò Í∏∞Ï§ÄÍ∏àÎ¶¨ Ï†ïÏ±Ö Î∞©Ìñ•ÏùÄ?",
                    options: ["ÏßÄÏÜçÏ†Å Ïù∏ÏÉÅ", "ÎèôÍ≤∞ Ïú†ÏßÄ", "ÏßÄÏÜçÏ†Å Ïù∏Ìïò", "Î≥ÄÎèôÏÑ± ÌôïÎåÄ"],
                    correct: 1,
                    explanation: "ÏµúÍ∑º ÌïúÍµ≠ÏùÄÌñâÏùÄ Ïù∏ÌîåÎ†àÏù¥ÏÖòÍ≥º Í≤ΩÏ†úÏÑ±Ïû• Í∑†ÌòïÏùÑ ÏúÑÌï¥ Í∏∞Ï§ÄÍ∏àÎ¶¨Î•º ÎèôÍ≤∞ Ïú†ÏßÄÌïòÍ≥† ÏûàÏäµÎãàÎã§."
                },
                {
                    question: "Î∂ÑÏÇ∞Ìà¨ÏûêÏùò Ï£ºÏöî Î™©Ï†ÅÏùÄ?",
                    options: ["ÏàòÏùµÎ•† Í∑πÎåÄÌôî", "ÏúÑÌóò Î∂ÑÏÇ∞", "Í±∞ÎûòÎπÑÏö© Ï†àÏïΩ", "ÏÑ∏Í∏à Ï†àÏïΩ"],
                    correct: 1,
                    explanation: "Î∂ÑÏÇ∞Ìà¨ÏûêÎäî Ïó¨Îü¨ ÏûêÏÇ∞Ïóê Ìà¨ÏûêÌïòÏó¨ Ï†ÑÏ≤¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Ïùò ÏúÑÌóòÏùÑ Ï§ÑÏù¥Îäî Í≤ÉÏù¥ Ï£ºÎ™©Ï†ÅÏûÖÎãàÎã§."
                },
                {
                    question: "Ï£ºÏãù Ìà¨ÏûêÏãú Í∞ÄÏû• Ï§ëÏöîÌïú Í≤ÉÏùÄ?",
                    options: ["Îã®Í∏∞ ÏàòÏùµ", "Í∏∞ÏóÖ Î∂ÑÏÑù", "ÏãúÏû• ÌÉÄÏù¥Î∞ç", "ÏÜåÎ¨∏Í≥º Ï∂îÏ≤ú"],
                    correct: 1,
                    explanation: "Ï£ºÏãù Ìà¨ÏûêÎäî Í∏∞ÏóÖÏùò Ïû¨Î¨¥ÏÉÅÌÉú, ÏÑ±Ïû•ÏÑ±, Í≤ΩÏüÅÎ†• Îì±ÏùÑ Ï¢ÖÌï©Ï†ÅÏúºÎ°ú Î∂ÑÏÑùÌïòÎäî Í≤ÉÏù¥ Í∞ÄÏû• Ï§ëÏöîÌï©ÎãàÎã§."
                }
            ];
        }

        // ÌïôÏäµ ÏΩòÌÖêÏ∏† Ïó¥Í∏∞ (ÏùºÏùº Ï∫êÏã± ÏãúÏä§ÌÖú Ï†ÅÏö©)
        async function openStudyContent(type) {
            const modal = document.getElementById('contentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = type;
            modalBody.innerHTML = '<div class="loading-spinner"></div><div style="text-align: center;">Ïò§ÎäòÏùò ÏΩòÌÖêÏ∏†Î•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§...</div>';
            
            modal.classList.add('show');
            
            try {
                let content;
                
                if (type === 'Í∏àÏúµ Îâ¥Ïä§') {
                    // Îâ¥Ïä§Îäî Ï∫êÏã±Îêú Îç∞Ïù¥ÌÑ∞ ÎòêÎäî ÏÉàÎ°ú ÏÉùÏÑ±
                    content = await getCachedDataOrUpdate('news', async () => {
                        const newsData = await getLatestFinanceNews();
                        return await generateFormattedNews(newsData);
                    });
                } else if (type === 'Í∏àÏúµ Ïö©Ïñ¥') {
                    // Í∏àÏúµ Ïö©Ïñ¥Îäî Ï∫êÏã±Îêú Îç∞Ïù¥ÌÑ∞ ÎòêÎäî ÏÉàÎ°ú ÏÉùÏÑ±
                    content = await getCachedDataOrUpdate('terms', async () => {
                        const newsData = await getLatestFinanceNews();
                        return await generateContentWithGemini(type, newsData);
                    });
                } else if (type === 'Í∏àÏúµ ÌÄ¥Ï¶à') {
                    // ÌÄ¥Ï¶àÎäî Ï∫êÏã±Îêú Îç∞Ïù¥ÌÑ∞ ÎòêÎäî ÏÉàÎ°ú ÏÉùÏÑ±
                    const quizData = await getCachedDataOrUpdate('quiz', async () => {
                        const newsData = await getLatestFinanceNews();
                        return await generateQuizData(newsData);
                    });
                    content = await generateQuizInterface(quizData);
                } else {
                    // Í∏∞ÌÉÄ ÏΩòÌÖêÏ∏†
                    const newsData = await getLatestFinanceNews();
                    content = await generateContentWithGemini(type, newsData);
                }
                
                modalBody.innerHTML = content;
                
                // ÌÄ¥Ï¶àÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ ÌïôÏäµ ÏôÑÎ£å Î≤ÑÌäº Ï∂îÍ∞Ä
                if (type !== 'Í∏àÏúµ ÌÄ¥Ï¶à') {
                    addCompletionInterface(type);
                }
                
            } catch (error) {
                console.error('ÏΩòÌÖêÏ∏† Î°úÎìú Ïã§Ìå®:', error);
                modalBody.innerHTML = '<div style="text-align: center; color: red;">ÏΩòÌÖêÏ∏† Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.</div>';
            }
        }

        // Ìè¨Îß∑Îêú Îâ¥Ïä§ ÏÉùÏÑ± (Î≤àÌò∏ Î¶¨Ïä§Ìä∏ ÌòïÌÉú)
        async function generateFormattedNews(newsData) {
            try {
                if (!newsData || newsData.length === 0) {
                    return '<div style="text-align: center; color: #666;">Îâ¥Ïä§Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                }

                const today = new Date();
                const dateStr = `${today.getFullYear()}ÎÖÑ ${today.getMonth() + 1}Ïõî ${today.getDate()}Ïùº`;

                const prompt = 
                    'Îã§Ïùå ' + dateStr + ' ÏµúÏã† Í∏àÏúµ Îâ¥Ïä§Îì§ÏùÑ Î∂ÑÏÑùÌïòÏó¨ Ï£ºÏöî ÎÇ¥Ïö©ÏùÑ Î≤àÌò∏Î≥ÑÎ°ú Ï†ïÎ¶¨Ìï¥Ï£ºÏÑ∏Ïöî:\n\n' +
                    newsData.map(n => 'Ï†úÎ™©: ' + n.title + '\nÎÇ¥Ïö©: ' + n.description + '\nÏ∂úÏ≤ò: ' + n.source + '\nÏπ¥ÌÖåÍ≥†Î¶¨: ' + (n.category || 'ÏùºÎ∞ò') + '\nÎßÅÌÅ¨: ' + n.url).join('\n\n') +
                    '\n\nÎã§Ïùå ÌòïÏãùÏúºÎ°ú ÏùëÎãµÌï¥Ï£ºÏÑ∏Ïöî (ÏΩîÎìú Î∏îÎ°ù ÏóÜÏù¥ ÏàúÏàò HTMLÎßå):\n\n' +
                    '<div style="padding: 20px; line-height: 1.6;">\n' +
                    '<h3 style="color: #333; margin-bottom: 20px;">üìà ' + dateStr + ' Ï£ºÏöî Í∏àÏúµÎâ¥Ïä§</h3>\n\n' +
                    '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">\n' +
                    '<strong style="color: #007bff;"><a href="[Îâ¥Ïä§ÎßÅÌÅ¨]" target="_blank" style="color: #007bff; text-decoration: none;">1. [Ï≤´ Î≤àÏß∏ Ï£ºÏöî Îâ¥Ïä§ Ï†úÎ™©]</a></strong><br>\n' +
                    '<span style="color: #666; font-size: 14px;">[ÌïµÏã¨ ÎÇ¥Ïö© ÏöîÏïΩ - 1-2Ï§Ñ]</span><br>\n' +
                    '<small style="color: #999; font-size: 12px;">Ï∂úÏ≤ò: [Ï∂úÏ≤ò] | [Ïπ¥ÌÖåÍ≥†Î¶¨]</small>\n' +
                    '</div>\n\n' +
                    '(ÎÇòÎ®∏ÏßÄ Îâ¥Ïä§Îì§ÎèÑ ÎèôÏùºÌïú ÌòïÏãùÏúºÎ°ú...)\n\n' +
                    '<div style="background: #e8f4fd; padding: 15px; border-radius: 10px; margin-top: 20px;">\n' +
                    '<strong style="color: #0056b3;">üí° ' + dateStr + ' Í∏àÏúµ Ìè¨Ïù∏Ìä∏</strong><br>\n' +
                    '<span style="color: #666; font-size: 14px;">[Ïò§Îäò Îâ¥Ïä§Îì§Ïùò Ï†ÑÏ≤¥Ï†ÅÏù∏ ÏãúÏû• ÏòÅÌñ•Ïù¥ÎÇò Ï£ºÎ™©Ìï† Ï†ê]</span>\n' +
                    '</div>\n' +
                    '</div>\n\n' +
                    'Ï£ºÏùòÏÇ¨Ìï≠:\n' +
                    '- Í∞Å Îâ¥Ïä§ Ï†úÎ™©ÏùÄ Î∞òÎìúÏãú <a> ÌÉúÍ∑∏Î°ú ÌÅ¥Î¶≠ Í∞ÄÎä•Ìïú ÎßÅÌÅ¨Î°ú ÎßåÎì§Í∏∞\n' +
                    '- Ï†úÍ≥µÎêú Ïã§Ï†ú Îâ¥Ïä§ ÎßÅÌÅ¨Î•º hrefÏóê Ìè¨Ìï®\n' +
                    '- Î≤àÌò∏Î•º Îß§Í≤®ÏÑú ÏùΩÍ∏∞ ÏâΩÍ≤å Íµ¨ÏÑ±\n' +
                    '- Ï∂úÏ≤òÏôÄ Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ Ìè¨Ìï®\n' +
                    '- ÏàúÏàò HTMLÎßå ÏùëÎãµÌïòÍ≥† ÏΩîÎìú Î∏îÎ°ù(```html)ÏùÄ Ï†àÎåÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî\n' +
                    '- Î∞±Ìã±(`)ÏùÄ ÏÇ¨Ïö©ÌïòÏßÄ ÎßàÏÑ∏Ïöî';

                console.log(`üì∞ ${dateStr} Îâ¥Ïä§ Ìè¨Îß∑ÌåÖ Ï§ë...`);
                const response = await callGeminiAPI(prompt);
                
                if (response && response.trim()) {
                    return response.trim();
                } else {
                    throw new Error('Îπà ÏùëÎãµ');
                }
                
            } catch (error) {
                console.error('Îâ¥Ïä§ Ìè¨Îß∑ÌåÖ Ïã§Ìå®:', error);
                // Í∏∞Î≥∏ Îâ¥Ïä§ Ìè¨Îß∑ Î∞òÌôò (Ïò§Îäò ÎÇ†Ïßú Ìè¨Ìï®)
                const today = new Date();
                const dateStr = `${today.getFullYear()}ÎÖÑ ${today.getMonth() + 1}Ïõî ${today.getDate()}Ïùº`;
                
                return `<div style="padding: 20px; line-height: 1.6;">
                    <h3 style="color: #333; margin-bottom: 20px;">üìà ${dateStr} Ï£ºÏöî Í∏àÏúµÎâ¥Ïä§</h3>` +
                    newsData.slice(0, 4).map((news, index) => 
                        `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong style="color: #007bff;">
                                <a href="${news.url}" target="_blank" style="color: #007bff; text-decoration: none; cursor: pointer;" 
                                   onmouseover="this.style.textDecoration='underline'" 
                                   onmouseout="this.style.textDecoration='none'">
                                   ${index + 1}. ${news.title}
                                </a>
                            </strong><br>
                            <span style="color: #666; font-size: 14px;">${news.description}</span><br>
                            <small style="color: #999; font-size: 12px;">Ï∂úÏ≤ò: ${news.source} | ${news.category}</small>
                        </div>`
                    ).join('') +
                    `<div style="background: #e8f4fd; padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <strong style="color: #0056b3;">üí° ${dateStr} Í∏àÏúµ Ìè¨Ïù∏Ìä∏</strong><br>
                        <span style="color: #666; font-size: 14px;">Ïò§ÎäòÏùò Ï£ºÏöî Í∏àÏúµ Ïù¥ÏäàÎì§ÏùÑ ÌÜµÌï¥ ÏãúÏû• ÎèôÌñ•ÏùÑ ÌååÏïÖÌï† Ïàò ÏûàÏäµÎãàÎã§.</span>
                    </div>
                </div>`;
            }
        }

        // ÌÄ¥Ï¶à Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÏÉùÏÑ±
        async function generateQuizInterface(quizData) {
            if (!quizData || !Array.isArray(quizData) || quizData.length === 0) {
                return '<div style="text-align: center; color: #666;">ÌÄ¥Ï¶àÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }

            let quizHTML = '<div class="quiz-container">';
            quizHTML += '<h3 style="margin-bottom: 20px;">üìù Ïò§ÎäòÏùò Í∏àÏúµ ÌÄ¥Ï¶à</h3>';
            
            quizData.forEach((quiz, index) => {
                quizHTML += `
                    <div class="quiz-section" style="margin-bottom: 30px;">
                        <div class="quiz-question">${index + 1}. ${quiz.question}</div>
                        <div class="quiz-options" id="quiz-${index}">
                `;
                
                quiz.options.forEach((option, optionIndex) => {
                    quizHTML += `
                        <div class="quiz-option" 
                             data-quiz="${index}" 
                             data-option="${optionIndex}"
                             onclick="selectQuizOption(${index}, ${optionIndex})">
                            ${option}
                        </div>
                    `;
                });
                
                quizHTML += `
                        </div>
                        <div id="explanation-${index}" style="display: none; margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; color: #333;">
                            ${quiz.explanation}
                        </div>
                    </div>
                `;
            });
            
            quizHTML += `
                <button class="quiz-submit" onclick="submitQuiz()">ÌÄ¥Ï¶à Ï†úÏ∂úÌïòÍ∏∞</button>
                <div style="margin-top: 10px; text-align: center; font-size: 12px; color: #999;">
                    Î≥¥ÏÉÅ: 50,000Ïõê + 100 EXP (70% Ïù¥ÏÉÅ Ï†ïÎãµ Ïãú)
                </div>
            </div>`;
            
            // ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
            window.currentQuizData = quizData;
            
            return quizHTML;
        }

        // ÌÄ¥Ï¶à ÏòµÏÖò ÏÑ†ÌÉù
        function selectQuizOption(quizIndex, optionIndex) {
            const options = document.querySelectorAll(`[data-quiz="${quizIndex}"]`);
            options.forEach(opt => opt.classList.remove('selected'));
            options[optionIndex].classList.add('selected');
        }

        // ÌÄ¥Ï¶à Ï†úÏ∂ú
        function submitQuiz() {
            if (!window.currentQuizData) return;
            
            let correctCount = 0;
            const totalQuestions = window.currentQuizData.length;
            
            window.currentQuizData.forEach((quiz, index) => {
                const selectedOption = document.querySelector(`[data-quiz="${index}"].selected`);
                if (selectedOption) {
                    const selectedIndex = parseInt(selectedOption.dataset.option);
                    const options = document.querySelectorAll(`[data-quiz="${index}"]`);
                    
                    if (selectedIndex === quiz.correct) {
                        correctCount++;
                        selectedOption.classList.add('correct');
                    } else {
                        selectedOption.classList.add('incorrect');
                        options[quiz.correct].classList.add('correct');
                    }
                    
                    // ÏÑ§Î™Ö ÌëúÏãú
                    document.getElementById(`explanation-${index}`).style.display = 'block';
                }
            });
            
            const percentage = (correctCount / totalQuestions) * 100;
            
            // Ï†úÏ∂ú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelector('.quiz-submit').disabled = true;
            
            // 70% Ïù¥ÏÉÅ ÎßûÏ∑ÑÏùÑ Îïå Î≥¥ÏÉÅ
            if (percentage >= 70) {
                setTimeout(() => {
                    completeStudy('Í∏àÏúµ ÌÄ¥Ï¶à', 50000, 100);
                }, 1500);
            } else {
                setTimeout(() => {
                    alert(`${correctCount}/${totalQuestions}Í∞ú Ï†ïÎãµ! (${percentage.toFixed(0)}%)\n70% Ïù¥ÏÉÅ ÎßûÏ∂∞Ïïº Î≥¥ÏÉÅÏùÑ Î∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.`);
                    closeModal();
                }, 1500);
            }
        }

        // ÌÄ¥Ï¶à Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ Ï∂îÍ∞Ä (Îâ¥Ïä§ Í∏∞Î∞ò)
        // ÌïôÏäµ ÏôÑÎ£å Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ Ï∂îÍ∞Ä
        function addCompletionInterface(type) {
            const modalBody = document.getElementById('modalBody');
            const completionDiv = document.createElement('div');
            completionDiv.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px; border-top: 1px solid #eee;';
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 15px; color: #666;';
            messageDiv.textContent = 'ÌïôÏäµÏùÑ ÏôÑÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            
            const button = document.createElement('button');
            button.className = 'quiz-submit';
            button.textContent = 'ÌïôÏäµ ÏôÑÎ£åÌïòÍ∏∞';
            button.onclick = function() { completeStudy(type, 30000, 50); };
            
            const rewardDiv = document.createElement('div');
            rewardDiv.style.cssText = 'margin-top: 10px; font-size: 12px; color: #999;';
            rewardDiv.textContent = 'Î≥¥ÏÉÅ: 30,000Ïõê + 50 EXP';
            
            completionDiv.appendChild(messageDiv);
            completionDiv.appendChild(button);
            completionDiv.appendChild(rewardDiv);
            modalBody.appendChild(completionDiv);
        }

        // ÌïôÏäµ ÏôÑÎ£å Ï≤òÎ¶¨
        async function completeStudy(type, cashReward, expReward) {
            try {
                const today = getTodayDate();
                if (!userAssets.studyProgress) userAssets.studyProgress = {};
                if (!userAssets.studyProgress[today]) userAssets.studyProgress[today] = {};
                
                // Ïù¥ÎØ∏ ÏôÑÎ£åÌñàÎäîÏßÄ ÌôïÏù∏
                const typeKey = type === 'Í∏àÏúµ Ïö©Ïñ¥' ? 'financialTerms' : 
                              type === 'Í∏àÏúµ Îâ¥Ïä§' ? 'financialNews' : 'financialQuiz';
                
                if (userAssets.studyProgress[today][typeKey]) {
                    alert('Ïù¥ÎØ∏ Ïò§Îäò ÏôÑÎ£åÌïú ÏΩòÌÖêÏ∏†ÏûÖÎãàÎã§!');
                    return;
                }
                
                // Î≥¥ÏÉÅ ÏßÄÍ∏â
                userAssets.cash = (userAssets.cash || 0) + cashReward;
                userAssets.totalAssets = (userAssets.totalAssets || 0) + cashReward;
                userAssets.virtualBalance = (userAssets.virtualBalance || 0) + cashReward;
                userAssets.exp = (userAssets.exp || 0) + expReward;
                
                // Î†àÎ≤® ÏóÖ Ï≤¥ÌÅ¨
                const oldLevel = userAssets.level;
                userAssets.level = calculateUserLevel(userAssets.exp);
                
                // ÏôÑÎ£å ÏÉÅÌÉú Ï†ÄÏû•
                userAssets.studyProgress[today][typeKey] = true;
                userAssets.lastUpdated = new Date().toISOString();
                
                // FirebaseÏóê Ï†ÄÏû•
                const userRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}`);
                await window.firebaseSet(userRef, userAssets);
                
                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                
                // Î≥¥ÏÉÅ Ïï†ÎãàÎ©îÏù¥ÏÖò
                showRewardAnimation(cashReward, expReward);
                
                // Ïπ¥Îìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                updateCardCompletion(typeKey.replace(/([A-Z])/g, '-$1').toLowerCase().replace(/^-/, ''), true);
                
                // Î†àÎ≤®ÏóÖ Ï≤¥ÌÅ¨
                if (oldLevel !== userAssets.level) {
                    setTimeout(() => {
                        alert('üéâ Î†àÎ≤® ÏóÖ! ' + oldLevel.toUpperCase() + ' ‚Üí ' + userAssets.level.toUpperCase());
                    }, 2000);
                }
                
                // Î™®Îã¨ Îã´Í∏∞
                setTimeout(() => {
                    closeModal();
                }, 2000);
                
            } catch (error) {
                console.error('ÌïôÏäµ ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:', error);
                alert('Î≥¥ÏÉÅ ÏßÄÍ∏âÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // Îì±Í∏â ÏãúÏä§ÌÖú ÏÑ§Ï†ï (a1Í≥º ÎèôÏùº)
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW „ÖÅ.png', nav: 'YELLOW „Öá', navImage: 'YELLOW „Öá.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN „ÖÅ.png', nav: 'GREEN „Öá', navImage: 'GREEN „Öá.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE „ÖÅ.png', nav: 'BLUE „Öá', navImage: 'BLUE „Öá.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED „ÖÅ.png', nav: 'RED „Öá', navImage: 'RED „Öá.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK „ÖÅ.png', nav: 'BLACK „Öá', navImage: 'BLACK „Öá.png' }
        };

        // ÏÇ¨Ïö©Ïûê Îì±Í∏â Í≥ÑÏÇ∞ (a1Í≥º ÎèôÏùº)
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK'; // ÏµúÍ≥† Îì±Í∏â
        }

        // Îì±Í∏âÎ≥Ñ ÏÉâÏÉÅ Î∞òÌôò (a1Í≥º ÎèôÏùº)
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú Î≥ÑÏπ≠
        function calculateUserGrade(exp) {
            return calculateUserLevel(exp).toLowerCase();
        }

        // Î≥¥ÏÉÅ Ïï†ÎãàÎ©îÏù¥ÏÖò
        function showRewardAnimation(cash, exp) {
            // Î≥Ñ ÎÇ†Î¶¨Í∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò
            const starPositions = [
                { x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight },
                { x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight },
                { x: Math.random() * window.innerWidth, y: Math.random() * window.innerHeight }
            ];
            
            starPositions.forEach((pos, i) => {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'star-fly';
                    star.innerHTML = '‚≠ê';
                    star.style.left = pos.x + 'px';
                    star.style.top = pos.y + 'px';
                    document.body.appendChild(star);
                    
                    setTimeout(() => {
                        document.body.removeChild(star);
                    }, 1500);
                }, i * 200);
            });
            
            // Î≥¥ÏÉÅ ÌåùÏóÖ
            const rewardDiv = document.createElement('div');
            rewardDiv.className = 'reward-animation';
            rewardDiv.innerHTML = 'üéâ ÌïôÏäµ ÏôÑÎ£å!<br>üí∞ ' + cash.toLocaleString() + 'Ïõê<br>‚≠ê ' + exp + ' EXP';
            document.body.appendChild(rewardDiv);
            
            setTimeout(() => {
                document.body.removeChild(rewardDiv);
            }, 2000);
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeModal() {
            document.getElementById('contentModal').classList.remove('show');
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìö A2 ÌéòÏù¥ÏßÄ Î°úÎìúÎê®');
            
            // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏
            if (!checkLoginStatus()) return;
            
            // Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            // ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÏöîÏÜåÎì§Ïù¥ ÎÇòÌÉÄÎÇòÎèÑÎ°ù ÏÑ§Ï†ï
            const cards = document.querySelectorAll('.fade-in');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });

        // ÏÇ¨Ïö©Ïûê Îì±Í∏â Î°úÎìú Î∞è ÌëúÏãú
        async function loadUserGrade() {
            try {
                if (!window.firebaseDB || !currentUser) {
                    console.log('üî• Firebase ÎòêÎäî ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÎåÄÍ∏∞ Ï§ë...');
                    setTimeout(loadUserGrade, 500);
                    return;
                }
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}`);
                const snapshot = await window.firebaseGet(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const experience = userData.experience || 0;
                    const grade = calculateUserGrade(experience);
                    
                    // Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
                    updateGradeButton(grade);
                }
            } catch (error) {
                console.error('A2 Îì±Í∏â Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (a1Í≥º ÎèôÏùºÌïú Î°úÏßÅ)
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                // Îì±Í∏â Î≤ÑÌäº Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                if (gradeButtonImage && levelData.navImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    console.log('üéñÔ∏è A2 Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏:', upperGrade, levelData.navImage);
                }
            }
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ìï®Ïàò
        function goToPage(page) {
            console.log('üîÑ A2ÏóêÏÑú ÌéòÏù¥ÏßÄ Ïù¥Îèô:', page);
            
            // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌôúÏÑ± ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // ÌéòÏù¥ÏßÄ Ïù¥Îèô
            if (page !== 'a2.html') {
                window.location.href = page;
            } else {
                // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎ©¥ ÌôúÏÑ± ÏÉÅÌÉú Ïú†ÏßÄ
                const currentNavItem = document.querySelector('.nav-item[onclick*="a2.html"]');
                if (currentNavItem) {
                    currentNavItem.classList.add('active');
                }
            }
        }

        // Í∏∞ÌÉÄ Ìï®ÏàòÎì§
        function logout() {
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                localStorage.removeItem('fineu_current_user');
                localStorage.removeItem('fineu_user_assets');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('üìö ÏÉàÎ°úÏö¥ ÌïôÏäµ ÏΩòÌÖêÏ∏†Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!\n\n‚Ä¢ Ïò§ÎäòÏùò Í∏àÏúµ Ïö©Ïñ¥\n‚Ä¢ ÏµúÏã† Í∏àÏúµ Îâ¥Ïä§ Î∂ÑÏÑù\n‚Ä¢ Í∏àÏúµ ÌÄ¥Ï¶à Ï±åÎ¶∞ÏßÄ\n\nÏßÄÍ∏à Î∞îÎ°ú ÌïôÏäµÌïòÍ≥† Î≥¥ÏÉÅÏùÑ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî!');
        }
    </script>
</body>
</html>