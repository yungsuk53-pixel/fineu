<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - í•™ìŠµ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .study-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .study-card:active {
            transform: translateY(0);
        }

        .study-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .study-card.disabled:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .study-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .star-icon {
            color: #ffd700;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .star-icon.completed {
            color: #4CAF50;
            animation: sparkle 0.6s ease-in-out;
        }

        .study-card.completed {
            background: linear-gradient(135deg, #f0f8f0, #e8f5e8);
            border: 2px solid #4CAF50;
        }

        .divider {
            height: 2px;
            background: #333;
            margin: 30px 0;
            border-radius: 1px;
        }

        .scrap-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scrap-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .scrap-content {
            text-align: center;
            color: #666;
            font-size: 16px;
            font-weight: 600;
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ - a1ê³¼ ë™ì¼ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* ì¤‘ì•™ ë°˜ì› ëŒì¶œ ë¶€ë¶„ - a1ê³¼ ë™ì¼ */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: #fafaf8;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7cb9e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/ë ˆì´ì–´ 1.png" alt="FINE U ë¡œê³ " class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <div class="main-content">
        <div class="page-title">STUDY ZONE</div>

        <div class="study-card fade-in" id="card-financial-terms" style="animation-delay: 0.1s">
            <div class="study-title">ê¸ˆìœµ ìš©ì–´</div>
            <i class="fas fa-star star-icon" id="star-financial-terms"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-news" style="animation-delay: 0.2s">
            <div class="study-title">ê¸ˆìœµ ë‰´ìŠ¤</div>
            <i class="fas fa-star star-icon" id="star-financial-news"></i>
        </div>

        <div class="study-card fade-in" id="card-financial-quiz" style="animation-delay: 0.3s">
            <div class="study-title">ê¸ˆìœµ í€´ì¦ˆ</div>
            <i class="fas fa-star star-icon" id="star-financial-quiz"></i>
        </div>

        <div class="divider"></div>

        <div class="scrap-section fade-in" style="animation-delay: 0.4s" onclick="goToScrapPage()">
            <div class="scrap-content">
                ìŠ¤í¬ë©
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ - a1ê³¼ ë™ì¼í•œ êµ¬ì¡° -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/ì§‘.png" alt="í™ˆ">
            </div>
        </div>
        <div class="nav-item active" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/ë¬¸ì„œ.png" alt="ë¬¸ì„œ">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ã…‡.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/ì±„íŒ….png" alt="ì±„íŒ…">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ë”ë³´ê¸°.png" alt="ë”ë³´ê¸°">
            </div>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = 'AIzaSyBJhMtNOYyCfl6NRCQQz_CkTUHWP2TNweI';
        
        let currentUser = null;
        let userAssets = {};
        let isTodayDataReady = false;
        let contentHistory = {
            news: [],
            terms: [],
            quizzes: []
        };
        
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, navImage: 'YELLOW ã…‡.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, navImage: 'GREEN ã…‡.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, navImage: 'BLUE ã…‡.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, navImage: 'RED ã…‡.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, navImage: 'BLACK ã…‡.png' }
        };

        function calculateLevelFromExp(exp) {
            if (exp >= 50000) return 'black';
            if (exp >= 30000) return 'red';
            if (exp >= 15000) return 'blue';
            if (exp >= 5000) return 'green';
            return 'yellow';
        }
        
        function getTodayDate() {
            const now = new Date();
            const koreaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
            const year = koreaTime.getFullYear();
            const month = String(koreaTime.getMonth() + 1).padStart(2, '0');
            const day = String(koreaTime.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ì½˜í…ì¸  íˆìŠ¤í† ë¦¬ ë¡œë“œ
        async function loadContentHistory() {
            try {
                if (!window.firebaseDB) return;
                
                const historyRef = window.firebaseRef(window.firebaseDB, 'contentHistory');
                const snapshot = await window.firebaseGet(historyRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    contentHistory = {
                        news: data.news || [],
                        terms: data.terms || [],
                        quizzes: data.quizzes || []
                    };
                    console.log('ğŸ“š ì½˜í…ì¸  íˆìŠ¤í† ë¦¬ ë¡œë“œ:', {
                        ë‰´ìŠ¤: contentHistory.news.length,
                        ìš©ì–´: contentHistory.terms.length,
                        í€´ì¦ˆ: contentHistory.quizzes.length
                    });
                }
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì½˜í…ì¸  íˆìŠ¤í† ë¦¬ ì €ì¥
        async function saveContentHistory(type, items) {
            try {
                if (!window.firebaseDB) return;
                
                // ê¸°ì¡´ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                if (type === 'news') {
                    items.forEach(item => {
                        if (!contentHistory.news.some(n => n.title === item.title)) {
                            contentHistory.news.push({
                                title: item.title,
                                date: getTodayDate()
                            });
                        }
                    });
                } else if (type === 'terms') {
                    items.forEach(item => {
                        if (!contentHistory.terms.some(t => t.term === item.term)) {
                            contentHistory.terms.push({
                                term: item.term,
                                date: getTodayDate()
                            });
                        }
                    });
                } else if (type === 'quizzes') {
                    items.forEach(item => {
                        if (!contentHistory.quizzes.some(q => q.question === item.question)) {
                            contentHistory.quizzes.push({
                                question: item.question,
                                date: getTodayDate()
                            });
                        }
                    });
                }
                
                // ìµœê·¼ 100ê°œë§Œ ìœ ì§€ (ë©”ëª¨ë¦¬ ê´€ë¦¬)
                contentHistory.news = contentHistory.news.slice(-100);
                contentHistory.terms = contentHistory.terms.slice(-100);
                contentHistory.quizzes = contentHistory.quizzes.slice(-300); // í€´ì¦ˆëŠ” ë” ë§ì´ ìœ ì§€
                
                const historyRef = window.firebaseRef(window.firebaseDB, 'contentHistory');
                await window.firebaseSet(historyRef, contentHistory);
                
                console.log('âœ… ì½˜í…ì¸  íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸');
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ì¤‘ë³µ ì²´í¬ í•¨ìˆ˜
        function isContentDuplicate(type, item) {
            if (type === 'news') {
                return contentHistory.news.some(n => n.title === item.title);
            } else if (type === 'terms') {
                return contentHistory.terms.some(t => t.term === item.term);
            } else if (type === 'quiz') {
                return contentHistory.quizzes.some(q => q.question === item.question);
            }
            return false;
        }

        async function cleanOldData() {
            const today = new Date();
            const twoWeeksAgo = new Date(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('todayFinancialData_')) {
                    const dateStr = key.replace('todayFinancialData_', '');
                    const keyDate = new Date(dateStr);
                    if (keyDate < twoWeeksAgo) {
                        localStorage.removeItem(key);
                        console.log(`ì‚­ì œëœ ì˜¤ë˜ëœ ë¡œì»¬ ë°ì´í„°: ${key}`);
                    }
                }
            });

            if (window.firebaseDB && window.firebaseRemove) {
                try {
                    const cacheRef = window.firebaseRef(window.firebaseDB, 'cache');
                    const snapshot = await window.firebaseGet(cacheRef);
                    
                    if (snapshot.exists()) {
                        const cacheData = snapshot.val();
                        for (const key in cacheData) {
                            if (cacheData[key].date) {
                                const keyDate = new Date(cacheData[key].date);
                                if (keyDate < twoWeeksAgo) {
                                    const oldRef = window.firebaseRef(window.firebaseDB, `cache/${key}`);
                                    await window.firebaseRemove(oldRef);
                                    console.log(`Firebaseì—ì„œ ì‚­ì œëœ ì˜¤ë˜ëœ ë°ì´í„°: ${key}`);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Firebase ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                }
            }
        }

        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        function validateTodayData(data) {
            if (!data) return false;
            
            if (!data.date || !data.news || !data.terms || !data.quizzes) {
                console.log('âŒ í•„ìˆ˜ í•„ë“œ ëˆ„ë½');
                return false;
            }
            
            if (!Array.isArray(data.news) || data.news.length === 0) {
                console.log('âŒ ë‰´ìŠ¤ ë°ì´í„° ì—†ìŒ');
                return false;
            }
            
            if (!Array.isArray(data.terms) || data.terms.length < 3) {
                console.log('âŒ ìš©ì–´ ë°ì´í„° ë¶€ì¡± (3ê°œ í•„ìš”)');
                return false;
            }
            
            if (!data.quizzes.beginner || !Array.isArray(data.quizzes.beginner) || data.quizzes.beginner.length < 5) {
                console.log('âŒ ì´ˆê¸‰ í€´ì¦ˆ ë¶€ì¡± (5ê°œ í•„ìš”)');
                return false;
            }
            
            if (!data.quizzes.intermediate || !Array.isArray(data.quizzes.intermediate) || data.quizzes.intermediate.length < 5) {
                console.log('âŒ ì¤‘ê¸‰ í€´ì¦ˆ ì—†ìŒ');
                return false;
            }
            
            if (!data.quizzes.advanced || !Array.isArray(data.quizzes.advanced) || data.quizzes.advanced.length < 5) {
                console.log('âŒ ê³ ê¸‰ í€´ì¦ˆ ì—†ìŒ');
                return false;
            }
            
            console.log('âœ… ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ í†µê³¼');
            return true;
        }

        function updateStudyCardsStatus(status) {
            const cards = [
                { id: 'card-financial-terms', title: 'ê¸ˆìœµ ìš©ì–´', func: 'goToTermsPage' },
                { id: 'card-financial-news', title: 'ê¸ˆìœµ ë‰´ìŠ¤', func: 'goToNewsPage' },
                { id: 'card-financial-quiz', title: 'ê¸ˆìœµ í€´ì¦ˆ', func: 'goToQuizPage' }
            ];
            
            cards.forEach(card => {
                const cardElement = document.getElementById(card.id);
                if (!cardElement) return;
                
                if (status === 'loading') {
                    cardElement.classList.add('disabled');
                    cardElement.style.opacity = '0.5';
                    cardElement.style.cursor = 'not-allowed';
                    cardElement.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('ğŸ“Š ë°ì´í„°ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
                        return false;
                    };
                    
                    const starIcon = document.getElementById(`star-${card.id.replace('card-', '')}`);
                    if (starIcon) {
                        starIcon.className = 'fas fa-spinner fa-spin';
                        starIcon.style.color = '#999';
                    }
                } else if (status === 'ready') {
                    cardElement.classList.remove('disabled');
                    cardElement.style.opacity = '1';
                    cardElement.style.cursor = 'pointer';
                    
                    if (card.func === 'goToTermsPage') {
                        cardElement.onclick = function() { goToTermsPage(); };
                    } else if (card.func === 'goToNewsPage') {
                        cardElement.onclick = function() { goToNewsPage(); };
                    } else if (card.func === 'goToQuizPage') {
                        cardElement.onclick = function() { goToQuizPage(); };
                    }
                    
                    const starIcon = document.getElementById(`star-${card.id.replace('card-', '')}`);
                    if (starIcon) {
                        starIcon.className = 'fas fa-star star-icon';
                        starIcon.style.color = '#ffd700';
                    }
                    
                    checkTodayCompletion();
                }
            });
        }

        function showLoadingOverlay() {
            const existingOverlay = document.getElementById('loadingOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            overlay.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 16px; text-align: center;">
                    <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                    <h3 style="margin-bottom: 10px; color: #333;">ì˜¤ëŠ˜ì˜ í•™ìŠµ ì½˜í…ì¸  ìƒì„± ì¤‘</h3>
                    <p style="color: #666; font-size: 14px;">ìµœì‹  ê¸ˆìœµ ë‰´ìŠ¤ì™€ ìš©ì–´ë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">ìµœëŒ€ 30ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        async function loadUserDataFromFirebase() {
            try {
                if (!window.firebaseDB) {
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }

                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);

                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {},
                        scrappedItems: firebaseData.scrappedItems || []
                    };

                    const exp = userAssets.exp || 0;
                    let determinedLevel = 'yellow';
                    if (exp >= 50000) {
                        determinedLevel = 'black';
                    } else if (exp >= 30000) {
                        determinedLevel = 'red';
                    } else if (exp >= 15000) {
                        determinedLevel = 'blue';
                    } else if (exp >= 5000) {
                        determinedLevel = 'green';
                    }
                    userAssets.level = determinedLevel;
                    updateGradeButton(determinedLevel);
                } else {
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 10000000,
                        totalAssets: 10000000,
                        virtualBalance: 10000000,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {},
                        scrappedItems: []
                    };
                    updateGradeButton('yellow');
                }
                
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                checkTodayCompletion();
                
                // íˆìŠ¤í† ë¦¬ ë¡œë“œ í›„ ì½˜í…ì¸  ìƒì„±
                await loadContentHistory();
                await cleanOldData();
                await generateTodayContent();

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 10000000,
                    level: 'yellow',
                    exp: 0,
                    experience: 0,
                    studyProgress: {},
                    scrappedItems: []
                };
                updateGradeButton('yellow');
            }
        }

        function checkTodayCompletion() {
            const today = getTodayDate();
            
            if (!userAssets.studyProgress) {
                userAssets.studyProgress = {};
            }
            
            const todayProgress = userAssets.studyProgress[today] || {};
            
            updateCardCompletion('financial-terms', todayProgress.financialTerms === true);
            updateCardCompletion('financial-news', todayProgress.financialNews === true);
            updateCardCompletion('financial-quiz', todayProgress.financialQuiz === true);
        }

        function updateCardCompletion(type, completed) {
            const card = document.getElementById(`card-${type}`);
            const star = document.getElementById(`star-${type}`);
            
            if (completed) {
                card.classList.add('completed');
                star.classList.add('completed');
            } else {
                card.classList.remove('completed');
                star.classList.remove('completed');
            }
        }

        function updateGradeButton(grade) {
            const upperGrade = (grade || 'yellow').toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                if (gradeButtonImage && levelData.navImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    console.log('âœ… ê·¸ë ˆì´ë“œ ë²„íŠ¼ ì—…ë°ì´íŠ¸:', levelData.name);
                }
                const gradeButton = document.getElementById('gradeButton');
                if (gradeButton) {
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                }
            }
        }
        
        function updateLevelFromExp() {
            const exp = userAssets.exp || userAssets.experience || 0;
            let level = 'yellow';
            
            if (exp >= 50000) {
                level = 'black';
            } else if (exp >= 30000) {
                level = 'red';
            } else if (exp >= 15000) {
                level = 'blue';
            } else if (exp >= 5000) {
                level = 'green';
            }
            
            userAssets.level = level;
            updateGradeButton(level);
            return level;
        }

        async function getLatestFinanceNews() {
            try {
                const koreaTime = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                const dateStr = `${koreaTime.getFullYear()}ë…„ ${koreaTime.getMonth() + 1}ì›” ${koreaTime.getDate()}ì¼`;
                
                console.log(`ğŸ” ${dateStr} ì‹¤ì œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹œì‘...`);
                
                const rssProxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];
                
                const rssUrls = [
                    'https://news.google.com/rss/search?q=ê¸ˆìœµ+OR+ê²½ì œ+OR+ì£¼ì‹+OR+ì½”ìŠ¤í”¼&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=í•œêµ­ì€í–‰+OR+ê¸ˆë¦¬+OR+í™˜ìœ¨&hl=ko&gl=KR&ceid=KR:ko',
                    'https://news.google.com/rss/search?q=ì‚¼ì„±ì „ì+OR+SKí•˜ì´ë‹‰ìŠ¤+OR+ë°˜ë„ì²´&hl=ko&gl=KR&ceid=KR:ko'
                ];
                
                let allNews = [];
                
                for (const rssUrl of rssUrls) {
                    for (const proxy of rssProxies) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent(rssUrl);
                            const response = await fetch(proxyUrl);
                            
                            if (response.ok) {
                                const data = await response.text();
                                const newsItems = parseRSSData(data);
                                
                                if (newsItems && newsItems.length > 0) {
                                    allNews.push(...newsItems);
                                    break;
                                }
                            }
                        } catch (error) {
                            console.warn(`RSS í”„ë¡ì‹œ ì‹¤íŒ¨:`, error);
                        }
                    }
                }
                
                // ì¤‘ë³µ ì œê±° ë° í•„í„°ë§
                const uniqueNews = [];
                const seenTitles = new Set();
                
                for (const item of allNews) {
                    if (!seenTitles.has(item.title) && !isContentDuplicate('news', item)) {
                        uniqueNews.push({
                            id: `news-${uniqueNews.length}`,
                            title: item.title.replace(/<[^>]*>/g, ''),
                            description: item.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...',
                            content: item.description.replace(/<[^>]*>/g, ''),
                            url: item.url,
                            source: item.source || 'Google News',
                            category: 'ê¸ˆìœµë‰´ìŠ¤',
                            publishedAt: item.publishedAt || koreaTime.toISOString()
                        });
                        seenTitles.add(item.title);
                        
                        if (uniqueNews.length >= 5) break;
                    }
                }
                
                if (uniqueNews.length > 0) {
                    console.log(`âœ… ìƒˆë¡œìš´ ë‰´ìŠ¤ ${uniqueNews.length}ê±´ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ`);
                    await saveContentHistory('news', uniqueNews);
                    return uniqueNews;
                }
                
                console.log('âš ï¸ RSS ì‹¤íŒ¨, ëŒ€ì²´ ë‰´ìŠ¤ ì‚¬ìš©');
                return getFallbackNews();
                
            } catch (error) {
                console.error('ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return getFallbackNews();
            }
        }

        function parseRSSData(xmlText) {
            try {
                if (xmlText.includes('"contents"')) {
                    const jsonData = JSON.parse(xmlText);
                    xmlText = jsonData.contents;
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');
                
                const newsItems = [];
                items.forEach((item, index) => {
                    if (index < 10) { // ë” ë§ì€ ì•„ì´í…œ íŒŒì‹±
                        const title = item.querySelector('title')?.textContent;
                        const description = item.querySelector('description')?.textContent || '';
                        const link = item.querySelector('link')?.textContent;
                        const pubDate = item.querySelector('pubDate')?.textContent;
                        const source = item.querySelector('source')?.textContent || 'Google News';
                        
                        if (title && link) {
                            const financeKeywords = ['ê¸ˆìœµ', 'ê²½ì œ', 'ì½”ìŠ¤í”¼', 'ì½”ìŠ¤ë‹¥', 'í•œêµ­ì€í–‰', 'ê¸ˆë¦¬', 'í™˜ìœ¨', 'ì‚¼ì„±ì „ì', 'ì£¼ì‹', 'íˆ¬ì', 'ì¦ì‹œ', 'ê¸°ì—…', 'ì‹œì¥', 'ì€í–‰', 'ë³´í—˜', 'ì¦ê¶Œ'];
                            const hasKeyword = financeKeywords.some(keyword => 
                                title.includes(keyword) || description.includes(keyword)
                            );
                            
                            if (hasKeyword) {
                                newsItems.push({
                                    title: title,
                                    description: description || title,
                                    url: link,
                                    source: source,
                                    publishedAt: pubDate || new Date().toISOString()
                                });
                            }
                        }
                    }
                });
                
                return newsItems;
            } catch (error) {
                console.error('RSS íŒŒì‹± ì˜¤ë¥˜:', error);
                return [];
            }
        }

        function getFallbackNews() {
            const today = new Date();
            const kospiPrice = 2650 + Math.floor(Math.random() * 100);
            const usdRate = 1320 + Math.floor(Math.random() * 50);
            
            const fallbackNewsList = [
                {
                    id: 'news-0',
                    title: `í•œêµ­ì€í–‰, ê¸°ì¤€ê¸ˆë¦¬ 3.50% ë™ê²° ê²°ì •`,
                    description: `í•œêµ­ì€í–‰ì´ ${today.getMonth() + 1}ì›” ê¸ˆìœµí†µí™”ìœ„ì›íšŒì—ì„œ í˜„í–‰ ê¸°ì¤€ê¸ˆë¦¬ 3.50%ë¥¼ ìœ ì§€í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.`,
                    content: `í•œêµ­ì€í–‰ì´ ${today.getMonth() + 1}ì›” ê¸ˆìœµí†µí™”ìœ„ì›íšŒì—ì„œ í˜„í–‰ ê¸°ì¤€ê¸ˆë¦¬ 3.50%ë¥¼ ìœ ì§€í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤. ì¸í”Œë ˆì´ì…˜ ì••ë ¥ê³¼ ê²½ì œì„±ì¥ì„¸ë¥¼ ì¢…í•© ê³ ë ¤í•œ ê²°ê³¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`,
                    url: "https://www.bok.or.kr/",
                    source: "í•œêµ­ì€í–‰",
                    category: "í†µí™”ì •ì±…",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-1',
                    title: `ì½”ìŠ¤í”¼ ${kospiPrice}ì„ ì—ì„œ ë“±ë½ - ì™¸êµ­ì¸ íˆ¬ì ë™í–¥ ì£¼ëª©`,
                    description: `êµ­ë‚´ ì¦ì‹œê°€ ${kospiPrice}ëŒ€ì—ì„œ ë“±ë½ì„ ê±°ë“­í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    content: `êµ­ë‚´ ì¦ì‹œê°€ ${kospiPrice}ëŒ€ì—ì„œ ë“±ë½ì„ ê±°ë“­í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë°˜ë„ì²´ì™€ 2ì°¨ì „ì§€ ì—…ì¢…ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì™¸êµ­ì¸ íˆ¬ììë“¤ì˜ ë§¤ë§¤ íŒ¨í„´ì´ ì‹œì¥ ë°©í–¥ì„±ì„ ì¢Œìš°í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    url: "https://finance.naver.com/sise/",
                    source: "í•œêµ­ê±°ë˜ì†Œ",
                    category: "ì¦ì‹œë™í–¥",
                    publishedAt: today.toISOString()
                },
                {
                    id: 'news-2',
                    title: `ë‹¬ëŸ¬-ì› í™˜ìœ¨ ${usdRate}ì›ëŒ€ - ë¯¸ ì—°ì¤€ ì •ì±… ì˜í–¥`,
                    description: `ì›-ë‹¬ëŸ¬ í™˜ìœ¨ì´ ${usdRate}ì›ëŒ€ì—ì„œ í˜•ì„±ë˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    content: `ì›-ë‹¬ëŸ¬ í™˜ìœ¨ì´ ${usdRate}ì›ëŒ€ì—ì„œ í˜•ì„±ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë¯¸êµ­ ì—°ë°©ì¤€ë¹„ì œë„ì˜ í†µí™”ì •ì±… ë°©í–¥ê³¼ êµ­ë‚´ ê²½ì œì§€í‘œê°€ í™˜ìœ¨ ë³€ë™ì˜ ì£¼ìš” ìš”ì¸ìœ¼ë¡œ ì‘ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                    url: "https://www.koreaexim.go.kr/",
                    source: "í•œêµ­ìˆ˜ì¶œì…ì€í–‰",
                    category: "í™˜ìœ¨ë™í–¥",
                    publishedAt: today.toISOString()
                }
            ];
            
            // ì¤‘ë³µë˜ì§€ ì•Šì€ ë‰´ìŠ¤ë§Œ ë°˜í™˜
            const uniqueFallback = fallbackNewsList.filter(news => !isContentDuplicate('news', news));
            if (uniqueFallback.length > 0) {
                saveContentHistory('news', uniqueFallback);
            }
            return uniqueFallback;
        }

        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`GEMINI API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    let result = data.candidates[0].content.parts[0].text;
                    
                    result = result.replace(/```(?:json|javascript|js|html|css)?\s*/gi, '');
                    result = result.replace(/```\s*/g, '');
                    result = result.replace(/`/g, '');
                    result = result.trim();
                    
                    return result;
                } else {
                    throw new Error('GEMINI API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
                }
                
            } catch (error) {
                console.error('GEMINI API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        function generateIntermediateQuiz() {
            const quizPool = [
                {
                    question: "PERì´ ë‚®ì€ ì£¼ì‹ì˜ ì¼ë°˜ì ì¸ íŠ¹ì§•ì€?",
                    options: ["ê³ í‰ê°€ ìƒíƒœ", "ì €í‰ê°€ ê°€ëŠ¥ì„±", "ë°°ë‹¹ê¸ˆì´ ë†’ìŒ", "ì„±ì¥ì„±ì´ ë†’ìŒ"],
                    correct: 1,
                    explanation: "PERì´ ë‚®ë‹¤ëŠ” ê²ƒì€ ì£¼ê°€ê°€ ìˆ˜ìµ ëŒ€ë¹„ ì €í‰ê°€ë˜ì–´ ìˆì„ ê°€ëŠ¥ì„±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤."
                },
                {
                    question: "ê¸ˆë¦¬ ì¸ìƒ ì‹œ ì¼ë°˜ì ìœ¼ë¡œ í•˜ë½í•˜ëŠ” ìì‚°ì€?",
                    options: ["ì˜ˆê¸ˆ", "ì±„ê¶Œ ê°€ê²©", "ëŒ€ì¶œ ì´ì", "ì›í™” ê°€ì¹˜"],
                    correct: 1,
                    explanation: "ê¸ˆë¦¬ê°€ ì˜¤ë¥´ë©´ ê¸°ì¡´ ì±„ê¶Œì˜ ë§¤ë ¥ë„ê°€ ë–¨ì–´ì ¸ ì±„ê¶Œ ê°€ê²©ì´ í•˜ë½í•©ë‹ˆë‹¤."
                },
                {
                    question: "ë¶„ì‚°íˆ¬ìì˜ í•µì‹¬ ì›ë¦¬ëŠ”?",
                    options: ["ìˆ˜ìµ ê·¹ëŒ€í™”", "ìœ„í—˜ ë¶„ì‚°", "ì„¸ê¸ˆ ì ˆê°", "ê±°ë˜ ë¹„ìš© ì ˆê°"],
                    correct: 1,
                    explanation: "ë¶„ì‚°íˆ¬ìëŠ” ì—¬ëŸ¬ ìì‚°ì— íˆ¬ìí•˜ì—¬ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ìœ„í—˜ì„ ì¤„ì´ëŠ” ì „ëµì…ë‹ˆë‹¤."
                },
                {
                    question: "ROEê°€ ë†’ì€ ê¸°ì—…ì˜ íŠ¹ì§•ì€?",
                    options: ["ë¶€ì±„ê°€ ë§ìŒ", "ìê¸°ìë³¸ ìˆ˜ìµë¥ ì´ ë†’ìŒ", "ë§¤ì¶œì´ ì ìŒ", "ì„±ì¥ì„±ì´ ë‚®ìŒ"],
                    correct: 1,
                    explanation: "ROEëŠ” ìê¸°ìë³¸ ëŒ€ë¹„ ìˆœì´ìµ ë¹„ìœ¨ë¡œ, ë†’ì„ìˆ˜ë¡ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜ìµì„ ì°½ì¶œí•©ë‹ˆë‹¤."
                },
                {
                    question: "ì¸í”Œë ˆì´ì…˜ í—¤ì§€ì— ìœ ë¦¬í•œ ìì‚°ì€?",
                    options: ["í˜„ê¸ˆ", "ë¶€ë™ì‚°", "ì¥ê¸°ì±„ê¶Œ", "ì •ê¸°ì˜ˆê¸ˆ"],
                    correct: 1,
                    explanation: "ë¶€ë™ì‚°ì€ ë¬¼ê°€ìƒìŠ¹ê³¼ í•¨ê»˜ ê°€ì¹˜ê°€ ì˜¤ë¥´ëŠ” ê²½í–¥ì´ ìˆì–´ ì¸í”Œë ˆì´ì…˜ í—¤ì§€ì— ìœ ë¦¬í•©ë‹ˆë‹¤."
                }
            ];
            
            // ì¤‘ë³µë˜ì§€ ì•Šì€ í€´ì¦ˆ ì„ íƒ
            const uniqueQuizzes = quizPool.filter(quiz => !isContentDuplicate('quiz', quiz));
            const selectedQuizzes = uniqueQuizzes.slice(0, 5);
            
            // ë¶€ì¡±í•˜ë©´ ê¸°ë³¸ í€´ì¦ˆ ì¶”ê°€
            while (selectedQuizzes.length < 5) {
                selectedQuizzes.push(quizPool[selectedQuizzes.length]);
            }
            
            saveContentHistory('quizzes', selectedQuizzes);
            return selectedQuizzes;
        }

        function generateAdvancedQuiz() {
            const quizPool = [
                {
                    question: "ì˜µì…˜ì˜ ì‹œê°„ê°€ì¹˜ê°€ ê°€ì¥ ë¹ ë¥´ê²Œ ê°ì†Œí•˜ëŠ” ì‹œê¸°ëŠ”?",
                    options: ["ë§Œê¸° 6ê°œì›” ì „", "ë§Œê¸° 3ê°œì›” ì „", "ë§Œê¸° 1ê°œì›” ì „", "ë§Œê¸° ë‹¹ì¼"],
                    correct: 2,
                    explanation: "ì˜µì…˜ì˜ ì‹œê°„ê°€ì¹˜ëŠ” ë§Œê¸°ê°€ ê°€ê¹Œì›Œì§ˆìˆ˜ë¡ ê°€ì†ë„ì ìœ¼ë¡œ ê°ì†Œí•©ë‹ˆë‹¤(ì„¸íƒ€ decay)."
                },
                {
                    question: "í—¤ì§€í€ë“œê°€ ì‚¬ìš©í•˜ëŠ” 'ë¡±ìˆ ì „ëµ'ì˜ ëª©ì ì€?",
                    options: ["ë ˆë²„ë¦¬ì§€ ê·¹ëŒ€í™”", "ì‹œì¥ ì¤‘ë¦½ì  ìˆ˜ìµ", "ë°°ë‹¹ ìˆ˜ìµ", "í™˜ì°¨ìµ"],
                    correct: 1,
                    explanation: "ë¡±ìˆ ì „ëµì€ ì‹œì¥ ë°©í–¥ê³¼ ê´€ê³„ì—†ì´ ìˆ˜ìµì„ ì¶”êµ¬í•˜ëŠ” ì‹œì¥ ì¤‘ë¦½ ì „ëµì…ë‹ˆë‹¤."
                },
                {
                    question: "ì±„ê¶Œì˜ ë“€ë ˆì´ì…˜ì´ ì˜ë¯¸í•˜ëŠ” ê²ƒì€?",
                    options: ["ë§Œê¸°", "ì‹ ìš©ë“±ê¸‰", "ê¸ˆë¦¬ ë¯¼ê°ë„", "ìœ ë™ì„±"],
                    correct: 2,
                    explanation: "ë“€ë ˆì´ì…˜ì€ ê¸ˆë¦¬ ë³€ë™ì— ëŒ€í•œ ì±„ê¶Œ ê°€ê²©ì˜ ë¯¼ê°ë„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œì…ë‹ˆë‹¤."
                },
                {
                    question: "ìƒ¤í”„ ë¹„ìœ¨(Sharpe Ratio)ì´ ì¸¡ì •í•˜ëŠ” ê²ƒì€?",
                    options: ["ì ˆëŒ€ ìˆ˜ìµë¥ ", "ìœ„í—˜ ì¡°ì • ìˆ˜ìµë¥ ", "ë³€ë™ì„±", "ìµœëŒ€ ì†ì‹¤"],
                    correct: 1,
                    explanation: "ìƒ¤í”„ ë¹„ìœ¨ì€ ìœ„í—˜ ë‹¨ìœ„ë‹¹ ì´ˆê³¼ ìˆ˜ìµë¥ ì„ ì¸¡ì •í•˜ëŠ” ì§€í‘œì…ë‹ˆë‹¤."
                },
                {
                    question: "ì»¨íƒ±ê³ (Contango) ì‹œì¥ì˜ íŠ¹ì§•ì€?",
                    options: ["í˜„ë¬¼ê°€ê²© > ì„ ë¬¼ê°€ê²©", "ì„ ë¬¼ê°€ê²© > í˜„ë¬¼ê°€ê²©", "ê°€ê²© ë™ì¼", "ë³€ë™ì„± ì—†ìŒ"],
                    correct: 1,
                    explanation: "ì»¨íƒ±ê³ ëŠ” ì„ ë¬¼ê°€ê²©ì´ í˜„ë¬¼ê°€ê²©ë³´ë‹¤ ë†’ì€ ì •ìƒì ì¸ ì‹œì¥ ìƒí™©ì…ë‹ˆë‹¤."
                }
            ];
            
            // ì¤‘ë³µë˜ì§€ ì•Šì€ í€´ì¦ˆ ì„ íƒ
            const uniqueQuizzes = quizPool.filter(quiz => !isContentDuplicate('quiz', quiz));
            const selectedQuizzes = uniqueQuizzes.slice(0, 5);
            
            // ë¶€ì¡±í•˜ë©´ ê¸°ë³¸ í€´ì¦ˆ ì¶”ê°€
            while (selectedQuizzes.length < 5) {
                selectedQuizzes.push(quizPool[selectedQuizzes.length]);
            }
            
            saveContentHistory('quizzes', selectedQuizzes);
            return selectedQuizzes;
        }

        async function generateTodayContent() {
            const today = getTodayDate();
            const firebaseCacheKey = `daily_${today}`;
            
            console.log(`ğŸ“… ${today} ë°ì´í„° ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘`);
            
            updateStudyCardsStatus('loading');
            
            if (!window.firebaseDB) {
                console.log('â³ Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...');
                setTimeout(generateTodayContent, 1000);
                return;
            }
            
            try {
                console.log('ğŸ” Firebaseì—ì„œ ë°ì´í„° í™•ì¸ ì¤‘...');
                const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                const firebaseSnapshot = await window.firebaseGet(firebaseRef);
                
                let needsGeneration = false;
                let existingData = null;
                
                if (firebaseSnapshot.exists()) {
                    existingData = firebaseSnapshot.val();
                    console.log('ğŸ“¦ Firebaseì— ë°ì´í„° ì¡´ì¬');
                    
                    if (validateTodayData(existingData)) {
                        console.log('âœ… Firebase ë°ì´í„° ìœ íš¨ - ì‚¬ìš©');
                        localStorage.setItem('todayFinancialData', JSON.stringify(existingData));
                        localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(existingData));
                        isTodayDataReady = true;
                        updateStudyCardsStatus('ready');
                        return;
                    } else {
                        console.log('âŒ Firebase ë°ì´í„° ë¶ˆì™„ì „ - ì¬ìƒì„± í•„ìš”');
                        needsGeneration = true;
                    }
                } else {
                    console.log('âŒ Firebaseì— ë°ì´í„° ì—†ìŒ - ìƒì„± í•„ìš”');
                    needsGeneration = true;
                }
                
                if (needsGeneration) {
                    console.log('ğŸ”„ ìƒˆ ë°ì´í„° ìƒì„± ì‹œì‘...');
                    
                    showLoadingOverlay();
                    
                    const newsData = await getLatestFinanceNews();
                    console.log(`ğŸ“° ë‰´ìŠ¤ ${newsData.length}ê±´ ìˆ˜ì§‘ ì™„ë£Œ`);
                    
                    // ì´ë¯¸ ë³¸ ìš©ì–´ ì œì™¸í•˜ê³  í”„ë¡¬í”„íŠ¸ ìƒì„±
                    const excludedTerms = contentHistory.terms.map(t => t.term).join(', ');
                    const termsPrompt = `ì˜¤ëŠ˜ì˜ ê¸ˆìœµ ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¤‘ìš”í•œ ê¸ˆìœµ ìš©ì–´ 3ê°œë¥¼ ì„ ì •í•˜ê³  JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”:
                    ${newsData.map(n => n.title).join('\n')}
                    
                    ë‹¤ìŒ ìš©ì–´ë“¤ì€ ì´ë¯¸ í•™ìŠµí–ˆìœ¼ë¯€ë¡œ ì œì™¸í•´ì£¼ì„¸ìš”: ${excludedTerms}
                    
                    ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ 3ê°œì˜ ìƒˆë¡œìš´ ìš©ì–´ë¥¼ ë°˜í™˜:
                    [
                        {
                            "id": "term-0",
                            "term": "ìš©ì–´ëª… (ì˜ë¬¸ëª…)",
                            "definition": "ì •ì˜ (ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì‰½ê²Œ ì„¤ëª…)",
                            "example": "ì‹¤ì œ ì‚¬ë¡€ (êµ¬ì²´ì ì¸ ì˜ˆì‹œ)",
                            "isToday": true
                        },
                        {
                            "id": "term-1",
                            "term": "ìš©ì–´ëª… (ì˜ë¬¸ëª…)",
                            "definition": "ì •ì˜ (ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì‰½ê²Œ ì„¤ëª…)",
                            "example": "ì‹¤ì œ ì‚¬ë¡€ (êµ¬ì²´ì ì¸ ì˜ˆì‹œ)",
                            "isToday": true
                        },
                        {
                            "id": "term-2",
                            "term": "ìš©ì–´ëª… (ì˜ë¬¸ëª…)",
                            "definition": "ì •ì˜ (ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ì‰½ê²Œ ì„¤ëª…)",
                            "example": "ì‹¤ì œ ì‚¬ë¡€ (êµ¬ì²´ì ì¸ ì˜ˆì‹œ)",
                            "isToday": true
                        }
                    ]`;
                    
                    // ì´ë¯¸ ë³¸ í€´ì¦ˆ ë¬¸ì œ ì œì™¸
                    const excludedQuestions = contentHistory.quizzes.slice(-20).map(q => q.question).join(', ');
                    const quizPrompt = `ë‹¤ìŒ ê¸ˆìœµ ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ˆê¸‰ í€´ì¦ˆ 5ë¬¸ì œë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”:
                    ${newsData.map(n => n.title + '\n' + n.description).join('\n\n')}
                    
                    ë‹¤ìŒ ë¬¸ì œë“¤ê³¼ ìœ ì‚¬í•œ ë¬¸ì œëŠ” ì œì™¸í•´ì£¼ì„¸ìš”: ${excludedQuestions}
                    
                    ë¬¸ì œ êµ¬ì„±:
                    1. ë‰´ìŠ¤ ê´€ë ¨ ë¬¸ì œ 2ê°œ (ìœ„ ë‰´ìŠ¤ ë‚´ìš© ì§ì ‘ í™œìš©)
                    2. ìµœê·¼ ê²½ì œ íŠ¸ë Œë“œ ê¸ˆìœµ ìƒì‹ ë¬¸ì œ 2ê°œ (ìœ„ ë‰´ìŠ¤ì—ì„œ íŒŒì•…ë˜ëŠ” íŠ¸ë Œë“œ ê¸°ë°˜)
                    3. ì¬ë¯¸ìˆëŠ” ê¸ˆìœµ ë¬¸ì œ 1ê°œ (ì¼ìƒìƒí™œê³¼ ì—°ê´€ëœ ì‰¬ìš´ ë¬¸ì œ)
                    
                    ë‚œì´ë„: ê¸ˆìœµ ì´ˆë³´ìë„ ìƒì‹ìœ¼ë¡œ í’€ ìˆ˜ ìˆëŠ” ë§¤ìš° ì‰¬ìš´ ìˆ˜ì¤€
                    
                    ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:
                    {
                        "beginner": [
                            {
                                "question": "ë‰´ìŠ¤ ê´€ë ¨ ë¬¸ì œ 1",
                                "options": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3", "ì„ íƒì§€4"],
                                "correct": ì •ë‹µì¸ë±ìŠ¤(0-3),
                                "explanation": "ì™œ ì´ê²ƒì´ ì •ë‹µì¸ì§€ ì‰½ê²Œ ì„¤ëª…"
                            },
                            // ... 5ê°œ ë¬¸ì œ
                        ]
                    }`;
                    
                    let terms = [];
                    let quizzes = { beginner: [], intermediate: [], advanced: [] };
                    
                    const termsResponse = await callGeminiAPI(termsPrompt);
                    if (termsResponse) {
                        try {
                            const jsonMatch = termsResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                const parsedTerms = JSON.parse(jsonMatch[0]);
                                // ì¤‘ë³µ ì²´í¬
                                terms = parsedTerms.filter(term => !isContentDuplicate('terms', term));
                            }
                        } catch (e) {
                            console.error('Terms íŒŒì‹± ì‹¤íŒ¨:', e);
                        }
                    }
                    
                    // ìš©ì–´ê°€ ë¶€ì¡±í•˜ë©´ ê¸°ë³¸ ìš©ì–´ ì¶”ê°€
                    if (terms.length < 3) {
                        const defaultTerms = [
                            {
                                id: "term-0",
                                term: "ETF (Exchange Traded Fund)",
                                definition: "ê±°ë˜ì†Œì—ì„œ ì£¼ì‹ì²˜ëŸ¼ ê±°ë˜ë˜ëŠ” í€ë“œì…ë‹ˆë‹¤. ì—¬ëŸ¬ ì¢…ëª©ì„ í•œ ë²ˆì— íˆ¬ìí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                                example: "KODEX 200 ETFë¥¼ ì‚¬ë©´ ì½”ìŠ¤í”¼ 200 ê¸°ì—…ì— ë¶„ì‚°íˆ¬ìí•˜ëŠ” íš¨ê³¼ê°€ ìˆìŠµë‹ˆë‹¤.",
                                isToday: true
                            },
                            {
                                id: "term-1",
                                term: "ë°°ë‹¹ìˆ˜ìµë¥  (Dividend Yield)",
                                definition: "ì£¼ê°€ ëŒ€ë¹„ ë°°ë‹¹ê¸ˆì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤. ì•ˆì •ì ì¸ í˜„ê¸ˆíë¦„ì„ ì›í•˜ëŠ” íˆ¬ììê°€ ì„ í˜¸í•©ë‹ˆë‹¤.",
                                example: "ì£¼ê°€ 10ë§Œì›, ì—° ë°°ë‹¹ 3ì²œì›ì´ë©´ ë°°ë‹¹ìˆ˜ìµë¥ ì€ 3%ì…ë‹ˆë‹¤.",
                                isToday: true
                            },
                            {
                                id: "term-2",
                                term: "ë§¤ë§¤ì°¨ìµ (Capital Gain)",
                                definition: "ìì‚°ì„ ë§¤ì…í•œ ê°€ê²©ë³´ë‹¤ ë†’ì€ ê°€ê²©ì— ë§¤ë„í•˜ì—¬ ì–»ëŠ” ì´ìµì…ë‹ˆë‹¤.",
                                example: "100ë§Œì›ì— ì‚° ì£¼ì‹ì„ 150ë§Œì›ì— íŒ”ë©´ 50ë§Œì›ì˜ ë§¤ë§¤ì°¨ìµì´ ë°œìƒí•©ë‹ˆë‹¤.",
                                isToday: true
                            }
                        ].filter(term => !isContentDuplicate('terms', term));
                        
                        while (terms.length < 3 && defaultTerms.length > 0) {
                            terms.push(defaultTerms.shift());
                        }
                    }
                    
                    await saveContentHistory('terms', terms);
                    
                    const quizResponse = await callGeminiAPI(quizPrompt);
                    if (quizResponse) {
                        try {
                            const jsonMatch = quizResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const parsed = JSON.parse(jsonMatch[0]);
                                if (parsed.beginner && Array.isArray(parsed.beginner)) {
                                    // ì¤‘ë³µ ì²´í¬
                                    quizzes.beginner = parsed.beginner.filter(quiz => !isContentDuplicate('quiz', quiz));
                                }
                            }
                        } catch (e) {
                            console.error('Quiz íŒŒì‹± ì‹¤íŒ¨:', e);
                        }
                    }
                    
                    // ì´ˆê¸‰ í€´ì¦ˆê°€ ë¶€ì¡±í•˜ë©´ ê¸°ë³¸ í€´ì¦ˆ ì¶”ê°€
                    if (quizzes.beginner.length < 5) {
                        const defaultQuizzes = [
                            {
                                question: "ISA ê³„ì¢Œì˜ ê°€ì¥ í° ì¥ì ì€?",
                                options: ["ë†’ì€ ìˆ˜ìµë¥ ", "ì„¸ê¸ˆ í˜œíƒ", "ë¬´ì œí•œ ì…ê¸ˆ", "í•´ì™¸íˆ¬ì ì „ìš©"],
                                correct: 1,
                                explanation: "ISAëŠ” ê°œì¸ì¢…í•©ìì‚°ê´€ë¦¬ê³„ì¢Œë¡œ, ì¼ì • í•œë„ ë‚´ì—ì„œ ì„¸ê¸ˆ í˜œíƒì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                            },
                            {
                                question: "ì½”ìŠ¤ë‹¥ì€ ì£¼ë¡œ ì–´ë–¤ ê¸°ì—…ë“¤ì´ ìƒì¥ë˜ì–´ ìˆë‚˜ìš”?",
                                options: ["ëŒ€ê¸°ì—…", "ì¤‘ì†ŒÂ·ë²¤ì²˜ê¸°ì—…", "ì™¸êµ­ê¸°ì—…", "ê³µê¸°ì—…"],
                                correct: 1,
                                explanation: "ì½”ìŠ¤ë‹¥ì€ ì£¼ë¡œ ì„±ì¥ ê°€ëŠ¥ì„±ì´ ë†’ì€ ì¤‘ì†ŒÂ·ë²¤ì²˜ê¸°ì—…ë“¤ì´ ìƒì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
                            },
                            {
                                question: "í€ë“œ íˆ¬ìì˜ ì¥ì ì€?",
                                options: ["ë³´ì¥ëœ ìˆ˜ìµ", "ì „ë¬¸ê°€ ìš´ìš©", "ì„¸ê¸ˆ ë©´ì œ", "ì›ê¸ˆ ë³´ì¥"],
                                correct: 1,
                                explanation: "í€ë“œëŠ” ì „ë¬¸ í€ë“œë§¤ë‹ˆì €ê°€ ìš´ìš©í•˜ì—¬ ê°œì¸ì´ ì§ì ‘ íˆ¬ìí•˜ê¸° ì–´ë ¤ìš´ ë¶„ì‚°íˆ¬ìê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤."
                            },
                            {
                                question: "ì‹ ìš©ì¹´ë“œ ë¦¬ë³¼ë¹™ì˜ ìœ„í—˜ì„±ì€?",
                                options: ["ë‚®ì€ í•œë„", "ë†’ì€ ì´ì", "ì‚¬ìš© ë¶ˆí¸", "í¬ì¸íŠ¸ ì—†ìŒ"],
                                correct: 1,
                                explanation: "ë¦¬ë³¼ë¹™ì€ ë§¤ìš° ë†’ì€ ì´ììœ¨(ì—° 15-20%)ì´ ì ìš©ë˜ì–´ ë¹šì´ ëŠ˜ì–´ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                            },
                            {
                                question: "ì˜ˆê¸ˆìë³´í˜¸ì œë„ì˜ ë³´í˜¸ í•œë„ëŠ”?",
                                options: ["1ì²œë§Œì›", "3ì²œë§Œì›", "5ì²œë§Œì›", "1ì–µì›"],
                                correct: 2,
                                explanation: "ì˜ˆê¸ˆìë³´í˜¸ì œë„ëŠ” ê¸ˆìœµê¸°ê´€ë³„ë¡œ ì›ê¸ˆê³¼ ì´ìë¥¼ í•©ì³ 1ì¸ë‹¹ 5ì²œë§Œì›ê¹Œì§€ ë³´í˜¸í•©ë‹ˆë‹¤."
                            }
                        ].filter(quiz => !isContentDuplicate('quiz', quiz));
                        
                        while (quizzes.beginner.length < 5 && defaultQuizzes.length > 0) {
                            quizzes.beginner.push(defaultQuizzes.shift());
                        }
                    }
                    
                    await saveContentHistory('quizzes', quizzes.beginner);
                    
                    quizzes.intermediate = generateIntermediateQuiz();
                    quizzes.advanced = generateAdvancedQuiz();
                    
                    const todayData = {
                        date: today,
                        news: newsData,
                        terms: terms.slice(0, 3),
                        quizzes: quizzes
                    };
                    
                    console.log('ğŸ’¾ Firebaseì— ë°ì´í„° ì €ì¥ ì¤‘...');
                    await window.firebaseSet(firebaseRef, todayData);
                    console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ');
                    
                    localStorage.setItem('todayFinancialData', JSON.stringify(todayData));
                    localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(todayData));
                    console.log('âœ… localStorage ì €ì¥ ì™„ë£Œ');
                    
                    hideLoadingOverlay();
                    isTodayDataReady = true;
                    updateStudyCardsStatus('ready');
                }
                
            } catch (error) {
                console.error('âŒ ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨:', error);
                
                const fallbackData = {
                    date: today,
                    news: getFallbackNews(),
                    terms: [
                        {
                            id: "term-0",
                            term: "ë³µë¦¬ (Compound Interest)",
                            definition: "ì›ê¸ˆì— ë¶™ì€ ì´ìê°€ ë‹¤ì‹œ ì›ê¸ˆì´ ë˜ì–´ ì´ìê°€ ë¶™ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.",
                            example: "100ë§Œì›ì„ ì—° 10% ë³µë¦¬ë¡œ íˆ¬ìí•˜ë©´ 10ë…„ í›„ ì•½ 259ë§Œì›ì´ ë©ë‹ˆë‹¤.",
                            isToday: true
                        },
                        {
                            id: "term-1",
                            term: "ë¶„ì‚°íˆ¬ì (Diversification)",
                            definition: "ì—¬ëŸ¬ ìì‚°ì— ë‚˜ëˆ„ì–´ íˆ¬ìí•˜ì—¬ ìœ„í—˜ì„ ì¤„ì´ëŠ” ì „ëµì…ë‹ˆë‹¤.",
                            example: "ì£¼ì‹, ì±„ê¶Œ, ë¶€ë™ì‚° ë“± ë‹¤ì–‘í•œ ìì‚°ì— ë¶„ì‚° íˆ¬ìí•©ë‹ˆë‹¤.",
                            isToday: true
                        },
                        {
                            id: "term-2",
                            term: "ì¸í”Œë ˆì´ì…˜ (Inflation)",
                            definition: "ë¬¼ê°€ê°€ ì§€ì†ì ìœ¼ë¡œ ìƒìŠ¹í•˜ëŠ” í˜„ìƒì…ë‹ˆë‹¤.",
                            example: "ì‘ë…„ì— 1000ì›ì´ë˜ ë¹µì´ ì˜¬í•´ 1100ì›ì´ ë˜ëŠ” í˜„ìƒì…ë‹ˆë‹¤.",
                            isToday: true
                        }
                    ].filter(term => !isContentDuplicate('terms', term)),
                    quizzes: {
                        beginner: [
                            {
                                question: "ì˜ˆê¸ˆ ì´ìë¥¼ ê²°ì •í•˜ëŠ” ê¸°ì¤€ì´ ë˜ëŠ” ê¸ˆë¦¬ëŠ”?",
                                options: ["ì‹œì¥ê¸ˆë¦¬", "ê¸°ì¤€ê¸ˆë¦¬", "ëŒ€ì¶œê¸ˆë¦¬", "í™˜ìœ¨"],
                                correct: 1,
                                explanation: "í•œêµ­ì€í–‰ì´ ì •í•˜ëŠ” ê¸°ì¤€ê¸ˆë¦¬ê°€ ì‹œì¤‘ ê¸ˆë¦¬ì˜ ê¸°ì¤€ì´ ë©ë‹ˆë‹¤."
                            },
                            {
                                question: "ì£¼ì‹ì„ ì²˜ìŒ ì‹œì‘í•  ë•Œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€?",
                                options: ["í° ìˆ˜ìµ", "ë¹ ë¥¸ ë§¤ë§¤", "ë¦¬ìŠ¤í¬ ê´€ë¦¬", "ì°¨íŠ¸ ë¶„ì„"],
                                correct: 2,
                                explanation: "íˆ¬ìì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ì†ì‹¤ì„ ìµœì†Œí™”í•˜ëŠ” ë¦¬ìŠ¤í¬ ê´€ë¦¬ì…ë‹ˆë‹¤."
                            },
                            {
                                question: "1ë…„ì— ë¬¼ê°€ê°€ 3% ì˜¬ëë‹¤ë©´?",
                                options: ["ëˆì˜ ê°€ì¹˜ê°€ ì˜¬ëë‹¤", "ëˆì˜ ê°€ì¹˜ê°€ ë–¨ì–´ì¡Œë‹¤", "ë³€í™” ì—†ë‹¤", "í™˜ìœ¨ì´ ì˜¬ëë‹¤"],
                                correct: 1,
                                explanation: "ë¬¼ê°€ê°€ ì˜¤ë¥´ë©´ ê°™ì€ ëˆìœ¼ë¡œ ì‚´ ìˆ˜ ìˆëŠ” ë¬¼ê±´ì´ ì¤„ì–´ë“¤ì–´ ëˆì˜ ê°€ì¹˜ê°€ ë–¨ì–´ì§‘ë‹ˆë‹¤."
                            },
                            {
                                question: "ì ê¸ˆê³¼ ì˜ˆê¸ˆì˜ ì°¨ì´ëŠ”?",
                                options: ["ì´ììœ¨", "ì •ê¸° ë‚©ì… ì—¬ë¶€", "ìœ„í—˜ë„", "ì„¸ê¸ˆ"],
                                correct: 1,
                                explanation: "ì ê¸ˆì€ ë§¤ë‹¬ ì •ê¸°ì ìœ¼ë¡œ ë‚©ì…í•˜ê³ , ì˜ˆê¸ˆì€ í•œ ë²ˆì— ì˜ˆì¹˜í•©ë‹ˆë‹¤."
                            },
                            {
                                question: "ìš©ëˆì„ ëª¨ìœ¼ëŠ” ê°€ì¥ ì¢‹ì€ ë°©ë²•ì€?",
                                options: ["ì „ë¶€ ì†Œë¹„", "ì¼ë¶€ëŠ” ì €ì¶•", "íˆ¬ìë§Œ", "ë¹šë‚´ì„œ íˆ¬ì"],
                                correct: 1,
                                explanation: "ìˆ˜ì…ì˜ ì¼ë¶€ë¥¼ ê¾¸ì¤€íˆ ì €ì¶•í•˜ëŠ” ê²ƒì´ ìì‚°ì„ ë§Œë“œëŠ” ì²«ê±¸ìŒì…ë‹ˆë‹¤."
                            }
                        ].filter(quiz => !isContentDuplicate('quiz', quiz)),
                        intermediate: generateIntermediateQuiz(),
                        advanced: generateAdvancedQuiz()
                    }
                };
                
                await saveContentHistory('terms', fallbackData.terms);
                await saveContentHistory('quizzes', fallbackData.quizzes.beginner);
                
                try {
                    const firebaseRef = window.firebaseRef(window.firebaseDB, `cache/${firebaseCacheKey}`);
                    await window.firebaseSet(firebaseRef, fallbackData);
                } catch (e) {
                    console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', e);
                }
                
                localStorage.setItem('todayFinancialData', JSON.stringify(fallbackData));
                localStorage.setItem(`todayFinancialData_${today}`, JSON.stringify(fallbackData));
                
                hideLoadingOverlay();
                isTodayDataReady = true;
                updateStudyCardsStatus('ready');
            }
        }

        function goToTermsPage() {
            if (!isTodayDataReady) {
                alert('ğŸ“š í•™ìŠµ ë°ì´í„°ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            window.location.href = 'a2-terms.html';
        }

        function goToNewsPage() {
            if (!isTodayDataReady) {
                alert('ğŸ“° ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            window.location.href = 'a2-news.html';
        }

        function goToQuizPage() {
            if (!isTodayDataReady) {
                alert('â“ í€´ì¦ˆ ë°ì´í„°ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            window.location.href = 'a2-quiz.html';
        }

        function goToScrapPage() {
            window.location.href = 'a2-scrap.html';
        }

        function goToPage(page) {
            if (page === 'a2.html') return;
            window.location.href = page;
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('fineu_current_user');
                localStorage.removeItem('fineu_user_assets');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('ğŸ“š ìƒˆë¡œìš´ í•™ìŠµ ì½˜í…ì¸ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâ€¢ ì˜¤ëŠ˜ì˜ ê¸ˆìœµ ìš©ì–´ (3ê°œ)\nâ€¢ ìµœì‹  ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„\nâ€¢ ê¸ˆìœµ í€´ì¦ˆ ì±Œë¦°ì§€\n\nì§€ê¸ˆ ë°”ë¡œ í•™ìŠµí•˜ê³  ë³´ìƒì„ ë°›ì•„ë³´ì„¸ìš”!');
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            return true;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!checkLoginStatus()) return;
            
            updateStudyCardsStatus('loading');
            
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            const cards = document.querySelectorAll('.fade-in');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>
