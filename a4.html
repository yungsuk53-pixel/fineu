<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FINE U - ì±„íŒ…</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* ê³µí†µ í—¤ë” */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ìˆ˜ì • */
        .main-content {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 130px;
            padding: 10px 20px;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        .main-content.hidden {
            display: none;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        /* ì±„íŒ… ì˜ì—­ ìˆ˜ì • */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #7cb9e8;
            color: white;
        }

        .message.bot .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.system .message-bubble {
            background: #fffbf0;
            color: #666;
            border: 1px solid #ffd700;
            max-width: 90%;
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            max-width: 60px;
        }

        .typing-indicator.active {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* ì…ë ¥ ì˜ì—­ ìˆ˜ì • */
        .input-area {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 10px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }

        .input-area.hidden {
            display: none;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #333;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: #555;
            transform: scale(1.05);
        }

        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .attach-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .attach-button:hover {
            background: #f0f0f0;
        }

        /* ìŒì„± ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .voice-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .voice-button:hover {
            background: #f0f0f0;
        }

        /* ìŒì„± ëª¨ë“œ í™”ë©´ */
        .voice-mode-container {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 90;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .voice-mode-container.active {
            display: flex;
        }

        .voice-mode-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-mode-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .voice-assistant-avatar {
            width: 150px;
            height: 150px;
            background: white;
            border-radius: 50%;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .voice-assistant-avatar img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
        }

        .voice-assistant-avatar.listening {
            animation: pulse-listen 2s infinite;
        }

        .voice-assistant-avatar.speaking {
            animation: pulse-speak 1s infinite;
        }

        @keyframes pulse-listen {
            0% {
                box-shadow: 0 0 0 0 rgba(124, 185, 232, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(124, 185, 232, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(124, 185, 232, 0);
            }
        }

        @keyframes pulse-speak {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .voice-status-text {
            color: white;
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center;
            min-height: 30px;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            max-width: 350px;
        }

        .voice-transcript-text {
            color: white;
            font-size: 16px;
            line-height: 1.5;
            text-align: center;
        }

        .voice-control-button {
            width: 80px;
            height: 80px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #667eea;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .voice-control-button:hover {
            transform: scale(1.1);
        }

        .voice-control-button:active {
            transform: scale(0.95);
        }

        .voice-control-button.recording {
            background: #ff4444;
            color: white;
            animation: pulse-record 1.5s infinite;
        }

        @keyframes pulse-record {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }

        .voice-wave-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            margin: 20px 0;
        }

        .voice-wave-animation.hidden {
            visibility: hidden;
        }

        .voice-wave-bar {
            width: 4px;
            height: 20px;
            background: white;
            margin: 0 3px;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .voice-wave-bar:nth-child(2) {
            animation-delay: 0.1s;
            height: 30px;
        }

        .voice-wave-bar:nth-child(3) {
            animation-delay: 0.2s;
            height: 25px;
        }

        .voice-wave-bar:nth-child(4) {
            animation-delay: 0.3s;
            height: 35px;
        }

        .voice-wave-bar:nth-child(5) {
            animation-delay: 0.4s;
            height: 20px;
        }

        @keyframes wave {
            0%, 100% {
                transform: scaleY(1);
                opacity: 0.8;
            }
            50% {
                transform: scaleY(1.5);
                opacity: 1;
            }
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* ì¤‘ì•™ ë°˜ì› ëŒì¶œ ë¶€ë¶„ ì¶”ê°€ */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        /* ë“±ê¸‰ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ */
        .grade-button {
            width: 55px;
            height: 55px;
            background: transparent;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        /* êµìœ¡ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .education-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .education-modal.active {
            display: block;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .modal-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .modal-button.confirm {
            background: #7cb9e8;
            color: white;
        }

        .modal-button.cancel {
            background: #ddd;
            color: #333;
        }

        .modal-button:hover {
            opacity: 0.8;
        }

        .modal-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ë°˜ì‘í˜• ìˆ˜ì • */
        @media (max-width: 480px) {
            .main-content {
                padding: 10px 15px;
                width: 100%;
                max-width: none;
            }
            
            .input-area {
                padding: 10px 15px;
                max-width: none;
            }
            
            .chat-input {
                padding: 10px 14px;
                font-size: 16px;
            }
            
            .send-button,
            .attach-button,
            .voice-button {
                width: 36px;
                height: 36px;
            }
        }

        /* iOS Safe Area ëŒ€ì‘ */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(70px + env(safe-area-inset-bottom));
            }
            
            .input-area {
                bottom: calc(70px + env(safe-area-inset-bottom));
            }
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/ë ˆì´ì–´ 1.png" alt="FINE U ë¡œê³ " class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content" id="mainContent">
        <div class="page-title">AI CHATBOT</div>
        
        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="chat-area" id="chatArea">
            <!-- íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° -->
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- ìŒì„± ëª¨ë“œ í™”ë©´ -->
    <div class="voice-mode-container" id="voiceModeContainer">
        <button class="voice-mode-close" onclick="closeVoiceMode()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="voice-assistant-avatar" id="voiceAvatar">
            <img src="images/ë˜‘ë¶€ë¦¬.png" alt="ë˜‘ë¶€ë¦¬">
        </div>
        
        <div class="voice-status-text" id="voiceStatus">
            ìŒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤
        </div>
        
        <div class="voice-wave-animation" id="voiceWave">
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
        </div>
        
        <div class="voice-transcript">
            <div class="voice-transcript-text" id="voiceTranscript">
                ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•´ì£¼ì„¸ìš”
            </div>
        </div>
        
        <button class="voice-control-button" id="voiceControlButton" onclick="toggleVoiceRecording()">
            <i class="fas fa-microphone" id="voiceControlIcon"></i>
        </button>
    </div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <div class="input-area" id="inputArea">
        <div class="input-container">
            <button class="attach-button" onclick="attachFile()">
                <i class="fas fa-camera"></i>
            </button>
            <button class="voice-button" id="voiceButton" onclick="openVoiceMode()">
                <i class="fas fa-microphone"></i>
            </button>
            <input type="text" class="chat-input" placeholder="ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš”." id="chatInput" onkeypress="handleKeyPress(event)">
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- êµìœ¡ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeEducationModal()"></div>
    <div class="education-modal" id="educationModal">
        <div class="modal-title" id="modalTitle">ê´€ë¦¬ì ì¸ì¦</div>
        <div id="modalContent">
            <input type="password" class="modal-input" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="modal-buttons">
            <button class="modal-button cancel" onclick="closeEducationModal()">ì·¨ì†Œ</button>
            <button class="modal-button confirm" id="modalConfirmBtn" onclick="handleEducationAuth()">í™•ì¸</button>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/ì§‘.png" alt="í™ˆ">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/ë¬¸ì„œ.png" alt="ë¬¸ì„œ">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ã…‡.png" alt="YELLOW">
        </div>
        <div class="nav-item active" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/ì±„íŒ….png" alt="ì±„íŒ…">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ë”ë³´ê¸°.png" alt="ë”ë³´ê¸°">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
        database.ref('.info/connected').on('value', (snapshot) => {
            const connected = snapshot.val();
            console.log('ğŸ”¥ Firebase ì—°ê²° ìƒíƒœ:', connected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŠê¹€');
        });

        // Gemini API ì„¤ì •
        const GEMINI_API_KEY = 'AIzaSyDMawZDEzBrAvAJt8ZrZxvvq2aZIRnbObk';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // ìŒì„± ì¸ì‹ ê´€ë ¨ ë³€ìˆ˜
        let recognition = null;
        let isRecording = false;
        let speechSynthesis = window.speechSynthesis;
        let isSpeaking = false;
        let isVoiceMode = false;
        let voiceModeAutoListen = true;

        // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.interimResults = true;
                recognition.continuous = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    console.log('ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘');
                    isRecording = true;
                    if (isVoiceMode) {
                        updateVoiceModeUI('listening');
                    }
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('ğŸ¤ ì¸ì‹ëœ í…ìŠ¤íŠ¸:', transcript);
                    
                    if (isVoiceMode) {
                        document.getElementById('voiceTranscript').textContent = transcript;
                        
                        if (event.results[0].isFinal) {
                            // ìŒì„± ì¸ì‹ ì™„ë£Œ ì‹œ ë°”ë¡œ ë©”ì‹œì§€ ì „ì†¡
                            setTimeout(() => {
                                sendVoiceMessage(transcript);
                            }, 500);
                        }
                    } else {
                        document.getElementById('chatInput').value = transcript;
                        if (event.results[0].isFinal) {
                            setTimeout(() => {
                                sendMessage();
                            }, 500);
                        }
                    }
                };

                recognition.onerror = function(event) {
                    console.error('âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                    if (event.error === 'no-speech') {
                        if (isVoiceMode) {
                            updateVoiceModeUI('ready');
                            document.getElementById('voiceTranscript').textContent = 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        }
                    } else if (event.error === 'not-allowed') {
                        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                    }
                    stopVoiceRecording();
                };

                recognition.onend = function() {
                    console.log('ğŸ¤ ìŒì„± ì¸ì‹ ì¢…ë£Œ');
                    stopVoiceRecording();
                };
            } else {
                console.warn('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ìŒì„± ëª¨ë“œ ì—´ê¸°
        function openVoiceMode() {
            isVoiceMode = true;
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('inputArea').classList.add('hidden');
            document.getElementById('voiceModeContainer').classList.add('active');
            
            updateVoiceModeUI('ready');
            document.getElementById('voiceTranscript').textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•´ì£¼ì„¸ìš”';
            
            // ìŒì„± ëª¨ë“œ ì§„ì… ì•ˆë‚´
            speakText('ìŒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•´ì£¼ì„¸ìš”.');
        }

        // ìŒì„± ëª¨ë“œ ë‹«ê¸°
        function closeVoiceMode() {
            isVoiceMode = false;
            voiceModeAutoListen = true;
            
            // ìŒì„± ì¤‘ì§€
            if (isRecording) {
                stopVoiceRecording();
            }
            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            document.getElementById('voiceModeContainer').classList.remove('active');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
        }

        // ìŒì„± ëª¨ë“œ UI ì—…ë°ì´íŠ¸
        function updateVoiceModeUI(status) {
            const avatar = document.getElementById('voiceAvatar');
            const statusText = document.getElementById('voiceStatus');
            const controlButton = document.getElementById('voiceControlButton');
            const controlIcon = document.getElementById('voiceControlIcon');
            const waveAnimation = document.getElementById('voiceWave');
            
            switch(status) {
                case 'listening':
                    avatar.classList.add('listening');
                    avatar.classList.remove('speaking');
                    statusText.textContent = 'ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
                    controlButton.classList.add('recording');
                    controlIcon.className = 'fas fa-stop';
                    waveAnimation.classList.remove('hidden');
                    break;
                    
                case 'speaking':
                    avatar.classList.add('speaking');
                    avatar.classList.remove('listening');
                    statusText.textContent = 'ë‹µë³€ ì¤‘...';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
                    
                case 'processing':
                    avatar.classList.remove('listening', 'speaking');
                    statusText.textContent = 'ì²˜ë¦¬ ì¤‘...';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
                    
                case 'ready':
                default:
                    avatar.classList.remove('listening', 'speaking');
                    statusText.textContent = 'ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
            }
        }

        // ìŒì„± ë©”ì‹œì§€ ì „ì†¡
        async function sendVoiceMessage(message) {
            if (!message || message.trim() === '') return;
            
            updateVoiceModeUI('processing');
            document.getElementById('voiceTranscript').textContent = 'ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            
            // ì±„íŒ… ì˜ì—­ì— ë©”ì‹œì§€ ì¶”ê°€
            addMessage(message, 'user', true);
            
            try {
                const userInfo = await getUserFinancialInfo();
                const response = await callGeminiAPI(message, userInfo);
                
                // ì±„íŒ… ì˜ì—­ì— ì‘ë‹µ ì¶”ê°€
                addMessage(response, 'bot', true);
                
                // ìŒì„± ëª¨ë“œì—ì„œ ì‘ë‹µ í‘œì‹œ ë° ìŒì„± ì¶œë ¥
                document.getElementById('voiceTranscript').textContent = response;
                updateVoiceModeUI('speaking');
                
                // ìŒì„± ì¶œë ¥ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ë“£ê¸° ëª¨ë“œ
                speakTextWithCallback(response, () => {
                    if (isVoiceMode && voiceModeAutoListen) {
                        updateVoiceModeUI('ready');
                        document.getElementById('voiceTranscript').textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•´ì£¼ì„¸ìš”';
                    }
                });
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                const errorMessage = 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                document.getElementById('voiceTranscript').textContent = errorMessage;
                addMessage(errorMessage, 'bot', false);
                speakText(errorMessage);
                
                setTimeout(() => {
                    if (isVoiceMode) {
                        updateVoiceModeUI('ready');
                        document.getElementById('voiceTranscript').textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•´ì£¼ì„¸ìš”';
                    }
                }, 3000);
            }
        }

        // ìŒì„± ë…¹ìŒ í† ê¸€
        function toggleVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        // ìŒì„± ë…¹ìŒ ì‹œì‘
        function startVoiceRecording() {
            if (!recognition) {
                initSpeechRecognition();
            }
            
            // ìŒì„± ì¶œë ¥ ì¤‘ì´ë©´ ì¤‘ì§€
            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            if (recognition) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:', error);
                    if (isVoiceMode) {
                        document.getElementById('voiceTranscript').textContent = 'ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                }
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ìŒì„± ë…¹ìŒ ì¤‘ì§€
        function stopVoiceRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            isRecording = false;
            if (isVoiceMode) {
                updateVoiceModeUI('ready');
            }
        }

        undefined

        // í…ìŠ¤íŠ¸ë¥¼ ìŒì„±ìœ¼ë¡œ ë³€í™˜
        function speakText(text) {
            console.log('ğŸ”Š speakText í˜¸ì¶œ:', text.substring(0, 30) + '...');
            speakTextWithCallback(text, null);
        }

        // ë“±ê¸‰ ì‹œìŠ¤í…œ ì„¤ì •
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW ã….png', nav: 'YELLOW ã…‡', navImage: 'YELLOW ã…‡.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN ã….png', nav: 'GREEN ã…‡', navImage: 'GREEN ã…‡.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE ã….png', nav: 'BLUE ã…‡', navImage: 'BLUE ã…‡.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED ã….png', nav: 'RED ã…‡', navImage: 'RED ã…‡.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK ã….png', nav: 'BLACK ã…‡', navImage: 'BLACK ã…‡.png' }
        };

        // ì‚¬ìš©ì ì •ë³´
        let currentUser = JSON.parse(localStorage.getItem('fineu_current_user')) || {
            id: 'user_' + Date.now(),
            name: 'ì‚¬ìš©ì',
            level: 'yellow',
            exp: 0
        };

        // ì±„íŒ… íˆìŠ¤í† ë¦¬
        let chatHistory = [];
        let isProcessing = false;

        // êµìœ¡ ë°ì´í„°
        let educationData = [];
        let educationMode = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸš€ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
    initSpeechRecognition();
    
    // ìŒì„± ëª©ë¡ ë¡œë“œ (ë¹„ë™ê¸°)
    if (speechSynthesis) {
        speechSynthesis.getVoices();
        speechSynthesis.onvoiceschanged = function() {
            const voices = speechSynthesis.getVoices();
            console.log('ğŸ”Š ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„±:', voices.filter(v => v.lang.includes('ko')));
        };
    }
    
    await loadUserDataFromFirebase();
    await loadEducationDataFromFirebase();
    await loadChatHistory();
    
    // í™˜ì˜ ë©”ì‹œì§€ì™€ ìŒì„±ì„ ì•½ê°„ ì§€ì—°ì‹œì¼œ ìë™ì¬ìƒ ì°¨ë‹¨ ìš°íšŒ
    setTimeout(() => {
        initializeWelcomeMessage();
        
        // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ìœ ë„ë¥¼ ìœ„í•œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        document.addEventListener('click', function enableAudio() {
            // ì²« í´ë¦­ ì‹œ ìŒì„± í™œì„±í™”
            const welcomeText = "ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ì—¬ëŸ¬ë¶„ì˜ ìŠ¬ê¸°ë¡œìš´ ê¸ˆìœµ ìƒí™œì„ ë•ëŠ” ë˜‘ë¶€ë¦¬ì—ìš”. í˜¹ì‹œ ë„ì›€ì´ í•„ìš”í•œ ì¼ì´ ìˆë‚˜ìš”?";
            speakText(welcomeText);
            // ì´ë²¤íŠ¸ ì œê±°
            document.removeEventListener('click', enableAudio);
        }, { once: true });
    }, 500);
});

        // Firebaseì—ì„œ êµìœ¡ ë°ì´í„° ë¡œë“œ
        async function loadEducationDataFromFirebase() {
            try {
                console.log('ğŸ“š êµìœ¡ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                const snapshot = await database.ref('educations').once('value');
                const data = snapshot.val();
                
                if (data) {
                    educationData = Object.entries(data).map(([key, value]) => ({
                        id: key,
                        ...value
                    }));
                    educationData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    console.log(`âœ… ${educationData.length}ê°œì˜ êµìœ¡ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                } else {
                    educationData = [];
                    console.log('ğŸ“š ì €ì¥ëœ êµìœ¡ ë°ì´í„° ì—†ìŒ');
                }
            } catch (error) {
                console.error('âŒ êµìœ¡ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                educationData = [];
            }
        }

        // Firebaseì—ì„œ ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadUserDataFromFirebase() {
            console.log('=== ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');
            
            try {
                const savedUser = localStorage.getItem('fineu_current_user');
                if (!savedUser) {
                    console.log('âŒ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ');
                    return;
                }
                
                currentUser = JSON.parse(savedUser);
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('ğŸ‘¤ ì‚¬ìš©ì ID:', userId);
                
                const snapshot = await database.ref(`users/${userId}`).once('value');
                
                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    console.log('âœ… Firebase ë°ì´í„° ë¡œë“œ ì„±ê³µ');
                    
                    const exp = firebaseData.exp || firebaseData.experience || 0;
                    const userLevel = calculateUserLevel(exp);
                    
                    currentUser.exp = exp;
                    currentUser.level = userLevel.toLowerCase();
                    
                    updateGradeButton(currentUser.level);
                } else {
                    console.log('âŒ Firebaseì— ë°ì´í„° ì—†ìŒ');
                    updateGradeButton('yellow');
                }
                
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                updateGradeButton('yellow');
            }
        }

        // ì‚¬ìš©ì ë“±ê¸‰ ê³„ì‚°
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK';
        }

        // ë“±ê¸‰ë³„ ìƒ‰ìƒ ë°˜í™˜
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButton = document.getElementById('gradeButton');
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                
                if (gradeButton && gradeButtonImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                }
            }
        }

        // í™˜ì˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
function initializeWelcomeMessage() {
    const welcomeMessage = "ì•ˆë…•í•˜ì„¸ìš”.\nì €ëŠ” ì—¬ëŸ¬ë¶„ì˜ ìŠ¬ê¸°ë¡œìš´ ê¸ˆìœµ ìƒí™œì„ ë•ëŠ” ë˜‘ë¶€ë¦¬ì—ìš”.\ní˜¹ì‹œ ë„ì›€ì´ í•„ìš”í•œ ì¼ì´ ìˆë‚˜ìš”?";
    addMessage(welcomeMessage, 'bot', false, true); // ë§ˆì§€ë§‰ íŒŒë¼ë¯¸í„°ë¥¼ trueë¡œ ë³€ê²½
}


        // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ
        async function loadChatHistory() {
            try {
                const snapshot = await database.ref(`chats/${currentUser.id}`).limitToLast(20).once('value');
                const data = snapshot.val();
                if (data) {
                    Object.values(data).forEach(msg => {
                        addMessage(msg.text, msg.sender, false, false); // íˆìŠ¤í† ë¦¬ëŠ” ìŒì„± ì¶œë ¥ ì•ˆí•¨
                    });
                }
            } catch (error) {
                console.error('ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '' || isProcessing) return;

            // êµìœ¡ ëª…ë ¹ì–´ ì²´í¬
            if (message === '/êµìœ¡í•˜ê¸°') {
                input.value = '';
                showEducationModal('auth');
                return;
            } else if (message === '/êµìœ¡ëª©ë¡') {
                input.value = '';
                await showEducationList();
                return;
            } else if (message.startsWith('/êµìœ¡ì‚­ì œ ')) {
                const index = parseInt(message.split(' ')[1]) - 1;
                input.value = '';
                await deleteEducation(index);
                return;
            }
            
            isProcessing = true;
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            addMessage(message, 'user', true);
            input.value = '';
            
            showTypingIndicator();
            
            try {
                const userInfo = await getUserFinancialInfo();
                const response = await callGeminiAPI(message, userInfo);
                hideTypingIndicator();
                addMessage(response, 'bot', true, true); // ë´‡ ì‘ë‹µì€ ìŒì„± ì¶œë ¥
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                hideTypingIndicator();
                const errorMessage = 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                addMessage(errorMessage, 'bot', false, true); // ì—ëŸ¬ ë©”ì‹œì§€ë„ ìŒì„± ì¶œë ¥
            } finally {
                isProcessing = false;
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        // êµìœ¡ ëª¨ë‹¬ í‘œì‹œ
        function showEducationModal(mode) {
            educationMode = mode;
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            
            if (mode === 'auth') {
                title.textContent = 'ê´€ë¦¬ì ì¸ì¦';
                content.innerHTML = '<input type="password" class="modal-input" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key===\'Enter\') handleEducationAuth()">';
                confirmBtn.onclick = handleEducationAuth;
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'í™•ì¸';
            } else if (mode === 'content') {
                title.textContent = 'êµìœ¡ ë‚´ìš© ì…ë ¥';
                content.innerHTML = '<textarea class="modal-textarea" id="educationContent" placeholder="êµìœ¡í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”\nì˜ˆ: ê¸ˆìœµê°ë…ì›ì¥ ì´ë¦„ì€ ì´ì°¬ì§„ì…ë‹ˆë‹¤."></textarea>';
                confirmBtn.onclick = saveEducation;
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ì €ì¥';
            }
            
            modal.classList.add('active');
            overlay.classList.add('active');
            
            // í¬ì»¤ìŠ¤ ì„¤ì •
            setTimeout(() => {
                if (mode === 'auth') {
                    document.getElementById('adminPassword')?.focus();
                } else if (mode === 'content') {
                    document.getElementById('educationContent')?.focus();
                }
            }, 100);
        }

        // êµìœ¡ ëª¨ë‹¬ ë‹«ê¸°
        function closeEducationModal() {
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            overlay.classList.remove('active');
            educationMode = null;
        }

        // ê´€ë¦¬ì ì¸ì¦ ì²˜ë¦¬
        function handleEducationAuth() {
            const password = document.getElementById('adminPassword').value;
            if (password === '0317') {
                closeEducationModal();
                setTimeout(() => {
                    showEducationModal('content');
                }, 300);
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // êµìœ¡ ë‚´ìš© ì €ì¥
        async function saveEducation() {
            const content = document.getElementById('educationContent').value.trim();
            if (!content) {
                alert('êµìœ¡ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'ì €ì¥ ì¤‘...';

            try {
                // Firebaseì— ì €ì¥
                const educationRef = database.ref('educations').push();
                const educationData = {
                    content: content,
                    timestamp: Date.now(),
                    createdBy: currentUser.id || 'admin',
                    createdAt: new Date().toISOString()
                };
                
                await educationRef.set(educationData);
                
                console.log('âœ… êµìœ¡ ë°ì´í„° ì €ì¥ ì„±ê³µ:', educationRef.key);
                
                // ë¡œì»¬ ë°°ì—´ ì—…ë°ì´íŠ¸
                await loadEducationDataFromFirebase();
                
                const successMessage = 'âœ… êµìœ¡ ë‚´ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                addMessage(successMessage, 'system', false);
                closeEducationModal();
                
            } catch (error) {
                console.error('âŒ êµìœ¡ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ì €ì¥';
            }
        }

        // êµìœ¡ ëª©ë¡ í‘œì‹œ
        async function showEducationList() {
            await loadEducationDataFromFirebase();
            
            if (educationData.length === 0) {
                const emptyMessage = 'ğŸ“š ì €ì¥ëœ êµìœ¡ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.\n\n/êµìœ¡í•˜ê¸° ëª…ë ¹ì–´ë¡œ ìƒˆë¡œìš´ êµìœ¡ ë‚´ìš©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                addMessage(emptyMessage, 'system', false);
                return;
            }
            
            let listMessage = `ğŸ“š êµìœ¡ ëª©ë¡ (ì´ ${educationData.length}ê°œ)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            educationData.forEach((item, index) => {
                const date = item.createdAt ? new Date(item.createdAt).toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                const preview = item.content.length > 40 ? 
                    item.content.substring(0, 40) + '...' : item.content;
                listMessage += `[${index + 1}] ${preview}\n   ğŸ“… ${date}\n\n`;
            });
            listMessage += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ ì‚­ì œ: /êµìœ¡ì‚­ì œ [ë²ˆí˜¸]\nğŸ’¡ ì¶”ê°€: /êµìœ¡í•˜ê¸°';
            
            addMessage(listMessage, 'system', false);
        }

        // êµìœ¡ ì‚­ì œ
        async function deleteEducation(index) {
            if (index < 0 || index >= educationData.length) {
                const errorMessage = 'âŒ ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (1ë¶€í„° ' + educationData.length + 'ê¹Œì§€)';
                addMessage(errorMessage, 'system', false);
                return;
            }

            const itemToDelete = educationData[index];
            
            try {
                await database.ref(`educations/${itemToDelete.id}`).remove();
                
                console.log('âœ… êµìœ¡ ë°ì´í„° ì‚­ì œ ì„±ê³µ:', itemToDelete.id);
                
                await loadEducationDataFromFirebase();
                
                const successMessage = `âœ… êµìœ¡ ë‚´ìš© ${index + 1}ë²ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                addMessage(successMessage, 'system', false);
            } catch (error) {
                console.error('âŒ êµìœ¡ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                const errorMessage = 'âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                addMessage(errorMessage, 'system', false);
            }
        }

        // ì‚¬ìš©ì ê¸ˆìœµ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function getUserFinancialInfo() {
            try {
                const snapshot = await database.ref(`users/${currentUser.id}/financial`).once('value');
                const data = snapshot.val() || {};
                
                await loadEducationDataFromFirebase();
                
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    portfolio: data.portfolio || [],
                    transactions: data.transactions || [],
                    learningProgress: data.learningProgress || {},
                    quizScores: data.quizScores || [],
                    educationData: educationData
                };
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    educationData: educationData
                };
            }
        }

        // Gemini API í˜¸ì¶œ
        async function callGeminiAPI(userMessage, userInfo) {
            const dangerousKeywords = [
                'ì¢…ëª© ì¶”ì²œ', 'ì£¼ì‹ ì¶”ì²œ', 'ì½”ì¸ ì¶”ì²œ', 'ì•”í˜¸í™”í ì¶”ì²œ',
                'ì–´ë–¤ ì£¼ì‹', 'ì–´ë–¤ ì½”ì¸', 'ë­˜ ì‚¬ì•¼', 'íˆ¬ì ì¢…ëª©',
                'ìˆ˜ìµë¥  ë³´ì¥', 'í™•ì‹¤í•œ ìˆ˜ìµ'
            ];
            
            const isDangerous = dangerousKeywords.some(keyword => 
                userMessage.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (isDangerous) {
                return 'ì£„ì†¡í•˜ì§€ë§Œ íŠ¹ì • íˆ¬ì ì¢…ëª©ì„ ì¶”ì²œí•˜ê±°ë‚˜ ìˆ˜ìµì„ ë³´ì¥í•˜ëŠ” ì¡°ì–¸ì€ ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹  íˆ¬ìì˜ ê¸°ë³¸ ì›ì¹™, ë¶„ì‚°íˆ¬ìì˜ ì¤‘ìš”ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ë²• ë“±ì— ëŒ€í•´ ì•Œë ¤ë“œë¦´ ìˆ˜ ìˆì–´ìš”. ê±´ì „í•œ íˆ¬ì ìŠµê´€ì„ ê¸°ë¥´ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤!';
            }

            let educationContext = '';
            if (educationData && educationData.length > 0) {
                educationContext = '\n\n=== ì¤‘ìš”: ë‹¤ìŒ êµìœ¡ ë‚´ìš©ì„ ìµœìš°ì„ ìœ¼ë¡œ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš” ===\n';
                educationData.forEach((item, index) => {
                    educationContext += `[êµìœ¡ ${index + 1}] ${item.content}\n`;
                });
                educationContext += '=== êµìœ¡ ë‚´ìš© ë ===\n';
            }

            const systemPrompt = `ë‹¹ì‹ ì€ 'ë˜‘ë¶€ë¦¬'ë¼ëŠ” ì´ë¦„ì˜ ì¹œê·¼í•œ ê¸ˆìœµ êµìœ¡ AI ì±—ë´‡ì…ë‹ˆë‹¤.
            
            ì‚¬ìš©ì ì •ë³´:
            - íˆ¬ì ë ˆë²¨: ${userInfo.level}
            - ê²½í—˜ì¹˜: ${userInfo.exp}
            ${educationContext}
            
            ì—­í• ê³¼ ì§€ì¹¨:
            1. ìœ„ì˜ êµìœ¡ ë‚´ìš©ì„ ìµœìš°ì„ ìœ¼ë¡œ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤
            2. ê¸ˆìœµ êµìœ¡ì„ ëª©ì ìœ¼ë¡œ ì¹œê·¼í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤
            3. ì‚¬ìš©ìì˜ ë ˆë²¨ì— ë§ëŠ” ì„¤ëª…ì„ ì œê³µí•©ë‹ˆë‹¤
            4. êµ¬ì²´ì ì¸ íˆ¬ì ì¢…ëª© ì¶”ì²œì´ë‚˜ íˆ¬ì ì¡°ì–¸ì€ ì ˆëŒ€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
            5. ê¸ˆìœµì˜ ê¸°ë³¸ ê°œë…, ì €ì¶•ì˜ ì¤‘ìš”ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë“±ì„ ê°•ì¡°í•©ë‹ˆë‹¤
            6. ì‹¤ì œ ì‚¬ë¡€ë‚˜ ë¹„ìœ ë¥¼ ë“¤ì–´ ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤
            7. í•­ìƒ ê¸ì •ì ì´ê³  ê²©ë ¤í•˜ëŠ” í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤
            8. ë‹µë³€ì€ 2-3ë¬¸ë‹¨ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ í•©ë‹ˆë‹¤
            9. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ì¹œê·¼ê°ì„ ë†’ì…ë‹ˆë‹¤
            10. êµìœ¡ë°›ì€ ë‚´ìš©ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë‚´ìš©ì„ ì •í™•íˆ ì „ë‹¬í•©ë‹ˆë‹¤
            11. ì§§ê³  ê°„ê²°í•˜ê²Œ ë§í•©ë‹ˆë‹¤
            12. ë¬¼ì–´ë³´ì§€ ì•ŠëŠ” ë‚´ìš©ì— ëŒ€í•´ì„œëŠ” ë‹µë³€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
            13. ì£¼ì‹ ê°™ì´ ë³€ë™ì„± ìˆëŠ” ìì‚°ì€ ì¶”ì²œí•˜ì§€ ì•Šì§€ë§Œ ì ê¸ˆê³¼ ê°™ì€ ì•ˆì „ì„± ìì‚°ì€ ì¶”ì²œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: `${systemPrompt}\n\nì‚¬ìš©ì ì§ˆë¬¸: ${userMessage}\n\nìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµìœ¡ì ì´ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”.`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                },
                safetySettings: [
                    {
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    }
                ]
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                        return candidate.content.parts[0].text;
                    }
                }
                
                throw new Error('ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                
            } catch (error) {
                console.error('âŒ Gemini API ì˜¤ë¥˜:', error);
                return getFallbackResponse(userMessage);
            }
        }

        // í´ë°± ì‘ë‹µ ìƒì„±
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // êµìœ¡ ë°ì´í„°ì—ì„œ ê´€ë ¨ ë‚´ìš© ì°¾ê¸°
            for (const item of educationData) {
                const keywords = item.content.toLowerCase().split(' ');
                for (const keyword of keywords) {
                    if (keyword.length > 2 && lowerMessage.includes(keyword)) {
                        return `ğŸ“š êµìœ¡ ë‚´ìš© ì°¸ê³ :\n\n${item.content}`;
                    }
                }
            }
            
            const keywordResponses = {
                'íˆ¬ì': 'ğŸ“ˆ íˆ¬ìëŠ” ë¯¸ë˜ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘ìš”í•œ ë°©ë²•ì…ë‹ˆë‹¤!',
                'ì €ì¶•': 'ğŸ’° ì €ì¶•ì€ ê¸ˆìœµ ì•ˆì •ì˜ ì²« ê±¸ìŒì´ì—ìš”!',
                'ì£¼ì‹': 'ğŸ“Š ì£¼ì‹ íˆ¬ìë¥¼ ê³ ë ¤í•˜ê³  ê³„ì‹œëŠ”êµ°ìš”!',
                'ì•ˆë…•': 'ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë˜‘ë¶€ë¦¬ì˜ˆìš”!'
            };
            
            for (const [keyword, response] of Object.entries(keywordResponses)) {
                if (lowerMessage.includes(keyword)) {
                    return response;
                }
            }
            
            return 'ğŸ¤– ê¸ˆìœµì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!';
        }

        // ë©”ì‹œì§€ ì¶”ê°€ (ìŒì„± ì¶œë ¥ íŒŒë¼ë¯¸í„° ì¶”ê°€)
        function addMessage(text, sender, save = true, playVoice = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (sender === 'bot') {
                messageDiv.style.flexDirection = 'row';
                messageDiv.style.alignItems = 'flex-start';

                const avatarDiv = document.createElement('div');
                avatarDiv.style.cssText = `
                    width: 35px;
                    height: 35px;
                    background-image: url('images/ë˜‘ë¶€ë¦¬.png');
                    background-size: cover;
                    background-position: center;
                    border-radius: 50%;
                    margin-right: 8px;
                    flex-shrink: 0;
                `;
                messageDiv.appendChild(avatarDiv);
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';

            const escapedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            bubbleDiv.innerHTML = escapedText.replace(/\n/g, '<br>');

            messageDiv.appendChild(bubbleDiv);
            
            const typingIndicator = document.getElementById('typingIndicator');
            chatArea.insertBefore(messageDiv, typingIndicator);
            
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // ë´‡ ë©”ì‹œì§€ì¼ ë•Œ ìŒì„± ì¶œë ¥ (ìŒì„± ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
            if (sender === 'bot' && playVoice && !isVoiceMode) {
                console.log('ğŸ”Š ë´‡ ë©”ì‹œì§€ ìŒì„± ì¶œë ¥ ì‹œì‘');
                speakText(text);
            }
            
            if (save && sender !== 'system') {
                saveChatMessage(text, sender);
            }
            
            chatHistory.push({ text, sender, timestamp: Date.now() });
            
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(-50);
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì €ì¥
        async function saveChatMessage(text, sender) {
            try {
                await database.ref(`chats/${currentUser.id}`).push({
                    text: text,
                    sender: sender,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.add('active');
            
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.remove('active');
        }

        // ì—”í„° í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // íŒŒì¼ ì²¨ë¶€
        function attachFile() {
            alert('íŒŒì¼ ì²¨ë¶€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
        function goToPage(page) {
            // ìŒì„± ì¤‘ì§€
            if (speechSynthesis && isSpeaking) {
                speechSynthesis.cancel();
            }
            if (isRecording) {
                stopVoiceRecording();
            }
            if (isVoiceMode) {
                closeVoiceMode();
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (page !== 'a4.html') {
                window.location.href = page;
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ìŒì„± ì¤‘ì§€
                if (speechSynthesis && isSpeaking) {
                    speechSynthesis.cancel();
                }
                if (isRecording) {
                    stopVoiceRecording();
                }
                if (isVoiceMode) {
                    closeVoiceMode();
                }
                
                localStorage.removeItem('fineu_current_user');
                window.location.href = 'index.html';
            }
        }

        // ì•Œë¦¼
        function showNotifications() {
            alert('ì•Œë¦¼ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ì—ëŸ¬ ì²˜ë¦¬
        window.addEventListener('error', function(event) {
            console.error('ì „ì—­ ì—ëŸ¬:', event.error);
        });

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì²´í¬
        window.addEventListener('online', function() {
            console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
        });

        window.addEventListener('offline', function() {
            console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
            const offlineMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            addMessage(offlineMessage, 'bot', false);
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìŒì„± ì¤‘ì§€
        window.addEventListener('beforeunload', function() {
            if (speechSynthesis && isSpeaking) {
                speechSynthesis.cancel();
            }
            if (isRecording) {
                stopVoiceRecording();
            }
        });
    </script>
</body>
</html>
