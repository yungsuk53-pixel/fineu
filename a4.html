<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - ì±„íŒ…</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* ê³µí†µ í—¤ë” */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            padding: 70px 20px 160px;
            max-width: 400px;
            margin: 0 auto;
            height: calc(100vh - 160px);
            display: flex;
            flex-direction: column;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #7cb9e8;
            color: white;
        }

        .message.bot .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            max-width: 60px;
        }

        .typing-indicator.active {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            padding: 0 20px;
            background: #f5f5f5;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #333;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: #555;
            transform: scale(1.05);
        }

        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .attach-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .attach-button:hover {
            background: #f0f0f0;
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* ì¤‘ì•™ ë°˜ì› ëŒì¶œ ë¶€ë¶„ ì¶”ê°€ */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .black-button {
            width: 55px;
            height: 55px;
            background: #333;
            border-radius: 50%;
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .black-button:hover {
            transform: scale(1.1);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 160px;
            }
            
            .input-area {
                padding: 0 15px;
            }
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/ë ˆì´ì–´ 1.png" alt="FINE U ë¡œê³ " class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <div class="page-title">AI CHATBOT</div>
        
        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="chat-area" id="chatArea">
            <!-- íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° -->
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <div class="input-area">
        <div class="input-container">
            <button class="attach-button" onclick="attachFile()">
                <i class="fas fa-camera"></i>
            </button>
            <input type="text" class="chat-input" placeholder="ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš”." id="chatInput" onkeypress="handleKeyPress(event)">
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/ì§‘.png" alt="í™ˆ">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/ë¬¸ì„œ.png" alt="ë¬¸ì„œ">
            </div>
        </div>
        <div class="black-button" onclick="goToPage('a3.html')">BLACK</div>
        <div class="nav-item active" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/ì±„íŒ….png" alt="ì±„íŒ…">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ë”ë³´ê¸°.png" alt="ë”ë³´ê¸°">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Gemini API ì„¤ì • (ìƒˆë¡œìš´ API í‚¤ ì‚¬ìš©)
        const GEMINI_API_KEY = 'AIzaSyDMawZDEzBrAvAJt8ZrZxvvq2aZIRnbObk';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // ì‚¬ìš©ì ì •ë³´
        let currentUser = JSON.parse(localStorage.getItem('fineu_current_user')) || {
            id: 'user_' + Date.now(),
            name: 'ì‚¬ìš©ì',
            level: 'yellow',
            exp: 0
        };

        // ì±„íŒ… íˆìŠ¤í† ë¦¬
        let chatHistory = [];
        let isProcessing = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadChatHistory();
            initializeWelcomeMessage();
        });

        // í™˜ì˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
        function initializeWelcomeMessage() {
            // ì²« ë²ˆì§¸ ì±—ë´‡ ë©”ì‹œì§€ ì¶”ê°€ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
            const welcomeMessage = "ì•ˆë…•í•˜ì„¸ìš”.\nì €ëŠ” ì—¬ëŸ¬ë¶„ì˜ ìŠ¬ê¸°ë¡œìš´ ê¸ˆìœµ ìƒí™œì„ ë•ëŠ” ë˜‘ë¶€ë¦¬ì—ìš”.\ní˜¹ì‹œ ë„ì›€ì´ í•„ìš”í•œ ì¼ì´ ìˆë‚˜ìš”?";
            addMessage(welcomeMessage, 'bot', false);
        }

        // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ
        async function loadChatHistory() {
            try {
                const snapshot = await database.ref(`chats/${currentUser.id}`).limitToLast(20).once('value');
                const data = snapshot.val();
                if (data) {
                    Object.values(data).forEach(msg => {
                        addMessage(msg.text, msg.sender, false);
                    });
                }
            } catch (error) {
                console.error('ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '' || isProcessing) return;
            
            // UI ìƒíƒœ ë³€ê²½
            isProcessing = true;
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage(message, 'user', true);
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            input.value = '';
            
            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            showTypingIndicator();
            
            try {
                // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userInfo = await getUserFinancialInfo();
                
                // Gemini API í˜¸ì¶œ
                const response = await callGeminiAPI(message, userInfo);
                
                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
                hideTypingIndicator();
                
                // ë´‡ ì‘ë‹µ ì¶”ê°€
                addMessage(response, 'bot', true);
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                hideTypingIndicator();
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'bot', false);
            } finally {
                // UI ìƒíƒœ ë³µì›
                isProcessing = false;
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        // ì‚¬ìš©ì ê¸ˆìœµ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function getUserFinancialInfo() {
            try {
                const snapshot = await database.ref(`users/${currentUser.id}/financial`).once('value');
                const data = snapshot.val() || {};
                
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    portfolio: data.portfolio || [],
                    transactions: data.transactions || [],
                    learningProgress: data.learningProgress || {},
                    quizScores: data.quizScores || []
                };
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0
                };
            }
        }

        // Gemini API í˜¸ì¶œ
        async function callGeminiAPI(userMessage, userInfo) {
            // ìœ„í—˜í•œ ì§ˆë¬¸ í•„í„°ë§
            const dangerousKeywords = [
                'ì¢…ëª© ì¶”ì²œ', 'ì£¼ì‹ ì¶”ì²œ', 'ì½”ì¸ ì¶”ì²œ', 'ì•”í˜¸í™”í ì¶”ì²œ',
                'ì–´ë–¤ ì£¼ì‹', 'ì–´ë–¤ ì½”ì¸', 'ë­˜ ì‚¬ì•¼', 'íˆ¬ì ì¢…ëª©',
                'ìˆ˜ìµë¥  ë³´ì¥', 'í™•ì‹¤í•œ ìˆ˜ìµ'
            ];
            
            const isDangerous = dangerousKeywords.some(keyword => 
                userMessage.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (isDangerous) {
                return 'ì£„ì†¡í•˜ì§€ë§Œ íŠ¹ì • íˆ¬ì ì¢…ëª©ì„ ì¶”ì²œí•˜ê±°ë‚˜ ìˆ˜ìµì„ ë³´ì¥í•˜ëŠ” ì¡°ì–¸ì€ ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹  íˆ¬ìì˜ ê¸°ë³¸ ì›ì¹™, ë¶„ì‚°íˆ¬ìì˜ ì¤‘ìš”ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ë²• ë“±ì— ëŒ€í•´ ì•Œë ¤ë“œë¦´ ìˆ˜ ìˆì–´ìš”. ê±´ì „í•œ íˆ¬ì ìŠµê´€ì„ ê¸°ë¥´ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤!';
            }

            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
            const systemPrompt = `ë‹¹ì‹ ì€ 'ë˜‘ë¶€ë¦¬'ë¼ëŠ” ì´ë¦„ì˜ ì¹œê·¼í•œ ê¸ˆìœµ êµìœ¡ AI ì±—ë´‡ì…ë‹ˆë‹¤.
            
            ì‚¬ìš©ì ì •ë³´:
            - íˆ¬ì ë ˆë²¨: ${userInfo.level}
            - ê²½í—˜ì¹˜: ${userInfo.exp}
            - í•™ìŠµ ì§„ë„: ${JSON.stringify(userInfo.learningProgress || {})}
            
            ì—­í• ê³¼ ì§€ì¹¨:
            1. ê¸ˆìœµ êµìœ¡ì„ ëª©ì ìœ¼ë¡œ ì¹œê·¼í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤
            2. ì‚¬ìš©ìì˜ ë ˆë²¨ì— ë§ëŠ” ì„¤ëª…ì„ ì œê³µí•©ë‹ˆë‹¤
            3. êµ¬ì²´ì ì¸ íˆ¬ì ì¢…ëª© ì¶”ì²œì´ë‚˜ íˆ¬ì ì¡°ì–¸ì€ ì ˆëŒ€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
            4. ê¸ˆìœµì˜ ê¸°ë³¸ ê°œë…, ì €ì¶•ì˜ ì¤‘ìš”ì„±, ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë“±ì„ ê°•ì¡°í•©ë‹ˆë‹¤
            5. ì‹¤ì œ ì‚¬ë¡€ë‚˜ ë¹„ìœ ë¥¼ ë“¤ì–´ ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤
            6. í•­ìƒ ê¸ì •ì ì´ê³  ê²©ë ¤í•˜ëŠ” í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤
            7. ë‹µë³€ì€ 2-3ë¬¸ë‹¨ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ í•©ë‹ˆë‹¤
            8. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ì¹œê·¼ê°ì„ ë†’ì…ë‹ˆë‹¤`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: `${systemPrompt}\n\nì‚¬ìš©ì ì§ˆë¬¸: ${userMessage}\n\nìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµìœ¡ì ì´ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”.`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                },
                safetySettings: [
                    {
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    }
                ]
            };

            try {
                console.log('ğŸ¤– Gemini API í˜¸ì¶œ ì‹œì‘:', GEMINI_API_URL);
                
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API ì—ëŸ¬ ìƒì„¸:', errorText);
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('ğŸ“Š API ì‘ë‹µ ë°ì´í„°:', data);
                
                // ì‘ë‹µ êµ¬ì¡° í™•ì¸ ë° í…ìŠ¤íŠ¸ ì¶”ì¶œ
                if (data.candidates && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                        const responseText = candidate.content.parts[0].text;
                        console.log('âœ… Gemini ì‘ë‹µ ì„±ê³µ:', responseText.substring(0, 100) + '...');
                        return responseText;
                    }
                }
                
                // ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ê²½ìš°
                console.warn('âš ï¸ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì‘ë‹µ êµ¬ì¡°:', data);
                throw new Error('ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                
            } catch (error) {
                console.error('âŒ Gemini API ì˜¤ë¥˜:', error);
                
                // í´ë°± ì‘ë‹µ
                return getFallbackResponse(userMessage);
            }
        }

        // í´ë°± ì‘ë‹µ ìƒì„± (ê°œì„ ëœ ë²„ì „)
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // êµ¬ì²´ì ì¸ í‚¤ì›Œë“œ ê¸°ë°˜ ì‘ë‹µ
            const keywordResponses = {
                'íˆ¬ì': 'ğŸ“ˆ íˆ¬ìëŠ” ë¯¸ë˜ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘ìš”í•œ ë°©ë²•ì…ë‹ˆë‹¤! \n\nê¸°ë³¸ ì›ì¹™ì„ ì•Œë ¤ë“œë¦´ê²Œìš”:\nâ€¢ ì—¬ìœ ìê¸ˆìœ¼ë¡œë§Œ íˆ¬ìí•˜ê¸°\nâ€¢ ë¶„ì‚°íˆ¬ìë¡œ ë¦¬ìŠ¤í¬ ê´€ë¦¬\nâ€¢ ì¥ê¸°ì ì¸ ê´€ì  ìœ ì§€\nâ€¢ ì¶©ë¶„í•œ ê³µë¶€ì™€ ë¶„ì„ í›„ ê²°ì •\n\níˆ¬ìì— ëŒ€í•´ ë” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!',
                
                'ì €ì¶•': 'ğŸ’° ì €ì¶•ì€ ê¸ˆìœµ ì•ˆì •ì˜ ì²« ê±¸ìŒì´ì—ìš”!\n\níš¨ê³¼ì ì¸ ì €ì¶• ë°©ë²•:\nâ€¢ ì„ ì €ì¶• í›„ì†Œë¹„ ì›ì¹™\nâ€¢ ìë™ì´ì²´ë¡œ ê°•ì œ ì €ì¶•\nâ€¢ ëª©í‘œ ê¸ˆì•¡ê³¼ ê¸°ê°„ ì„¤ì •\nâ€¢ ë¹„ìƒê¸ˆ ë¨¼ì € ì¤€ë¹„í•˜ê¸°\n\nì‘ì€ ê¸ˆì•¡ì´ë¼ë„ ê¾¸ì¤€íˆ í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤!',
                
                'ì£¼ì‹': 'ğŸ“Š ì£¼ì‹ íˆ¬ìë¥¼ ê³ ë ¤í•˜ê³  ê³„ì‹œëŠ”êµ°ìš”!\n\nì‹œì‘í•˜ê¸° ì „ ì¤€ë¹„ì‚¬í•­:\nâ€¢ ê¸°ì—… ë¶„ì„ ë°©ë²• í•™ìŠµ\nâ€¢ ì¬ë¬´ì œí‘œ ì½ê¸° ì—°ìŠµ\nâ€¢ íˆ¬ì ì² í•™ ì •ë¦½\nâ€¢ ì†ì‹¤ ê°ì˜¤ì™€ ìœ„í—˜ ê´€ë¦¬\n\në¬´ì‘ì • ì‹œì‘í•˜ê¸°ë³´ë‹¤ëŠ” ì¶©ë¶„í•œ ê³µë¶€ê°€ ì„ í–‰ë˜ì–´ì•¼ í•´ìš”!',
                
                'ì˜ˆì‚°': 'ğŸ“ ì˜ˆì‚° ê´€ë¦¬ëŠ” ê±´ì „í•œ ê¸ˆìœµ ìƒí™œì˜ ê¸°ì´ˆì…ë‹ˆë‹¤!\n\nì˜ˆì‚° ê´€ë¦¬ ë‹¨ê³„:\nâ€¢ ìˆ˜ì…ê³¼ ì§€ì¶œ íŒŒì•…\nâ€¢ í•„ìˆ˜/ì„ íƒ ì§€ì¶œ ë¶„ë¥˜\nâ€¢ ì €ì¶• ëª©í‘œ ì„¤ì •\nâ€¢ ì •ê¸°ì ì¸ ì ê²€ê³¼ ì¡°ì •\n\nê°€ê³„ë¶€ ì•±ì„ í™œìš©í•˜ì‹œë©´ ë” ì‰½ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”!',
                
                'ì€í‡´': 'ğŸ–ï¸ ì€í‡´ ì¤€ë¹„ëŠ” ë¹ ë¥¼ìˆ˜ë¡ ì¢‹ì•„ìš”!\n\nì€í‡´ ì¤€ë¹„ ë°©ë²•:\nâ€¢ ë³µë¦¬ íš¨ê³¼ í™œìš©í•œ ì¥ê¸° íˆ¬ì\nâ€¢ ì—°ê¸ˆì €ì¶•, IRP ë“± ì„¸ì œí˜œíƒ ìƒí’ˆ\nâ€¢ ë‹¤ì–‘í•œ ìì‚°ì— ë¶„ì‚° íˆ¬ì\nâ€¢ ì •ê¸°ì ì¸ ê³„íš ì ê²€\n\nì‹œê°„ì´ ê°€ì¥ í° ë¬´ê¸°ì´ë‹ˆ ì§€ê¸ˆë¶€í„° ì‹œì‘í•˜ì„¸ìš”!',
                
                'ë³µë¦¬': 'âœ¨ ë³µë¦¬ëŠ” ì •ë§ ë§ˆë²• ê°™ì€ í˜ì„ ê°€ì§€ê³  ìˆì–´ìš”!\n\në³µë¦¬ì˜ í˜:\nâ€¢ ì‹œê°„ì´ ê¸¸ìˆ˜ë¡ íš¨ê³¼ ê·¹ëŒ€í™”\nâ€¢ ì›ê¸ˆê³¼ ì´ìê°€ í•¨ê»˜ ì¬íˆ¬ì\nâ€¢ ì‘ì€ ì°¨ì´ê°€ í° ê²°ê³¼ë¡œ\nâ€¢ ê¾¸ì¤€í•¨ì´ ê°€ì¥ ì¤‘ìš”\n\n"ë³µë¦¬ëŠ” ì„¸ìƒì—ì„œ ê°€ì¥ ê°•í•œ í˜ì´ë‹¤" - ì•„ì¸ìŠˆíƒ€ì¸',
                
                'ë¶€ì±„': 'âš ï¸ ë¶€ì±„ ê´€ë¦¬ëŠ” ë§¤ìš° ì¤‘ìš”í•œ ë¬¸ì œì˜ˆìš”!\n\në¶€ì±„ ì •ë¦¬ ë°©ë²•:\nâ€¢ ê³ ê¸ˆë¦¬ ë¶€ì±„ë¶€í„° ìš°ì„  ìƒí™˜\nâ€¢ ìµœì†Œ ë‚©ì…ê¸ˆì•¡ ì´ìƒ ë‚©ë¶€\nâ€¢ ì¶”ê°€ ëŒ€ì¶œ ìì œ\nâ€¢ ê°€ê³„ë¶€ë¡œ ì§€ì¶œ ê´€ë¦¬\n\në¶€ì±„ë¥¼ ì¤„ì´ëŠ” ê²ƒë„ ìˆ˜ìµë¥  ë†’ì€ íˆ¬ìë¼ê³  ìƒê°í•˜ì„¸ìš”!',
                
                'etf': 'ğŸ“ˆ ETFëŠ” ì´ˆë³´ìì—ê²Œ ì¢‹ì€ íˆ¬ì ë°©ë²•ì´ì—ìš”!\n\nETFì˜ ì¥ì :\nâ€¢ ë¶„ì‚°íˆ¬ì íš¨ê³¼\nâ€¢ ë‚®ì€ ìš´ìš©ë¹„ìš©\nâ€¢ ë†’ì€ ìœ ë™ì„±\nâ€¢ íˆ¬ëª…í•œ ìš´ìš©\n\ní•˜ì§€ë§Œ ì—¬ì „íˆ íˆ¬ìì´ë¯€ë¡œ ì¶©ë¶„í•œ ê³µë¶€ê°€ í•„ìš”í•´ìš”!'
            };
            
            // í‚¤ì›Œë“œ ë§¤ì¹­ìœ¼ë¡œ ì‘ë‹µ ì°¾ê¸°
            for (const [keyword, response] of Object.entries(keywordResponses)) {
                if (lowerMessage.includes(keyword)) {
                    return response;
                }
            }
            
            // ì§ˆë¬¸ í˜•íƒœë³„ ì‘ë‹µ
            if (lowerMessage.includes('ì–´ë–»ê²Œ') || lowerMessage.includes('ë°©ë²•')) {
                return 'ğŸ¤” êµ¬ì²´ì ì¸ ë°©ë²•ì„ ì•Œê³  ì‹¶ìœ¼ì‹œëŠ”êµ°ìš”! íˆ¬ì, ì €ì¶•, ì˜ˆì‚°ê´€ë¦¬ ë“± ì–´ë–¤ ë¶„ì•¼ì˜ ë°©ë²•ì´ ê¶ê¸ˆí•˜ì‹ ì§€ ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì‹œë©´ ë” ì •í™•í•œ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”!';
            }
            
            if (lowerMessage.includes('ì¶”ì²œ') || lowerMessage.includes('ì¢…ëª©')) {
                return 'âš ï¸ ì£„ì†¡í•˜ì§€ë§Œ íŠ¹ì • íˆ¬ì ì¢…ëª©ì´ë‚˜ ê¸ˆìœµìƒí’ˆ ì¶”ì²œì€ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ëŒ€ì‹  íˆ¬ì ì›ì¹™, ë¶„ì‚°íˆ¬ìì˜ ì¤‘ìš”ì„±, ìƒí’ˆ ì„ íƒ ê¸°ì¤€ ë“±ì— ëŒ€í•´ ì•Œë ¤ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
            }
            
            // ì¸ì‚¬ë§ ì‘ë‹µ
            if (lowerMessage.includes('ì•ˆë…•') || lowerMessage.includes('í•˜ì´') || lowerMessage.includes('hello')) {
                return 'ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë˜‘ë¶€ë¦¬ì˜ˆìš”! ê¸ˆìœµì— ëŒ€í•œ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”. íˆ¬ì, ì €ì¶•, ì˜ˆì‚°ê´€ë¦¬ ë“± ë‹¤ì–‘í•œ ì£¼ì œë¡œ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”! ğŸ˜Š';
            }
            
            // ê¸°ë³¸ ì‘ë‹µ
            return 'ğŸ¤– ê¸ˆìœµì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œêµ°ìš”! ë” êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì‹œë©´ ì •í™•í•œ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.\n\nì´ëŸ° ì£¼ì œë“¤ë¡œ ë„ì›€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:\nâ€¢ íˆ¬ì ê¸°ì´ˆì™€ ì›ì¹™\nâ€¢ ì €ì¶•ê³¼ ì˜ˆì‚° ê´€ë¦¬\nâ€¢ ë³µë¦¬ì™€ ìì‚° ì¦ì‹\nâ€¢ ì€í‡´ ì¤€ë¹„ ë°©ë²•\nâ€¢ ë¶€ì±„ ê´€ë¦¬ ì „ëµ\n\nì–´ë–¤ ê²ƒì´ ê¶ê¸ˆí•˜ì„¸ìš”? ğŸ˜Š';
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(text, sender, save = true) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (sender === 'bot') {
                messageDiv.style.flexDirection = 'row';
                messageDiv.style.alignItems = 'flex-start';

                const avatarDiv = document.createElement('div');
                avatarDiv.style.cssText = `
                    width: 35px;
                    height: 35px;
                    background-image: url('images/ë˜‘ë¶€ë¦¬.png');
                    background-size: cover;
                    background-position: center;
                    border-radius: 50%;
                    margin-right: 8px;
                    flex-shrink: 0;
                `;
                messageDiv.appendChild(avatarDiv);
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';

            // HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
            const escapedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            bubbleDiv.innerHTML = escapedText.replace(/\n/g, '<br>');

            messageDiv.appendChild(bubbleDiv);
            
            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì•ì— ì‚½ì…
            const typingIndicator = document.getElementById('typingIndicator');
            chatArea.insertBefore(messageDiv, typingIndicator);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // Firebaseì— ì €ì¥
            if (save) {
                saveChatMessage(text, sender);
            }
            
            // ì±„íŒ… íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            chatHistory.push({ text, sender, timestamp: Date.now() });
            
            // íˆìŠ¤í† ë¦¬ í¬ê¸° ì œí•œ (ìµœê·¼ 50ê°œë§Œ ìœ ì§€)
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(-50);
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì €ì¥
        async function saveChatMessage(text, sender) {
            try {
                await database.ref(`chats/${currentUser.id}`).push({
                    text: text,
                    sender: sender,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.add('active');
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.remove('active');
        }

        // ì—”í„° í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // íŒŒì¼ ì²¨ë¶€
        function attachFile() {
            alert('íŒŒì¼ ì²¨ë¶€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
        function goToPage(page) {
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            if (page !== 'a4.html') {
                window.location.href = page;
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('fineu_current_user');
                window.location.href = 'index.html';
            }
        }

        // ì•Œë¦¼
        function showNotifications() {
            alert('ì•Œë¦¼ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ì—ëŸ¬ ì²˜ë¦¬
        window.addEventListener('error', function(event) {
            console.error('ì „ì—­ ì—ëŸ¬:', event.error);
        });

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì²´í¬
        window.addEventListener('online', function() {
            console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
        });

        window.addEventListener('offline', function() {
            console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
            addMessage('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'bot', false);
        });
    </script>
</body>
</html>