<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FINE U - Ï±ÑÌåÖ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Í≥µÌÜµ Ìó§Îçî */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏàòÏ†ï */
        .main-content {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 130px;
            padding: 10px 20px;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        .main-content.hidden {
            display: none;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        /* Ï±ÑÌåÖ ÏòÅÏó≠ ÏàòÏ†ï */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #7cb9e8;
            color: white;
        }

        .message.bot .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.system .message-bubble {
            background: #fffbf0;
            color: #666;
            border: 1px solid #ffd700;
            max-width: 90%;
        }

        /* ÌÉÄÏù¥Ìïë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            max-width: 60px;
        }

        .typing-indicator.active {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* ÏûÖÎ†• ÏòÅÏó≠ ÏàòÏ†ï */
        .input-area {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 10px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }

        .input-area.hidden {
            display: none;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #333;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: #555;
            transform: scale(1.05);
        }

        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .attach-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .attach-button:hover {
            background: #f0f0f0;
        }

        /* ÏùåÏÑ± Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
        .voice-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .voice-button:hover {
            background: #f0f0f0;
        }

        /* ÏùåÏÑ± Î™®Îìú ÌôîÎ©¥ */
        .voice-mode-container {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 90;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .voice-mode-container.active {
            display: flex;
        }

        .voice-mode-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-mode-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .voice-assistant-avatar {
            width: 150px;
            height: 150px;
            background: white;
            border-radius: 50%;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .voice-assistant-avatar img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
        }

        .voice-assistant-avatar.listening {
            animation: pulse-listen 2s infinite;
        }

        .voice-assistant-avatar.speaking {
            animation: pulse-speak 1s infinite;
        }

        @keyframes pulse-listen {
            0% {
                box-shadow: 0 0 0 0 rgba(124, 185, 232, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(124, 185, 232, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(124, 185, 232, 0);
            }
        }

        @keyframes pulse-speak {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .voice-status-text {
            color: white;
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center;
            min-height: 30px;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            max-width: 350px;
        }

        .voice-transcript-text {
            color: white;
            font-size: 16px;
            line-height: 1.5;
            text-align: center;
        }

        .voice-control-button {
            width: 80px;
            height: 80px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #667eea;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .voice-control-button:hover {
            transform: scale(1.1);
        }

        .voice-control-button:active {
            transform: scale(0.95);
        }

        .voice-control-button.recording {
            background: #ff4444;
            color: white;
            animation: pulse-record 1.5s infinite;
        }

        @keyframes pulse-record {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }

        .voice-wave-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            margin: 20px 0;
        }

        .voice-wave-animation.hidden {
            visibility: hidden;
        }

        .voice-wave-bar {
            width: 4px;
            height: 20px;
            background: white;
            margin: 0 3px;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .voice-wave-bar:nth-child(2) {
            animation-delay: 0.1s;
            height: 30px;
        }

        .voice-wave-bar:nth-child(3) {
            animation-delay: 0.2s;
            height: 25px;
        }

        .voice-wave-bar:nth-child(4) {
            animation-delay: 0.3s;
            height: 35px;
        }

        .voice-wave-bar:nth-child(5) {
            animation-delay: 0.4s;
            height: 20px;
        }

        @keyframes wave {
            0%, 100% {
                transform: scaleY(1);
                opacity: 0.8;
            }
            50% {
                transform: scaleY(1.5);
                opacity: 1;
            }
        }

        /* ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/Î∞∞Í≤Ω.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* Ï§ëÏïô Î∞òÏõê ÎèåÏ∂ú Î∂ÄÎ∂Ñ Ï∂îÍ∞Ä */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/Î∞∞Í≤Ω.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        /* Îì±Í∏â Î≤ÑÌäºÏúºÎ°ú Î≥ÄÍ≤Ω */
        .grade-button {
            width: 55px;
            height: 55px;
            background: transparent;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        /* ÍµêÏú° Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .education-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .education-modal.active {
            display: block;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .modal-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .modal-button.confirm {
            background: #7cb9e8;
            color: white;
        }

        .modal-button.cancel {
            background: #ddd;
            color: #333;
        }

        .modal-button:hover {
            opacity: 0.8;
        }

        .modal-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Î∞òÏùëÌòï ÏàòÏ†ï */
        @media (max-width: 480px) {
            .main-content {
                padding: 10px 15px;
                width: 100%;
                max-width: none;
            }
            
            .input-area {
                padding: 10px 15px;
                max-width: none;
            }
            
            .chat-input {
                padding: 10px 14px;
                font-size: 16px;
            }
            
            .send-button,
            .attach-button,
            .voice-button {
                width: 36px;
                height: 36px;
            }
        }

        /* iOS Safe Area ÎåÄÏùë */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(70px + env(safe-area-inset-bottom));
            }
            
            .input-area {
                bottom: calc(70px + env(safe-area-inset-bottom));
            }
        }

        /* ÏóêÎü¨ Î©îÏãúÏßÄ Ïä§ÌÉÄÏùº */
        .error-message {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/Î†àÏù¥Ïñ¥ 1.png" alt="FINE U Î°úÍ≥†" class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
    <div class="main-content" id="mainContent">
        <div class="page-title">AI CHATBOT</div>
        
        <!-- Ï±ÑÌåÖ ÏòÅÏó≠ -->
        <div class="chat-area" id="chatArea">
            <!-- ÌÉÄÏù¥Ìïë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ -->
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- ÏùåÏÑ± Î™®Îìú ÌôîÎ©¥ -->
    <div class="voice-mode-container" id="voiceModeContainer">
        <button class="voice-mode-close" onclick="closeVoiceMode()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="voice-assistant-avatar" id="voiceAvatar">
            <img src="images/ÎòëÎ∂ÄÎ¶¨.png" alt="ÎòëÎ∂ÄÎ¶¨">
        </div>
        
        <div class="voice-status-text" id="voiceStatus">
            ÏùåÏÑ± Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§
        </div>
        
        <div class="voice-wave-animation" id="voiceWave">
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
        </div>
        
        <div class="voice-transcript">
            <div class="voice-transcript-text" id="voiceTranscript">
                ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Í≥† ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî
            </div>
        </div>
        
        <button class="voice-control-button" id="voiceControlButton" onclick="toggleVoiceRecording()">
            <i class="fas fa-microphone" id="voiceControlIcon"></i>
        </button>
    </div>

    <!-- ÏûÖÎ†• ÏòÅÏó≠ -->
    <div class="input-area" id="inputArea">
        <div class="input-container">
            <button class="attach-button" onclick="attachFile()">
                <i class="fas fa-camera"></i>
            </button>
            <button class="voice-button" id="voiceButton" onclick="openVoiceMode()">
                <i class="fas fa-microphone"></i>
            </button>
            <input type="text" class="chat-input" placeholder="Ï±ÑÌåÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî." id="chatInput" onkeypress="handleKeyPress(event)">
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- ÍµêÏú° Î™®Îã¨ -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeEducationModal()"></div>
    <div class="education-modal" id="educationModal">
        <div class="modal-title" id="modalTitle">Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù</div>
        <div id="modalContent">
            <input type="password" class="modal-input" id="adminPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
        </div>
        <div class="modal-buttons">
            <button class="modal-button cancel" onclick="closeEducationModal()">Ï∑®ÏÜå</button>
            <button class="modal-button confirm" id="modalConfirmBtn" onclick="handleEducationAuth()">ÌôïÏù∏</button>
        </div>
    </div>

    <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/Ïßë.png" alt="Ìôà">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/Î¨∏ÏÑú.png" alt="Î¨∏ÏÑú">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW „Öá.png" alt="YELLOW">
        </div>
        <div class="nav-item active" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/Ï±ÑÌåÖ.png" alt="Ï±ÑÌåÖ">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ÎçîÎ≥¥Í∏∞.png" alt="ÎçîÎ≥¥Í∏∞">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };

        // Firebase Ï¥àÍ∏∞Ìôî
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Firebase Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        database.ref('.info/connected').on('value', (snapshot) => {
            const connected = snapshot.val();
            console.log('üî• Firebase Ïó∞Í≤∞ ÏÉÅÌÉú:', connected ? 'Ïó∞Í≤∞Îê®' : 'Ïó∞Í≤∞ ÎÅäÍπÄ');
        });

        // Gemini API ÏÑ§Ï†ï
        const GEMINI_API_KEY = 'AIzaSyDMawZDEzBrAvAJt8ZrZxvvq2aZIRnbObk';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // ÌååÌååÍ≥† TTS ÌîÑÎ°ùÏãú ÏÑúÎ≤Ñ URL (Vercel Î∞∞Ìè¨ ÌõÑ Î≥ÄÍ≤Ω ÌïÑÏöî)
        // Î°úÏª¨ ÌÖåÏä§Ìä∏: http://localhost:3000/api/papago-tts
        // Vercel Î∞∞Ìè¨ ÌõÑ: https://your-app.vercel.app/api/papago-tts
        const PAPAGO_TTS_PROXY_URL = 'https://your-app.vercel.app/api/papago-tts';

        // ÏùåÏÑ± Ïù∏Ïãù Í¥ÄÎ†® Î≥ÄÏàò
        let recognition = null;
        let isRecording = false;
        let speechSynthesis = window.speechSynthesis;
        let isSpeaking = false;
        let isVoiceMode = false;
        let voiceModeAutoListen = true;

        // ÏùåÏÑ± Ïù∏Ïãù Ï¥àÍ∏∞Ìôî
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.interimResults = true;
                recognition.continuous = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    console.log('üé§ ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë');
                    isRecording = true;
                    if (isVoiceMode) {
                        updateVoiceModeUI('listening');
                    }
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('üé§ Ïù∏ÏãùÎêú ÌÖçÏä§Ìä∏:', transcript);
                    
                    if (isVoiceMode) {
                        document.getElementById('voiceTranscript').textContent = transcript;
                        
                        if (event.results[0].isFinal) {
                            // ÏùåÏÑ± Ïù∏Ïãù ÏôÑÎ£å Ïãú Î∞îÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
                            setTimeout(() => {
                                sendVoiceMessage(transcript);
                            }, 500);
                        }
                    } else {
                        document.getElementById('chatInput').value = transcript;
                        if (event.results[0].isFinal) {
                            setTimeout(() => {
                                sendMessage();
                            }, 500);
                        }
                    }
                };

                recognition.onerror = function(event) {
                    console.error('‚ùå ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•ò:', event.error);
                    if (event.error === 'no-speech') {
                        if (isVoiceMode) {
                            updateVoiceModeUI('ready');
                            document.getElementById('voiceTranscript').textContent = 'ÏùåÏÑ±Ïù¥ Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                        }
                    } else if (event.error === 'not-allowed') {
                        alert('ÎßàÏù¥ÌÅ¨ Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÎßàÏù¥ÌÅ¨ Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                    }
                    stopVoiceRecording();
                };

                recognition.onend = function() {
                    console.log('üé§ ÏùåÏÑ± Ïù∏Ïãù Ï¢ÖÎ£å');
                    stopVoiceRecording();
                };
            } else {
                console.warn('‚ö†Ô∏è Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            }
        }

        // ÏùåÏÑ± Î™®Îìú Ïó¥Í∏∞
        function openVoiceMode() {
            isVoiceMode = true;
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('inputArea').classList.add('hidden');
            document.getElementById('voiceModeContainer').classList.add('active');
            
            updateVoiceModeUI('ready');
            document.getElementById('voiceTranscript').textContent = 'ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Í≥† ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî';
            
            // ÏùåÏÑ± Î™®Îìú ÏßÑÏûÖ ÏïàÎÇ¥
            speakText('ÏùåÏÑ± Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Í≥† ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî.');
        }

        // ÏùåÏÑ± Î™®Îìú Îã´Í∏∞
        function closeVoiceMode() {
            isVoiceMode = false;
            voiceModeAutoListen = true;
            
            // ÏùåÏÑ± Ï§ëÏßÄ
            if (isRecording) {
                stopVoiceRecording();
            }
            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            document.getElementById('voiceModeContainer').classList.remove('active');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
        }

        // ÏùåÏÑ± Î™®Îìú UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateVoiceModeUI(status) {
            const avatar = document.getElementById('voiceAvatar');
            const statusText = document.getElementById('voiceStatus');
            const controlButton = document.getElementById('voiceControlButton');
            const controlIcon = document.getElementById('voiceControlIcon');
            const waveAnimation = document.getElementById('voiceWave');
            
            switch(status) {
                case 'listening':
                    avatar.classList.add('listening');
                    avatar.classList.remove('speaking');
                    statusText.textContent = 'Îì£Í≥† ÏûàÏäµÎãàÎã§...';
                    controlButton.classList.add('recording');
                    controlIcon.className = 'fas fa-stop';
                    waveAnimation.classList.remove('hidden');
                    break;
                    
                case 'speaking':
                    avatar.classList.add('speaking');
                    avatar.classList.remove('listening');
                    statusText.textContent = 'ÎãµÎ≥Ä Ï§ë...';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
                    
                case 'processing':
                    avatar.classList.remove('listening', 'speaking');
                    statusText.textContent = 'Ï≤òÎ¶¨ Ï§ë...';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
                    
                case 'ready':
                default:
                    avatar.classList.remove('listening', 'speaking');
                    statusText.textContent = 'Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
            }
        }

        // ÏùåÏÑ± Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendVoiceMessage(message) {
            if (!message || message.trim() === '') return;
            
            updateVoiceModeUI('processing');
            document.getElementById('voiceTranscript').textContent = 'ÎãµÎ≥ÄÏùÑ Ï§ÄÎπÑÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
            
            // Ï±ÑÌåÖ ÏòÅÏó≠Ïóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            addMessage(message, 'user', true);
            
            try {
                const userInfo = await getUserFinancialInfo();
                const response = await callGeminiAPI(message, userInfo);
                
                // Ï±ÑÌåÖ ÏòÅÏó≠Ïóê ÏùëÎãµ Ï∂îÍ∞Ä
                addMessage(response, 'bot', true);
                
                // ÏùåÏÑ± Î™®ÎìúÏóêÏÑú ÏùëÎãµ ÌëúÏãú Î∞è ÏùåÏÑ± Ï∂úÎ†•
                document.getElementById('voiceTranscript').textContent = response;
                updateVoiceModeUI('speaking');
                
                // ÏùåÏÑ± Ï∂úÎ†• ÏôÑÎ£å ÌõÑ ÏûêÎèôÏúºÎ°ú Îã§Ïãú Îì£Í∏∞ Î™®Îìú
                speakTextWithCallback(response, () => {
                    if (isVoiceMode && voiceModeAutoListen) {
                        updateVoiceModeUI('ready');
                        document.getElementById('voiceTranscript').textContent = 'ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Í≥† ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî';
                    }
                });
                
            } catch (error) {
                console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                const errorMessage = 'Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                document.getElementById('voiceTranscript').textContent = errorMessage;
                addMessage(errorMessage, 'bot', false);
                speakText(errorMessage);
                
                setTimeout(() => {
                    if (isVoiceMode) {
                        updateVoiceModeUI('ready');
                        document.getElementById('voiceTranscript').textContent = 'ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Í≥† ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî';
                    }
                }, 3000);
            }
        }

        // ÏùåÏÑ± ÎÖπÏùå ÌÜ†Í∏Ä
        function toggleVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        // ÏùåÏÑ± ÎÖπÏùå ÏãúÏûë
        function startVoiceRecording() {
            if (!recognition) {
                initSpeechRecognition();
            }
            
            // ÏùåÏÑ± Ï∂úÎ†• Ï§ëÏù¥Î©¥ Ï§ëÏßÄ
            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            if (recognition) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë Ïã§Ìå®:', error);
                    if (isVoiceMode) {
                        document.getElementById('voiceTranscript').textContent = 'ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.';
                    }
                }
            } else {
                alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            }
        }

        // ÏùåÏÑ± ÎÖπÏùå Ï§ëÏßÄ
        function stopVoiceRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            isRecording = false;
            if (isVoiceMode) {
                updateVoiceModeUI('ready');
            }
        }

        // ÎÑ§Ïù¥Î≤Ñ ÌååÌååÍ≥† TTSÎ•º ÏÇ¨Ïö©Ìïú ÏùåÏÑ± Ìï©ÏÑ±
        async function speakTextWithCallback(text, callback) {
            try {
                console.log('üîä ÌååÌååÍ≥† TTS ÏãúÏûë');
                
                // ÌååÌååÍ≥† TTS ÌîÑÎ°ùÏãú ÏÑúÎ≤ÑÎ°ú ÏöîÏ≤≠
                const response = await fetch(PAPAGO_TTS_PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        speaker: 'nara',  // ÏùåÏÑ± ÏÑ†ÌÉù: nara(Ï∞®Î∂ÑÌïú Ïó¨ÏÑ±), kyuri(Í∑ÄÏó¨Ïö¥ Ïó¨ÏÑ±), jinho(ÎÇ®ÏÑ±), mijin(Ï∞®Î∂ÑÌïú Ïó¨ÏÑ±)
                        speed: 0,         // -5 ~ 5 (0Ïù¥ Í∏∞Î≥∏)
                        pitch: 2          // -5 ~ 5 (ÎÜíÏùÑÏàòÎ°ù ÎÜíÏùÄ ÌÜ§, Í∑ÄÏó¨Ïö¥ Î™©ÏÜåÎ¶¨)
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ÌååÌååÍ≥† TTS ÏöîÏ≤≠ Ïã§Ìå®');
                }
                
                // Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞ Î∞õÍ∏∞
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onplay = () => {
                    isSpeaking = true;
                    console.log('üîä ÌååÌååÍ≥† ÏùåÏÑ± Ïû¨ÏÉù ÏãúÏûë');
                };
                
                audio.onended = () => {
                    isSpeaking = false;
                    URL.revokeObjectURL(audioUrl);
                    console.log('üîä ÌååÌååÍ≥† ÏùåÏÑ± Ïû¨ÏÉù ÏôÑÎ£å');
                    if (callback) callback();
                };
                
                audio.onerror = (error) => {
                    console.error('‚ùå ÌååÌååÍ≥† Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïò§Î•ò:', error);
                    isSpeaking = false;
                    URL.revokeObjectURL(audioUrl);
                    // Ìè¥Î∞±: Í∏∞Î≥∏ TTS ÏÇ¨Ïö©
                    speakTextWithBasicTTS(text, callback);
                };
                
                // Ïû¨ÏÉù ÏÜçÎèÑ Ï°∞Ï†à (Îçî Í∑ÄÏó¨Ïö¥ Ìö®Í≥º)
                audio.playbackRate = 1.1;
                await audio.play();
                
            } catch (error) {
                console.error('‚ùå ÌååÌååÍ≥† TTS Ïã§Ìå®:', error);
                // Ìè¥Î∞±: Google Translate TTS ÏÇ¨Ïö©
                speakTextWithGoogleTTS(text, callback);
            }
        }

        // Google Translate TTS (Ìè¥Î∞±Ïö©)
        async function speakTextWithGoogleTTS(text, callback) {
            try {
                console.log('üîä Google TTSÎ°ú Ìè¥Î∞±');
                
                // ÌÖçÏä§Ìä∏Î•º 200ÏûêÏî© Î∂ÑÌï† (Google TTS Ï†úÌïú)
                const chunks = text.match(/.{1,200}/g) || [text];
                let currentChunk = 0;
                
                function playNextChunk() {
                    if (currentChunk >= chunks.length) {
                        isSpeaking = false;
                        if (callback) callback();
                        return;
                    }
                    
                    const chunk = chunks[currentChunk];
                    const encodedText = encodeURIComponent(chunk);
                    
                    // Google Translate TTS URL
                    const googleTTSUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=ko&client=tw-ob`;
                    
                    const audio = new Audio(googleTTSUrl);
                    
                    audio.onplay = () => {
                        if (currentChunk === 0) {
                            isSpeaking = true;
                            console.log('üîä Google TTS Ïû¨ÏÉù ÏãúÏûë');
                        }
                    };
                    
                    audio.onended = () => {
                        currentChunk++;
                        playNextChunk();
                    };
                    
                    audio.onerror = (error) => {
                        console.error('‚ùå Google TTS Ïò§Î•ò:', error);
                        // ÏµúÏ¢Ö Ìè¥Î∞±: Î∏åÎùºÏö∞Ï†Ä Í∏∞Î≥∏ TTS
                        speakTextWithBasicTTS(text, callback);
                    };
                    
                    // Ïû¨ÏÉù ÏÜçÎèÑ Ï°∞Ï†à
                    audio.playbackRate = 1.1;
                    audio.play();
                }
                
                playNextChunk();
                
            } catch (error) {
                console.error('‚ùå Google TTS Ïã§Ìå®:', error);
                speakTextWithBasicTTS(text, callback);
            }
        }

        // Í∏∞Î≥∏ Î∏åÎùºÏö∞Ï†Ä TTS (ÏµúÏ¢Ö Ìè¥Î∞±Ïö©)
        function speakTextWithBasicTTS(text, callback) {
            if (!speechSynthesis) {
                if (callback) callback();
                return;
            }

            if (isSpeaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.15;
            utterance.pitch = 1.85;
            utterance.volume = 0.95;

            const voices = speechSynthesis.getVoices();
            const koreanVoices = voices.filter(voice => voice.lang.includes('ko'));
            if (koreanVoices.length > 0) {
                utterance.voice = koreanVoices[0];
            }

            utterance.onstart = () => {
                isSpeaking = true;
                console.log('üîä Í∏∞Î≥∏ TTS ÏãúÏûë');
            };
            
            utterance.onend = () => {
                isSpeaking = false;
                console.log('üîä Í∏∞Î≥∏ TTS Ï¢ÖÎ£å');
                if (callback) callback();
            };

            speechSynthesis.speak(utterance);
        }

        // ÌÖçÏä§Ìä∏Î•º ÏùåÏÑ±ÏúºÎ°ú Î≥ÄÌôò
        function speakText(text) {
            speakTextWithCallback(text, null);
        }

        // Îì±Í∏â ÏãúÏä§ÌÖú ÏÑ§Ï†ï
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW „ÖÅ.png', nav: 'YELLOW „Öá', navImage: 'YELLOW „Öá.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN „ÖÅ.png', nav: 'GREEN „Öá', navImage: 'GREEN „Öá.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE „ÖÅ.png', nav: 'BLUE „Öá', navImage: 'BLUE „Öá.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED „ÖÅ.png', nav: 'RED „Öá', navImage: 'RED „Öá.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK „ÖÅ.png', nav: 'BLACK „Öá', navImage: 'BLACK „Öá.png' }
        };

        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥
        let currentUser = JSON.parse(localStorage.getItem('fineu_current_user')) || {
            id: 'user_' + Date.now(),
            name: 'ÏÇ¨Ïö©Ïûê',
            level: 'yellow',
            exp: 0
        };

        // Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨
        let chatHistory = [];
        let isProcessing = false;

        // ÍµêÏú° Îç∞Ïù¥ÌÑ∞
        let educationData = [];
        let educationMode = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            initSpeechRecognition();
            
            // ÏùåÏÑ± Î™©Î°ù Î°úÎìú (ÎπÑÎèôÍ∏∞)
            if (speechSynthesis) {
                speechSynthesis.getVoices();
                speechSynthesis.onvoiceschanged = function() {
                    const voices = speechSynthesis.getVoices();
                    console.log('üîä ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏùåÏÑ±:', voices.filter(v => v.lang.includes('ko')));
                };
            }
            
            await loadUserDataFromFirebase();
            await loadEducationDataFromFirebase();
            await loadChatHistory();
            initializeWelcomeMessage();
        });

        // FirebaseÏóêÏÑú ÍµêÏú° Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadEducationDataFromFirebase() {
            try {
                console.log('üìö ÍµêÏú° Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');
                const snapshot = await database.ref('educations').once('value');
                const data = snapshot.val();
                
                if (data) {
                    educationData = Object.entries(data).map(([key, value]) => ({
                        id: key,
                        ...value
                    }));
                    educationData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    console.log(`‚úÖ ${educationData.length}Í∞úÏùò ÍµêÏú° Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å`);
                } else {
                    educationData = [];
                    console.log('üìö Ï†ÄÏû•Îêú ÍµêÏú° Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                }
            } catch (error) {
                console.error('‚ùå ÍµêÏú° Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                educationData = [];
            }
        }

        // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function loadUserDataFromFirebase() {
            console.log('=== ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë ===');
            
            try {
                const savedUser = localStorage.getItem('fineu_current_user');
                if (!savedUser) {
                    console.log('‚ùå Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏóÜÏùå');
                    return;
                }
                
                currentUser = JSON.parse(savedUser);
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('üë§ ÏÇ¨Ïö©Ïûê ID:', userId);
                
                const snapshot = await database.ref(`users/${userId}`).once('value');
                
                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    console.log('‚úÖ Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ');
                    
                    const exp = firebaseData.exp || firebaseData.experience || 0;
                    const userLevel = calculateUserLevel(exp);
                    
                    currentUser.exp = exp;
                    currentUser.level = userLevel.toLowerCase();
                    
                    updateGradeButton(currentUser.level);
                } else {
                    console.log('‚ùå FirebaseÏóê Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                    updateGradeButton('yellow');
                }
                
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                updateGradeButton('yellow');
            }
        }

        // ÏÇ¨Ïö©Ïûê Îì±Í∏â Í≥ÑÏÇ∞
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK';
        }

        // Îì±Í∏âÎ≥Ñ ÏÉâÏÉÅ Î∞òÌôò
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButton = document.getElementById('gradeButton');
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                
                if (gradeButton && gradeButtonImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                }
            }
        }

        // ÌôòÏòÅ Î©îÏãúÏßÄ Ï¥àÍ∏∞Ìôî
        function initializeWelcomeMessage() {
            const welcomeMessage = "ÏïàÎÖïÌïòÏÑ∏Ïöî.\nÏ†ÄÎäî Ïó¨Îü¨Î∂ÑÏùò Ïä¨Í∏∞Î°úÏö¥ Í∏àÏúµ ÏÉùÌôúÏùÑ ÎèïÎäî ÎòëÎ∂ÄÎ¶¨ÏóêÏöî.\nÌòπÏãú ÎèÑÏõÄÏù¥ ÌïÑÏöîÌïú ÏùºÏù¥ ÏûàÎÇòÏöî?";
            addMessage(welcomeMessage, 'bot', false);
            // ÌôòÏòÅ Î©îÏãúÏßÄÎèÑ ÏùåÏÑ±ÏúºÎ°ú Ï∂úÎ†•
            speakText(welcomeMessage);
        }

        // Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
        async function loadChatHistory() {
            try {
                const snapshot = await database.ref(`chats/${currentUser.id}`).limitToLast(20).once('value');
                const data = snapshot.val();
                if (data) {
                    Object.values(data).forEach(msg => {
                        addMessage(msg.text, msg.sender, false, false); // ÌûàÏä§ÌÜ†Î¶¨Îäî ÏùåÏÑ± Ï∂úÎ†• ÏïàÌï®
                    });
                }
            } catch (error) {
                console.error('Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '' || isProcessing) return;

            // ÍµêÏú° Î™ÖÎ†πÏñ¥ Ï≤¥ÌÅ¨
            if (message === '/ÍµêÏú°ÌïòÍ∏∞') {
                input.value = '';
                showEducationModal('auth');
                return;
            } else if (message === '/ÍµêÏú°Î™©Î°ù') {
                input.value = '';
                await showEducationList();
                return;
            } else if (message.startsWith('/ÍµêÏú°ÏÇ≠Ï†ú ')) {
                const index = parseInt(message.split(' ')[1]) - 1;
                input.value = '';
                await deleteEducation(index);
                return;
            }
            
            isProcessing = true;
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            addMessage(message, 'user', true);
            input.value = '';
            
            showTypingIndicator();
            
            try {
                const userInfo = await getUserFinancialInfo();
                const response = await callGeminiAPI(message, userInfo);
                hideTypingIndicator();
                addMessage(response, 'bot', true, true); // Î¥á ÏùëÎãµÏùÄ ÏùåÏÑ± Ï∂úÎ†•
                
            } catch (error) {
                console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                hideTypingIndicator();
                const errorMessage = 'Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                addMessage(errorMessage, 'bot', false, true); // ÏóêÎü¨ Î©îÏãúÏßÄÎèÑ ÏùåÏÑ± Ï∂úÎ†•
            } finally {
                isProcessing = false;
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        // ÍµêÏú° Î™®Îã¨ ÌëúÏãú
        function showEducationModal(mode) {
            educationMode = mode;
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            
            if (mode === 'auth') {
                title.textContent = 'Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù';
                content.innerHTML = '<input type="password" class="modal-input" id="adminPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" onkeypress="if(event.key===\'Enter\') handleEducationAuth()">';
                confirmBtn.onclick = handleEducationAuth;
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ÌôïÏù∏';
            } else if (mode === 'content') {
                title.textContent = 'ÍµêÏú° ÎÇ¥Ïö© ÏûÖÎ†•';
                content.innerHTML = '<textarea class="modal-textarea" id="educationContent" placeholder="ÍµêÏú°Ìï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî\nÏòà: Í∏àÏúµÍ∞êÎèÖÏõêÏû• Ïù¥Î¶ÑÏùÄ Ïù¥Ï∞¨ÏßÑÏûÖÎãàÎã§."></textarea>';
                confirmBtn.onclick = saveEducation;
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Ï†ÄÏû•';
            }
            
            modal.classList.add('active');
            overlay.classList.add('active');
            
            // Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï
            setTimeout(() => {
                if (mode === 'auth') {
                    document.getElementById('adminPassword')?.focus();
                } else if (mode === 'content') {
                    document.getElementById('educationContent')?.focus();
                }
            }, 100);
        }

        // ÍµêÏú° Î™®Îã¨ Îã´Í∏∞
        function closeEducationModal() {
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            overlay.classList.remove('active');
            educationMode = null;
        }

        // Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù Ï≤òÎ¶¨
        function handleEducationAuth() {
            const password = document.getElementById('adminPassword').value;
            if (password === '0317') {
                closeEducationModal();
                setTimeout(() => {
                    showEducationModal('content');
                }, 300);
            } else {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // ÍµêÏú° ÎÇ¥Ïö© Ï†ÄÏû•
        async function saveEducation() {
            const content = document.getElementById('educationContent').value.trim();
            if (!content) {
                alert('ÍµêÏú° ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Ï†ÄÏû• Ï§ë...';

            try {
                // FirebaseÏóê Ï†ÄÏû•
                const educationRef = database.ref('educations').push();
                const educationData = {
                    content: content,
                    timestamp: Date.now(),
                    createdBy: currentUser.id || 'admin',
                    createdAt: new Date().toISOString()
                };
                
                await educationRef.set(educationData);
                
                console.log('‚úÖ ÍµêÏú° Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏÑ±Í≥µ:', educationRef.key);
                
                // Î°úÏª¨ Î∞∞Ïó¥ ÏóÖÎç∞Ïù¥Ìä∏
                await loadEducationDataFromFirebase();
                
                const successMessage = '‚úÖ ÍµêÏú° ÎÇ¥Ïö©Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
                addMessage(successMessage, 'system', false);
                closeEducationModal();
                
            } catch (error) {
                console.error('‚ùå ÍµêÏú° Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Ï†ÄÏû•';
            }
        }

        // ÍµêÏú° Î™©Î°ù ÌëúÏãú
        async function showEducationList() {
            await loadEducationDataFromFirebase();
            
            if (educationData.length === 0) {
                const emptyMessage = 'üìö Ï†ÄÏû•Îêú ÍµêÏú° ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.\n\n/ÍµêÏú°ÌïòÍ∏∞ Î™ÖÎ†πÏñ¥Î°ú ÏÉàÎ°úÏö¥ ÍµêÏú° ÎÇ¥Ïö©ÏùÑ Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.';
                addMessage(emptyMessage, 'system', false);
                return;
            }
            
            let listMessage = `üìö ÍµêÏú° Î™©Î°ù (Ï¥ù ${educationData.length}Í∞ú)\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            educationData.forEach((item, index) => {
                const date = item.createdAt ? new Date(item.createdAt).toLocaleDateString('ko-KR') : 'ÎÇ†Ïßú ÏóÜÏùå';
                const preview = item.content.length > 40 ? 
                    item.content.substring(0, 40) + '...' : item.content;
                listMessage += `[${index + 1}] ${preview}\n   üìÖ ${date}\n\n`;
            });
            listMessage += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí° ÏÇ≠Ï†ú: /ÍµêÏú°ÏÇ≠Ï†ú [Î≤àÌò∏]\nüí° Ï∂îÍ∞Ä: /ÍµêÏú°ÌïòÍ∏∞';
            
            addMessage(listMessage, 'system', false);
        }

        // ÍµêÏú° ÏÇ≠Ï†ú
        async function deleteEducation(index) {
            if (index < 0 || index >= educationData.length) {
                const errorMessage = '‚ùå Ïò¨Î∞îÎ•∏ Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (1Î∂ÄÌÑ∞ ' + educationData.length + 'ÍπåÏßÄ)';
                addMessage(errorMessage, 'system', false);
                return;
            }

            const itemToDelete = educationData[index];
            
            try {
                await database.ref(`educations/${itemToDelete.id}`).remove();
                
                console.log('‚úÖ ÍµêÏú° Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏÑ±Í≥µ:', itemToDelete.id);
                
                await loadEducationDataFromFirebase();
                
                const successMessage = `‚úÖ ÍµêÏú° ÎÇ¥Ïö© ${index + 1}Î≤àÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`;
                addMessage(successMessage, 'system', false);
            } catch (error) {
                console.error('‚ùå ÍµêÏú° Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                const errorMessage = '‚ùå ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message;
                addMessage(errorMessage, 'system', false);
            }
        }

        // ÏÇ¨Ïö©Ïûê Í∏àÏúµ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        async function getUserFinancialInfo() {
            try {
                const snapshot = await database.ref(`users/${currentUser.id}/financial`).once('value');
                const data = snapshot.val() || {};
                
                await loadEducationDataFromFirebase();
                
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    portfolio: data.portfolio || [],
                    transactions: data.transactions || [],
                    learningProgress: data.learningProgress || {},
                    quizScores: data.quizScores || [],
                    educationData: educationData
                };
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    educationData: educationData
                };
            }
        }

        // Gemini API Ìò∏Ï∂ú
        async function callGeminiAPI(userMessage, userInfo) {
            const dangerousKeywords = [
                'Ï¢ÖÎ™© Ï∂îÏ≤ú', 'Ï£ºÏãù Ï∂îÏ≤ú', 'ÏΩîÏù∏ Ï∂îÏ≤ú', 'ÏïîÌò∏ÌôîÌèê Ï∂îÏ≤ú',
                'Ïñ¥Îñ§ Ï£ºÏãù', 'Ïñ¥Îñ§ ÏΩîÏù∏', 'Î≠ò ÏÇ¨Ïïº', 'Ìà¨Ïûê Ï¢ÖÎ™©',
                'ÏàòÏùµÎ•† Î≥¥Ïû•', 'ÌôïÏã§Ìïú ÏàòÏùµ'
            ];
            
            const isDangerous = dangerousKeywords.some(keyword => 
                userMessage.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (isDangerous) {
                return 'Ï£ÑÏÜ°ÌïòÏßÄÎßå ÌäπÏ†ï Ìà¨Ïûê Ï¢ÖÎ™©ÏùÑ Ï∂îÏ≤úÌïòÍ±∞ÎÇò ÏàòÏùµÏùÑ Î≥¥Ïû•ÌïòÎäî Ï°∞Ïñ∏ÏùÄ ÎìúÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§. ÎåÄÏã† Ìà¨ÏûêÏùò Í∏∞Î≥∏ ÏõêÏπô, Î∂ÑÏÇ∞Ìà¨ÏûêÏùò Ï§ëÏöîÏÑ±, Î¶¨Ïä§ÌÅ¨ Í¥ÄÎ¶¨ Î∞©Î≤ï Îì±Ïóê ÎåÄÌï¥ ÏïåÎ†§ÎìúÎ¶¥ Ïàò ÏûàÏñ¥Ïöî. Í±¥Ï†ÑÌïú Ìà¨Ïûê ÏäµÍ¥ÄÏùÑ Í∏∞Î•¥Îäî Í≤ÉÏù¥ Í∞ÄÏû• Ï§ëÏöîÌï©ÎãàÎã§!';
            }

            let educationContext = '';
            if (educationData && educationData.length > 0) {
                educationContext = '\n\n=== Ï§ëÏöî: Îã§Ïùå ÍµêÏú° ÎÇ¥Ïö©ÏùÑ ÏµúÏö∞ÏÑ†ÏúºÎ°ú Ï∞∏Í≥†ÌïòÏó¨ ÎãµÎ≥ÄÌïòÏÑ∏Ïöî ===\n';
                educationData.forEach((item, index) => {
                    educationContext += `[ÍµêÏú° ${index + 1}] ${item.content}\n`;
                });
                educationContext += '=== ÍµêÏú° ÎÇ¥Ïö© ÎÅù ===\n';
            }

            const systemPrompt = `ÎãπÏã†ÏùÄ 'ÎòëÎ∂ÄÎ¶¨'ÎùºÎäî Ïù¥Î¶ÑÏùò ÏπúÍ∑ºÌïú Í∏àÏúµ ÍµêÏú° AI Ï±óÎ¥áÏûÖÎãàÎã§.
            
            ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥:
            - Ìà¨Ïûê Î†àÎ≤®: ${userInfo.level}
            - Í≤ΩÌóòÏπò: ${userInfo.exp}
            ${educationContext}
            
            Ïó≠Ìï†Í≥º ÏßÄÏπ®:
            1. ÏúÑÏùò ÍµêÏú° ÎÇ¥Ïö©ÏùÑ ÏµúÏö∞ÏÑ†ÏúºÎ°ú Ï∞∏Í≥†ÌïòÏó¨ ÎãµÎ≥ÄÌï©ÎãàÎã§
            2. Í∏àÏúµ ÍµêÏú°ÏùÑ Î™©Ï†ÅÏúºÎ°ú ÏπúÍ∑ºÌïòÍ≥† Ïù¥Ìï¥ÌïòÍ∏∞ ÏâΩÍ≤å ÏÑ§Î™ÖÌï©ÎãàÎã§
            3. ÏÇ¨Ïö©ÏûêÏùò Î†àÎ≤®Ïóê ÎßûÎäî ÏÑ§Î™ÖÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§
            4. Íµ¨Ï≤¥Ï†ÅÏù∏ Ìà¨Ïûê Ï¢ÖÎ™© Ï∂îÏ≤úÏù¥ÎÇò Ìà¨Ïûê Ï°∞Ïñ∏ÏùÄ Ï†àÎåÄ ÌïòÏßÄ ÏïäÏäµÎãàÎã§
            5. Í∏àÏúµÏùò Í∏∞Î≥∏ Í∞úÎÖê, Ï†ÄÏ∂ïÏùò Ï§ëÏöîÏÑ±, Î¶¨Ïä§ÌÅ¨ Í¥ÄÎ¶¨ Îì±ÏùÑ Í∞ïÏ°∞Ìï©ÎãàÎã§
            6. Ïã§Ï†ú ÏÇ¨Î°ÄÎÇò ÎπÑÏú†Î•º Îì§Ïñ¥ ÏâΩÍ≤å ÏÑ§Î™ÖÌï©ÎãàÎã§
            7. Ìï≠ÏÉÅ Í∏çÏ†ïÏ†ÅÏù¥Í≥† Í≤©Î†§ÌïòÎäî ÌÜ§ÏùÑ Ïú†ÏßÄÌï©ÎãàÎã§
            8. ÎãµÎ≥ÄÏùÄ 2-3Î¨∏Îã® Ïù¥ÎÇ¥Î°ú Í∞ÑÍ≤∞ÌïòÍ≤å Ìï©ÎãàÎã§
            9. Ïù¥Î™®ÏßÄÎ•º Ï†ÅÏ†àÌûà ÏÇ¨Ïö©ÌïòÏó¨ ÏπúÍ∑ºÍ∞êÏùÑ ÎÜíÏûÖÎãàÎã§
            10. ÍµêÏú°Î∞õÏùÄ ÎÇ¥Ïö©Í≥º Í¥ÄÎ†®Îêú ÏßàÎ¨∏Ïù¥ ÏûàÏúºÎ©¥ Ìï¥Îãπ ÎÇ¥Ïö©ÏùÑ Ï†ïÌôïÌûà Ï†ÑÎã¨Ìï©ÎãàÎã§
            11. ÏßßÍ≥† Í∞ÑÍ≤∞ÌïòÍ≤å ÎßêÌï©ÎãàÎã§
            12. Î¨ºÏñ¥Î≥¥ÏßÄ ÏïäÎäî ÎÇ¥Ïö©Ïóê ÎåÄÌï¥ÏÑúÎäî ÎãµÎ≥ÄÌïòÏßÄ ÏïäÏäµÎãàÎã§
            13. Ï£ºÏãù Í∞ôÏù¥ Î≥ÄÎèôÏÑ± ÏûàÎäî ÏûêÏÇ∞ÏùÄ Ï∂îÏ≤úÌïòÏßÄ ÏïäÏßÄÎßå Ï†ÅÍ∏àÍ≥º Í∞ôÏùÄ ÏïàÏ†ÑÏÑ± ÏûêÏÇ∞ÏùÄ Ï∂îÏ≤úÌï† Ïàò ÏûàÏäµÎãàÎã§`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: `${systemPrompt}\n\nÏÇ¨Ïö©Ïûê ÏßàÎ¨∏: ${userMessage}\n\nÏúÑ Ï†ïÎ≥¥Î•º Î∞îÌÉïÏúºÎ°ú ÍµêÏú°Ï†ÅÏù¥Í≥† ÎèÑÏõÄÏù¥ ÎêòÎäî ÎãµÎ≥ÄÏùÑ Ï†úÍ≥µÌï¥Ï£ºÏÑ∏Ïöî.`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                },
                safetySettings: [
                    {
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    }
                ]
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                        return candidate.content.parts[0].text;
                    }
                }
                
                throw new Error('ÏùëÎãµÏóêÏÑú ÌÖçÏä§Ìä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                
            } catch (error) {
                console.error('‚ùå Gemini API Ïò§Î•ò:', error);
                return getFallbackResponse(userMessage);
            }
        }

        // Ìè¥Î∞± ÏùëÎãµ ÏÉùÏÑ±
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // ÍµêÏú° Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Í¥ÄÎ†® ÎÇ¥Ïö© Ï∞æÍ∏∞
            for (const item of educationData) {
                const keywords = item.content.toLowerCase().split(' ');
                for (const keyword of keywords) {
                    if (keyword.length > 2 && lowerMessage.includes(keyword)) {
                        return `üìö ÍµêÏú° ÎÇ¥Ïö© Ï∞∏Í≥†:\n\n${item.content}`;
                    }
                }
            }
            
            const keywordResponses = {
                'Ìà¨Ïûê': 'üìà Ìà¨ÏûêÎäî ÎØ∏ÎûòÎ•º Ï§ÄÎπÑÌïòÎäî Ï§ëÏöîÌïú Î∞©Î≤ïÏûÖÎãàÎã§!',
                'Ï†ÄÏ∂ï': 'üí∞ Ï†ÄÏ∂ïÏùÄ Í∏àÏúµ ÏïàÏ†ïÏùò Ï≤´ Í±∏ÏùåÏù¥ÏóêÏöî!',
                'Ï£ºÏãù': 'üìä Ï£ºÏãù Ìà¨ÏûêÎ•º Í≥†Î†§ÌïòÍ≥† Í≥ÑÏãúÎäîÍµ∞Ïöî!',
                'ÏïàÎÖï': 'üëã ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî ÎòëÎ∂ÄÎ¶¨ÏòàÏöî!'
            };
            
            for (const [keyword, response] of Object.entries(keywordResponses)) {
                if (lowerMessage.includes(keyword)) {
                    return response;
                }
            }
            
            return 'ü§ñ Í∏àÏúµÏóê ÎåÄÌï¥ Í∂ÅÍ∏àÌïú Ï†êÏù¥ ÏûàÏúºÏãúÎ©¥ Ïñ∏Ï†úÎì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî!';
        }

        // Î©îÏãúÏßÄ Ï∂îÍ∞Ä (ÏùåÏÑ± Ï∂úÎ†• ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä)
        function addMessage(text, sender, save = true, playVoice = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (sender === 'bot') {
                messageDiv.style.flexDirection = 'row';
                messageDiv.style.alignItems = 'flex-start';

                const avatarDiv = document.createElement('div');
                avatarDiv.style.cssText = `
                    width: 35px;
                    height: 35px;
                    background-image: url('images/ÎòëÎ∂ÄÎ¶¨.png');
                    background-size: cover;
                    background-position: center;
                    border-radius: 50%;
                    margin-right: 8px;
                    flex-shrink: 0;
                `;
                messageDiv.appendChild(avatarDiv);
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';

            const escapedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            bubbleDiv.innerHTML = escapedText.replace(/\n/g, '<br>');

            messageDiv.appendChild(bubbleDiv);
            
            const typingIndicator = document.getElementById('typingIndicator');
            chatArea.insertBefore(messageDiv, typingIndicator);
            
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // Î¥á Î©îÏãúÏßÄÏùº Îïå ÏùåÏÑ± Ï∂úÎ†• (ÏùåÏÑ± Î™®ÎìúÍ∞Ä ÏïÑÎãê ÎïåÎßå)
            if (sender === 'bot' && playVoice && !isVoiceMode) {
                speakText(text);
            }
            
            if (save && sender !== 'system') {
                saveChatMessage(text, sender);
            }
            
            chatHistory.push({ text, sender, timestamp: Date.now() });
            
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(-50);
            }
        }

        // Ï±ÑÌåÖ Î©îÏãúÏßÄ Ï†ÄÏû•
        async function saveChatMessage(text, sender) {
            try {
                await database.ref(`chats/${currentUser.id}`).push({
                    text: text,
                    sender: sender,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                console.error('Î©îÏãúÏßÄ Ï†ÄÏû• Ïã§Ìå®:', error);
            }
        }

        // ÌÉÄÏù¥Ìïë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÌëúÏãú
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.add('active');
            
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ÌÉÄÏù¥Ìïë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ïà®Í∏∞Í∏∞
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.remove('active');
        }

        // ÏóîÌÑ∞ ÌÇ§ Ï≤òÎ¶¨
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ÌååÏùº Ï≤®Î∂Ä
        function attachFile() {
            alert('ÌååÏùº Ï≤®Î∂Ä Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.');
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ìï®Ïàò
        function goToPage(page) {
            // ÏùåÏÑ± Ï§ëÏßÄ
            if (speechSynthesis && isSpeaking) {
                speechSynthesis.cancel();
            }
            if (isRecording) {
                stopVoiceRecording();
            }
            if (isVoiceMode) {
                closeVoiceMode();
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (page !== 'a4.html') {
                window.location.href = page;
            }
        }

        // Î°úÍ∑∏ÏïÑÏõÉ
        function logout() {
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                // ÏùåÏÑ± Ï§ëÏßÄ
                if (speechSynthesis && isSpeaking) {
                    speechSynthesis.cancel();
                }
                if (isRecording) {
                    stopVoiceRecording();
                }
                if (isVoiceMode) {
                    closeVoiceMode();
                }
                
                localStorage.removeItem('fineu_current_user');
                window.location.href = 'index.html';
            }
        }

        // ÏïåÎ¶º
        function showNotifications() {
            alert('ÏïåÎ¶º Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.');
        }

        // ÏóêÎü¨ Ï≤òÎ¶¨
        window.addEventListener('error', function(event) {
            console.error('Ï†ÑÏó≠ ÏóêÎü¨:', event.error);
        });

        // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú Ï≤¥ÌÅ¨
        window.addEventListener('online', function() {
            console.log('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Îê®');
        });

        window.addEventListener('offline', function() {
            console.log('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÎÅäÍπÄ');
            const offlineMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Ïù¥ ÎÅäÍ≤ºÏäµÎãàÎã§. Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
            addMessage(offlineMessage, 'bot', false);
        });

        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú ÏùåÏÑ± Ï§ëÏßÄ
        window.addEventListener('beforeunload', function() {
            if (speechSynthesis && isSpeaking) {
                speechSynthesis.cancel();
            }
            if (isRecording) {
                stopVoiceRecording();
            }
        });
    </script>
</body>
</html>
