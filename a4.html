<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FINE U - 채팅</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* 공통 헤더 */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* 메인 콘텐츠 수정 */
        .main-content {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 130px;
            padding: 10px 20px;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        /* 채팅 영역 수정 */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #7cb9e8;
            color: white;
        }

        .message.bot .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 타이핑 인디케이터 */
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            max-width: 60px;
        }

        .typing-indicator.active {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* 입력 영역 수정 */
        .input-area {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 10px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #333;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: #555;
            transform: scale(1.05);
        }

        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .attach-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .attach-button:hover {
            background: #f0f0f0;
        }

        /* 하단 네비게이션 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/배경.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* 중앙 반원 돌출 부분 추가 */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/배경.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        /* 등급 버튼으로 변경 */
        .grade-button {
            width: 55px;
            height: 55px;
            background: transparent;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        /* 교육 모달 스타일 */
        .education-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 350px;
            width: 90%;
        }

        .education-modal.active {
            display: block;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .modal-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .modal-button.confirm {
            background: #7cb9e8;
            color: white;
        }

        .modal-button.cancel {
            background: #ddd;
            color: #333;
        }

        .modal-button:hover {
            opacity: 0.8;
        }

        .education-list {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .education-item {
            padding: 5px;
            margin-bottom: 5px;
            background: white;
            border-radius: 3px;
            font-size: 13px;
        }

        /* 반응형 수정 */
        @media (max-width: 480px) {
            .main-content {
                padding: 10px 15px;
                width: 100%;
                max-width: none;
            }
            
            .input-area {
                padding: 10px 15px;
                max-width: none;
            }
            
            .chat-input {
                padding: 10px 14px;
                font-size: 16px;
            }
            
            .send-button,
            .attach-button {
                width: 36px;
                height: 36px;
            }
        }

        /* iOS Safe Area 대응 */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(70px + env(safe-area-inset-bottom));
            }
            
            .input-area {
                bottom: calc(70px + env(safe-area-inset-bottom));
            }
        }

        /* 에러 메시지 스타일 */
        .error-message {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* 로딩 스피너 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/레이어 1.png" alt="FINE U 로고" class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
        <div class="page-title">AI CHATBOT</div>
        
        <!-- 채팅 영역 -->
        <div class="chat-area" id="chatArea">
            <!-- 타이핑 인디케이터 -->
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- 입력 영역 -->
    <div class="input-area">
        <div class="input-container">
            <button class="attach-button" onclick="attachFile()">
                <i class="fas fa-camera"></i>
            </button>
            <input type="text" class="chat-input" placeholder="채팅을 입력하세요." id="chatInput" onkeypress="handleKeyPress(event)">
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- 교육 모달 -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeEducationModal()"></div>
    <div class="education-modal" id="educationModal">
        <div class="modal-title" id="modalTitle">관리자 인증</div>
        <div id="modalContent">
            <input type="password" class="modal-input" id="adminPassword" placeholder="비밀번호를 입력하세요">
        </div>
        <div class="modal-buttons">
            <button class="modal-button cancel" onclick="closeEducationModal()">취소</button>
            <button class="modal-button confirm" id="modalConfirmBtn" onclick="handleEducationAuth()">확인</button>
        </div>
    </div>

    <!-- 하단 네비게이션 -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/집.png" alt="홈">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/문서.png" alt="문서">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ㅇ.png" alt="YELLOW">
        </div>
        <div class="nav-item active" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/채팅.png" alt="채팅">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/더보기.png" alt="더보기">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Gemini API 설정
        const GEMINI_API_KEY = 'AIzaSyDMawZDEzBrAvAJt8ZrZxvvq2aZIRnbObk';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // 등급 시스템 설정
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW ㅁ.png', nav: 'YELLOW ㅇ', navImage: 'YELLOW ㅇ.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN ㅁ.png', nav: 'GREEN ㅇ', navImage: 'GREEN ㅇ.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE ㅁ.png', nav: 'BLUE ㅇ', navImage: 'BLUE ㅇ.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED ㅁ.png', nav: 'RED ㅇ', navImage: 'RED ㅇ.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK ㅁ.png', nav: 'BLACK ㅇ', navImage: 'BLACK ㅇ.png' }
        };

        // 사용자 정보
        let currentUser = JSON.parse(localStorage.getItem('fineu_current_user')) || {
            id: 'user_' + Date.now(),
            name: '사용자',
            level: 'yellow',
            exp: 0
        };

        // 채팅 히스토리
        let chatHistory = [];
        let isProcessing = false;

        // 교육 데이터 저장소
        let educationData = JSON.parse(localStorage.getItem('fineu_education_data')) || [];
        let educationMode = null;
        let educationContent = '';

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadUserDataFromFirebase();
            loadChatHistory();
            initializeWelcomeMessage();
        });

        // Firebase에서 사용자 데이터 가져오기
        async function loadUserDataFromFirebase() {
            console.log('=== A4 데이터 로드 시작 ===');
            
            try {
                const savedUser = localStorage.getItem('fineu_current_user');
                if (!savedUser) {
                    console.log('❌ 로그인 정보 없음');
                    return;
                }
                
                currentUser = JSON.parse(savedUser);
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('👤 A4 사용자 ID:', userId);
                
                const snapshot = await database.ref(`users/${userId}`).once('value');
                console.log('📊 A4 데이터 스냅샷 확인:', snapshot.exists());

                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    console.log('✅ A4 Firebase 데이터 로드 성공:', firebaseData);
                    
                    const exp = firebaseData.exp || firebaseData.experience || 0;
                    const userLevel = calculateUserLevel(exp);
                    
                    currentUser.exp = exp;
                    currentUser.level = userLevel.toLowerCase();
                    
                    updateGradeButton(currentUser.level);
                    
                } else {
                    console.log('❌ A4 Firebase에 데이터 없음 - 기본값 사용');
                    updateGradeButton('yellow');
                }
                
            } catch (error) {
                console.error('❌ A4 데이터 로드 오류:', error);
                updateGradeButton('yellow');
            }
        }

        // 사용자 등급 계산
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK';
        }

        // 등급별 색상 반환
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // 등급 버튼 업데이트
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButton = document.getElementById('gradeButton');
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                
                if (gradeButton && gradeButtonImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                    console.log('🎖️ A4 등급 버튼 업데이트:', upperGrade, levelData.navImage);
                }
            }
        }

        // 환영 메시지 초기화
        function initializeWelcomeMessage() {
            const welcomeMessage = "안녕하세요.\n저는 여러분의 슬기로운 금융 생활을 돕는 똑부리에요.\n혹시 도움이 필요한 일이 있나요?";
            addMessage(welcomeMessage, 'bot', false);
        }

        // 채팅 히스토리 로드
        async function loadChatHistory() {
            try {
                const snapshot = await database.ref(`chats/${currentUser.id}`).limitToLast(20).once('value');
                const data = snapshot.val();
                if (data) {
                    Object.values(data).forEach(msg => {
                        addMessage(msg.text, msg.sender, false);
                    });
                }
            } catch (error) {
                console.error('채팅 히스토리 로드 실패:', error);
            }
        }

        // 메시지 전송
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '' || isProcessing) return;

            // 교육 명령어 체크
            if (message === '/교육하기') {
                input.value = '';
                showEducationModal('auth');
                return;
            } else if (message === '/교육목록') {
                input.value = '';
                showEducationList();
                return;
            } else if (message.startsWith('/교육삭제 ')) {
                const index = parseInt(message.split(' ')[1]) - 1;
                input.value = '';
                deleteEducation(index);
                return;
            }
            
            isProcessing = true;
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            addMessage(message, 'user', true);
            input.value = '';
            
            showTypingIndicator();
            
            try {
                const userInfo = await getUserFinancialInfo();
                const response = await callGeminiAPI(message, userInfo);
                hideTypingIndicator();
                addMessage(response, 'bot', true);
                
            } catch (error) {
                console.error('메시지 전송 실패:', error);
                hideTypingIndicator();
                addMessage('죄송합니다. 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'bot', false);
            } finally {
                isProcessing = false;
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        // 교육 모달 표시
        function showEducationModal(mode) {
            educationMode = mode;
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            
            if (mode === 'auth') {
                title.textContent = '관리자 인증';
                content.innerHTML = '<input type="password" class="modal-input" id="adminPassword" placeholder="비밀번호를 입력하세요">';
                confirmBtn.onclick = handleEducationAuth;
            } else if (mode === 'content') {
                title.textContent = '교육 내용 입력';
                content.innerHTML = '<textarea class="modal-textarea" id="educationContent" placeholder="교육할 내용을 입력하세요"></textarea>';
                confirmBtn.onclick = saveEducation;
            }
            
            modal.classList.add('active');
            overlay.classList.add('active');
        }

        // 교육 모달 닫기
        function closeEducationModal() {
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            overlay.classList.remove('active');
            educationMode = null;
        }

        // 관리자 인증 처리
        function handleEducationAuth() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'admin123') {
                closeEducationModal();
                setTimeout(() => {
                    showEducationModal('content');
                }, 300);
            } else {
                alert('비밀번호가 틀렸습니다.');
            }
        }

        // 교육 내용 저장
        function saveEducation() {
            const content = document.getElementById('educationContent').value.trim();
            if (content) {
                educationData.push({
                    content: content,
                    timestamp: Date.now()
                });
                localStorage.setItem('fineu_education_data', JSON.stringify(educationData));
                addMessage('교육 내용이 저장되었습니다.', 'bot', false);
                closeEducationModal();
            } else {
                alert('교육 내용을 입력해주세요.');
            }
        }

        // 교육 목록 표시
        function showEducationList() {
            if (educationData.length === 0) {
                addMessage('저장된 교육 내용이 없습니다.', 'bot', false);
                return;
            }
            
            let listMessage = '📚 교육 목록:\n\n';
            educationData.forEach((item, index) => {
                const preview = item.content.length > 30 ? 
                    item.content.substring(0, 30) + '...' : item.content;
                listMessage += `${index + 1}. ${preview}\n`;
            });
            listMessage += '\n삭제하려면 /교육삭제 [번호]를 입력하세요.';
            
            addMessage(listMessage, 'bot', false);
        }

        // 교육 삭제
        function deleteEducation(index) {
            if (index >= 0 && index < educationData.length) {
                educationData.splice(index, 1);
                localStorage.setItem('fineu_education_data', JSON.stringify(educationData));
                addMessage(`교육 내용 ${index + 1}번이 삭제되었습니다.`, 'bot', false);
            } else {
                addMessage('올바른 번호를 입력해주세요.', 'bot', false);
            }
        }

        // 사용자 금융 정보 가져오기
        async function getUserFinancialInfo() {
            try {
                const snapshot = await database.ref(`users/${currentUser.id}/financial`).once('value');
                const data = snapshot.val() || {};
                
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    portfolio: data.portfolio || [],
                    transactions: data.transactions || [],
                    learningProgress: data.learningProgress || {},
                    quizScores: data.quizScores || [],
                    educationData: educationData
                };
            } catch (error) {
                console.error('사용자 정보 로드 실패:', error);
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    educationData: educationData
                };
            }
        }

        // Gemini API 호출
        async function callGeminiAPI(userMessage, userInfo) {
            const dangerousKeywords = [
                '종목 추천', '주식 추천', '코인 추천', '암호화폐 추천',
                '어떤 주식', '어떤 코인', '뭘 사야', '투자 종목',
                '수익률 보장', '확실한 수익'
            ];
            
            const isDangerous = dangerousKeywords.some(keyword => 
                userMessage.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (isDangerous) {
                return '죄송하지만 특정 투자 종목을 추천하거나 수익을 보장하는 조언은 드릴 수 없습니다. 대신 투자의 기본 원칙, 분산투자의 중요성, 리스크 관리 방법 등에 대해 알려드릴 수 있어요. 건전한 투자 습관을 기르는 것이 가장 중요합니다!';
            }

            // 교육 데이터를 시스템 프롬프트에 추가
            let educationContext = '';
            if (educationData.length > 0) {
                educationContext = '\n\n추가 교육 내용:\n';
                educationData.forEach((item, index) => {
                    educationContext += `${index + 1}. ${item.content}\n`;
                });
            }

            const systemPrompt = `당신은 '똑부리'라는 이름의 친근한 금융 교육 AI 챗봇입니다.
            
            사용자 정보:
            - 투자 레벨: ${userInfo.level}
            - 경험치: ${userInfo.exp}
            - 학습 진도: ${JSON.stringify(userInfo.learningProgress || {})}
            ${educationContext}
            
            역할과 지침:
            1. 금융 교육을 목적으로 친근하고 이해하기 쉽게 설명합니다
            2. 사용자의 레벨에 맞는 설명을 제공합니다-필요시에만
            3. 구체적인 투자 종목 추천이나 투자 조언은 절대 하지 않습니다
            4. 금융의 기본 개념, 저축의 중요성, 리스크 관리 등을 강조합니다
            5. 실제 사례나 비유를 들어 쉽게 설명합니다
            6. 항상 긍정적이고 격려하는 톤을 유지합니다
            7. 답변은 2-3문단 이내로 간결하게 합니다
            8. 이모지를 적절히 사용하여 친근감을 높입니다
            9. 금융보안에 대해 물어보면 명확하게 답합니다.
            10. 금융감독원장 이름은 이찬진 입니다.
            11. 짧고 간결하게 말합니다.
            12. 금융감독원의 앞으로의 금융 감독방향은 도약을 위한 혁신 기반을 마련해 나가는 것, 공정한 시정질서를 확립해 나가는 것, 부실화된 부동산 PF 문제를 조속히 정리하는 것, 금융안정을 철저히 지켜 나가는 것, 금융 소비자 보호 기능을 대폭 강화하는 것 
            13. 물어보지 않는 내용에 대해서는 답변 금지 
            14. 주식 같이 변동성 있는 자산은 추천 안하는데 적금과 같은 안전성 자산은 추천
            15. 추가로 교육받은 내용이 있다면 그것도 참고하여 답변합니다`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: `${systemPrompt}\n\n사용자 질문: ${userMessage}\n\n위 정보를 바탕으로 교육적이고 도움이 되는 답변을 제공해주세요.`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                },
                safetySettings: [
                    {
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    }
                ]
            };

            try {
                console.log('🤖 Gemini API 호출 시작:', GEMINI_API_URL);
                
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('📡 API 응답 상태:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ API 에러 상세:', errorText);
                    throw new Error(`API 요청 실패: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('📊 API 응답 데이터:', data);
                
                if (data.candidates && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                        const responseText = candidate.content.parts[0].text;
                        console.log('✅ Gemini 응답 성공:', responseText.substring(0, 100) + '...');
                        return responseText;
                    }
                }
                
                console.warn('⚠️ 예상과 다른 응답 구조:', data);
                throw new Error('응답에서 텍스트를 찾을 수 없습니다');
                
            } catch (error) {
                console.error('❌ Gemini API 오류:', error);
                return getFallbackResponse(userMessage);
            }
        }

        // 폴백 응답 생성
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            const keywordResponses = {
                '투자': '📈 투자는 미래를 준비하는 중요한 방법입니다! \n\n기본 원칙을 알려드릴게요:\n• 여유자금으로만 투자하기\n• 분산투자로 리스크 관리\n• 장기적인 관점 유지\n• 충분한 공부와 분석 후 결정\n\n투자에 대해 더 궁금한 점이 있으시면 언제든 물어보세요!',
                
                '저축': '💰 저축은 금융 안정의 첫 걸음이에요!\n\n효과적인 저축 방법:\n• 선저축 후소비 원칙\n• 자동이체로 강제 저축\n• 목표 금액과 기간 설정\n• 비상금 먼저 준비하기\n\n작은 금액이라도 꾸준히 하는 것이 가장 중요합니다!',
                
                '주식': '📊 주식 투자를 고려하고 계시는군요!\n\n시작하기 전 준비사항:\n• 기업 분석 방법 학습\n• 재무제표 읽기 연습\n• 투자 철학 정립\n• 손실 각오와 위험 관리\n\n무작정 시작하기보다는 충분한 공부가 선행되어야 해요!',
                
                '예산': '📝 예산 관리는 건전한 금융 생활의 기초입니다!\n\n예산 관리 단계:\n• 수입과 지출 파악\n• 필수/선택 지출 분류\n• 저축 목표 설정\n• 정기적인 점검과 조정\n\n가계부 앱을 활용하시면 더 쉽게 관리할 수 있어요!',
                
                '은퇴': '🏖️ 은퇴 준비는 빠를수록 좋아요!\n\n은퇴 준비 방법:\n• 복리 효과 활용한 장기 투자\n• 연금저축, IRP 등 세제혜택 상품\n• 다양한 자산에 분산 투자\n• 정기적인 계획 점검\n\n시간이 가장 큰 무기이니 지금부터 시작하세요!',
                
                '복리': '✨ 복리는 정말 마법 같은 힘을 가지고 있어요!\n\n복리의 힘:\n• 시간이 길수록 효과 극대화\n• 원금과 이자가 함께 재투자\n• 작은 차이가 큰 결과로\n• 꾸준함이 가장 중요\n\n"복리는 세상에서 가장 강한 힘이다" - 아인슈타인',
                
                '부채': '⚠️ 부채 관리는 매우 중요한 문제예요!\n\n부채 정리 방법:\n• 고금리 부채부터 우선 상환\n• 최소 납입금액 이상 납부\n• 추가 대출 자제\n• 가계부로 지출 관리\n\n부채를 줄이는 것도 수익률 높은 투자라고 생각하세요!',
                
                'etf': '📈 ETF는 초보자에게 좋은 투자 방법이에요!\n\nETF의 장점:\n• 분산투자 효과\n• 낮은 운용비용\n• 높은 유동성\n• 투명한 운용\n\n하지만 여전히 투자이므로 충분한 공부가 필요해요!'
            };
            
            for (const [keyword, response] of Object.entries(keywordResponses)) {
                if (lowerMessage.includes(keyword)) {
                    return response;
                }
            }
            
            if (lowerMessage.includes('어떻게') || lowerMessage.includes('방법')) {
                return '🤔 구체적인 방법을 알고 싶으시는군요! 투자, 저축, 예산관리 등 어떤 분야의 방법이 궁금하신지 좀 더 구체적으로 말씀해주시면 더 정확한 답변을 드릴 수 있어요!';
            }
            
            if (lowerMessage.includes('추천') || lowerMessage.includes('종목')) {
                return '⚠️ 죄송하지만 특정 투자 종목이나 금융상품 추천은 드릴 수 없어요. 대신 투자 원칙, 분산투자의 중요성, 상품 선택 기준 등에 대해 알려드릴 수 있습니다!';
            }
            
            if (lowerMessage.includes('안녕') || lowerMessage.includes('하이') || lowerMessage.includes('hello')) {
                return '👋 안녕하세요! 저는 똑부리예요! 금융에 대한 궁금한 점이 있으시면 언제든 물어보세요. 투자, 저축, 예산관리 등 다양한 주제로 도움을 드릴 수 있어요! 😊';
            }
            
            return '🤖 금융에 대해 궁금한 점이 있으시군요! 더 구체적으로 알려주시면 정확한 답변을 드릴 수 있어요.\n\n이런 주제들로 도움드릴 수 있습니다:\n• 투자 기초와 원칙\n• 저축과 예산 관리\n• 복리와 자산 증식\n• 은퇴 준비 방법\n• 부채 관리 전략\n\n어떤 것이 궁금하세요? 😊';
        }

        // 메시지 추가
        function addMessage(text, sender, save = true) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (sender === 'bot') {
                messageDiv.style.flexDirection = 'row';
                messageDiv.style.alignItems = 'flex-start';

                const avatarDiv = document.createElement('div');
                avatarDiv.style.cssText = `
                    width: 35px;
                    height: 35px;
                    background-image: url('images/똑부리.png');
                    background-size: cover;
                    background-position: center;
                    border-radius: 50%;
                    margin-right: 8px;
                    flex-shrink: 0;
                `;
                messageDiv.appendChild(avatarDiv);
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';

            const escapedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            bubbleDiv.innerHTML = escapedText.replace(/\n/g, '<br>');

            messageDiv.appendChild(bubbleDiv);
            
            const typingIndicator = document.getElementById('typingIndicator');
            chatArea.insertBefore(messageDiv, typingIndicator);
            
            chatArea.scrollTop = chatArea.scrollHeight;
            
            if (save) {
                saveChatMessage(text, sender);
            }
            
            chatHistory.push({ text, sender, timestamp: Date.now() });
            
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(-50);
            }
        }

        // 채팅 메시지 저장
        async function saveChatMessage(text, sender) {
            try {
                await database.ref(`chats/${currentUser.id}`).push({
                    text: text,
                    sender: sender,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                console.error('메시지 저장 실패:', error);
            }
        }

        // 타이핑 인디케이터 표시
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.add('active');
            
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 타이핑 인디케이터 숨기기
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.remove('active');
        }

        // 엔터 키 처리
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 파일 첨부
        function attachFile() {
            alert('파일 첨부 기능은 준비 중입니다.');
        }

        // 네비게이션 함수
        function goToPage(page) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (page !== 'a4.html') {
                window.location.href = page;
            }
        }

        // 로그아웃
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('fineu_current_user');
                window.location.href = 'index.html';
            }
        }

        // 알림
        function showNotifications() {
            alert('알림 기능은 준비 중입니다.');
        }

        // 에러 처리
        window.addEventListener('error', function(event) {
            console.error('전역 에러:', event.error);
        });

        // 네트워크 상태 체크
        window.addEventListener('online', function() {
            console.log('네트워크 연결됨');
        });

        window.addEventListener('offline', function() {
            console.log('네트워크 연결 끊김');
            addMessage('네트워크 연결이 끊겼습니다. 연결 상태를 확인해주세요.', 'bot', false);
        });
    </script>
</body>
</html>
