<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FINE U - 채팅</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* 공통 헤더 */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* 메인 콘텐츠 수정 */
        .main-content {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 130px;
            padding: 10px 20px;
            max-width: 400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        .main-content.hidden {
            display: none;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        /* 채팅 영역 수정 */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #7cb9e8;
            color: white;
        }

        .message.bot .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.system .message-bubble {
            background: #fffbf0;
            color: #666;
            border: 1px solid #ffd700;
            max-width: 90%;
        }

        /* 타이핑 인디케이터 */
        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            max-width: 60px;
        }

        .typing-indicator.active {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* 입력 영역 수정 */
        .input-area {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 10px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }

        .input-area.hidden {
            display: none;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .chat-input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #333;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            background: #555;
            transform: scale(1.05);
        }

        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .attach-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .attach-button:hover {
            background: #f0f0f0;
        }

        /* 음성 버튼 스타일 추가 */
        .voice-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .voice-button:hover {
            background: #f0f0f0;
        }

        /* 음성 모드 화면 */
        .voice-mode-container {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 90;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .voice-mode-container.active {
            display: flex;
        }

        .voice-mode-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-mode-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .voice-assistant-avatar {
            width: 150px;
            height: 150px;
            background: white;
            border-radius: 50%;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .voice-assistant-avatar img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
        }

        .voice-assistant-avatar.listening {
            animation: pulse-listen 2s infinite;
        }

        .voice-assistant-avatar.speaking {
            animation: pulse-speak 1s infinite;
        }

        @keyframes pulse-listen {
            0% {
                box-shadow: 0 0 0 0 rgba(124, 185, 232, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(124, 185, 232, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(124, 185, 232, 0);
            }
        }

        @keyframes pulse-speak {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .voice-status-text {
            color: white;
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
            text-align: center;
            min-height: 30px;
        }

        .voice-transcript {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            max-width: 350px;
        }

        .voice-transcript-text {
            color: white;
            font-size: 16px;
            line-height: 1.5;
            text-align: center;
        }

        .voice-control-button {
            width: 80px;
            height: 80px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #667eea;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .voice-control-button:hover {
            transform: scale(1.1);
        }

        .voice-control-button:active {
            transform: scale(0.95);
        }

        .voice-control-button.recording {
            background: #ff4444;
            color: white;
            animation: pulse-record 1.5s infinite;
        }

        @keyframes pulse-record {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);
            }
        }

        .voice-wave-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            margin: 20px 0;
        }

        .voice-wave-animation.hidden {
            visibility: hidden;
        }

        .voice-wave-bar {
            width: 4px;
            height: 20px;
            background: white;
            margin: 0 3px;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .voice-wave-bar:nth-child(2) {
            animation-delay: 0.1s;
            height: 30px;
        }

        .voice-wave-bar:nth-child(3) {
            animation-delay: 0.2s;
            height: 25px;
        }

        .voice-wave-bar:nth-child(4) {
            animation-delay: 0.3s;
            height: 35px;
        }

        .voice-wave-bar:nth-child(5) {
            animation-delay: 0.4s;
            height: 20px;
        }

        @keyframes wave {
            0%, 100% {
                transform: scaleY(1);
                opacity: 0.8;
            }
            50% {
                transform: scaleY(1.5);
                opacity: 1;
            }
        }

        /* 하단 네비게이션 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/배경.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* 중앙 반원 돌출 부분 추가 */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/배경.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        /* 등급 버튼으로 변경 */
        .grade-button {
            width: 55px;
            height: 55px;
            background: transparent;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        /* 교육 모달 스타일 */
        .education-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .education-modal.active {
            display: block;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .modal-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .modal-button.confirm {
            background: #7cb9e8;
            color: white;
        }

        .modal-button.cancel {
            background: #ddd;
            color: #333;
        }

        .modal-button:hover {
            opacity: 0.8;
        }

        .modal-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 반응형 수정 */
        @media (max-width: 480px) {
            .main-content {
                padding: 10px 15px;
                width: 100%;
                max-width: none;
            }
            
            .input-area {
                padding: 10px 15px;
                max-width: none;
            }
            
            .chat-input {
                padding: 10px 14px;
                font-size: 16px;
            }
            
            .send-button,
            .attach-button,
            .voice-button {
                width: 36px;
                height: 36px;
            }
        }

        /* iOS Safe Area 대응 */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(70px + env(safe-area-inset-bottom));
            }
            
            .input-area {
                bottom: calc(70px + env(safe-area-inset-bottom));
            }
        }

        /* 에러 메시지 스타일 */
        .error-message {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* 로딩 스피너 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/레이어 1.png" alt="FINE U 로고" class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content" id="mainContent">
        <div class="page-title">AI CHATBOT</div>
        
        <!-- 채팅 영역 -->
        <div class="chat-area" id="chatArea">
            <!-- 타이핑 인디케이터 -->
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- 음성 모드 화면 -->
    <div class="voice-mode-container" id="voiceModeContainer">
        <button class="voice-mode-close" onclick="closeVoiceMode()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="voice-assistant-avatar" id="voiceAvatar">
            <img src="images/똑부리.png" alt="똑부리">
        </div>
        
        <div class="voice-status-text" id="voiceStatus">
            음성 모드가 활성화되었습니다
        </div>
        
        <div class="voice-wave-animation" id="voiceWave">
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
            <div class="voice-wave-bar"></div>
        </div>
        
        <div class="voice-transcript">
            <div class="voice-transcript-text" id="voiceTranscript">
                마이크 버튼을 누르고 말씀해주세요
            </div>
        </div>
        
        <button class="voice-control-button" id="voiceControlButton" onclick="toggleVoiceRecording()">
            <i class="fas fa-microphone" id="voiceControlIcon"></i>
        </button>
    </div>

    <!-- 입력 영역 -->
    <div class="input-area" id="inputArea">
        <div class="input-container">
            <button class="attach-button" onclick="attachFile()">
                <i class="fas fa-camera"></i>
            </button>
            <button class="voice-button" id="voiceButton" onclick="openVoiceMode()">
                <i class="fas fa-microphone"></i>
            </button>
            <input type="text" class="chat-input" placeholder="채팅을 입력하세요." id="chatInput" onkeypress="handleKeyPress(event)">
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- 교육 모달 -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeEducationModal()"></div>
    <div class="education-modal" id="educationModal">
        <div class="modal-title" id="modalTitle">관리자 인증</div>
        <div id="modalContent">
            <input type="password" class="modal-input" id="adminPassword" placeholder="비밀번호를 입력하세요">
        </div>
        <div class="modal-buttons">
            <button class="modal-button cancel" onclick="closeEducationModal()">취소</button>
            <button class="modal-button confirm" id="modalConfirmBtn" onclick="handleEducationAuth()">확인</button>
        </div>
    </div>

    <!-- 하단 네비게이션 -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/집.png" alt="홈">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/문서.png" alt="문서">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ㅇ.png" alt="YELLOW">
        </div>
        <div class="nav-item active" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/채팅.png" alt="채팅">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/더보기.png" alt="더보기">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Firebase 연결 테스트
        database.ref('.info/connected').on('value', (snapshot) => {
            const connected = snapshot.val();
            console.log('🔥 Firebase 연결 상태:', connected ? '연결됨' : '연결 끊김');
        });

        // Gemini API 설정
        const GEMINI_API_KEY = 'AIzaSyDMawZDEzBrAvAJt8ZrZxvvq2aZIRnbObk';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        // 음성 인식 관련 변수
        let recognition = null;
        let isRecording = false;
        let speechSynthesis = window.speechSynthesis;
        let isSpeaking = false;
        let isVoiceMode = false;
        let voiceModeAutoListen = true;

        // 음성 인식 초기화
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.interimResults = true;
                recognition.continuous = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    console.log('🎤 음성 인식 시작');
                    isRecording = true;
                    if (isVoiceMode) {
                        updateVoiceModeUI('listening');
                    }
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('🎤 인식된 텍스트:', transcript);
                    
                    if (isVoiceMode) {
                        document.getElementById('voiceTranscript').textContent = transcript;
                        
                        if (event.results[0].isFinal) {
                            // 음성 인식 완료 시 바로 메시지 전송
                            setTimeout(() => {
                                sendVoiceMessage(transcript);
                            }, 500);
                        }
                    } else {
                        document.getElementById('chatInput').value = transcript;
                        if (event.results[0].isFinal) {
                            setTimeout(() => {
                                sendMessage();
                            }, 500);
                        }
                    }
                };

                recognition.onerror = function(event) {
                    console.error('❌ 음성 인식 오류:', event.error);
                    if (event.error === 'no-speech') {
                        if (isVoiceMode) {
                            updateVoiceModeUI('ready');
                            document.getElementById('voiceTranscript').textContent = '음성이 감지되지 않았습니다. 다시 시도해주세요.';
                        }
                    } else if (event.error === 'not-allowed') {
                        alert('마이크 권한이 필요합니다. 브라우저 설정에서 마이크 권한을 허용해주세요.');
                    }
                    stopVoiceRecording();
                };

                recognition.onend = function() {
                    console.log('🎤 음성 인식 종료');
                    stopVoiceRecording();
                };
            } else {
                console.warn('⚠️ 이 브라우저는 음성 인식을 지원하지 않습니다.');
            }
        }

        // 음성 모드 열기
        function openVoiceMode() {
            isVoiceMode = true;
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('inputArea').classList.add('hidden');
            document.getElementById('voiceModeContainer').classList.add('active');
            
            updateVoiceModeUI('ready');
            document.getElementById('voiceTranscript').textContent = '마이크 버튼을 누르고 말씀해주세요';
            
            // 음성 모드 진입 안내
            speakText('음성 모드가 활성화되었습니다. 마이크 버튼을 누르고 말씀해주세요.');
        }

        // 음성 모드 닫기
        function closeVoiceMode() {
            isVoiceMode = false;
            voiceModeAutoListen = true;
            
            // 음성 중지
            if (isRecording) {
                stopVoiceRecording();
            }
            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            document.getElementById('voiceModeContainer').classList.remove('active');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
        }

        // 음성 모드 UI 업데이트
        function updateVoiceModeUI(status) {
            const avatar = document.getElementById('voiceAvatar');
            const statusText = document.getElementById('voiceStatus');
            const controlButton = document.getElementById('voiceControlButton');
            const controlIcon = document.getElementById('voiceControlIcon');
            const waveAnimation = document.getElementById('voiceWave');
            
            switch(status) {
                case 'listening':
                    avatar.classList.add('listening');
                    avatar.classList.remove('speaking');
                    statusText.textContent = '듣고 있습니다...';
                    controlButton.classList.add('recording');
                    controlIcon.className = 'fas fa-stop';
                    waveAnimation.classList.remove('hidden');
                    break;
                    
                case 'speaking':
                    avatar.classList.add('speaking');
                    avatar.classList.remove('listening');
                    statusText.textContent = '답변 중...';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
                    
                case 'processing':
                    avatar.classList.remove('listening', 'speaking');
                    statusText.textContent = '처리 중...';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
                    
                case 'ready':
                default:
                    avatar.classList.remove('listening', 'speaking');
                    statusText.textContent = '준비되었습니다';
                    controlButton.classList.remove('recording');
                    controlIcon.className = 'fas fa-microphone';
                    waveAnimation.classList.add('hidden');
                    break;
            }
        }

        // 음성 메시지 전송
        async function sendVoiceMessage(message) {
            if (!message || message.trim() === '') return;
            
            updateVoiceModeUI('processing');
            document.getElementById('voiceTranscript').textContent = '답변을 준비하고 있습니다...';
            
            // 채팅 영역에 메시지 추가
            addMessage(message, 'user', true);
            
            try {
                const userInfo = await getUserFinancialInfo();
                const response = await callGeminiAPI(message, userInfo);
                
                // 채팅 영역에 응답 추가
                addMessage(response, 'bot', true);
                
                // 음성 모드에서 응답 표시 및 음성 출력
                document.getElementById('voiceTranscript').textContent = response;
                updateVoiceModeUI('speaking');
                
                // 음성 출력 완료 후 자동으로 다시 듣기 모드
                speakTextWithCallback(response, () => {
                    if (isVoiceMode && voiceModeAutoListen) {
                        updateVoiceModeUI('ready');
                        document.getElementById('voiceTranscript').textContent = '마이크 버튼을 누르고 말씀해주세요';
                    }
                });
                
            } catch (error) {
                console.error('메시지 전송 실패:', error);
                const errorMessage = '죄송합니다. 일시적인 오류가 발생했습니다.';
                document.getElementById('voiceTranscript').textContent = errorMessage;
                addMessage(errorMessage, 'bot', false);
                speakText(errorMessage);
                
                setTimeout(() => {
                    if (isVoiceMode) {
                        updateVoiceModeUI('ready');
                        document.getElementById('voiceTranscript').textContent = '마이크 버튼을 누르고 말씀해주세요';
                    }
                }, 3000);
            }
        }

        // 음성 녹음 토글
        function toggleVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        // 음성 녹음 시작
        function startVoiceRecording() {
            if (!recognition) {
                initSpeechRecognition();
            }
            
            // 음성 출력 중이면 중지
            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            if (recognition) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('음성 인식 시작 실패:', error);
                    if (isVoiceMode) {
                        document.getElementById('voiceTranscript').textContent = '음성 인식을 시작할 수 없습니다.';
                    }
                }
            } else {
                alert('이 브라우저는 음성 인식을 지원하지 않습니다.');
            }
        }

        // 음성 녹음 중지
        function stopVoiceRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            isRecording = false;
            if (isVoiceMode) {
                updateVoiceModeUI('ready');
            }
        }

        undefined

        // 텍스트를 음성으로 변환
        function speakText(text) {
            console.log('🔊 speakText 호출:', text.substring(0, 30) + '...');
            speakTextWithCallback(text, null);
        }

        // 등급 시스템 설정
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW ㅁ.png', nav: 'YELLOW ㅇ', navImage: 'YELLOW ㅇ.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN ㅁ.png', nav: 'GREEN ㅇ', navImage: 'GREEN ㅇ.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE ㅁ.png', nav: 'BLUE ㅇ', navImage: 'BLUE ㅇ.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED ㅁ.png', nav: 'RED ㅇ', navImage: 'RED ㅇ.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK ㅁ.png', nav: 'BLACK ㅇ', navImage: 'BLACK ㅇ.png' }
        };

        // 사용자 정보
        let currentUser = JSON.parse(localStorage.getItem('fineu_current_user')) || {
            id: 'user_' + Date.now(),
            name: '사용자',
            level: 'yellow',
            exp: 0
        };

        // 채팅 히스토리
        let chatHistory = [];
        let isProcessing = false;

        // 교육 데이터
        let educationData = [];
        let educationMode = null;

        // 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 페이지 초기화 시작');
    initSpeechRecognition();
    
    // 음성 목록 로드 (비동기)
    if (speechSynthesis) {
        speechSynthesis.getVoices();
        speechSynthesis.onvoiceschanged = function() {
            const voices = speechSynthesis.getVoices();
            console.log('🔊 사용 가능한 음성:', voices.filter(v => v.lang.includes('ko')));
        };
    }
    
    await loadUserDataFromFirebase();
    await loadEducationDataFromFirebase();
    await loadChatHistory();
    
    // 환영 메시지와 음성을 약간 지연시켜 자동재생 차단 우회
    setTimeout(() => {
        initializeWelcomeMessage();
        
        // 사용자 상호작용 유도를 위한 클릭 이벤트 추가
        document.addEventListener('click', function enableAudio() {
            // 첫 클릭 시 음성 활성화
            const welcomeText = "안녕하세요. 저는 여러분의 슬기로운 금융 생활을 돕는 똑부리에요. 혹시 도움이 필요한 일이 있나요?";
            speakText(welcomeText);
            // 이벤트 제거
            document.removeEventListener('click', enableAudio);
        }, { once: true });
    }, 500);
});

        // Firebase에서 교육 데이터 로드
        async function loadEducationDataFromFirebase() {
            try {
                console.log('📚 교육 데이터 로드 시작...');
                const snapshot = await database.ref('educations').once('value');
                const data = snapshot.val();
                
                if (data) {
                    educationData = Object.entries(data).map(([key, value]) => ({
                        id: key,
                        ...value
                    }));
                    educationData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    console.log(`✅ ${educationData.length}개의 교육 데이터 로드 완료`);
                } else {
                    educationData = [];
                    console.log('📚 저장된 교육 데이터 없음');
                }
            } catch (error) {
                console.error('❌ 교육 데이터 로드 실패:', error);
                educationData = [];
            }
        }

        // Firebase에서 사용자 데이터 가져오기
        async function loadUserDataFromFirebase() {
            console.log('=== 사용자 데이터 로드 시작 ===');
            
            try {
                const savedUser = localStorage.getItem('fineu_current_user');
                if (!savedUser) {
                    console.log('❌ 로그인 정보 없음');
                    return;
                }
                
                currentUser = JSON.parse(savedUser);
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('👤 사용자 ID:', userId);
                
                const snapshot = await database.ref(`users/${userId}`).once('value');
                
                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    console.log('✅ Firebase 데이터 로드 성공');
                    
                    const exp = firebaseData.exp || firebaseData.experience || 0;
                    const userLevel = calculateUserLevel(exp);
                    
                    currentUser.exp = exp;
                    currentUser.level = userLevel.toLowerCase();
                    
                    updateGradeButton(currentUser.level);
                } else {
                    console.log('❌ Firebase에 데이터 없음');
                    updateGradeButton('yellow');
                }
                
            } catch (error) {
                console.error('❌ 데이터 로드 오류:', error);
                updateGradeButton('yellow');
            }
        }

        // 사용자 등급 계산
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK';
        }

        // 등급별 색상 반환
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // 등급 버튼 업데이트
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButton = document.getElementById('gradeButton');
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                
                if (gradeButton && gradeButtonImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                }
            }
        }

        // 환영 메시지 초기화
function initializeWelcomeMessage() {
    const welcomeMessage = "안녕하세요.\n저는 여러분의 슬기로운 금융 생활을 돕는 똑부리에요.\n혹시 도움이 필요한 일이 있나요?";
    addMessage(welcomeMessage, 'bot', false, true); // 마지막 파라미터를 true로 변경
}


        // 채팅 히스토리 로드
        async function loadChatHistory() {
            try {
                const snapshot = await database.ref(`chats/${currentUser.id}`).limitToLast(20).once('value');
                const data = snapshot.val();
                if (data) {
                    Object.values(data).forEach(msg => {
                        addMessage(msg.text, msg.sender, false, false); // 히스토리는 음성 출력 안함
                    });
                }
            } catch (error) {
                console.error('채팅 히스토리 로드 실패:', error);
            }
        }

        // 메시지 전송
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '' || isProcessing) return;

            // 교육 명령어 체크
            if (message === '/교육하기') {
                input.value = '';
                showEducationModal('auth');
                return;
            } else if (message === '/교육목록') {
                input.value = '';
                await showEducationList();
                return;
            } else if (message.startsWith('/교육삭제 ')) {
                const index = parseInt(message.split(' ')[1]) - 1;
                input.value = '';
                await deleteEducation(index);
                return;
            }
            
            isProcessing = true;
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            addMessage(message, 'user', true);
            input.value = '';
            
            showTypingIndicator();
            
            try {
                const userInfo = await getUserFinancialInfo();
                const response = await callGeminiAPI(message, userInfo);
                hideTypingIndicator();
                addMessage(response, 'bot', true, true); // 봇 응답은 음성 출력
                
            } catch (error) {
                console.error('메시지 전송 실패:', error);
                hideTypingIndicator();
                const errorMessage = '죄송합니다. 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                addMessage(errorMessage, 'bot', false, true); // 에러 메시지도 음성 출력
            } finally {
                isProcessing = false;
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        // 교육 모달 표시
        function showEducationModal(mode) {
            educationMode = mode;
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            
            if (mode === 'auth') {
                title.textContent = '관리자 인증';
                content.innerHTML = '<input type="password" class="modal-input" id="adminPassword" placeholder="비밀번호를 입력하세요" onkeypress="if(event.key===\'Enter\') handleEducationAuth()">';
                confirmBtn.onclick = handleEducationAuth;
                confirmBtn.disabled = false;
                confirmBtn.textContent = '확인';
            } else if (mode === 'content') {
                title.textContent = '교육 내용 입력';
                content.innerHTML = '<textarea class="modal-textarea" id="educationContent" placeholder="교육할 내용을 입력하세요\n예: 금융감독원장 이름은 이찬진입니다."></textarea>';
                confirmBtn.onclick = saveEducation;
                confirmBtn.disabled = false;
                confirmBtn.textContent = '저장';
            }
            
            modal.classList.add('active');
            overlay.classList.add('active');
            
            // 포커스 설정
            setTimeout(() => {
                if (mode === 'auth') {
                    document.getElementById('adminPassword')?.focus();
                } else if (mode === 'content') {
                    document.getElementById('educationContent')?.focus();
                }
            }, 100);
        }

        // 교육 모달 닫기
        function closeEducationModal() {
            const modal = document.getElementById('educationModal');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            overlay.classList.remove('active');
            educationMode = null;
        }

        // 관리자 인증 처리
        function handleEducationAuth() {
            const password = document.getElementById('adminPassword').value;
            if (password === '0317') {
                closeEducationModal();
                setTimeout(() => {
                    showEducationModal('content');
                }, 300);
            } else {
                alert('비밀번호가 틀렸습니다.');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // 교육 내용 저장
        async function saveEducation() {
            const content = document.getElementById('educationContent').value.trim();
            if (!content) {
                alert('교육 내용을 입력해주세요.');
                return;
            }

            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '저장 중...';

            try {
                // Firebase에 저장
                const educationRef = database.ref('educations').push();
                const educationData = {
                    content: content,
                    timestamp: Date.now(),
                    createdBy: currentUser.id || 'admin',
                    createdAt: new Date().toISOString()
                };
                
                await educationRef.set(educationData);
                
                console.log('✅ 교육 데이터 저장 성공:', educationRef.key);
                
                // 로컬 배열 업데이트
                await loadEducationDataFromFirebase();
                
                const successMessage = '✅ 교육 내용이 성공적으로 저장되었습니다.';
                addMessage(successMessage, 'system', false);
                closeEducationModal();
                
            } catch (error) {
                console.error('❌ 교육 데이터 저장 실패:', error);
                alert('저장 중 오류가 발생했습니다: ' + error.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = '저장';
            }
        }

        // 교육 목록 표시
        async function showEducationList() {
            await loadEducationDataFromFirebase();
            
            if (educationData.length === 0) {
                const emptyMessage = '📚 저장된 교육 내용이 없습니다.\n\n/교육하기 명령어로 새로운 교육 내용을 추가할 수 있습니다.';
                addMessage(emptyMessage, 'system', false);
                return;
            }
            
            let listMessage = `📚 교육 목록 (총 ${educationData.length}개)\n━━━━━━━━━━━━━━━━━━━━\n\n`;
            educationData.forEach((item, index) => {
                const date = item.createdAt ? new Date(item.createdAt).toLocaleDateString('ko-KR') : '날짜 없음';
                const preview = item.content.length > 40 ? 
                    item.content.substring(0, 40) + '...' : item.content;
                listMessage += `[${index + 1}] ${preview}\n   📅 ${date}\n\n`;
            });
            listMessage += '━━━━━━━━━━━━━━━━━━━━\n💡 삭제: /교육삭제 [번호]\n💡 추가: /교육하기';
            
            addMessage(listMessage, 'system', false);
        }

        // 교육 삭제
        async function deleteEducation(index) {
            if (index < 0 || index >= educationData.length) {
                const errorMessage = '❌ 올바른 번호를 입력해주세요. (1부터 ' + educationData.length + '까지)';
                addMessage(errorMessage, 'system', false);
                return;
            }

            const itemToDelete = educationData[index];
            
            try {
                await database.ref(`educations/${itemToDelete.id}`).remove();
                
                console.log('✅ 교육 데이터 삭제 성공:', itemToDelete.id);
                
                await loadEducationDataFromFirebase();
                
                const successMessage = `✅ 교육 내용 ${index + 1}번이 삭제되었습니다.`;
                addMessage(successMessage, 'system', false);
            } catch (error) {
                console.error('❌ 교육 데이터 삭제 실패:', error);
                const errorMessage = '❌ 삭제 중 오류가 발생했습니다: ' + error.message;
                addMessage(errorMessage, 'system', false);
            }
        }

        // 사용자 금융 정보 가져오기
        async function getUserFinancialInfo() {
            try {
                const snapshot = await database.ref(`users/${currentUser.id}/financial`).once('value');
                const data = snapshot.val() || {};
                
                await loadEducationDataFromFirebase();
                
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    portfolio: data.portfolio || [],
                    transactions: data.transactions || [],
                    learningProgress: data.learningProgress || {},
                    quizScores: data.quizScores || [],
                    educationData: educationData
                };
            } catch (error) {
                console.error('사용자 정보 로드 실패:', error);
                return {
                    level: currentUser.level || 'yellow',
                    exp: currentUser.exp || 0,
                    educationData: educationData
                };
            }
        }

        // Gemini API 호출
        async function callGeminiAPI(userMessage, userInfo) {
            const dangerousKeywords = [
                '종목 추천', '주식 추천', '코인 추천', '암호화폐 추천',
                '어떤 주식', '어떤 코인', '뭘 사야', '투자 종목',
                '수익률 보장', '확실한 수익'
            ];
            
            const isDangerous = dangerousKeywords.some(keyword => 
                userMessage.toLowerCase().includes(keyword.toLowerCase())
            );
            
            if (isDangerous) {
                return '죄송하지만 특정 투자 종목을 추천하거나 수익을 보장하는 조언은 드릴 수 없습니다. 대신 투자의 기본 원칙, 분산투자의 중요성, 리스크 관리 방법 등에 대해 알려드릴 수 있어요. 건전한 투자 습관을 기르는 것이 가장 중요합니다!';
            }

            let educationContext = '';
            if (educationData && educationData.length > 0) {
                educationContext = '\n\n=== 중요: 다음 교육 내용을 최우선으로 참고하여 답변하세요 ===\n';
                educationData.forEach((item, index) => {
                    educationContext += `[교육 ${index + 1}] ${item.content}\n`;
                });
                educationContext += '=== 교육 내용 끝 ===\n';
            }

            const systemPrompt = `당신은 '똑부리'라는 이름의 친근한 금융 교육 AI 챗봇입니다.
            
            사용자 정보:
            - 투자 레벨: ${userInfo.level}
            - 경험치: ${userInfo.exp}
            ${educationContext}
            
            역할과 지침:
            1. 위의 교육 내용을 최우선으로 참고하여 답변합니다
            2. 금융 교육을 목적으로 친근하고 이해하기 쉽게 설명합니다
            3. 사용자의 레벨에 맞는 설명을 제공합니다
            4. 구체적인 투자 종목 추천이나 투자 조언은 절대 하지 않습니다
            5. 금융의 기본 개념, 저축의 중요성, 리스크 관리 등을 강조합니다
            6. 실제 사례나 비유를 들어 쉽게 설명합니다
            7. 항상 긍정적이고 격려하는 톤을 유지합니다
            8. 답변은 2-3문단 이내로 간결하게 합니다
            9. 이모지를 적절히 사용하여 친근감을 높입니다
            10. 교육받은 내용과 관련된 질문이 있으면 해당 내용을 정확히 전달합니다
            11. 짧고 간결하게 말합니다
            12. 물어보지 않는 내용에 대해서는 답변하지 않습니다
            13. 주식 같이 변동성 있는 자산은 추천하지 않지만 적금과 같은 안전성 자산은 추천할 수 있습니다`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: `${systemPrompt}\n\n사용자 질문: ${userMessage}\n\n위 정보를 바탕으로 교육적이고 도움이 되는 답변을 제공해주세요.`
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                },
                safetySettings: [
                    {
                        category: "HARM_CATEGORY_HARASSMENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_HATE_SPEECH",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    },
                    {
                        category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                        threshold: "BLOCK_MEDIUM_AND_ABOVE"
                    }
                ]
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API 요청 실패: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                        return candidate.content.parts[0].text;
                    }
                }
                
                throw new Error('응답에서 텍스트를 찾을 수 없습니다');
                
            } catch (error) {
                console.error('❌ Gemini API 오류:', error);
                return getFallbackResponse(userMessage);
            }
        }

        // 폴백 응답 생성
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // 교육 데이터에서 관련 내용 찾기
            for (const item of educationData) {
                const keywords = item.content.toLowerCase().split(' ');
                for (const keyword of keywords) {
                    if (keyword.length > 2 && lowerMessage.includes(keyword)) {
                        return `📚 교육 내용 참고:\n\n${item.content}`;
                    }
                }
            }
            
            const keywordResponses = {
                '투자': '📈 투자는 미래를 준비하는 중요한 방법입니다!',
                '저축': '💰 저축은 금융 안정의 첫 걸음이에요!',
                '주식': '📊 주식 투자를 고려하고 계시는군요!',
                '안녕': '👋 안녕하세요! 저는 똑부리예요!'
            };
            
            for (const [keyword, response] of Object.entries(keywordResponses)) {
                if (lowerMessage.includes(keyword)) {
                    return response;
                }
            }
            
            return '🤖 금융에 대해 궁금한 점이 있으시면 언제든 물어보세요!';
        }

        // 메시지 추가 (음성 출력 파라미터 추가)
        function addMessage(text, sender, save = true, playVoice = false) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            if (sender === 'bot') {
                messageDiv.style.flexDirection = 'row';
                messageDiv.style.alignItems = 'flex-start';

                const avatarDiv = document.createElement('div');
                avatarDiv.style.cssText = `
                    width: 35px;
                    height: 35px;
                    background-image: url('images/똑부리.png');
                    background-size: cover;
                    background-position: center;
                    border-radius: 50%;
                    margin-right: 8px;
                    flex-shrink: 0;
                `;
                messageDiv.appendChild(avatarDiv);
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';

            const escapedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            bubbleDiv.innerHTML = escapedText.replace(/\n/g, '<br>');

            messageDiv.appendChild(bubbleDiv);
            
            const typingIndicator = document.getElementById('typingIndicator');
            chatArea.insertBefore(messageDiv, typingIndicator);
            
            chatArea.scrollTop = chatArea.scrollHeight;
            
            // 봇 메시지일 때 음성 출력 (음성 모드가 아닐 때만)
            if (sender === 'bot' && playVoice && !isVoiceMode) {
                console.log('🔊 봇 메시지 음성 출력 시작');
                speakText(text);
            }
            
            if (save && sender !== 'system') {
                saveChatMessage(text, sender);
            }
            
            chatHistory.push({ text, sender, timestamp: Date.now() });
            
            if (chatHistory.length > 50) {
                chatHistory = chatHistory.slice(-50);
            }
        }

        // 채팅 메시지 저장
        async function saveChatMessage(text, sender) {
            try {
                await database.ref(`chats/${currentUser.id}`).push({
                    text: text,
                    sender: sender,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (error) {
                console.error('메시지 저장 실패:', error);
            }
        }

        // 타이핑 인디케이터 표시
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.add('active');
            
            const chatArea = document.getElementById('chatArea');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 타이핑 인디케이터 숨기기
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.remove('active');
        }

        // 엔터 키 처리
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 파일 첨부
        function attachFile() {
            alert('파일 첨부 기능은 준비 중입니다.');
        }

        // 네비게이션 함수
        function goToPage(page) {
            // 음성 중지
            if (speechSynthesis && isSpeaking) {
                speechSynthesis.cancel();
            }
            if (isRecording) {
                stopVoiceRecording();
            }
            if (isVoiceMode) {
                closeVoiceMode();
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (page !== 'a4.html') {
                window.location.href = page;
            }
        }

        // 로그아웃
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                // 음성 중지
                if (speechSynthesis && isSpeaking) {
                    speechSynthesis.cancel();
                }
                if (isRecording) {
                    stopVoiceRecording();
                }
                if (isVoiceMode) {
                    closeVoiceMode();
                }
                
                localStorage.removeItem('fineu_current_user');
                window.location.href = 'index.html';
            }
        }

        // 알림
        function showNotifications() {
            alert('알림 기능은 준비 중입니다.');
        }

        // 에러 처리
        window.addEventListener('error', function(event) {
            console.error('전역 에러:', event.error);
        });

        // 네트워크 상태 체크
        window.addEventListener('online', function() {
            console.log('네트워크 연결됨');
        });

        window.addEventListener('offline', function() {
            console.log('네트워크 연결 끊김');
            const offlineMessage = '네트워크 연결이 끊겼습니다. 연결 상태를 확인해주세요.';
            addMessage(offlineMessage, 'bot', false);
        });

        // 페이지 언로드 시 음성 중지
        window.addEventListener('beforeunload', function() {
            if (speechSynthesis && isSpeaking) {
                speechSynthesis.cancel();
            }
            if (isRecording) {
                stopVoiceRecording();
            }
        });
    </script>
</body>
</html>
