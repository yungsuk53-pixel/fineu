<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - Îì±Í∏â</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Chart.js for price charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        console.log('üî• A3 Firebase Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Í≥µÌÜµ Ìó§Îçî */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        /* Îì±Í∏â Ïπ¥Îìú */
        .grade-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .grade-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .grade-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .grade-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .grade-card.locked:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .grade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .grade-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .lock-icon {
            font-size: 20px;
            color: #999;
        }

        .grade-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .grade-badge.green {
            background: #4caf50;
        }

        .grade-badge.blue {
            background: #2196f3;
        }

        .grade-badge.red {
            background: #f44336;
        }

        .grade-badge.black {
            background: #333;
        }

        .grade-description {
            font-size: 12px;
            color: #666;
        }

        /* ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/Î∞∞Í≤Ω.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* Ï§ëÏïô Î∞òÏõê ÎèåÏ∂ú Î∂ÄÎ∂Ñ Ï∂îÍ∞Ä */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/Î∞∞Í≤Ω.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .black-button {
            width: 55px;
            height: 55px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 150;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: transparent;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .black-button:hover {
            transform: scale(1.1);
        }

        /* Îì±Í∏âÎ≥Ñ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .yellow-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .green-button {
            background: linear-gradient(45deg, #32CD32, #228B22);
            color: white;
        }
        
        .blue-button {
            background: linear-gradient(45deg, #1E90FF, #0066CC);
            color: white;
        }
        
        .red-button {
            background: linear-gradient(45deg, #FF4444, #CC0000);
            color: white;
        }
        
        .black-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/Î†àÏù¥Ïñ¥ 1.png" alt="FINE U Î°úÍ≥†" class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
    <div class="main-content">
        <div class="page-title">GRADE ZONE</div>

        <!-- Í∞ÄÍ≥ÑÎ∂Ä -->
        <div class="grade-card">
            <div class="grade-header">
                <div class="grade-title">Í∞ÄÍ≥ÑÎ∂Ä</div>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge yellow">YELLOW</div>
                <div class="grade-description">Í∏∞Î≥∏ Í∏∞Îä•</div>
            </div>
        </div>

        <!-- ÏòàÍ∏à Î∞è Ï†ÅÍ∏à -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">ÏòàÍ∏à Î∞è Ï†ÅÍ∏à</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge green">GREEN</div>
                <div class="grade-description">Îì±Í∏â Îã¨ÏÑ± Ïãú Ïó¥Îûå Í∞ÄÎä•</div>
            </div>
        </div>

        <!-- Ï£ºÏãù Ìà¨Ïûê -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">Ï£ºÏãù Ìà¨Ïûê</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge blue">BLUE</div>
                <div class="grade-description">Îì±Í∏â Îã¨ÏÑ± Ïãú Ïó¥Îûå Í∞ÄÎä•</div>
            </div>
        </div>

        <!-- ÎåÄÏ∂ú -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">ÎåÄÏ∂ú</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge red">RED</div>
                <div class="grade-description">Îì±Í∏â Îã¨ÏÑ± Ïãú Ïó¥Îûå Í∞ÄÎä•</div>
            </div>
        </div>

        <!-- ÌéÄÎìú -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">ÌéÄÎìú</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge black">BLACK</div>
                <div class="grade-description">Îì±Í∏â Îã¨ÏÑ± Ïãú Ïó¥Îûå Í∞ÄÎä•</div>
            </div>
        </div>
    </div>

    <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/Ïßë.png" alt="Ìôà">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/Î¨∏ÏÑú.png" alt="Î¨∏ÏÑú">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW „Öá.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/Ï±ÑÌåÖ.png" alt="Ï±ÑÌåÖ">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ÎçîÎ≥¥Í∏∞.png" alt="ÎçîÎ≥¥Í∏∞">
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let userAssets = {};
        
        // Îì±Í∏â ÏãúÏä§ÌÖú ÏÑ§Ï†ï (a1Í≥º ÎèôÏùº)
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW „ÖÅ.png', nav: 'YELLOW „Öá', navImage: 'YELLOW „Öá.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN „ÖÅ.png', nav: 'GREEN „Öá', navImage: 'GREEN „Öá.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE „ÖÅ.png', nav: 'BLUE „Öá', navImage: 'BLUE „Öá.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED „ÖÅ.png', nav: 'RED „Öá', navImage: 'RED „Öá.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK „ÖÅ.png', nav: 'BLACK „Öá', navImage: 'BLACK „Öá.png' }
        };

        // ÏÇ¨Ïö©Ïûê Îì±Í∏â Í≥ÑÏÇ∞ (a1Í≥º ÎèôÏùº)
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK'; // ÏµúÍ≥† Îì±Í∏â
        }

        // Îì±Í∏âÎ≥Ñ ÏÉâÏÉÅ Î∞òÌôò (a1Í≥º ÎèôÏùº)
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (a4ÏôÄ ÎèôÏùºÌïòÍ≤å Ï∂îÍ∞Ä)
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButton = document.getElementById('gradeButton');
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                
                if (gradeButton && gradeButtonImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                    console.log('üéñÔ∏è A3 Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏:', upperGrade, levelData.navImage);
                }
            }
        }
        
        // Îì±Í∏âÎ≥Ñ Ïû†Í∏à Ìï¥Ï†ú Ï°∞Í±¥
        const gradeRequirements = {
            'yellow': 0,     // Í∏∞Î≥∏ Îì±Í∏â
            'green': 5000,   // 5000 EXP
            'blue': 15000,   // 15000 EXP
            'red': 30000,    // 30000 EXP
            'black': 50000   // 50000 EXP
        };

        // Îì±Í∏âÎ≥Ñ Î©îÎâ¥ Ï†ëÍ∑º Í∂åÌïú
        const menuAccess = {
            'Í∞ÄÍ≥ÑÎ∂Ä': 'yellow',
            'ÏòàÍ∏à Î∞è Ï†ÅÍ∏à': 'green', 
            'Ï£ºÏãù Ìà¨Ïûê': 'blue',
            'ÎåÄÏ∂ú': 'red',
            'ÌéÄÎìú': 'black'
        };

        // Î°úÍ∑∏Ïù∏ ÌôïÏù∏ Î∞è Ï¥àÍ∏∞Ìôî
        function checkLoginAndInit() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                console.log('‚ùå Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏóÜÏùå - index.htmlÎ°ú Ïù¥Îèô');
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            console.log('‚úÖ A3 Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê:', currentUser.id);
            
            return true;
        }

        // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (a1Í≥º ÎèôÏùº)
        async function loadUserDataFromFirebase() {
            console.log('=== A3 Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë ===');
            
            try {
                // 1. Firebase Ïó∞Í≤∞ ÌôïÏù∏
                if (!window.firebaseDB) {
                    console.log('A3 Firebase Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...');
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }
                console.log('‚úÖ A3 Firebase Ïó∞Í≤∞ ÌôïÏù∏Îê®');

                // 2. Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò§Í∏∞ ÎòêÎäî Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('üë§ A3 ÏÇ¨Ïö©Ïûê ID:', userId);
                
                // 3. FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);
                console.log('üìä A3 Îç∞Ïù¥ÌÑ∞ Ïä§ÎÉÖÏÉ∑ ÌôïÏù∏:', snapshot.exists());

                if (snapshot.exists()) {
                    // FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ
                    const firebaseData = snapshot.val();
                    console.log('‚úÖ A3 Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:', firebaseData);
                    
                    // userAssetsÏóê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {}
                    };
                    
                    console.log('‚úÖ A3 userAssets ÏÑ§Ï†ï ÏôÑÎ£å:', userAssets);
                    
                    // Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ)
                    const userLevel = calculateUserLevel(userAssets.exp);
                    updateGradeButton(userLevel);
                    
                    // Îì±Í∏âÎ≥Ñ Î©îÎâ¥ ÏóÖÎç∞Ïù¥Ìä∏
                    updateMenuAccess();
                    
                } else {
                    // FirebaseÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï (Í∞ÄÏÉÅ Ìà¨Ïûê Í∏àÏï° Ï†úÍ±∞)
                    console.log('‚ùå A3 FirebaseÏóê Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå - Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Îßå ÏÑ§Ï†ï');
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 0, // Í∞ÄÏÉÅ Ìà¨Ïûê Í∏àÏï° Ï†úÍ±∞
                        totalAssets: 0,
                        virtualBalance: 0,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {}
                    };
                    
                    // Í∏∞Î≥∏ Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ)
                    updateGradeButton('YELLOW');
                    updateMenuAccess();
                }
                
                // 5. localStorageÏóê Î∞±ÏóÖ Ï†ÄÏû•
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                console.log('‚úÖ A3 localStorage Î∞±ÏóÖ ÏôÑÎ£å');

            } catch (error) {
                console.error('‚ùå A3 Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî (Í∞ÄÏÉÅ Ìà¨Ïûê Í∏àÏï° Ï†úÍ±∞)
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 0, // Í∞ÄÏÉÅ Ìà¨Ïûê Í∏àÏï° Ï†úÍ±∞
                    level: 'yellow',
                    exp: 0,
                    experience: 0
                };
                
                // Ïò§Î•ò Ïãú Í∏∞Î≥∏ Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ)
                updateGradeButton('YELLOW');
                updateMenuAccess();
            }
        }

        // ÏÇ¨Ïö©Ïûê Îì±Í∏â Î°úÎìú Î∞è ÌëúÏãú
        async function loadUserGrade() {
            try {
                if (!window.firebaseDB || !currentUser) {
                    console.log('üî• Firebase ÎòêÎäî ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÎåÄÍ∏∞ Ï§ë...');
                    setTimeout(loadUserGrade, 500);
                    return;
                }
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}`);
                const snapshot = await window.firebaseGet(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const experience = userData.experience || 0;
                    const grade = calculateUserGrade(experience);
                    
                    // Îì±Í∏â Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ)
                    updateGradeButton(grade.toUpperCase());
                    
                    // userAssets ÏóÖÎç∞Ïù¥Ìä∏
                    userAssets.exp = experience;
                }
            } catch (error) {
                console.error('A3 Îì±Í∏â Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // Îì±Í∏âÎ≥Ñ Î©îÎâ¥ Ï†ëÍ∑º Í∂åÌïú ÏóÖÎç∞Ïù¥Ìä∏
        function updateMenuAccess() {
            const userExp = userAssets.exp || userAssets.experience || 0;
            const userLevel = calculateUserLevel(userExp).toLowerCase();
            
            console.log('üîí A3 Î©îÎâ¥ Ï†ëÍ∑º Í∂åÌïú ÏóÖÎç∞Ïù¥Ìä∏:', userLevel, userExp);
            
            // Í∞Å Î©îÎâ¥ Ïπ¥ÎìúÏùò Ïû†Í∏à ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            Object.entries(menuAccess).forEach(([menuName, requiredLevel]) => {
                const requiredExp = gradeRequirements[requiredLevel];
                const isUnlocked = userExp >= requiredExp;
                
                // Ïπ¥Îìú Ï∞æÍ∏∞ (Îã§ÏñëÌïú Î∞©Î≤ïÏúºÎ°ú ÏãúÎèÑ)
                let card = null;
                // Ï†úÎ™©ÏúºÎ°ú Ïπ¥Îìú Ï∞æÍ∏∞ (Í∞ÄÍ≥ÑÎ∂Ä Ìè¨Ìï®)
                const cards = document.querySelectorAll('.grade-card');
                cards.forEach(c => {
                    const titleElement = c.querySelector('.grade-title') || c.querySelector('h3');
                    if (titleElement && titleElement.textContent === menuName) {
                        card = c;
                    }
                });
                
                if (card) {
                    if (isUnlocked) {
                        // Ïû†Í∏à Ìï¥Ï†ú
                        card.classList.remove('locked');
                        const lockIcon = card.querySelector('.lock-icon');
                        if (lockIcon) lockIcon.style.display = 'none';
                        
                        // Îì±Í∏â Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
                        const badge = card.querySelector('.grade-badge');
                        if (badge) {
                            badge.className = `grade-badge ${requiredLevel}`;
                            badge.textContent = requiredLevel.toUpperCase();
                        }
                        
                        console.log(`‚úÖ ${menuName} Ïû†Í∏à Ìï¥Ï†ú (${userExp} >= ${requiredExp})`);
                    } else {
                        // Ïû†Í∏à ÏÉÅÌÉú Ïú†ÏßÄ
                        card.classList.add('locked');
                        
                        // Ïû†Í∏à ÏïÑÏù¥ÏΩò Ï∂îÍ∞Ä/ÌëúÏãú
                        let lockIcon = card.querySelector('.lock-icon');
                        if (!lockIcon) {
                            lockIcon = document.createElement('div');
                            lockIcon.className = 'lock-icon';
                            lockIcon.innerHTML = 'üîí';
                            lockIcon.style.cssText = `
                                position: absolute;
                                top: 10px;
                                right: 10px;
                                font-size: 20px;
                                background: rgba(255,255,255,0.9);
                                border-radius: 50%;
                                width: 35px;
                                height: 35px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                            `;
                            card.style.position = 'relative';
                            card.appendChild(lockIcon);
                        }
                        lockIcon.style.display = 'flex';
                        
                        // Îì±Í∏â Î∞∞ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ (ÌïÑÏöî Îì±Í∏â ÌëúÏãú)
                        const badge = card.querySelector('.grade-badge');
                        if (badge) {
                            badge.className = `grade-badge ${requiredLevel} locked`;
                            badge.textContent = `${requiredLevel.toUpperCase()} ÌïÑÏöî`;
                            badge.style.opacity = '0.6';
                        }
                        
                        console.log(`üîí ${menuName} Ïû†Í∏à ÏÉÅÌÉú (${userExp} < ${requiredExp})`);
                    }
                }
            });
        }

        // ÏÇ¨Ïö©Ïûê Îì±Í∏â Í≥ÑÏÇ∞ (Ìò∏ÌôòÏÑ±)
        function calculateUserGrade(exp) {
            return calculateUserLevel(exp).toLowerCase();
        }

        // Î©îÎâ¥ Ï†ëÍ∑º Í∂åÌïú ÌôïÏù∏
        function canAccessMenu(menuName) {
            const userExp = userAssets.exp || 0;
            const userGrade = calculateUserGrade(userExp);
            const requiredGrade = menuAccess[menuName];
            
            const gradeOrder = ['yellow', 'green', 'blue', 'red', 'black'];
            const userGradeIndex = gradeOrder.indexOf(userGrade);
            const requiredGradeIndex = gradeOrder.indexOf(requiredGrade);
            
            return userGradeIndex >= requiredGradeIndex;
        }

        // Îì±Í∏â Ïπ¥Îìú ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        function handleGradeClick(menuName) {
            const userExp = userAssets.exp || userAssets.experience || 0;
            const userLevel = calculateUserLevel(userExp).toLowerCase();
            
            // Í∞ÄÍ≥ÑÎ∂ÄÎäî Ìï≠ÏÉÅ Ï†ëÍ∑º Í∞ÄÎä•
            if (menuName === 'Í∞ÄÍ≥ÑÎ∂Ä') {
                openMenuContent(menuName);
                return;
            }
            
            if (!canAccessMenu(menuName)) {
                const requiredLevel = menuAccess[menuName];
                const requiredExp = gradeRequirements[requiredLevel];
                const remainingExp = requiredExp - userExp;
                
                // Îçî ÏπúÍ∑ºÌïú Î©îÏãúÏßÄÎ°ú Í∞úÏÑ†
                const levelNames = {
                    'green': 'GREEN Í∑∏Î¶∞',
                    'blue': 'BLUE Î∏îÎ£®',
                    'red': 'RED Î†àÎìú',
                    'black': 'BLACK Î∏îÎûô'
                };
                
                const message = `üîí ${menuName} Í∏∞Îä• Ïû†Í∏àÎê®\n\n` +
                    `üìä ÌòÑÏû¨ Îì±Í∏â: ${userLevel.toUpperCase()} (${userExp.toLocaleString()} EXP)\n` +
                    `üéØ ÌïÑÏöî Îì±Í∏â: ${levelNames[requiredLevel] || requiredLevel.toUpperCase()}\n` +
                    `‚≠ê ÌïÑÏöî Í≤ΩÌóòÏπò: ${remainingExp.toLocaleString()} EXP Îçî ÌïÑÏöî\n\n` +
                    `üí° ÌåÅ: ÌïôÏäµ ÌôúÎèôÍ≥º Ìà¨Ïûê Ïã§ÏäµÏùÑ ÌÜµÌï¥ Í≤ΩÌóòÏπòÎ•º ÏåìÏïÑÎ≥¥ÏÑ∏Ïöî!`;
                
                alert(message);
                return;
            }
            
            // Ìï¥Îãπ Î©îÎâ¥ ÏΩòÌÖêÏ∏† Ïó¥Í∏∞
            openMenuContent(menuName);
        }

        // Î©îÎâ¥ ÏΩòÌÖêÏ∏† Ïó¥Í∏∞
        function openMenuContent(menuName) {
            const modal = createModal(menuName);
            document.body.appendChild(modal);
            
            // Î©îÎâ¥Î≥Ñ ÏΩòÌÖêÏ∏† Î°úÎìú
            switch(menuName) {
                case 'Í∞ÄÍ≥ÑÎ∂Ä':
                    loadAccountBook(modal);
                    break;
                case 'ÏòàÍ∏à Î∞è Ï†ÅÍ∏à':
                    loadSavingsProducts(modal);
                    break;
                case 'Ï£ºÏãù Ìà¨Ïûê':
                    loadStockMarket(modal);
                    break;
                case 'ÎåÄÏ∂ú':
                    loadLoanProducts(modal);
                    break;
                case 'ÌéÄÎìú':
                    loadETFAndFunds(modal);
                    break;
                default:
                    const modalBody = modal.querySelector('.modal-body');
                    modalBody.innerHTML = `
                        <div class="item-card">
                            <div class="item-desc">${menuName} Í∏∞Îä•Ïù¥ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.</div>
                        </div>
                    `;
            }
        }

        // Î™®Îã¨ ÏÉùÏÑ±
        function createModal(title) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body" id="modal-body">
                        <div class="loading">ÏΩòÌÖêÏ∏†Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                    </div>
                </div>
            `;
            
            // Î™®Îã¨ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
            if (!document.getElementById('modal-styles')) {
                const style = document.createElement('style');
                style.id = 'modal-styles';
                style.textContent = `
                    .modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    }
                    .modal-content {
                        background: white;
                        border-radius: 16px;
                        width: 90%;
                        max-width: 500px;
                        max-height: 80%;
                        overflow-y: auto;
                    }
                    .modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #eee;
                    }
                    .modal-header h2 {
                        margin: 0;
                        font-size: 20px;
                        color: #333;
                    }
                    .close-btn {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                    }
                    .modal-body {
                        padding: 20px;
                        max-height: 60vh;
                        overflow-y: auto;
                    }
                    .loading {
                        text-align: center;
                        padding: 40px;
                        color: #666;
                    }
                    .item-card {
                        background: #f8f9fa;
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 10px;
                        border: 1px solid #eee;
                    }
                    .item-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                    }
                    .item-title {
                        font-weight: bold;
                        color: #333;
                    }
                    .item-price {
                        font-weight: bold;
                        color: #007bff;
                    }
                    .item-desc {
                        font-size: 14px;
                        color: #666;
                        line-height: 1.4;
                    }
                    .btn-primary {
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                    }
                    .btn-primary:hover {
                        background: #0056b3;
                    }
                    .stock-card {
                        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 10px;
                        cursor: pointer;
                    }
                    .stock-card.positive {
                        background: linear-gradient(135deg, #ffecee 0%, #ffd6d6 100%);
                    }
                    .stock-card.negative {
                        background: linear-gradient(135deg, #e8f4fd 0%, #d6eaff 100%);
                    }
                    .stock-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: start;
                        margin-bottom: 10px;
                    }
                    .stock-symbol {
                        font-weight: bold;
                        font-size: 16px;
                    }
                    .stock-price {
                        font-size: 18px;
                        font-weight: bold;
                    }
                    .stock-change {
                        font-size: 14px;
                        font-weight: 500;
                    }
                    .positive .stock-price,
                    .positive .stock-change {
                        color: #d32f2f;
                    }
                    .negative .stock-price,
                    .negative .stock-change {
                        color: #1976d2;
                    }
                    .account-input {
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        margin-bottom: 10px;
                    }
                    .account-form {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 15px;
                    }
                    
                    /* Ï∞®Ìä∏ Î™®Îã¨ Ïä§ÌÉÄÏùº */
                    .chart-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 2000;
                    }
                    .chart-content {
                        background: white;
                        border-radius: 20px;
                        width: 95%;
                        max-width: 600px;
                        max-height: 90%;
                        overflow-y: auto;
                    }
                    .chart-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 2px solid #f0f0f0;
                    }
                    .asset-info {
                        display: flex;
                        flex-direction: column;
                    }
                    .asset-name {
                        font-size: 22px;
                        font-weight: bold;
                        color: #333;
                    }
                    .asset-symbol {
                        font-size: 14px;
                        color: #666;
                        margin-top: 2px;
                    }
                    .current-price {
                        font-size: 24px;
                        font-weight: bold;
                        text-align: right;
                    }
                    .price-change {
                        font-size: 16px;
                        text-align: right;
                        margin-top: 4px;
                    }
                    .chart-body {
                        padding: 20px;
                    }
                    .chart-container {
                        position: relative;
                        height: 300px;
                        margin-bottom: 20px;
                    }
                    .trading-buttons {
                        display: flex;
                        gap: 10px;
                        margin-top: 20px;
                    }
                    .buy-btn {
                        flex: 1;
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 15px;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                    }
                    .sell-btn {
                        flex: 1;
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 15px;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                    }
                    .holdings-info {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 10px;
                        margin-top: 15px;
                    }
                    .holdings-title {
                        font-weight: bold;
                        margin-bottom: 10px;
                        color: #333;
                    }
                    .holdings-details {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 5px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            return modal;
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeModal(btn) {
            const modal = btn.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // ===== Ìà¨Ïûê ÏûêÏÇ∞ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú =====
        
        // FirebaseÏóê ÏÇ¨Ïö©Ïûê Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï†ÄÏû•
        async function saveUserPortfolio() {
            try {
                console.log('üíæ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï†ÄÏû• ÏãúÏûë');
                console.log('üîç Firebase DB:', !!window.firebaseDB);
                console.log('üë§ User ID:', userAssets.id);
                console.log('üìä Portfolio Data:', userAssets.portfolio);
                
                if (!window.firebaseDB) {
                    console.error('‚ùå Firebase DBÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');
                    alert('Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                if (!userAssets.id) {
                    console.error('‚ùå ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÏóÜÏäµÎãàÎã§');
                    alert('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                const updateData = {
                    portfolio: userAssets.portfolio || {},
                    cash: userAssets.cash || 0,
                    totalAssets: userAssets.totalAssets || 0,
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('üìù ÏóÖÎç∞Ïù¥Ìä∏Ìï† Îç∞Ïù¥ÌÑ∞:', updateData);
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userAssets.id}`);
                await window.firebaseUpdate(userRef, updateData);
                
                console.log('‚úÖ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Firebase Ï†ÄÏû• ÏôÑÎ£å');
                
                // localStorageÏóêÎèÑ Î∞±ÏóÖ Ï†ÄÏû•
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                console.log('‚úÖ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ localStorage Î∞±ÏóÖ ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Ìà¨Ïûê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
                
                // Ïã§Ìå®Ïãú localStorageÏóêÎùºÎèÑ Ï†ÄÏû•
                try {
                    localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                    console.log('‚ö†Ô∏è Firebase Ïã§Ìå®, localStorageÏóêÎßå Ï†ÄÏû•Îê®');
                } catch (localError) {
                    console.error('‚ùå localStorage Ï†ÄÏû•ÎèÑ Ïã§Ìå®:', localError);
                }
            }
        }

        // Ìà¨Ïûê ÏûêÏÇ∞ Íµ¨Îß§/ÌåêÎß§ Ï≤òÎ¶¨
        async function processTransaction(symbol, name, price, quantity, type, assetType = 'stock', currency = 'KRW') {
            try {
                console.log('üí∞ Í±∞Îûò Ï≤òÎ¶¨ ÏãúÏûë:', {symbol, name, price, quantity, type, assetType, currency});
                
                const totalAmount = price * Math.abs(quantity);
                const isUSD = currency === 'USD';
                
                if (!userAssets.portfolio) {
                    userAssets.portfolio = {};
                }
                
                if (!userAssets.portfolio[symbol]) {
                    userAssets.portfolio[symbol] = {
                        name: name,
                        symbol: symbol,
                        type: assetType,
                        currency: currency,
                        quantity: 0,
                        avgPrice: 0,
                        totalInvested: 0,
                        currentPrice: price // ÌòÑÏû¨ Í∞ÄÍ≤© Ï†ÄÏû•
                    };
                }
                
                const holding = userAssets.portfolio[symbol];
                
                // ÌÜµÌôî Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                holding.currency = currency;
                holding.currentPrice = price; // ÌòÑÏû¨ Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
                
                if (type === 'buy') {
                    // Îß§Ïàò Ï≤òÎ¶¨
                    if (userAssets.cash < totalAmount) {
                        alert('Î≥¥Ïú† ÌòÑÍ∏àÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
                        return false;
                    }
                    
                    const newTotalQuantity = holding.quantity + quantity;
                    const newTotalInvested = holding.totalInvested + totalAmount;
                    
                    holding.avgPrice = newTotalInvested / newTotalQuantity;
                    holding.quantity = newTotalQuantity;
                    holding.totalInvested = newTotalInvested;
                    
                    userAssets.cash -= totalAmount;
                    
                    const amountDisplay = formatPrice(totalAmount, currency, isUSD ? 2 : 0);
                    console.log('‚úÖ Îß§Ïàò ÏôÑÎ£å:', {symbol, quantity, totalAmount});
                    alert(`${name} ${quantity}${assetType === 'fund' ? 'Ï¢å' : 'Ï£º'}Î•º ${amountDisplay}Ïóê Îß§ÏàòÌñàÏäµÎãàÎã§.`);
                    
                } else if (type === 'sell') {
                    // Îß§ÎèÑ Ï≤òÎ¶¨
                    if (holding.quantity < quantity) {
                        alert('Î≥¥Ïú† ÏàòÎüâÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
                        return false;
                    }
                    
                    holding.quantity -= quantity;
                    holding.totalInvested -= (holding.avgPrice * quantity);
                    userAssets.cash += totalAmount;
                    
                    // Î™®Îì† Ï£ºÏãùÏùÑ Îß§ÎèÑÌïú Í≤ΩÏö∞ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ÏóêÏÑú Ï†úÍ±∞
                    if (holding.quantity === 0) {
                        delete userAssets.portfolio[symbol];
                    }
                    
                    const amountDisplay = formatPrice(totalAmount, currency, isUSD ? 2 : 0);
                    console.log('‚úÖ Îß§ÎèÑ ÏôÑÎ£å:', {symbol, quantity, totalAmount});
                    alert(`${name} ${quantity}${assetType === 'fund' ? 'Ï¢å' : 'Ï£º'}Î•º ${amountDisplay}Ïóê Îß§ÎèÑÌñàÏäµÎãàÎã§.`);
                }
                
                console.log('üíæ Firebase Ï†ÄÏû• ÏãúÎèÑ...');
                // Ï†ÑÏ≤¥ ÏûêÏÇ∞ Ïû¨Í≥ÑÏÇ∞
                updateTotalAssets();
                
                // FirebaseÏóê Ï†ÄÏû•
                await saveUserPortfolio();
                
                console.log('üéØ Í±∞Îûò Ï≤òÎ¶¨ ÏôÑÏ†Ñ ÏôÑÎ£å');
                return true;
                
            } catch (error) {
                console.error('‚ùå Í±∞Îûò Ï≤òÎ¶¨ Ïã§Ìå®:', error);
                alert('Í±∞Îûò Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                return false;
            }
        }

        // Ï†ÑÏ≤¥ ÏûêÏÇ∞ Ïû¨Í≥ÑÏÇ∞ (Îã§ÏñëÌïú ÏûêÏÇ∞ Ïú†Ìòï ÏßÄÏõê)
        function updateTotalAssets() {
            try {
                let totalPortfolioValue = 0;
                
                if (userAssets.portfolio) {
                    Object.values(userAssets.portfolio).forEach(holding => {
                        const assetType = holding.type || 'stock';
                        let assetValue = 0;
                        
                        if (assetType === 'stock' || assetType === 'fund') {
                            // Ï£ºÏãù/ÌéÄÎìú: ÏàòÎüâ √ó ÌòÑÏû¨Í∞Ä
                            const currentPrice = holding.currentPrice || holding.price || holding.avgPrice || 0;
                            assetValue = (holding.quantity || 0) * currentPrice;
                        } else if (assetType === 'savings') {
                            // ÏòàÏ†ÅÍ∏à: Ìà¨Ïûê Í∏àÏï° Í∑∏ÎåÄÎ°ú
                            assetValue = holding.avgPrice || 0;
                        } else if (assetType === 'loan') {
                            // ÎåÄÏ∂ú: Î∂ÄÏ±ÑÏù¥ÎØÄÎ°ú ÏùåÏàòÎ°ú Í≥ÑÏÇ∞
                            assetValue = -(holding.avgPrice || 0);
                        }
                        
                        totalPortfolioValue += assetValue;
                    });
                }
                
                userAssets.totalAssets = userAssets.cash + totalPortfolioValue;
                userAssets.virtualBalance = userAssets.totalAssets; // Í∞ÄÏÉÅ ÏûîÍ≥†ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                
                console.log('üìä Ï†ÑÏ≤¥ ÏûêÏÇ∞ ÏóÖÎç∞Ïù¥Ìä∏ (Îã§ÏñëÌïú ÏûêÏÇ∞ Ïú†Ìòï):', {
                    cash: userAssets.cash,
                    portfolioValue: totalPortfolioValue,
                    totalAssets: userAssets.totalAssets
                });
            } catch (error) {
                console.error('Ï†ÑÏ≤¥ ÏûêÏÇ∞ Í≥ÑÏÇ∞ Ïò§Î•ò:', error);
            }
        }

        // ÎèôÏ†Å Í∞ÄÍ≤© ÏÉùÏÑ± (Ïã§ÏãúÍ∞Ñ Î≥ÄÎèô)
        function generateDynamicPrice(basePrice, volatility = 0.02) {
            const change = (Math.random() - 0.5) * 2 * volatility;
            return Math.round(basePrice * (1 + change));
        }

        // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (30ÏùºÍ∞ÑÏùò Í∞ÄÍ≤© Î≥ÄÎèô)
        function generateChartData(currentPrice, days = 30) {
            const data = [];
            const labels = [];
            let price = currentPrice * 0.9; // ÏãúÏûëÍ∞ÄÎ•º ÌòÑÏû¨Í∞ÄÏùò 90%Î°ú ÏÑ§Ï†ï
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }));
                
                // ÎûúÎç§Ìïú Í∞ÄÍ≤© Î≥ÄÎèô ÏÉùÏÑ±
                const change = (Math.random() - 0.5) * 0.04; // ¬±2% Î≥ÄÎèô
                price = Math.max(price * (1 + change), currentPrice * 0.7); // ÏµúÏÜå 70%
                data.push(Math.round(price));
            }
            
            // ÎßàÏßÄÎßâ Í∞ÄÍ≤©ÏùÑ ÌòÑÏû¨Í∞ÄÎ°ú Ï°∞Ï†ï
            data[data.length - 1] = currentPrice;
            
            return { labels, data };
        }

        // Ï∞®Ìä∏ Î™®Îã¨ ÏÉùÏÑ± Î∞è ÌëúÏãú (Ïã§Ï†ú API Í∞ÄÍ≤© ÏÇ¨Ïö©)
        async function showAssetChart(symbol, name, passedPrice, assetType = 'stock', currency = 'KRW') {
            console.log(`üìä ${name} Ï∞®Ìä∏ Î™®Îã¨ Ïó¥Í∏∞ - Ï†ÑÎã¨Î∞õÏùÄ Í∞ÄÍ≤©: ${passedPrice}`);
            
            // Ïã§Ï†ú ÏµúÏã† Í∞ÄÍ≤© Îã§Ïãú Ï°∞Ìöå (Ï†ïÌôïÏÑ±ÏùÑ ÏúÑÌï¥)
            let currentPrice = passedPrice;
            try {
                let yahooSymbol = symbol;
                
                // ETF/ÌéÄÎìúÏùò Í≤ΩÏö∞ Yahoo Finance Ïã¨Î≥º Ï≤òÎ¶¨
                if (assetType === 'fund') {
                    // ÌïúÍµ≠ ETFÎäî Ï¢ÖÎ™©ÏΩîÎìú.KS ÎòêÎäî .KQ ÌòïÏãù
                    const etfSymbolMap = {
                        'KODEX_200': '069500.KS',
                        'TIGER_200': '102110.KS',
                        'KODEX_ÏΩîÏä§Îã•150': '229200.KS',
                        'TIGER_ÎÇòÏä§Îã•100': '133690.KS',
                        'KODEX_ÎØ∏Íµ≠S&P500': '360750.KS',
                        'TIGER_Ï∞®Ïù¥ÎÇòÏ†ÑÍ∏∞Ï∞®SOLACTIVE': '371460.KS',
                        'KODEX_2Ï∞®Ï†ÑÏßÄÏÇ∞ÏóÖ': '305720.KS',
                        'TIGER_Î∞òÎèÑÏ≤¥': '091230.KS',
                        'KODEX_Í≥®ÎìúÏÑ†Î¨º': '132030.KS',
                        'TIGER_ÏõêÏú†ÏÑ†Î¨ºEnhanced': '130680.KS',
                        'KODEX_Ïù∏Î≤ÑÏä§': '114800.KS',
                        'TIGER_ÎØ∏Íµ≠Ï±Ñ10ÎÖÑÏÑ†Î¨º': '305080.KS'
                    };
                    
                    yahooSymbol = etfSymbolMap[symbol] || symbol;
                    
                    // .KSÍ∞Ä ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä
                    if (!yahooSymbol.includes('.')) {
                        yahooSymbol += '.KS';
                    }
                } else if (!yahooSymbol.includes('.')) {
                    yahooSymbol += '.KS';
                }
                
                const latestData = await getYahooStockPrice(yahooSymbol);
                if (latestData && latestData.price) {
                    currentPrice = latestData.price;
                    currency = latestData.currency || currency;
                    console.log(`‚úÖ ${name} ÏµúÏã† Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏: ${currentPrice} ${currency}`);
                } else {
                    console.log(`‚ö†Ô∏è ${name} ÏµúÏã† Í∞ÄÍ≤© Ï°∞Ìöå Ïã§Ìå®, Ï†ÑÎã¨Î∞õÏùÄ Í∞ÄÍ≤© ÏÇ¨Ïö©: ${currentPrice}`);
                }
            } catch (error) {
                console.log(`‚ùå ${name} ÏµúÏã† Í∞ÄÍ≤© Ï°∞Ìöå Ïã§Ìå®: ${error.message}`);
            }
            
            const chartModal = document.createElement('div');
            chartModal.className = 'chart-modal';
            
            const { labels, data } = generateChartData(currentPrice);
            const previousPrice = data[data.length - 2];
            const priceChange = currentPrice - previousPrice;
            const priceChangePercent = (priceChange / previousPrice * 100).toFixed(2);
            const isPositive = priceChange >= 0;
            
            // ÌÜµÌôîÎ≥Ñ Í∞ÄÍ≤© ÌëúÏãú
            const isUSD = currency === 'USD';
            const priceDisplay = isUSD ? formatPrice(currentPrice, 'USD') : formatPrice(currentPrice, 'KRW', 0);
            const changeDisplay = isUSD ? formatPrice(Math.abs(priceChange), 'USD') : formatPrice(Math.abs(priceChange), 'KRW', 0);
            
            // Î≥¥Ïú† ÏàòÎüâ ÌôïÏù∏
            const holding = userAssets.portfolio && userAssets.portfolio[symbol] 
                ? userAssets.portfolio[symbol] 
                : { quantity: 0, avgPrice: 0, totalInvested: 0, currency: currency };
            
            // ÏûêÏÇ∞ Ïú†ÌòïÎ≥Ñ Îã®ÏúÑ ÏÑ§Ï†ï
            const unitText = assetType === 'fund' ? 'Ï¢å' : 'Ï£º';
            
            chartModal.innerHTML = `
                <div class="chart-content">
                    <div class="chart-header">
                        <div class="asset-info">
                            <div class="asset-name">${name}</div>
                            <div class="asset-symbol">${symbol} ${assetType === 'fund' ? '(ETF/ÌéÄÎìú)' : ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="current-price" style="color: ${isPositive ? '#dc3545' : '#007bff'}">
                                ${priceDisplay}
                            </div>
                            <div class="price-change" style="color: ${isPositive ? '#dc3545' : '#007bff'}">
                                ${isPositive ? '+' : ''}${changeDisplay} (${isPositive ? '+' : ''}${priceChangePercent}%)
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.chart-modal').remove()" style="margin-left: 15px;">&times;</button>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                        
                        ${holding.quantity > 0 ? `
                        <div class="holdings-info">
                            <div class="holdings-title">Î≥¥Ïú† ÌòÑÌô©</div>
                            <div class="holdings-details">
                                <span>Î≥¥Ïú†ÏàòÎüâ:</span>
                                <span>${holding.quantity.toLocaleString()}${unitText}</span>
                            </div>
                            <div class="holdings-details">
                                <span>ÌèâÍ∑†Îã®Í∞Ä:</span>
                                <span>${formatPrice(holding.avgPrice, currency, isUSD ? 2 : 0)}</span>
                            </div>
                            <div class="holdings-details">
                                <span>Ìà¨ÏûêÍ∏àÏï°:</span>
                                <span>${formatPrice(holding.totalInvested, currency, isUSD ? 2 : 0)}</span>
                            </div>
                            <div class="holdings-details">
                                <span>ÌèâÍ∞ÄÍ∏àÏï°:</span>
                                <span>${formatPrice(holding.quantity * currentPrice, currency, isUSD ? 2 : 0)}</span>
                            </div>
                            <div class="holdings-details">
                                <span>ÏÜêÏùµ:</span>
                                <span style="color: ${(holding.quantity * currentPrice - holding.totalInvested) >= 0 ? '#dc3545' : '#007bff'}">
                                    ${formatPrice((holding.quantity * currentPrice - holding.totalInvested), currency, isUSD ? 2 : 0)}
                                    (${(((holding.quantity * currentPrice - holding.totalInvested) / holding.totalInvested * 100)).toFixed(2)}%)
                                </span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="trading-buttons">
                            <button class="buy-btn" onclick="showTradeModal('${symbol}', '${name}', ${currentPrice}, 'buy', '${assetType}', '${currency}')">
                                Îß§Ïàò
                            </button>
                            <button class="sell-btn" onclick="showTradeModal('${symbol}', '${name}', ${currentPrice}, 'sell', '${assetType}', '${currency}')" 
                                    ${holding.quantity === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                Îß§ÎèÑ
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                            üí∞ Î≥¥Ïú† ÌòÑÍ∏à: ${userAssets.cash.toLocaleString()}Ïõê
                            ${isUSD ? `<br>üíµ ÏïΩ ${formatPrice(convertCurrency(userAssets.cash, 'KRW', 'USD'), 'USD')}` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(chartModal);
            
            // Ï∞®Ìä∏ ÏÉùÏÑ±
            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Í∞ÄÍ≤©',
                        data: data,
                        borderColor: isPositive ? '#dc3545' : '#007bff',
                        backgroundColor: isPositive ? 'rgba(220, 53, 69, 0.1)' : 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'Ïõê';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Í±∞Îûò Î™®Îã¨ ÌëúÏãú
        function showTradeModal(symbol, name, price, type, assetType = 'stock', currency = 'KRW') {
            const isBuy = type === 'buy';
            const isUSD = currency === 'USD';
            const holding = userAssets.portfolio && userAssets.portfolio[symbol] 
                ? userAssets.portfolio[symbol] 
                : { quantity: 0 };
            
            const maxQuantity = isBuy 
                ? Math.floor(userAssets.cash / price)
                : holding.quantity;
            
            if (maxQuantity === 0) {
                alert(isBuy ? 'Î≥¥Ïú† ÌòÑÍ∏àÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.' : 'Î≥¥Ïú† ÏàòÎüâÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const priceDisplay = formatPrice(price, currency, isUSD ? 2 : 0);
            const cashDisplay = userAssets.cash.toLocaleString() + 'Ïõê';
            const usdCashDisplay = isUSD ? ` (ÏïΩ ${formatPrice(convertCurrency(userAssets.cash, 'KRW', 'USD'), 'USD')})` : '';
            const unitText = assetType === 'fund' ? 'Ï¢å' : 'Ï£º';
            
            const quantity = prompt(
                `${name} ${isBuy ? 'Îß§Ïàò' : 'Îß§ÎèÑ'}\n` +
                `ÌòÑÏû¨Í∞Ä: ${priceDisplay}\n` +
                `${isBuy ? 'Î≥¥Ïú† ÌòÑÍ∏à' : 'Î≥¥Ïú† ÏàòÎüâ'}: ${isBuy ? cashDisplay + usdCashDisplay : holding.quantity + unitText}\n` +
                `ÏµúÎåÄ ${isBuy ? 'Îß§Ïàò' : 'Îß§ÎèÑ'} Í∞ÄÎä•: ${maxQuantity}${unitText}\n\n` +
                `${isBuy ? 'Îß§Ïàò' : 'Îß§ÎèÑ'}Ìï† ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:`
            );
            
            if (quantity && parseInt(quantity) > 0 && parseInt(quantity) <= maxQuantity) {
                processTransaction(symbol, name, price, parseInt(quantity), type, assetType, currency);
                
                // Ï∞®Ìä∏ Î™®Îã¨ Îã´Í∏∞ Î∞è Îã§Ïãú Ïó¥Í∏∞ (ÏóÖÎç∞Ïù¥Ìä∏Îêú Ï†ïÎ≥¥ ÌëúÏãú)
                const chartModal = document.querySelector('.chart-modal');
                if (chartModal) {
                    chartModal.remove();
                    setTimeout(() => {
                        showAssetChart(symbol, name, price, assetType, currency);
                    }, 100);
                }
            } else if (quantity) {
                alert('Ïò¨Î∞îÎ•∏ ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // 1. Í∞ÄÍ≥ÑÎ∂Ä Í∏∞Îä•
        async function loadAccountBook(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            // Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            let accountData = {};
            try {
                if (window.firebaseDB && currentUser) {
                    const accountRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}/accountBook`);
                    const snapshot = await window.firebaseGet(accountRef);
                    if (snapshot.exists()) {
                        accountData = snapshot.val();
                    }
                }
            } catch (error) {
                console.error('Í∞ÄÍ≥ÑÎ∂Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
            
            const today = new Date().toISOString().split('T')[0];
            const todayData = accountData[today] || { income: [], expense: [] };
            
            modalBody.innerHTML = `
                <div class="account-form">
                    <h3>ÏàòÏûÖ Ï∂îÍ∞Ä</h3>
                    <input type="text" id="incomeDesc" placeholder="ÏàòÏûÖ ÎÇ¥Ïö©" class="account-input">
                    <input type="number" id="incomeAmount" placeholder="Í∏àÏï°" class="account-input">
                    <button class="btn-primary" onclick="addAccountItem('income')">ÏàòÏûÖ Ï∂îÍ∞Ä</button>
                </div>
                
                <div class="account-form">
                    <h3>ÏßÄÏ∂ú Ï∂îÍ∞Ä</h3>
                    <input type="text" id="expenseDesc" placeholder="ÏßÄÏ∂ú ÎÇ¥Ïö©" class="account-input">
                    <input type="number" id="expenseAmount" placeholder="Í∏àÏï°" class="account-input">
                    <button class="btn-primary" onclick="addAccountItem('expense')">ÏßÄÏ∂ú Ï∂îÍ∞Ä</button>
                </div>
                
                <div class="account-summary">
                    <h3>Ïò§ÎäòÏùò Í∞ÄÍ≥ÑÎ∂Ä</h3>
                    <div id="account-list">
                        ${generateAccountList(todayData)}
                    </div>
                </div>
            `;
        }

        function generateAccountList(data) {
            let html = '';
            const totalIncome = data.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = data.expense.reduce((sum, item) => sum + item.amount, 0);
            
            html += `<div class="item-card">
                <div class="item-header">
                    <span class="item-title">Ï¥ù ÏàòÏûÖ</span>
                    <span class="item-price" style="color: #28a745;">+${totalIncome.toLocaleString()}Ïõê</span>
                </div>
            </div>`;
            
            html += `<div class="item-card">
                <div class="item-header">
                    <span class="item-title">Ï¥ù ÏßÄÏ∂ú</span>
                    <span class="item-price" style="color: #dc3545;">-${totalExpense.toLocaleString()}Ïõê</span>
                </div>
            </div>`;
            
            html += `<div class="item-card">
                <div class="item-header">
                    <span class="item-title">ÏûîÏï°</span>
                    <span class="item-price">${(totalIncome - totalExpense).toLocaleString()}Ïõê</span>
                </div>
            </div>`;
            
            data.income.forEach(item => {
                html += `<div class="item-card">
                    <div class="item-header">
                        <span class="item-title">${item.description}</span>
                        <span class="item-price" style="color: #28a745;">+${item.amount.toLocaleString()}Ïõê</span>
                    </div>
                </div>`;
            });
            
            data.expense.forEach(item => {
                html += `<div class="item-card">
                    <div class="item-header">
                        <span class="item-title">${item.description}</span>
                        <span class="item-price" style="color: #dc3545;">-${item.amount.toLocaleString()}Ïõê</span>
                    </div>
                </div>`;
            });
            
            return html;
        }

        async function addAccountItem(type) {
            const desc = document.getElementById(`${type}Desc`).value;
            const amount = parseInt(document.getElementById(`${type}Amount`).value);
            
            if (!desc || !amount) {
                alert('ÎÇ¥Ïö©Í≥º Í∏àÏï°ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const item = {
                description: desc,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            
            try {
                if (window.firebaseDB && currentUser) {
                    const accountRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}/accountBook/${today}/${type}`);
                    const snapshot = await window.firebaseGet(accountRef);
                    const currentData = snapshot.exists() ? snapshot.val() : [];
                    currentData.push(item);
                    
                    await window.firebaseSet(accountRef, currentData);
                    
                    // Í∞ÄÍ≥ÑÎ∂Ä Îã§Ïãú Î°úÎìú
                    const modal = document.querySelector('.modal');
                    loadAccountBook(modal);
                }
            } catch (error) {
                console.error('Í∞ÄÍ≥ÑÎ∂Ä Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // 2. ÏòàÏ†ÅÍ∏à ÏÉÅÌíà Í∏∞Îä•
        async function loadSavingsProducts(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            // Ïã§Ï†ú ÏòàÏ†ÅÍ∏à ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ (ÏùÄÌñâÎ≥Ñ)
            const savingsProducts = [
                {
                    bank: 'KBÍµ≠ÎØºÏùÄÌñâ',
                    name: 'KB Star Ï†ïÍ∏∞ÏòàÍ∏à',
                    rate: '3.50%',
                    term: '12Í∞úÏõî',
                    minAmount: 1000000,
                    description: 'Ïö∞ÎåÄÍ∏àÎ¶¨ Ï°∞Í±¥ Ïãú ÏµúÎåÄ 3.50%'
                },
                {
                    bank: 'Ïã†ÌïúÏùÄÌñâ',
                    name: 'Ïè† Ï†ïÍ∏∞ÏòàÍ∏à',
                    rate: '3.40%',
                    term: '12Í∞úÏõî',
                    minAmount: 500000,
                    description: 'Ïã†Í∑úÍ≥†Í∞ù Ïö∞ÎåÄÍ∏àÎ¶¨ Ï†ÅÏö©'
                },
                {
                    bank: 'ÌïòÎÇòÏùÄÌñâ',
                    name: 'ÌïòÎÇò ÏõêÌÅê Ï†ïÍ∏∞ÏòàÍ∏à',
                    rate: '3.30%',
                    term: '12Í∞úÏõî',
                    minAmount: 1000000,
                    description: 'Ïò®ÎùºÏù∏ Ï†ÑÏö© ÌäπÎ≥ÑÍ∏àÎ¶¨'
                },
                {
                    bank: 'IBKÍ∏∞ÏóÖÏùÄÌñâ',
                    name: 'i-ONE Ï†ïÍ∏∞ÏòàÍ∏à',
                    rate: '3.25%',
                    term: '6Í∞úÏõî',
                    minAmount: 300000,
                    description: '6Í∞úÏõî Îã®Í∏∞ Í≥†Í∏àÎ¶¨ ÏÉÅÌíà'
                },
                {
                    bank: 'Ïö∞Î¶¨ÏùÄÌñâ',
                    name: 'WON Ï†ïÍ∏∞ÏòàÍ∏à',
                    rate: '3.45%',
                    term: '24Í∞úÏõî',
                    minAmount: 2000000,
                    description: 'Ïû•Í∏∞ Ìà¨Ïûê Ïö∞ÎåÄÍ∏àÎ¶¨'
                }
            ];
            
            let html = '';
            savingsProducts.forEach(product => {
                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-title">${product.bank}</span>
                            <span class="item-price">${product.rate}</span>
                        </div>
                        <div class="item-desc">
                            <strong>${product.name}</strong><br>
                            Í∏∞Í∞Ñ: ${product.term} | ÏµúÏÜåÍ∏àÏï°: ${product.minAmount.toLocaleString()}Ïõê<br>
                            ${product.description}
                        </div>
                        <button class="btn-primary" onclick="subscribeSavings('${product.name}', '${product.rate}', ${product.minAmount})">
                            Í∞ÄÏûÖÌïòÍ∏∞
                        </button>
                    </div>
                `;
            });
            
            modalBody.innerHTML = html;
        }

        async function subscribeSavings(productName, rate, minAmount) {
            const amount = prompt(`${productName} Í∞ÄÏûÖ\nÏµúÏÜå Í∞ÄÏûÖÍ∏àÏï°: ${minAmount.toLocaleString()}Ïõê\nÍ∞ÄÏûÖ Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:`);
            if (amount && parseInt(amount) >= minAmount) {
                const investAmount = parseInt(amount);
                
                // processTransactionÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ FirebaseÏóê Ï†ÄÏû•
                const success = await processTransaction(
                    `SAVINGS_${productName.replace(/\s/g, '_')}`, // Ïã¨Î≥º ÏÉùÏÑ±
                    productName,
                    investAmount, // Í∞ÄÍ≤© (Ï†ÑÏ≤¥ Ìà¨Ïûê Í∏àÏï°)
                    1, // ÏàòÎüâ (1Í∞ú ÏÉÅÌíà)
                    'buy',
                    'savings', // ÏûêÏÇ∞ ÌÉÄÏûÖ
                    'KRW'
                );
                
                if (success) {
                    alert(`${productName}Ïóê ${investAmount.toLocaleString()}ÏõêÏúºÎ°ú Í∞ÄÏûÖÎêòÏóàÏäµÎãàÎã§.\nÏó∞Ïù¥Ïú®: ${rate}`);
                }
            } else if (amount) {
                alert(`ÏµúÏÜå Í∞ÄÏûÖÍ∏àÏï°ÏùÄ ${minAmount.toLocaleString()}ÏõêÏûÖÎãàÎã§.`);
            }
        }

        // 3. Ï£ºÏãù ÏãúÏû• Í∏∞Îä•
        async function loadStockMarket(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            try {
                // Í≤ÄÏÉâ Í∏∞Îä• Ìè¨Ìï®Ìïú Ï£ºÏãù Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
                let html = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="stockSearch" placeholder="Ï£ºÏãùÎ™Ö ÎòêÎäî Ï¢ÖÎ™©ÏΩîÎìú Í≤ÄÏÉâ (Ïòà: ÏÇºÏÑ±Ï†ÑÏûê, 005930)" 
                                   style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                                   onkeypress="if(event.key==='Enter') searchStocks()">
                            <button onclick="searchStocks()" style="padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Í≤ÄÏÉâ</button>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                            üí° ÌåÅ: Ï¢ÖÎ™©Î™Ö(ÏÇºÏÑ±Ï†ÑÏûê) ÎòêÎäî Ï¢ÖÎ™©ÏΩîÎìú(005930)Î°ú Í≤ÄÏÉâ Í∞ÄÎä•Ìï©ÎãàÎã§
                        </div>
                    </div>
                    
                    <div id="stockResults">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            ÏúÑÏóêÏÑú Ï£ºÏãùÏùÑ Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <h4 style="margin-bottom: 15px; color: #333;">Ïù∏Í∏∞ Ï¢ÖÎ™©</h4>
                        <div id="popularStocks">
                            <div style="text-align: center; color: #666;">Ïù∏Í∏∞ Ï¢ÖÎ™©ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                        </div>
                    </div>
                `;
                
                modalBody.innerHTML = html;
                
                // Ïù∏Í∏∞ Ï¢ÖÎ™© Î°úÎìú
                loadPopularStocks();
                
            } catch (error) {
                console.error('Ï£ºÏãù Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                modalBody.innerHTML = `
                    <div class="item-card">
                        <div class="item-desc">Ï£ºÏãù Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>
                    </div>
                `;
            }
        }

        // Ï£ºÏãù Í≤ÄÏÉâ Ìï®Ïàò
        async function searchStocks() {
            const searchInput = document.getElementById('stockSearch');
            const resultsDiv = document.getElementById('stockResults');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Ïã§ÏãúÍ∞Ñ Ï£ºÏãù Ï†ïÎ≥¥Î•º Í≤ÄÏÉâ Ï§ë...</div>';
            
            try {
                // ÌïúÍµ≠ Ï£ºÏãù Í≤ÄÏÉâ (Yahoo Finance ÏÇ¨Ïö©)
                let stocks = await searchKoreanStocks(query);
                
                // ÎØ∏Íµ≠ Ï£ºÏãùÎèÑ Í≤ÄÏÉâÌïòÎ†§Î©¥ .KS/.KQ ÏóÜÏù¥ Í≤ÄÏÉâ
                if (stocks.length === 0) {
                    stocks = await searchGlobalStocks(query);
                }
                
                displaySearchResults(stocks, resultsDiv);
            } catch (error) {
                console.error('Ï£ºÏãù Í≤ÄÏÉâ Ïã§Ìå®:', error);
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</div>';
            }
        }

        // ÌïúÍµ≠ Ï£ºÏãù Í≤ÄÏÉâ
        // ÌïúÍµ≠ Ï£ºÏãù Í≤ÄÏÉâ - Yahoo Finance API ÏÇ¨Ïö©
        async function searchKoreanStocks(query) {
            try {
                console.log('üîç Ïã§Ï†ú Yahoo Finance APIÎ°ú Í≤ÄÏÉâ ÏãúÏûë:', query);
                
                // 1Ï∞®: ÏßÅÏ†ë Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Îß§Ïπ≠ÌïòÏó¨ Ïã§Ï†ú API Ìò∏Ï∂ú
                const directResult = await searchFromLocalDatabase(query);
                if (directResult && directResult.length > 0) {
                    console.log('‚úÖ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Îß§Ïπ≠ + Ïã§Ï†ú API ÏÑ±Í≥µ:', directResult.length, 'Í∞ú');
                    return directResult;
                }
                
                // 2Ï∞®: Yahoo Finance Í≤ÄÏÉâ API ÏÇ¨Ïö©
                const searchUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=20&newsCount=0&enableFuzzyQuery=false&quotesQueryId=tss_match_phrase_query&multiQuoteQueryId=multi_quote_single_token_query&enableCb=true&enableNavLinks=false&enableEnhancedTrivialQuery=true&region=KR&lang=ko`;
                
                // CORS Ïö∞ÌöåÎ•º ÏúÑÌïú ÌîÑÎ°ùÏãú ÏÇ¨Ïö©
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const searchData = JSON.parse(data.contents);
                
                const stocksWithPrices = [];
                
                if (searchData.quotes && searchData.quotes.length > 0) {
                    console.log('üåê Yahoo Finance Í≤ÄÏÉâ Í≤∞Í≥º:', searchData.quotes.length, 'Í∞ú');
                    
                    // ÌïúÍµ≠ Ï£ºÏãùÎßå ÌïÑÌÑ∞ÎßÅ (.KS, .KQÎ°ú ÎÅùÎÇòÎäî Í≤É)
                    const koreanStocks = searchData.quotes.filter(quote => 
                        quote.symbol && (quote.symbol.endsWith('.KS') || quote.symbol.endsWith('.KQ'))
                    );
                    
                    console.log('üá∞üá∑ ÌïúÍµ≠ Ï£ºÏãù ÌïÑÌÑ∞ÎßÅ Í≤∞Í≥º:', koreanStocks.length, 'Í∞ú');
                    
                    // Í∞Å Ï£ºÏãùÏùò Ïã§ÏãúÍ∞Ñ Í∞ÄÍ≤© Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    for (const stock of koreanStocks.slice(0, 10)) { // ÏµúÎåÄ 10Í∞ú
                        try {
                            const priceData = await getYahooStockPrice(stock.symbol);
                            if (priceData) {
                                stocksWithPrices.push({
                                    symbol: stock.symbol.replace('.KS', '').replace('.KQ', ''),
                                    name: stock.longname || stock.shortname || stock.symbol,
                                    sector: stock.typeDisp || stock.quoteType || 'Ï£ºÏãù',
                                    currency: 'KRW',
                                    isUSD: false,
                                    ...priceData
                                });
                            }
                        } catch (error) {
                            console.log(`${stock.symbol} Í∞ÄÍ≤© Î°úÎìú Ïã§Ìå®`);
                        }
                    }
                }
                
                console.log('‚úÖ Yahoo Finance API Í≤ÄÏÉâ ÏôÑÎ£å:', stocksWithPrices.length, 'Í∞ú');
                return stocksWithPrices;
                
            } catch (error) {
                console.error('Yahoo Finance Í≤ÄÏÉâ Ïã§Ìå®:', error);
                console.log('‚ö†Ô∏è API Ïã§Ìå®Î°ú Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÇ¨Ïö©');
                // Ïã§Ìå® Ïãú Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÇ¨Ïö© (Ïù¥Ï†ú Ïã§Ï†ú API ÏãúÎèÑÌï®)
                return await searchFromLocalDatabase(query);
            }
        }

        // Yahoo FinanceÏóêÏÑú Ïã§ÏãúÍ∞Ñ Ï£ºÍ∞Ä Í∞ÄÏ†∏Ïò§Í∏∞
        async function getYahooStockPrice(symbol) {
            // ÌÉÄÏûÑÏïÑÏõÉ Í∏∞Îä•Ïù¥ ÏûàÎäî fetch Ìï®Ïàò
            const fetchWithTimeout = async (url, timeout = 5000) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            };

            // Ïó¨Îü¨ ÌîÑÎ°ùÏãú ÏÑúÎ≤Ñ Î™©Î°ù (ÏàúÏÑúÎåÄÎ°ú ÏãúÎèÑ)
            const proxyServers = [
                { url: 'https://cors-anywhere.herokuapp.com/', type: 'direct' },
                { url: 'https://api.allorigins.win/get?url=', type: 'allorigins' },
                { url: 'https://corsproxy.io/?', type: 'direct' }
            ];
            
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
            
            for (let i = 0; i < proxyServers.length; i++) {
                try {
                    console.log(`üîÑ ${symbol} ÌîÑÎ°ùÏãú ${i + 1} ÏãúÎèÑ`);
                    
                    let response;
                    let chartData;
                    
                    if (proxyServers[i].type === 'allorigins') {
                        // AllOrigins Î∞©Ïãù
                        const proxyUrl = `${proxyServers[i].url}${encodeURIComponent(yahooUrl)}`;
                        response = await fetchWithTimeout(proxyUrl, 3000);
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const data = await response.json();
                        if (!data.contents) throw new Error('No contents in response');
                        
                        chartData = JSON.parse(data.contents);
                    } else {
                        // ÏßÅÏ†ë ÌîÑÎ°ùÏãú Î∞©Ïãù
                        const proxyUrl = `${proxyServers[i].url}${yahooUrl}`;
                        response = await fetchWithTimeout(proxyUrl, 3000);
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        chartData = await response.json();
                    }
                    
                    // Îç∞Ïù¥ÌÑ∞ ÌååÏã±
                    if (chartData.chart && chartData.chart.result && chartData.chart.result[0]) {
                        const result = chartData.chart.result[0];
                        const meta = result.meta;
                        const quote = result.indicators.quote[0];
                        
                        const currentPrice = meta.regularMarketPrice || quote.close[quote.close.length - 1];
                        const previousClose = meta.previousClose || meta.chartPreviousClose;
                        const change = currentPrice - previousClose;
                        const changePercent = (change / previousClose) * 100;
                        
                        const currency = meta.currency || 'KRW';
                        const isUSD = currency === 'USD';
                        
                        console.log(`‚úÖ ${symbol} Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:`, currentPrice, currency);
                        
                        return {
                            price: isUSD ? parseFloat(currentPrice.toFixed(2)) : Math.round(currentPrice),
                            change: change,
                            changePercent: changePercent,
                            volume: quote.volume ? quote.volume[quote.volume.length - 1] : 0,
                            high: meta.regularMarketDayHigh,
                            low: meta.regularMarketDayLow,
                            currency: currency,
                            source: 'yahoo_api'
                        };
                    }
                    
                } catch (error) {
                    // ÎßàÏßÄÎßâ ÌîÑÎ°ùÏãúÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Í∞ÑÎã®Ìïú Î°úÍ∑∏
                    if (i === proxyServers.length - 1) {
                        console.log(`‚ùå ${symbol} Î™®Îì† ÌîÑÎ°ùÏãú Ïã§Ìå®`);
                        throw new Error(`Î™®Îì† ÌîÑÎ°ùÏãú ÏÑúÎ≤Ñ Ïã§Ìå®: ${error.message}`);
                    }
                    continue;
                }
            }
        }

        // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Í≤ÄÏÉâ (Ìè¥Î∞±) - Ïã§Ï†ú API Ïö∞ÏÑ† ÏÇ¨Ïö©
        async function searchFromLocalDatabase(query) {
            // Í∏∞Ï°¥ koreanStocks Î∞∞Ïó¥ ÏÇ¨Ïö©
            const koreanStocks = [
                { symbol: '005930', name: 'ÏÇºÏÑ±Ï†ÑÏûê', sector: 'Î∞òÎèÑÏ≤¥' },
                { symbol: '000660', name: 'SKÌïòÏù¥ÎãâÏä§', sector: 'Î∞òÎèÑÏ≤¥' },
                { symbol: '035420', name: 'NAVER', sector: 'Ïù∏ÌÑ∞ÎÑ∑' },
                { symbol: '005380', name: 'ÌòÑÎåÄÏ∞®', sector: 'ÏûêÎèôÏ∞®' },
                { symbol: '051910', name: 'LGÌôîÌïô', sector: 'ÌôîÌïô' },
                { symbol: '035720', name: 'Ïπ¥Ïπ¥Ïò§', sector: 'Ïù∏ÌÑ∞ÎÑ∑' },
                { symbol: '207940', name: 'ÏÇºÏÑ±Î∞îÏù¥Ïò§Î°úÏßÅÏä§', sector: 'Î∞îÏù¥Ïò§' },
                { symbol: '068270', name: 'ÏÖÄÌä∏Î¶¨Ïò®', sector: 'Î∞îÏù¥Ïò§' },
                { symbol: '373220', name: 'LGÏóêÎÑàÏßÄÏÜîÎ£®ÏÖò', sector: 'Î∞∞ÌÑ∞Î¶¨' },
                { symbol: '000270', name: 'Í∏∞ÏïÑ', sector: 'ÏûêÎèôÏ∞®' },
                { symbol: '006400', name: 'ÏÇºÏÑ±SDI', sector: 'Î∞∞ÌÑ∞Î¶¨' },
                { symbol: '105560', name: 'KBÍ∏àÏúµ', sector: 'Í∏àÏúµ' },
                { symbol: '055550', name: 'Ïã†ÌïúÏßÄÏ£º', sector: 'Í∏àÏúµ' },
                { symbol: '086790', name: 'ÌïòÎÇòÍ∏àÏúµÏßÄÏ£º', sector: 'Í∏àÏúµ' },
                { symbol: '066570', name: 'LGÏ†ÑÏûê', sector: 'Ï†ÑÏûê' },
                { symbol: '003550', name: 'LG', sector: 'ÌôîÌïô' },
                { symbol: '096770', name: 'SKÏù¥ÎÖ∏Î≤†Ïù¥ÏÖò', sector: 'ÌôîÌïô' },
                { symbol: '017670', name: 'SKÌÖîÎ†àÏΩ§', sector: 'ÌÜµÏã†' },
                { symbol: '030200', name: 'KT', sector: 'ÌÜµÏã†' },
                { symbol: '032830', name: 'ÏÇºÏÑ±ÏÉùÎ™Ö', sector: 'Î≥¥Ìóò' },
                { symbol: '009150', name: 'ÏÇºÏÑ±Ï†ÑÍ∏∞', sector: 'Ï†ÑÏûêÎ∂ÄÌíà' },
                { symbol: '018260', name: 'ÏÇºÏÑ±ÏóêÏä§ÎîîÏóêÏä§', sector: 'ITÏÑúÎπÑÏä§' },
                { symbol: '012330', name: 'ÌòÑÎåÄÎ™®ÎπÑÏä§', sector: 'ÏûêÎèôÏ∞®Î∂ÄÌíà' },
                { symbol: '028260', name: 'ÏÇºÏÑ±Î¨ºÏÇ∞', sector: 'Í±¥ÏÑ§' },
                { symbol: '010950', name: 'S-Oil', sector: 'Ï†ïÏú†' },
                { symbol: '267250', name: 'ÌòÑÎåÄÏ§ëÍ≥µÏóÖ', sector: 'Ï°∞ÏÑ†' },
                { symbol: '009540', name: 'HDÌïúÍµ≠Ï°∞ÏÑ†Ìï¥Ïñë', sector: 'Ï°∞ÏÑ†' },
                { symbol: '034730', name: 'SK', sector: 'ÏßÄÏ£ºÌöåÏÇ¨' },
                { symbol: '323410', name: 'Ïπ¥Ïπ¥Ïò§Î±ÖÌÅ¨', sector: 'ÏùÄÌñâ' },
                { symbol: '352820', name: 'ÌïòÏù¥Î∏å', sector: 'ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏' },
                { symbol: '034020', name: 'ÎëêÏÇ∞ÏóêÎÑàÎπåÎ¶¨Ìã∞', sector: 'Î∞úÏ†ÑÏÑ§ÎπÑ' },
                { symbol: '003490', name: 'ÎåÄÌïúÌï≠Í≥µ', sector: 'Ìï≠Í≥µ' },
                { symbol: '011170', name: 'Î°ØÎç∞ÏºÄÎØ∏Ïπº', sector: 'ÌôîÌïô' },
                { symbol: '047050', name: 'Ìè¨Ïä§ÏΩîÏù∏ÌÑ∞ÎÇ¥ÏÖîÎÑê', sector: 'Î¨¥Ïó≠' },
                { symbol: '001570', name: 'Í∏àÏñë', sector: 'Í±¥ÏÑ§' },
                { symbol: '028050', name: 'ÏÇºÏÑ±ÏóîÏßÄÎãàÏñ¥ÎßÅ', sector: 'Í±¥ÏÑ§' },
                { symbol: '036570', name: 'ÏóîÏî®ÏÜåÌîÑÌä∏', sector: 'Í≤åÏûÑ' },
                { symbol: '251270', name: 'ÎÑ∑ÎßàÎ∏î', sector: 'Í≤åÏûÑ' },
                { symbol: '112040', name: 'ÏúÑÎ©îÏù¥Îìú', sector: 'Í≤åÏûÑ' },
                { symbol: '259960', name: 'ÌÅ¨ÎûòÌîÑÌÜ§', sector: 'Í≤åÏûÑ' }
            ];
            
            let matchedStocks = koreanStocks.filter(stock => 
                stock.name.includes(query) || 
                stock.symbol.includes(query) ||
                stock.sector.includes(query)
            );
            
            // Ïã§Ï†ú Yahoo Finance APIÎ°ú Í∞ÄÍ≤© Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏïàÏ†ïÏÑ± Ìñ•ÏÉÅ)
            const stocksWithRealPrices = [];
            const maxConcurrentRequests = 3; // ÎèôÏãú ÏöîÏ≤≠ Ïàò Ï†úÌïú
            
            for (let i = 0; i < matchedStocks.slice(0, 10).length; i += maxConcurrentRequests) {
                const batch = matchedStocks.slice(i, i + maxConcurrentRequests);
                const batchPromises = batch.map(async stock => {
                    try {
                        console.log(`üîç ${stock.name} (${stock.symbol}) Í∞ÄÍ≤© Ï°∞Ìöå ÏãúÎèÑ`);
                        
                        // ÌïúÍµ≠ Ï£ºÏãùÏùÄ .KS ÎòêÎäî .KQ Ï†ëÎØ∏ÏÇ¨ ÏãúÎèÑ
                        let priceData = null;
                        
                        // 1Ï∞®: .KS (ÏΩîÏä§Ìîº) ÏãúÎèÑ
                        try {
                            priceData = await getYahooStockPrice(stock.symbol + '.KS');
                        } catch (error) {
                            console.log(`${stock.symbol}.KS Ïã§Ìå®, .KQ ÏãúÎèÑ`);
                        }
                        
                        // 2Ï∞®: .KQ (ÏΩîÏä§Îã•) ÏãúÎèÑ
                        if (!priceData) {
                            try {
                                priceData = await getYahooStockPrice(stock.symbol + '.KQ');
                            } catch (error) {
                                console.log(`${stock.symbol}.KQÎèÑ Ïã§Ìå®`);
                            }
                        }
                        
                        if (priceData && priceData.price) {
                            console.log(`‚úÖ ${stock.name} Ïã§Ï†ú API Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©: ${priceData.price}Ïõê`);
                            return {
                                symbol: stock.symbol,
                                name: stock.name,
                                sector: stock.sector,
                                price: priceData.price,
                                change: priceData.change || 0,
                                changePercent: priceData.changePercent || 0,
                                volume: priceData.volume || 0,
                                currency: 'KRW',
                                source: 'yahoo_api'
                            };
                        } else {
                            // API Ïã§Ìå® Ïãú ÌòÑÏã§Ï†ÅÏù∏ Í∞ÄÍ≤© ÏÉùÏÑ±
                            console.log(`üìä ${stock.name} ÌòÑÏã§Ï†Å Í∞ÄÍ≤© ÏÉùÏÑ±`);
                            return generateRealisticPrice(stock);
                        }
                        
                    } catch (error) {
                        console.log(`‚ö†Ô∏è ${stock.name} Ï≤òÎ¶¨ Ïã§Ìå®: ${error.message}`);
                        return generateRealisticPrice(stock);
                    }
                });
                
                // Î∞∞Ïπò Ï≤òÎ¶¨ ÏôÑÎ£å ÎåÄÍ∏∞
                const batchResults = await Promise.allSettled(batchPromises);
                batchResults.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        stocksWithRealPrices.push(result.value);
                    }
                });
                
                // ÏÑúÎ≤Ñ Í≥ºÎ∂ÄÌïò Î∞©ÏßÄÎ•º ÏúÑÌïú ÎîúÎ†àÏù¥
                if (i + maxConcurrentRequests < matchedStocks.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`üéØ ${query} Í≤ÄÏÉâ ÏôÑÎ£å: ${stocksWithRealPrices.length}Í∞ú Ï¢ÖÎ™©`);
            return stocksWithRealPrices;
        }
        
        // ÌòÑÏã§Ï†ÅÏù∏ Ï£ºÏãù Í∞ÄÍ≤© ÏÉùÏÑ±
        function generateRealisticPrice(stock) {
            // Ï£ºÏöî Ï¢ÖÎ™©Î≥Ñ ÌòÑÏã§Ï†ÅÏù∏ Í∞ÄÍ≤©ÎåÄ
            const realisticPrices = {
                '005930': { base: 75000, volatility: 0.03 },   // ÏÇºÏÑ±Ï†ÑÏûê
                '000660': { base: 85000, volatility: 0.04 },   // SKÌïòÏù¥ÎãâÏä§
                '035420': { base: 200000, volatility: 0.03 },  // NAVER
                '005380': { base: 185000, volatility: 0.04 },  // ÌòÑÎåÄÏ∞®
                '051910': { base: 420000, volatility: 0.03 },  // LGÌôîÌïô
                '207940': { base: 155000, volatility: 0.05 },  // ÏÇºÏÑ±Î∞îÏù¥Ïò§Î°úÏßÅÏä§
                '035720': { base: 95000, volatility: 0.06 },   // Ïπ¥Ïπ¥Ïò§
                '068270': { base: 180000, volatility: 0.05 }   // ÏÖÄÌä∏Î¶¨Ïò®
            };
            
            const priceInfo = realisticPrices[stock.symbol] || { base: 50000, volatility: 0.04 };
            
            // Í∏∞Ï§ÄÍ∞ÄÏóêÏÑú ¬±volatility Î≤îÏúÑÏùò Î≥ÄÎèô
            const variation = (Math.random() - 0.5) * 2 * priceInfo.volatility;
            const currentPrice = Math.round(priceInfo.base * (1 + variation));
            
            // Ï†ÑÏùº ÎåÄÎπÑ Î≥ÄÎèô Í≥ÑÏÇ∞
            const changePercent = variation * 100; // volatilityÎ•º Í∑∏ÎåÄÎ°ú Î≥ÄÎèôÎ•†Î°ú ÏÇ¨Ïö©
            const change = Math.round(currentPrice * (changePercent / 100));
            
            return {
                symbol: stock.symbol,
                name: stock.name,
                sector: stock.sector,
                price: currentPrice,
                change: change,
                changePercent: changePercent,
                volume: Math.floor(Math.random() * 1000000) + 100000,
                currency: 'KRW',
                source: 'realistic_simulation'
            };
        }

        // Í∏ÄÎ°úÎ≤å Ï£ºÏãù Í≤ÄÏÉâ (ÎØ∏Íµ≠, ÏùºÎ≥∏ Îì±)
        async function searchGlobalStocks(query) {
            try {
                const searchUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=10&newsCount=0`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const searchData = JSON.parse(data.contents);
                
                const stocksWithPrices = [];
                
                if (searchData.quotes) {
                    for (const stock of searchData.quotes.slice(0, 5)) {
                        const priceData = await getYahooStockPrice(stock.symbol);
                        if (priceData) {
                            stocksWithPrices.push({
                                symbol: stock.symbol,
                                name: stock.longname || stock.shortname,
                                sector: stock.exchange || 'Ìï¥Ïô∏Ï£ºÏãù',
                                ...priceData
                            });
                        }
                    }
                }
                
                return stocksWithPrices;
            } catch (error) {
                console.error('Í∏ÄÎ°úÎ≤å Ï£ºÏãù Í≤ÄÏÉâ Ïã§Ìå®:', error);
                return [];
            }
        }

        // ÌôòÏú® Í≥ÑÏÇ∞ Ìï®Ïàò
        function getExchangeRate() {
            // Ïã§Ï†úÎ°úÎäî APIÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏïº ÌïòÏßÄÎßå, ÏãúÎÆ¨Î†àÏù¥ÏÖòÏö© Í≥†Ï†ï ÌôòÏú® ÏÇ¨Ïö©
            return 1320; // 1Îã¨Îü¨ = 1320Ïõê (ÏòàÏãú)
        }

        function convertCurrency(amount, fromCurrency, toCurrency) {
            const exchangeRate = getExchangeRate();
            
            if (fromCurrency === 'USD' && toCurrency === 'KRW') {
                return amount * exchangeRate;
            } else if (fromCurrency === 'KRW' && toCurrency === 'USD') {
                return amount / exchangeRate;
            }
            return amount;
        }

        function formatPrice(price, currency, decimals = 2) {
            if (currency === 'USD') {
                return '$' + price.toFixed(decimals);
            } else {
                return price.toLocaleString() + 'Ïõê';
            }
        }

        // Ï£ºÏãù Í∞ÄÍ≤© ÏÉùÏÑ± (Ïã§Ï†ú API ÎåÄÏã† ÌòÑÏã§Ï†ÅÏù∏ ÎûúÎç§ Îç∞Ïù¥ÌÑ∞)
        function generateStockPrice(symbol) {
            // Ï¢ÖÎ™©Î≥Ñ Í∏∞Î≥∏ Í∞ÄÍ≤© ÏÑ§Ï†ï
            const basePrices = {
                '005930': 70000,  // ÏÇºÏÑ±Ï†ÑÏûê
                '000660': 120000, // SKÌïòÏù¥ÎãâÏä§
                '035420': 180000, // NAVER
                '005380': 45000,  // ÌòÑÎåÄÏ∞®
                '051910': 85000,  // LGÌôîÌïô
                '035720': 55000,  // Ïπ¥Ïπ¥Ïò§
                '207940': 850000, // ÏÇºÏÑ±Î∞îÏù¥Ïò§Î°úÏßÅÏä§
                '068270': 180000, // ÏÖÄÌä∏Î¶¨Ïò®
                '373220': 420000, // LGÏóêÎÑàÏßÄÏÜîÎ£®ÏÖò
                '000270': 85000   // Í∏∞ÏïÑ
            };
            
            const basePrice = basePrices[symbol] || (Math.floor(Math.random() * 50000) + 10000);
            const variation = (Math.random() - 0.5) * 0.1; // ¬±10% Î≥ÄÎèô
            const price = Math.floor(basePrice * (1 + variation));
            const change = (Math.random() - 0.5) * 10; // ¬±5% Î≥ÄÎèôÎ•†
            
            return {
                price: price,
                change: change,
                changePercent: change
            };
        }

        // Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú
        function displaySearchResults(stocks, container) {
            if (stocks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            let html = '';
            stocks.forEach(stock => {
                const isPositive = stock.changePercent >= 0;
                const changeClass = isPositive ? 'positive' : 'negative';
                const changeSymbol = isPositive ? '+' : '';
                
                // ÌÜµÌôîÏóê Îî∞Î•∏ Í∞ÄÍ≤© ÌëúÏãú
                const currencySymbol = stock.isUSD ? '$' : '';
                const currencyUnit = stock.isUSD ? '' : 'Ïõê';
                const priceDisplay = stock.isUSD ? 
                    currencySymbol + stock.price.toLocaleString() : 
                    stock.price.toLocaleString() + currencyUnit;
                
                html += '<div class="stock-card ' + changeClass + '" onclick="buyStock(\'' + stock.symbol + '\', \'' + stock.name + '\', ' + stock.price + ', \'' + (stock.currency || 'KRW') + '\')" style="cursor: pointer; margin-bottom: 10px;">' +
                        '<div class="stock-header">' +
                        '<div>' +
                        '<div class="stock-symbol">' + stock.symbol + '</div>' +
                        '<div style="font-size: 14px; color: #666;">' + stock.name + '</div>' +
                        '<div style="font-size: 12px; color: #999;">' + stock.sector + '</div>' +
                        '</div>' +
                        '<div style="text-align: right;">' +
                        '<div class="stock-price">' + priceDisplay + '</div>' +
                        '<div class="stock-change">' + changeSymbol + stock.changePercent.toFixed(2) + '%</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
            });
            
            container.innerHTML = html;
        }

        // Ïù∏Í∏∞ Ï¢ÖÎ™© Î°úÎìú
        async function loadPopularStocks() {
            const popularDiv = document.getElementById('popularStocks');
            if (!popularDiv) return;
            
            try {
                console.log('üìà Ïù∏Í∏∞ Ï¢ÖÎ™© Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë');
                
                // Ïù∏Í∏∞ Ï¢ÖÎ™© Ïã¨Î≥ºÎì§ (Ïã§Ï†ú Í±∞ÎûòÎüâ Í∏∞Ï§Ä)
                const popularSymbols = ['ÏÇºÏÑ±Ï†ÑÏûê', 'SKÌïòÏù¥ÎãâÏä§', 'NAVER', 'ÌòÑÎåÄÏ∞®', 'LGÌôîÌïô'];
                const popularStocks = [];
                
                for (const stockName of popularSymbols) {
                    try {
                        const results = await searchFromLocalDatabase(stockName);
                        if (results && results.length > 0) {
                            popularStocks.push(results[0]); // Ï≤´ Î≤àÏß∏ Í≤∞Í≥ºÎßå
                        }
                    } catch (error) {
                        console.log(`${stockName} Î°úÎìú Ïã§Ìå®`);
                    }
                }
                
                console.log('‚úÖ Ïù∏Í∏∞ Ï¢ÖÎ™© Î°úÎìú ÏôÑÎ£å:', popularStocks.length, 'Í∞ú');
                displaySearchResults(popularStocks, popularDiv);
            } catch (error) {
                console.error('Ïù∏Í∏∞ Ï¢ÖÎ™© Î°úÎìú Ïã§Ìå®:', error);
                popularDiv.innerHTML = '<div style="text-align: center; color: #666;">Ïù∏Í∏∞ Ï¢ÖÎ™©ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        function buyStock(symbol, name, price, currency = 'KRW') {
            // Ïã§Ï†ú Í∞ÄÍ≤©ÏúºÎ°ú Ï∞®Ìä∏ Î™®Îã¨ ÌëúÏãú (Í∞ÄÏÉÅ Í∞ÄÍ≤© ÏÉùÏÑ± Ï†úÍ±∞)
            console.log(`üéØ ${name} Îß§Ïàò/Îß§ÎèÑ Î™®Îã¨ Ïó¥Í∏∞ - Ïã§Ï†ú Í∞ÄÍ≤©: ${price} ${currency}`);
            showAssetChart(symbol, name, price, 'stock', currency);
        }

        // 4. ÎåÄÏ∂ú ÏÉÅÌíà Í∏∞Îä•
        async function loadLoanProducts(modal) {
            const modalBody = modal.querySelector('.modal-body');
            const userExp = userAssets.exp || 0;
            const userGrade = calculateUserGrade(userExp);
            
            // Îì±Í∏âÎ≥Ñ ÎåÄÏ∂ú Ï°∞Í±¥
            const loanProducts = [
                {
                    grade: 'red',
                    name: 'Ïã†Ïö©ÎåÄÏ∂ú',
                    maxAmount: 30000000,
                    rate: '4.5%',
                    term: '60Í∞úÏõî',
                    description: 'Î¨¥Îã¥Î≥¥ Í∞úÏù∏Ïã†Ïö©ÎåÄÏ∂ú'
                },
                {
                    grade: 'black',
                    name: 'Ï£ºÌÉùÎã¥Î≥¥ÎåÄÏ∂ú',
                    maxAmount: 500000000,
                    rate: '3.2%',
                    term: '360Í∞úÏõî',
                    description: 'Ï£ºÌÉùÎã¥Î≥¥ Ïû•Í∏∞ÎåÄÏ∂ú'
                },
                {
                    grade: 'black',
                    name: 'ÏÇ¨ÏóÖÏûêÎåÄÏ∂ú',
                    maxAmount: 100000000,
                    rate: '3.8%',
                    term: '120Í∞úÏõî',
                    description: 'ÏÇ¨ÏóÖÏûêÍ∏à Ï†ÑÏö©ÎåÄÏ∂ú'
                }
            ];
            
            let html = '';
            loanProducts.forEach(product => {
                const canAccess = userGrade === product.grade || 
                    (product.grade === 'red' && ['red', 'black'].includes(userGrade)) ||
                    (product.grade === 'black' && userGrade === 'black');
                
                html += '<div class="item-card ' + (canAccess ? '' : 'locked') + '">' +
                        '<div class="item-header">' +
                        '<span class="item-title">' + product.name + '</span>' +
                        '<span class="item-price">' + product.rate + '</span>' +
                        '</div>' +
                        '<div class="item-desc">' +
                        'ÏµúÎåÄÌïúÎèÑ: ' + product.maxAmount.toLocaleString() + 'Ïõê<br>' +
                        'ÎåÄÏ∂úÍ∏∞Í∞Ñ: ' + product.term + '<br>' +
                        product.description +
                        '</div>' +
                        (canAccess ? 
                            '<button class="btn-primary" onclick="applyLoan(\'' + product.name + '\', ' + product.maxAmount + ', \'' + product.rate + '\')">Ïã†Ï≤≠ÌïòÍ∏∞</button>' :
                            '<div style="color: #999; font-size: 14px;">' + product.grade.toUpperCase() + ' Îì±Í∏â ÌïÑÏöî</div>'
                        ) +
                        '</div>';
            });
            
            modalBody.innerHTML = html;
        }

        async function applyLoan(productName, maxAmount, rate) {
            const amount = prompt(productName + ' Ïã†Ï≤≠\nÏµúÎåÄÌïúÎèÑ: ' + maxAmount.toLocaleString() + 'Ïõê\nÎåÄÏ∂ú Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (amount && parseInt(amount) <= maxAmount && parseInt(amount) > 0) {
                const loanAmount = parseInt(amount);
                
                // ÎåÄÏ∂úÏùÄ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Ïóê Î∂ÄÏ±ÑÎ°ú Í∏∞Î°ùÌïòÍ≥† ÌòÑÍ∏à Ï¶ùÍ∞Ä
                if (!userAssets.portfolio) {
                    userAssets.portfolio = {};
                }
                
                const loanSymbol = `LOAN_${productName.replace(/\s/g, '_')}`;
                userAssets.portfolio[loanSymbol] = {
                    name: productName,
                    symbol: loanSymbol,
                    type: 'loan',
                    currency: 'KRW',
                    quantity: 1,
                    avgPrice: loanAmount,
                    totalInvested: loanAmount,
                    rate: rate,
                    isDebt: true // Î∂ÄÏ±Ñ ÌëúÏãú
                };
                
                // ÌòÑÍ∏à Ï¶ùÍ∞Ä
                userAssets.cash = (userAssets.cash || 0) + loanAmount;
                
                // FirebaseÏóê Ï†ÄÏû•
                await saveUserPortfolio();
                
                alert(productName + ' ' + loanAmount.toLocaleString() + 'ÏõêÏù¥ Ïã†Ï≤≠ÎêòÏóàÏäµÎãàÎã§.\nÍ∏àÎ¶¨: ' + rate);
            } else if (amount) {
                alert('ÎåÄÏ∂ú Í∞ÄÎä• Í∏àÏï°ÏùÑ Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.\nÏµúÎåÄ: ' + maxAmount.toLocaleString() + 'Ïõê');
            }
        }

        // 5. ETF Î∞è ÌéÄÎìú Í∏∞Îä•
        async function loadETFAndFunds(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            try {
                // Í≤ÄÏÉâ Í∏∞Îä• Ìè¨Ìï®Ìïú ETF/ÌéÄÎìú Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
                let html = '<div style="margin-bottom: 20px;">' +
                          '<div style="display: flex; gap: 10px; margin-bottom: 15px;">' +
                          '<input type="text" id="fundSearch" placeholder="ETF/ÌéÄÎìúÎ™Ö Í≤ÄÏÉâ (Ïòà: KODEX, ÏÇºÏÑ±)" ' +
                          'style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" ' +
                          'onkeypress="if(event.key===\'Enter\') searchFunds()">' +
                          '<button onclick="searchFunds()" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Í≤ÄÏÉâ</button>' +
                          '</div>' +
                          '<div style="font-size: 12px; color: #666; margin-bottom: 15px;">' +
                          'üí° ÌåÅ: ETFÎ™Ö(KODEX 200) ÎòêÎäî ÌéÄÎìúÏÇ¨Î™Ö(ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©)ÏúºÎ°ú Í≤ÄÏÉâ Í∞ÄÎä•Ìï©ÎãàÎã§' +
                          '</div>' +
                          '</div>' +
                          '<div id="fundResults">' +
                          '<div style="text-align: center; padding: 20px; color: #666;">' +
                          'ÏúÑÏóêÏÑú ETF/ÌéÄÎìúÎ•º Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî' +
                          '</div>' +
                          '</div>' +
                          '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">' +
                          '<h4 style="margin-bottom: 15px; color: #333;">Ïù∏Í∏∞ ÏÉÅÌíà</h4>' +
                          '<div id="popularFunds">' +
                          '<div style="text-align: center; color: #666;">Ïù∏Í∏∞ ÏÉÅÌíàÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>' +
                          '</div>' +
                          '</div>';
                
                modalBody.innerHTML = html;
                
                // Ïù∏Í∏∞ ÏÉÅÌíà Î°úÎìú
                loadPopularFunds();
                
            } catch (error) {
                console.error('ETF/ÌéÄÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                modalBody.innerHTML = '<div class="item-card">' +
                                    '<div class="item-desc">ETF Î∞è ÌéÄÎìú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>' +
                                    '</div>';
            }
        }

        // ETF/ÌéÄÎìú Í≤ÄÏÉâ Ìï®Ïàò
        async function searchFunds() {
            const searchInput = document.getElementById('fundSearch');
            const resultsDiv = document.getElementById('fundResults');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Ïã§ÏãúÍ∞Ñ ETF/ÌéÄÎìú Ï†ïÎ≥¥Î•º Í≤ÄÏÉâ Ï§ë...</div>';
            
            try {
                const funds = await searchKoreanFunds(query);
                displayFundResults(funds, resultsDiv);
            } catch (error) {
                console.error('ETF/ÌéÄÎìú Í≤ÄÏÉâ Ïã§Ìå®:', error);
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</div>';
            }
        }

        // ÌïúÍµ≠ ETF/ÌéÄÎìú Í≤ÄÏÉâ - Ïã§Ï†ú API Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
        async function searchKoreanFunds(query) {
            // ÌïúÍµ≠ Ï£ºÏöî ETF Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ (Yahoo Finance Ïã¨Î≥º Ìè¨Ìï®)
            const koreanETFs = [
                { symbol: '069500', yahooSymbol: '069500.KS', name: 'KODEX 200', type: 'ETF', description: 'KOSPI 200 ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'Íµ≠ÎÇ¥Ï£ºÏãù' },
                { symbol: '102110', yahooSymbol: '102110.KS', name: 'TIGER 200', type: 'ETF', description: 'KOSPI 200 ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'Íµ≠ÎÇ¥Ï£ºÏãù' },
                { symbol: '229200', yahooSymbol: '229200.KS', name: 'KODEX ÏΩîÏä§Îã•150', type: 'ETF', description: 'KOSDAQ 150 ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'Íµ≠ÎÇ¥Ï£ºÏãù' },
                { symbol: '133690', yahooSymbol: '133690.KS', name: 'TIGER ÎÇòÏä§Îã•100', type: 'ETF', description: 'ÎÇòÏä§Îã• 100 ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'Ìï¥Ïô∏Ï£ºÏãù' },
                { symbol: '360750', yahooSymbol: '360750.KS', name: 'KODEX ÎØ∏Íµ≠S&P500', type: 'ETF', description: 'S&P 500 ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'Ìï¥Ïô∏Ï£ºÏãù' },
                { symbol: '371460', yahooSymbol: '371460.KS', name: 'TIGER Ï∞®Ïù¥ÎÇòÏ†ÑÍ∏∞Ï∞®SOLACTIVE', type: 'ETF', description: 'Ï§ëÍµ≠ Ï†ÑÍ∏∞Ï∞® ÌÖåÎßà', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'ÌÖåÎßà' },
                { symbol: '305720', yahooSymbol: '305720.KS', name: 'KODEX 2Ï∞®Ï†ÑÏßÄÏÇ∞ÏóÖ', type: 'ETF', description: '2Ï∞®Ï†ÑÏßÄ Í¥ÄÎ†® Í∏∞ÏóÖ', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'ÌÖåÎßà' },
                { symbol: '091230', yahooSymbol: '091230.KS', name: 'TIGER Î∞òÎèÑÏ≤¥', type: 'ETF', description: 'Î∞òÎèÑÏ≤¥ Í¥ÄÎ†® Í∏∞ÏóÖ', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'ÏÑπÌÑ∞' },
                { symbol: '132030', yahooSymbol: '132030.KS', name: 'KODEX Í≥®ÎìúÏÑ†Î¨º', type: 'ETF', description: 'Í∏à ÏÑ†Î¨º Ï∂îÏ¢Ö', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'ÏõêÏûêÏû¨' },
                { symbol: '130680', yahooSymbol: '130680.KS', name: 'TIGER ÏõêÏú†ÏÑ†Î¨ºEnhanced', type: 'ETF', description: 'ÏõêÏú† ÏÑ†Î¨º Ï∂îÏ¢Ö', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'ÏõêÏûêÏû¨' },
                { symbol: '114800', yahooSymbol: '114800.KS', name: 'KODEX Ïù∏Î≤ÑÏä§', type: 'ETF', description: 'KOSPI 200 Ïù∏Î≤ÑÏä§', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'Ïù∏Î≤ÑÏä§' },
                { symbol: '305080', yahooSymbol: '305080.KS', name: 'TIGER ÎØ∏Íµ≠Ï±Ñ10ÎÖÑÏÑ†Î¨º', type: 'ETF', description: 'ÎØ∏Íµ≠ Íµ≠Ï±Ñ 10ÎÖÑ Ï∂îÏ¢Ö', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'Ï±ÑÍ∂å' },
                { symbol: '069660', yahooSymbol: '069660.KS', name: 'KOSEF 200', type: 'ETF', description: 'KOSPI 200 ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÌÇ§ÏõÄÌà¨ÏûêÏûêÏÇ∞Ïö¥Ïö©', category: 'Íµ≠ÎÇ¥Ï£ºÏãù' },
                { symbol: '278530', yahooSymbol: '278530.KS', name: 'KODEX MSCI Korea', type: 'ETF', description: 'MSCI Korea ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'Íµ≠ÎÇ¥Ï£ºÏãù' },
                { symbol: '143460', yahooSymbol: '143460.KS', name: 'KINDEX Ï§ëÍµ≠Î≥∏ÌÜ†CSI300', type: 'ETF', description: 'Ï§ëÍµ≠ CSI300 ÏßÄÏàò Ï∂îÏ¢Ö', company: 'ÌïúÍµ≠Ìà¨ÏûêÏã†ÌÉÅÏö¥Ïö©', category: 'Ìï¥Ïô∏Ï£ºÏãù' },
                { symbol: '300950', yahooSymbol: '300950.KS', name: 'TIGER K-Îâ¥Îîú', type: 'ETF', description: 'ÌïúÍµ≠Ìåê Îâ¥Îîú ÌÖåÎßà', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'ÌÖåÎßà' },
                { symbol: '276650', yahooSymbol: '276650.KS', name: 'KODEX Î∞îÏù¥Ïò§', type: 'ETF', description: 'Î∞îÏù¥Ïò§ Í¥ÄÎ†® Í∏∞ÏóÖ', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'ÏÑπÌÑ∞' },
                { symbol: '315270', yahooSymbol: '315270.KS', name: 'TIGER Ï∞®Ïù¥ÎÇòÏ†ÑÍ∏∞Ï∞®', type: 'ETF', description: 'Ï§ëÍµ≠ Ï†ÑÍ∏∞Ï∞® Í¥ÄÎ†®', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'ÌÖåÎßà' },
                { symbol: '157490', yahooSymbol: '157490.KS', name: 'TIGER ÏÜåÌîÑÌä∏Ïõ®Ïñ¥', type: 'ETF', description: 'ÏÜåÌîÑÌä∏Ïõ®Ïñ¥ Í¥ÄÎ†® Í∏∞ÏóÖ', company: 'ÎØ∏ÎûòÏóêÏÖãÏûêÏÇ∞Ïö¥Ïö©', category: 'ÏÑπÌÑ∞' },
                { symbol: '364970', yahooSymbol: '364970.KS', name: 'KODEX ÎØ∏Íµ≠Îã¨Îü¨ÏÑ†Î¨º', type: 'ETF', description: 'Îã¨Îü¨ ÏÑ†Î¨º Ï∂îÏ¢Ö', company: 'ÏÇºÏÑ±ÏûêÏÇ∞Ïö¥Ïö©', category: 'ÌÜµÌôî' }
            ];
            
            // Í≤ÄÏÉâÏñ¥ÏôÄ Îß§Ïπ≠ÎêòÎäî ETF Ï∞æÍ∏∞
            let matchedFunds = [];
            if (query) {
                matchedFunds = koreanETFs.filter(fund => 
                    fund.name.includes(query) || 
                    fund.company.includes(query) ||
                    fund.category.includes(query) ||
                    fund.description.includes(query) ||
                    fund.symbol.includes(query)
                );
            } else {
                // Í≤ÄÏÉâÏñ¥Í∞Ä ÏóÜÏúºÎ©¥ Ïù∏Í∏∞ ÏÉÅÌíà Î∞òÌôò
                const popularSymbols = ['069500', '102110', '229200', '133690', '091230'];
                matchedFunds = koreanETFs.filter(fund => 
                    popularSymbols.includes(fund.symbol)
                );
            }
            
            // Ïã§Ï†ú Yahoo Finance APIÎ°ú Í∞ÄÍ≤© Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const fundsWithRealPrices = [];
            const maxResults = Math.min(matchedFunds.length, 10);
            
            for (let i = 0; i < maxResults; i++) {
                const fund = matchedFunds[i];
                try {
                    console.log(`üîç ${fund.name} (${fund.yahooSymbol}) Ïã§ÏãúÍ∞Ñ Í∞ÄÍ≤© Ï°∞Ìöå`);
                    const priceData = await getYahooStockPrice(fund.yahooSymbol);
                    
                    if (priceData && priceData.price) {
                        console.log(`‚úÖ ${fund.name} Ïã§Ï†ú Í∞ÄÍ≤©: ${priceData.price}Ïõê`);
                        fundsWithRealPrices.push({
                            ...fund,
                            price: priceData.price,
                            returnRate: priceData.changePercent || 0,
                            change: priceData.change || 0,
                                                        currency: priceData.currency || 'KRW',
                            volume: priceData.volume || 0,
                            source: 'yahoo_api'
                        });
                    } else {
                        // API Ïã§Ìå® Ïãú ÌòÑÏã§Ï†ÅÏù∏ Í∞ÄÍ≤© ÏÉùÏÑ±
                        console.log(`‚ö†Ô∏è ${fund.name} API Ïã§Ìå®, ÌòÑÏã§Ï†Å Í∞ÄÍ≤© ÏÉùÏÑ±`);
                        const generatedPrice = generateRealisticETFPrice(fund);
                        fundsWithRealPrices.push({
                            ...fund,
                            ...generatedPrice
                        });
                    }
                } catch (error) {
                    console.log(`‚ùå ${fund.name} Ï≤òÎ¶¨ Ïã§Ìå®: ${error.message}`);
                    const generatedPrice = generateRealisticETFPrice(fund);
                    fundsWithRealPrices.push({
                        ...fund,
                        ...generatedPrice
                    });
                }
                
                // ÏÑúÎ≤Ñ Í≥ºÎ∂ÄÌïò Î∞©ÏßÄÎ•º ÏúÑÌïú ÎîúÎ†àÏù¥
                if (i < maxResults - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`üéØ ETF/ÌéÄÎìú Í≤ÄÏÉâ ÏôÑÎ£å: ${fundsWithRealPrices.length}Í∞ú`);
            return fundsWithRealPrices;
        }

        // ÌòÑÏã§Ï†ÅÏù∏ ETF Í∞ÄÍ≤© ÏÉùÏÑ±
        function generateRealisticETFPrice(fund) {
            // ETFÎ≥Ñ ÌòÑÏã§Ï†ÅÏù∏ Í∞ÄÍ≤©ÎåÄ
            const realisticPrices = {
                'KODEX 200': { base: 42000, volatility: 0.02 },
                'TIGER 200': { base: 41000, volatility: 0.02 },
                'KODEX ÏΩîÏä§Îã•150': { base: 8500, volatility: 0.03 },
                'TIGER ÎÇòÏä§Îã•100': { base: 18000, volatility: 0.03 },
                'KODEX ÎØ∏Íµ≠S&P500': { base: 15000, volatility: 0.025 },
                'TIGER Î∞òÎèÑÏ≤¥': { base: 12000, volatility: 0.04 },
                'KODEX 2Ï∞®Ï†ÑÏßÄÏÇ∞ÏóÖ': { base: 10000, volatility: 0.04 },
                'KODEX Í≥®ÎìúÏÑ†Î¨º': { base: 9000, volatility: 0.02 },
                'TIGER ÏõêÏú†ÏÑ†Î¨ºEnhanced': { base: 5000, volatility: 0.05 },
                'KODEX Ïù∏Î≤ÑÏä§': { base: 4500, volatility: 0.03 }
            };
            
            const priceInfo = realisticPrices[fund.name] || { base: 10000, volatility: 0.03 };
            
            // Í∏∞Ï§ÄÍ∞ÄÏóêÏÑú ¬±volatility Î≤îÏúÑÏùò Î≥ÄÎèô
            const variation = (Math.random() - 0.5) * 2 * priceInfo.volatility;
            const currentPrice = Math.round(priceInfo.base * (1 + variation));
            
            // Ï†ÑÏùº ÎåÄÎπÑ Î≥ÄÎèô Í≥ÑÏÇ∞
            const changePercent = variation * 100;
            const change = Math.round(currentPrice * (changePercent / 100));
            
            return {
                price: currentPrice,
                returnRate: changePercent,
                change: change,
                currency: 'KRW',
                volume: Math.floor(Math.random() * 500000) + 50000,
                source: 'realistic_simulation'
            };
        }

        // ETF/ÌéÄÎìú Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú
        function displayFundResults(funds, container) {
            if (funds.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            let html = '';
            funds.forEach(fund => {
                const isPositive = fund.returnRate >= 0;
                const returnClass = isPositive ? 'positive' : 'negative';
                const returnSymbol = isPositive ? '+' : '';
                
                // Ïã§Ï†ú Í∞ÄÍ≤©ÏúºÎ°ú ÌëúÏãú
                html += `
                    <div class="item-card" onclick="investFund('${fund.symbol}', '${fund.name}', ${fund.price}, '${fund.yahooSymbol || fund.symbol}')" style="cursor: pointer; margin-bottom: 10px;">
                        <div class="item-header">
                            <span class="item-title">${fund.name}</span>
                            <span class="item-price ${returnClass}">${returnSymbol}${fund.returnRate.toFixed(2)}%</span>
                        </div>
                        <div class="item-desc">
                            ${fund.description}<br>
                            Í∏∞Ï§ÄÍ∞Ä: ${fund.price.toLocaleString()}Ïõê<br>
                            Ïö¥Ïö©ÏÇ¨: ${fund.company} | Ïú†Ìòï: ${fund.type} | Î∂ÑÎ•ò: ${fund.category}
                            ${fund.source === 'yahoo_api' ? '<br><small style="color: #28a745;">‚úì Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞</small>' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Ïù∏Í∏∞ ETF/ÌéÄÎìú Î°úÎìú
        async function loadPopularFunds() {
            const popularDiv = document.getElementById('popularFunds');
            if (!popularDiv) return;
            
            try {
                console.log('üìà Ïù∏Í∏∞ ETF Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë');
                const popularFunds = await searchKoreanFunds('');
                displayFundResults(popularFunds, popularDiv);
            } catch (error) {
                console.error('Ïù∏Í∏∞ ETF Î°úÎìú Ïã§Ìå®:', error);
                popularDiv.innerHTML = '<div style="text-align: center; color: #666;">Ïù∏Í∏∞ ÏÉÅÌíàÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        // ETF/ÌéÄÎìú Ìà¨Ïûê Ìï®Ïàò ÏàòÏ†ï - Ïã§Ï†ú Í∞ÄÍ≤© ÏÇ¨Ïö©
        function investFund(symbol, productName, price, yahooSymbol) {
            // ETF/ÌéÄÎìúÎèÑ Ï∞®Ìä∏ Î™®Îã¨Î°ú ÌëúÏãú - Ïã§Ï†ú Í∞ÄÍ≤© ÏÇ¨Ïö©
            const displaySymbol = productName.replace(/\s+/g, '_'); // ÌëúÏãúÏö© Ïã¨Î≥º
            console.log(`üéØ ${productName} Ìà¨Ïûê Î™®Îã¨ Ïó¥Í∏∞ - Ïã§Ï†ú Í∞ÄÍ≤©: ${price}Ïõê`);
            
            // yahooSymbolÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ symbol ÏÇ¨Ïö©
            const apiSymbol = yahooSymbol || symbol;
            
            // showAssetChartÏóê Ïã§Ï†ú Í∞ÄÍ≤© Ï†ÑÎã¨
            showAssetChart(displaySymbol, productName, price, 'fund', 'KRW');
        }

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéñÔ∏è A3 Îì±Í∏â ÌéòÏù¥ÏßÄ Î°úÎìúÎê®');
            
            if (!checkLoginAndInit()) {
                return;
            }
            
            // Firebase Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            // Îì±Í∏â Ïπ¥ÎìúÏóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            const gradeCards = document.querySelectorAll('.grade-card');
            gradeCards.forEach(card => {
                const titleElement = card.querySelector('.grade-title') || card.querySelector('h3');
                if (titleElement) {
                    const title = titleElement.textContent;
                    card.addEventListener('click', () => {
                        handleGradeClick(title);
                    });
                }
            });
        }); // DOMContentLoaded Îã´Í∏∞

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ìï®Ïàò
        function goToPage(page) {
            console.log('üîÑ A3ÏóêÏÑú ÌéòÏù¥ÏßÄ Ïù¥Îèô:', page);
            
            // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÌôïÏù∏
            if (page === 'a3.html') {
                console.log('ÌòÑÏû¨ ÌéòÏù¥ÏßÄ(a3)ÏóêÏÑú ÎèôÏùº ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô ÏãúÎèÑ - Î¨¥Ïãú');
                return;
            }
            
            try {
                // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌôúÏÑ± ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // ÌéòÏù¥ÏßÄ Ïù¥Îèô
                console.log('ÌéòÏù¥ÏßÄ Ïù¥Îèô Ïã§Ìñâ:', page);
                window.location.href = page;
            } catch (error) {
                console.error('ÌéòÏù¥ÏßÄ Ïù¥Îèô Ïò§Î•ò:', error);
                alert('ÌéòÏù¥ÏßÄ Ïù¥Îèô Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Í∏∞ÌÉÄ Ìï®ÏàòÎì§
        function logout() {
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                localStorage.removeItem('fineu_current_user');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('ÏïåÎ¶º Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.');
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù (Î™®Îã¨ ÎÇ¥Î∂ÄÏóêÏÑú Ìò∏Ï∂ú Í∞ÄÎä•ÌïòÎèÑÎ°ù)
        window.addAccountItem = addAccountItem;
        window.subscribeSavings = subscribeSavings;
        window.searchStocks = searchStocks;
        window.buyStock = buyStock;
        window.applyLoan = applyLoan;
        window.searchFunds = searchFunds;
        window.investFund = investFund;
        window.showTradeModal = showTradeModal;
        window.closeModal = closeModal;
    </script>
</body>
</html>
