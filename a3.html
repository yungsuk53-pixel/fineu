<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - ë“±ê¸‰</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Chart.js for price charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApKJHvNXftrzXAZsH41FxqVj0_Byh_V28",
            authDomain: "invest-97aa7.firebaseapp.com",
            databaseURL: "https://invest-97aa7-default-rtdb.firebaseio.com",
            projectId: "invest-97aa7",
            storageBucket: "invest-97aa7.firebasestorage.app",
            messagingSenderId: "136719207030",
            appId: "1:136719207030:web:391bd46b7b79800c0fed57",
            measurementId: "G-78K35WTPGQ"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        console.log('ğŸ”¥ A3 Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* ê³µí†µ í—¤ë” */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .power-icon {
            width: 24px;
            height: 24px;
            color: #ff6b9d;
            font-size: 24px;
            cursor: pointer;
        }

        .fine-u-logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .logo-image {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .fine-text {
            color: #7cb9e8;
        }

        .u-text {
            color: #ffd700;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
            font-size: 20px;
            cursor: pointer;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            padding: 70px 20px 80px;
            max-width: 400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        /* ë“±ê¸‰ ì¹´ë“œ */
        .grade-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .grade-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .grade-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .grade-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .grade-card.locked:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .grade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .grade-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .lock-icon {
            font-size: 20px;
            color: #999;
        }

        .grade-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .grade-badge.green {
            background: #4caf50;
        }

        .grade-badge.blue {
            background: #2196f3;
        }

        .grade-badge.red {
            background: #f44336;
        }

        .grade-badge.black {
            background: #333;
        }

        .grade-description {
            font-size: 12px;
            color: #666;
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* ì¤‘ì•™ ë°˜ì› ëŒì¶œ ë¶€ë¶„ ì¶”ê°€ */
        .bottom-nav::before {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 65px;
            background: white;
            background-image: url('images/ë°°ê²½.png');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: -1;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .nav-item.active {
            color: #7cb9e8;
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .black-button {
            width: 55px;
            height: 55px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 150;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button {
            width: 55px;
            height: 55px;
            background: transparent;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: -35px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .grade-button:hover {
            transform: scale(1.1);
        }

        .grade-button img {
            width: 45px;
            height: 45px;
            object-fit: contain;
        }

        .black-button:hover {
            transform: scale(1.1);
        }

        /* ë“±ê¸‰ë³„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .yellow-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .green-button {
            background: linear-gradient(45deg, #32CD32, #228B22);
            color: white;
        }
        
        .blue-button {
            background: linear-gradient(45deg, #1E90FF, #0066CC);
            color: white;
        }
        
        .red-button {
            background: linear-gradient(45deg, #FF4444, #CC0000);
            color: white;
        }
        
        .black-button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .main-content {
                padding: 70px 15px 80px;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="header">
        <i class="fas fa-power-off power-icon" onclick="logout()"></i>
        <div class="fine-u-logo">
            <img src="images/ë ˆì´ì–´ 1.png" alt="FINE U ë¡œê³ " class="logo-image">
        </div>
        <i class="fas fa-bell notification-icon" onclick="showNotifications()"></i>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <div class="page-title">GRADE ZONE</div>

        <!-- ê°€ê³„ë¶€ -->
        <div class="grade-card">
            <div class="grade-header">
                <div class="grade-title">ê°€ê³„ë¶€</div>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge yellow">YELLOW</div>
                <div class="grade-description">ê¸°ë³¸ ê¸°ëŠ¥</div>
            </div>
        </div>

        <!-- ì˜ˆê¸ˆ ë° ì ê¸ˆ -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">ì˜ˆê¸ˆ ë° ì ê¸ˆ</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge green">GREEN</div>
                <div class="grade-description">ë“±ê¸‰ ë‹¬ì„± ì‹œ ì—´ëŒ ê°€ëŠ¥</div>
            </div>
        </div>

        <!-- ì£¼ì‹ íˆ¬ì -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">ì£¼ì‹ íˆ¬ì</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge blue">BLUE</div>
                <div class="grade-description">ë“±ê¸‰ ë‹¬ì„± ì‹œ ì—´ëŒ ê°€ëŠ¥</div>
            </div>
        </div>

        <!-- ëŒ€ì¶œ -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">ëŒ€ì¶œ</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge red">RED</div>
                <div class="grade-description">ë“±ê¸‰ ë‹¬ì„± ì‹œ ì—´ëŒ ê°€ëŠ¥</div>
            </div>
        </div>

        <!-- í€ë“œ -->
        <div class="grade-card locked">
            <div class="grade-header">
                <div class="grade-title">í€ë“œ</div>
                <i class="fas fa-lock lock-icon"></i>
            </div>
        </div>
        <div class="grade-info">
            <div class="grade-info-left">
                <div class="grade-badge black">BLACK</div>
                <div class="grade-description">ë“±ê¸‰ ë‹¬ì„± ì‹œ ì—´ëŒ ê°€ëŠ¥</div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="goToPage('a1.html')">
            <div class="nav-icon">
                <img src="images/ì§‘.png" alt="í™ˆ">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a2.html')">
            <div class="nav-icon">
                <img src="images/ë¬¸ì„œ.png" alt="ë¬¸ì„œ">
            </div>
        </div>
        <div class="grade-button" id="gradeButton" onclick="goToPage('a3.html')">
            <img id="gradeButtonImage" src="images/YELLOW ã…‡.png" alt="YELLOW">
        </div>
        <div class="nav-item" onclick="goToPage('a4.html')">
            <div class="nav-icon">
                <img src="images/ì±„íŒ….png" alt="ì±„íŒ…">
            </div>
        </div>
        <div class="nav-item" onclick="goToPage('a5.html')">
            <div class="nav-icon">
                <img src="images/ë”ë³´ê¸°.png" alt="ë”ë³´ê¸°">
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let userAssets = {};
        
        // ë“±ê¸‰ ì‹œìŠ¤í…œ ì„¤ì • (a1ê³¼ ë™ì¼)
        const levelSystem = {
            YELLOW: { name: 'YELLOW', exp: 0, max: 5000, image: 'YELLOW ã….png', nav: 'YELLOW ã…‡', navImage: 'YELLOW ã…‡.png' },
            GREEN: { name: 'GREEN', exp: 5000, max: 15000, image: 'GREEN ã….png', nav: 'GREEN ã…‡', navImage: 'GREEN ã…‡.png' },
            BLUE: { name: 'BLUE', exp: 15000, max: 30000, image: 'BLUE ã….png', nav: 'BLUE ã…‡', navImage: 'BLUE ã…‡.png' },
            RED: { name: 'RED', exp: 30000, max: 50000, image: 'RED ã….png', nav: 'RED ã…‡', navImage: 'RED ã…‡.png' },
            BLACK: { name: 'BLACK', exp: 50000, max: 999999, image: 'BLACK ã….png', nav: 'BLACK ã…‡', navImage: 'BLACK ã…‡.png' }
        };

        // ì‚¬ìš©ì ë“±ê¸‰ ê³„ì‚° (a1ê³¼ ë™ì¼)
        function calculateUserLevel(exp) {
            for (const [level, data] of Object.entries(levelSystem)) {
                if (exp >= data.exp && exp < data.max) {
                    return level;
                }
            }
            return 'BLACK'; // ìµœê³  ë“±ê¸‰
        }

        // ë“±ê¸‰ë³„ ìƒ‰ìƒ ë°˜í™˜ (a1ê³¼ ë™ì¼)
        function getUserLevelColor(level) {
            const colors = {
                'YELLOW': '#FFE99E',
                'GREEN': '#C1EDB3',
                'BLUE': '#ADD9FA',
                'RED': '#FAABAD',
                'BLACK': '#333333'
            };
            return colors[level] || colors['YELLOW'];
        }

        // ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (a4ì™€ ë™ì¼í•˜ê²Œ ì¶”ê°€)
        function updateGradeButton(grade) {
            const upperGrade = grade.toUpperCase();
            const levelData = levelSystem[upperGrade];
            
            if (levelData) {
                const gradeButton = document.getElementById('gradeButton');
                const gradeButtonImage = document.getElementById('gradeButtonImage');
                
                if (gradeButton && gradeButtonImage) {
                    gradeButtonImage.src = `images/${levelData.navImage}`;
                    gradeButtonImage.alt = levelData.name;
                    gradeButton.style.background = getUserLevelColor(upperGrade);
                    console.log('ğŸ–ï¸ A3 ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸:', upperGrade, levelData.navImage);
                }
            }
        }
        
        // ë“±ê¸‰ë³„ ì ê¸ˆ í•´ì œ ì¡°ê±´
        const gradeRequirements = {
            'yellow': 0,     // ê¸°ë³¸ ë“±ê¸‰
            'green': 5000,   // 5000 EXP
            'blue': 15000,   // 15000 EXP
            'red': 30000,    // 30000 EXP
            'black': 50000   // 50000 EXP
        };

        // ë“±ê¸‰ë³„ ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œ
        const menuAccess = {
            'ê°€ê³„ë¶€': 'yellow',
            'ì˜ˆê¸ˆ ë° ì ê¸ˆ': 'green', 
            'ì£¼ì‹ íˆ¬ì': 'blue',
            'ëŒ€ì¶œ': 'red',
            'í€ë“œ': 'black'
        };

        // ë¡œê·¸ì¸ í™•ì¸ ë° ì´ˆê¸°í™”
        function checkLoginAndInit() {
            const savedUser = localStorage.getItem('fineu_current_user');
            if (!savedUser) {
                console.log('âŒ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ - index.htmlë¡œ ì´ë™');
                window.location.href = 'index.html';
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            console.log('âœ… A3 ë¡œê·¸ì¸ ì‚¬ìš©ì:', currentUser.id);
            
            return true;
        }

        // Firebaseì—ì„œ ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (a1ê³¼ ë™ì¼)
        async function loadUserDataFromFirebase() {
            console.log('=== A3 ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');
            
            try {
                // 1. Firebase ì—°ê²° í™•ì¸
                if (!window.firebaseDB) {
                    console.log('A3 Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...');
                    setTimeout(loadUserDataFromFirebase, 1000);
                    return;
                }
                console.log('âœ… A3 Firebase ì—°ê²° í™•ì¸ë¨');

                // 2. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
                const currentUser = JSON.parse(localStorage.getItem('fineu_current_user') || '{}');
                const userId = currentUser.id || currentUser.username || 'Test';
                console.log('ğŸ‘¤ A3 ì‚¬ìš©ì ID:', userId);
                
                // 3. Firebaseì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);
                console.log('ğŸ“Š A3 ë°ì´í„° ìŠ¤ëƒ…ìƒ· í™•ì¸:', snapshot.exists());

                if (snapshot.exists()) {
                    // Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ
                    const firebaseData = snapshot.val();
                    console.log('âœ… A3 Firebase ë°ì´í„° ë¡œë“œ ì„±ê³µ:', firebaseData);
                    
                    // userAssetsì— ë°ì´í„° ì„¤ì •
                    userAssets = {
                        id: firebaseData.id || userId,
                        name: firebaseData.name || userId,
                        cash: firebaseData.cash || 0,
                        totalAssets: firebaseData.totalAssets || firebaseData.virtualBalance || firebaseData.cash || 0,
                        virtualBalance: firebaseData.virtualBalance || firebaseData.cash || 0,
                        level: firebaseData.level || 'yellow',
                        exp: firebaseData.exp || firebaseData.experience || 0,
                        experience: firebaseData.experience || firebaseData.exp || 0,
                        portfolio: firebaseData.portfolio || {},
                        joinDate: firebaseData.joinDate || new Date().toISOString().split('T')[0],
                        lastUpdated: firebaseData.lastUpdated || new Date().toISOString(),
                        studyProgress: firebaseData.studyProgress || {}
                    };
                    
                    console.log('âœ… A3 userAssets ì„¤ì • ì™„ë£Œ:', userAssets);
                    
                    // ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
                    const userLevel = calculateUserLevel(userAssets.exp);
                    updateGradeButton(userLevel);
                    
                    // ë“±ê¸‰ë³„ ë©”ë‰´ ì—…ë°ì´íŠ¸
                    updateMenuAccess();
                    
                } else {
                    // Firebaseì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„° ì„¤ì • (ê°€ìƒ íˆ¬ì ê¸ˆì•¡ ì œê±°)
                    console.log('âŒ A3 Firebaseì— ë°ì´í„° ì—†ìŒ - ì‹¤ì œ ë°ì´í„°ë§Œ ì„¤ì •');
                    userAssets = {
                        id: userId,
                        name: userId,
                        cash: 0, // ê°€ìƒ íˆ¬ì ê¸ˆì•¡ ì œê±°
                        totalAssets: 0,
                        virtualBalance: 0,
                        level: 'yellow',
                        exp: 0,
                        experience: 0,
                        portfolio: {},
                        joinDate: new Date().toISOString().split('T')[0],
                        lastUpdated: new Date().toISOString(),
                        studyProgress: {}
                    };
                    
                    // ê¸°ë³¸ ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
                    updateGradeButton('YELLOW');
                    updateMenuAccess();
                }
                
                // 5. localStorageì— ë°±ì—… ì €ì¥
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                console.log('âœ… A3 localStorage ë°±ì—… ì™„ë£Œ');

            } catch (error) {
                console.error('âŒ A3 ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™” (ê°€ìƒ íˆ¬ì ê¸ˆì•¡ ì œê±°)
                userAssets = {
                    id: 'Test',
                    name: 'Test',
                    cash: 0, // ê°€ìƒ íˆ¬ì ê¸ˆì•¡ ì œê±°
                    level: 'yellow',
                    exp: 0,
                    experience: 0
                };
                
                // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
                updateGradeButton('YELLOW');
                updateMenuAccess();
            }
        }

        // ì‚¬ìš©ì ë“±ê¸‰ ë¡œë“œ ë° í‘œì‹œ
        async function loadUserGrade() {
            try {
                if (!window.firebaseDB || !currentUser) {
                    console.log('ğŸ”¥ Firebase ë˜ëŠ” ì‚¬ìš©ì ì •ë³´ ëŒ€ê¸° ì¤‘...');
                    setTimeout(loadUserGrade, 500);
                    return;
                }
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}`);
                const snapshot = await window.firebaseGet(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const experience = userData.experience || 0;
                    const grade = calculateUserGrade(experience);
                    
                    // ë“±ê¸‰ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
                    updateGradeButton(grade.toUpperCase());
                    
                    // userAssets ì—…ë°ì´íŠ¸
                    userAssets.exp = experience;
                }
            } catch (error) {
                console.error('A3 ë“±ê¸‰ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë“±ê¸‰ë³„ ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œ ì—…ë°ì´íŠ¸
        function updateMenuAccess() {
            const userExp = userAssets.exp || userAssets.experience || 0;
            const userLevel = calculateUserLevel(userExp).toLowerCase();
            
            console.log('ğŸ”’ A3 ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œ ì—…ë°ì´íŠ¸:', userLevel, userExp);
            
            // ê° ë©”ë‰´ ì¹´ë“œì˜ ì ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
            Object.entries(menuAccess).forEach(([menuName, requiredLevel]) => {
                const requiredExp = gradeRequirements[requiredLevel];
                const isUnlocked = userExp >= requiredExp;
                
                // ì¹´ë“œ ì°¾ê¸° (ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ì‹œë„)
                let card = null;
                // ì œëª©ìœ¼ë¡œ ì¹´ë“œ ì°¾ê¸° (ê°€ê³„ë¶€ í¬í•¨)
                const cards = document.querySelectorAll('.grade-card');
                cards.forEach(c => {
                    const titleElement = c.querySelector('.grade-title') || c.querySelector('h3');
                    if (titleElement && titleElement.textContent === menuName) {
                        card = c;
                    }
                });
                
                if (card) {
                    if (isUnlocked) {
                        // ì ê¸ˆ í•´ì œ
                        card.classList.remove('locked');
                        const lockIcon = card.querySelector('.lock-icon');
                        if (lockIcon) lockIcon.style.display = 'none';
                        
                        // ë“±ê¸‰ ë°°ì§€ ì—…ë°ì´íŠ¸
                        const badge = card.querySelector('.grade-badge');
                        if (badge) {
                            badge.className = `grade-badge ${requiredLevel}`;
                            badge.textContent = requiredLevel.toUpperCase();
                        }
                        
                        console.log(`âœ… ${menuName} ì ê¸ˆ í•´ì œ (${userExp} >= ${requiredExp})`);
                    } else {
                        // ì ê¸ˆ ìƒíƒœ ìœ ì§€
                        card.classList.add('locked');
                        
                        // ì ê¸ˆ ì•„ì´ì½˜ ì¶”ê°€/í‘œì‹œ
                        let lockIcon = card.querySelector('.lock-icon');
                        if (!lockIcon) {
                            lockIcon = document.createElement('div');
                            lockIcon.className = 'lock-icon';
                            lockIcon.innerHTML = 'ğŸ”’';
                            lockIcon.style.cssText = `
                                position: absolute;
                                top: 10px;
                                right: 10px;
                                font-size: 20px;
                                background: rgba(255,255,255,0.9);
                                border-radius: 50%;
                                width: 35px;
                                height: 35px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                            `;
                            card.style.position = 'relative';
                            card.appendChild(lockIcon);
                        }
                        lockIcon.style.display = 'flex';
                        
                        // ë“±ê¸‰ ë°°ì§€ ì—…ë°ì´íŠ¸ (í•„ìš” ë“±ê¸‰ í‘œì‹œ)
                        const badge = card.querySelector('.grade-badge');
                        if (badge) {
                            badge.className = `grade-badge ${requiredLevel} locked`;
                            badge.textContent = `${requiredLevel.toUpperCase()} í•„ìš”`;
                            badge.style.opacity = '0.6';
                        }
                        
                        console.log(`ğŸ”’ ${menuName} ì ê¸ˆ ìƒíƒœ (${userExp} < ${requiredExp})`);
                    }
                }
            });
        }

        // ì‚¬ìš©ì ë“±ê¸‰ ê³„ì‚° (í˜¸í™˜ì„±)
        function calculateUserGrade(exp) {
            return calculateUserLevel(exp).toLowerCase();
        }

        // ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
        function canAccessMenu(menuName) {
            const userExp = userAssets.exp || 0;
            const userGrade = calculateUserGrade(userExp);
            const requiredGrade = menuAccess[menuName];
            
            const gradeOrder = ['yellow', 'green', 'blue', 'red', 'black'];
            const userGradeIndex = gradeOrder.indexOf(userGrade);
            const requiredGradeIndex = gradeOrder.indexOf(requiredGrade);
            
            return userGradeIndex >= requiredGradeIndex;
        }

        // ë“±ê¸‰ ì¹´ë“œ í´ë¦­ ì²˜ë¦¬
        function handleGradeClick(menuName) {
            const userExp = userAssets.exp || userAssets.experience || 0;
            const userLevel = calculateUserLevel(userExp).toLowerCase();
            
            // ê°€ê³„ë¶€ëŠ” í•­ìƒ ì ‘ê·¼ ê°€ëŠ¥
            if (menuName === 'ê°€ê³„ë¶€') {
                openMenuContent(menuName);
                return;
            }
            
            if (!canAccessMenu(menuName)) {
                const requiredLevel = menuAccess[menuName];
                const requiredExp = gradeRequirements[requiredLevel];
                const remainingExp = requiredExp - userExp;
                
                // ë” ì¹œê·¼í•œ ë©”ì‹œì§€ë¡œ ê°œì„ 
                const levelNames = {
                    'green': 'GREEN ê·¸ë¦°',
                    'blue': 'BLUE ë¸”ë£¨',
                    'red': 'RED ë ˆë“œ',
                    'black': 'BLACK ë¸”ë™'
                };
                
                const message = `ğŸ”’ ${menuName} ê¸°ëŠ¥ ì ê¸ˆë¨\n\n` +
                    `ğŸ“Š í˜„ì¬ ë“±ê¸‰: ${userLevel.toUpperCase()} (${userExp.toLocaleString()} EXP)\n` +
                    `ğŸ¯ í•„ìš” ë“±ê¸‰: ${levelNames[requiredLevel] || requiredLevel.toUpperCase()}\n` +
                    `â­ í•„ìš” ê²½í—˜ì¹˜: ${remainingExp.toLocaleString()} EXP ë” í•„ìš”\n\n` +
                    `ğŸ’¡ íŒ: í•™ìŠµ í™œë™ê³¼ íˆ¬ì ì‹¤ìŠµì„ í†µí•´ ê²½í—˜ì¹˜ë¥¼ ìŒ“ì•„ë³´ì„¸ìš”!`;
                
                alert(message);
                return;
            }
            
            // í•´ë‹¹ ë©”ë‰´ ì½˜í…ì¸  ì—´ê¸°
            openMenuContent(menuName);
        }

        // ë©”ë‰´ ì½˜í…ì¸  ì—´ê¸°
        function openMenuContent(menuName) {
            const modal = createModal(menuName);
            document.body.appendChild(modal);
            
            // ë©”ë‰´ë³„ ì½˜í…ì¸  ë¡œë“œ
            switch(menuName) {
                case 'ê°€ê³„ë¶€':
                    loadAccountBook(modal);
                    break;
                case 'ì˜ˆê¸ˆ ë° ì ê¸ˆ':
                    loadSavingsProducts(modal);
                    break;
                case 'ì£¼ì‹ íˆ¬ì':
                    loadStockMarket(modal);
                    break;
                case 'ëŒ€ì¶œ':
                    loadLoanProducts(modal);
                    break;
                case 'í€ë“œ':
                    loadETFAndFunds(modal);
                    break;
                default:
                    const modalBody = modal.querySelector('.modal-body');
                    modalBody.innerHTML = `
                        <div class="item-card">
                            <div class="item-desc">${menuName} ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
                        </div>
                    `;
            }
        }

        // ëª¨ë‹¬ ìƒì„±
        function createModal(title) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="close-btn" onclick="closeModal(this)">&times;</button>
                    </div>
                    <div class="modal-body" id="modal-body">
                        <div class="loading">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            `;
            
            // ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€
            if (!document.getElementById('modal-styles')) {
                const style = document.createElement('style');
                style.id = 'modal-styles';
                style.textContent = `
                    .modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    }
                    .modal-content {
                        background: white;
                        border-radius: 16px;
                        width: 90%;
                        max-width: 500px;
                        max-height: 80%;
                        overflow-y: auto;
                    }
                    .modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 1px solid #eee;
                    }
                    .modal-header h2 {
                        margin: 0;
                        font-size: 20px;
                        color: #333;
                    }
                    .close-btn {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                    }
                    .modal-body {
                        padding: 20px;
                        max-height: 60vh;
                        overflow-y: auto;
                    }
                    .loading {
                        text-align: center;
                        padding: 40px;
                        color: #666;
                    }
                    .item-card {
                        background: #f8f9fa;
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 10px;
                        border: 1px solid #eee;
                    }
                    .item-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                    }
                    .item-title {
                        font-weight: bold;
                        color: #333;
                    }
                    .item-price {
                        font-weight: bold;
                        color: #007bff;
                    }
                    .item-desc {
                        font-size: 14px;
                        color: #666;
                        line-height: 1.4;
                    }
                    .btn-primary {
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                    }
                    .btn-primary:hover {
                        background: #0056b3;
                    }
                    .stock-card {
                        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 10px;
                        cursor: pointer;
                    }
                    .stock-card.positive {
                        background: linear-gradient(135deg, #ffecee 0%, #ffd6d6 100%);
                    }
                    .stock-card.negative {
                        background: linear-gradient(135deg, #e8f4fd 0%, #d6eaff 100%);
                    }
                    .stock-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: start;
                        margin-bottom: 10px;
                    }
                    .stock-symbol {
                        font-weight: bold;
                        font-size: 16px;
                    }
                    .stock-price {
                        font-size: 18px;
                        font-weight: bold;
                    }
                    .stock-change {
                        font-size: 14px;
                        font-weight: 500;
                    }
                    .positive .stock-price,
                    .positive .stock-change {
                        color: #d32f2f;
                    }
                    .negative .stock-price,
                    .negative .stock-change {
                        color: #1976d2;
                    }
                    .account-input {
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        margin-bottom: 10px;
                    }
                    .account-form {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 15px;
                    }
                    
                    /* ì°¨íŠ¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
                    .chart-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 2000;
                    }
                    .chart-content {
                        background: white;
                        border-radius: 20px;
                        width: 95%;
                        max-width: 600px;
                        max-height: 90%;
                        overflow-y: auto;
                    }
                    .chart-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px;
                        border-bottom: 2px solid #f0f0f0;
                    }
                    .asset-info {
                        display: flex;
                        flex-direction: column;
                    }
                    .asset-name {
                        font-size: 22px;
                        font-weight: bold;
                        color: #333;
                    }
                    .asset-symbol {
                        font-size: 14px;
                        color: #666;
                        margin-top: 2px;
                    }
                    .current-price {
                        font-size: 24px;
                        font-weight: bold;
                        text-align: right;
                    }
                    .price-change {
                        font-size: 16px;
                        text-align: right;
                        margin-top: 4px;
                    }
                    .chart-body {
                        padding: 20px;
                    }
                    .chart-container {
                        position: relative;
                        height: 300px;
                        margin-bottom: 20px;
                    }
                    .trading-buttons {
                        display: flex;
                        gap: 10px;
                        margin-top: 20px;
                    }
                    .buy-btn {
                        flex: 1;
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 15px;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                    }
                    .sell-btn {
                        flex: 1;
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 15px;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                    }
                    .holdings-info {
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 10px;
                        margin-top: 15px;
                    }
                    .holdings-title {
                        font-weight: bold;
                        margin-bottom: 10px;
                        color: #333;
                    }
                    .holdings-details {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 5px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            return modal;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal(btn) {
            const modal = btn.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // ===== íˆ¬ì ìì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ =====
        
        // Firebaseì— ì‚¬ìš©ì í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥
        async function saveUserPortfolio() {
            try {
                console.log('ğŸ’¾ í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥ ì‹œì‘');
                console.log('ğŸ” Firebase DB:', !!window.firebaseDB);
                console.log('ğŸ‘¤ User ID:', userAssets.id);
                console.log('ğŸ“Š Portfolio Data:', userAssets.portfolio);
                
                if (!window.firebaseDB) {
                    console.error('âŒ Firebase DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    alert('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (!userAssets.id) {
                    console.error('âŒ ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤');
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const updateData = {
                    portfolio: userAssets.portfolio || {},
                    cash: userAssets.cash || 0,
                    totalAssets: userAssets.totalAssets || 0,
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('ğŸ“ ì—…ë°ì´íŠ¸í•  ë°ì´í„°:', updateData);
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userAssets.id}`);
                await window.firebaseUpdate(userRef, updateData);
                
                console.log('âœ… í¬íŠ¸í´ë¦¬ì˜¤ Firebase ì €ì¥ ì™„ë£Œ');
                
                // localStorageì—ë„ ë°±ì—… ì €ì¥
                localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                console.log('âœ… í¬íŠ¸í´ë¦¬ì˜¤ localStorage ë°±ì—… ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('íˆ¬ì ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                // ì‹¤íŒ¨ì‹œ localStorageì—ë¼ë„ ì €ì¥
                try {
                    localStorage.setItem('fineu_user_assets', JSON.stringify(userAssets));
                    console.log('âš ï¸ Firebase ì‹¤íŒ¨, localStorageì—ë§Œ ì €ì¥ë¨');
                } catch (localError) {
                    console.error('âŒ localStorage ì €ì¥ë„ ì‹¤íŒ¨:', localError);
                }
            }
        }

        // íˆ¬ì ìì‚° êµ¬ë§¤/íŒë§¤ ì²˜ë¦¬
        async function processTransaction(symbol, name, price, quantity, type, assetType = 'stock', currency = 'KRW') {
            try {
                console.log('ğŸ’° ê±°ë˜ ì²˜ë¦¬ ì‹œì‘:', {symbol, name, price, quantity, type, assetType, currency});
                
                const totalAmount = price * Math.abs(quantity);
                const isUSD = currency === 'USD';
                
                if (!userAssets.portfolio) {
                    userAssets.portfolio = {};
                }
                
                if (!userAssets.portfolio[symbol]) {
                    userAssets.portfolio[symbol] = {
                        name: name,
                        symbol: symbol,
                        type: assetType,
                        currency: currency,
                        quantity: 0,
                        avgPrice: 0,
                        totalInvested: 0,
                        currentPrice: price // í˜„ì¬ ê°€ê²© ì €ì¥
                    };
                }
                
                const holding = userAssets.portfolio[symbol];
                
                // í†µí™” ì •ë³´ ì—…ë°ì´íŠ¸
                holding.currency = currency;
                holding.currentPrice = price; // í˜„ì¬ ê°€ê²© ì—…ë°ì´íŠ¸
                
                if (type === 'buy') {
                    // ë§¤ìˆ˜ ì²˜ë¦¬
                    if (userAssets.cash < totalAmount) {
                        alert('ë³´ìœ  í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                        return false;
                    }
                    
                    const newTotalQuantity = holding.quantity + quantity;
                    const newTotalInvested = holding.totalInvested + totalAmount;
                    
                    holding.avgPrice = newTotalInvested / newTotalQuantity;
                    holding.quantity = newTotalQuantity;
                    holding.totalInvested = newTotalInvested;
                    
                    userAssets.cash -= totalAmount;
                    
                    const amountDisplay = formatPrice(totalAmount, currency, isUSD ? 2 : 0);
                    console.log('âœ… ë§¤ìˆ˜ ì™„ë£Œ:', {symbol, quantity, totalAmount});
                    alert(`${name} ${quantity}${assetType === 'fund' ? 'ì¢Œ' : 'ì£¼'}ë¥¼ ${amountDisplay}ì— ë§¤ìˆ˜í–ˆìŠµë‹ˆë‹¤.`);
                    
                } else if (type === 'sell') {
                    // ë§¤ë„ ì²˜ë¦¬
                    if (holding.quantity < quantity) {
                        alert('ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                        return false;
                    }
                    
                    holding.quantity -= quantity;
                    holding.totalInvested -= (holding.avgPrice * quantity);
                    userAssets.cash += totalAmount;
                    
                    // ëª¨ë“  ì£¼ì‹ì„ ë§¤ë„í•œ ê²½ìš° í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì œê±°
                    if (holding.quantity === 0) {
                        delete userAssets.portfolio[symbol];
                    }
                    
                    const amountDisplay = formatPrice(totalAmount, currency, isUSD ? 2 : 0);
                    console.log('âœ… ë§¤ë„ ì™„ë£Œ:', {symbol, quantity, totalAmount});
                    alert(`${name} ${quantity}${assetType === 'fund' ? 'ì¢Œ' : 'ì£¼'}ë¥¼ ${amountDisplay}ì— ë§¤ë„í–ˆìŠµë‹ˆë‹¤.`);
                }
                
                console.log('ğŸ’¾ Firebase ì €ì¥ ì‹œë„...');
                // ì „ì²´ ìì‚° ì¬ê³„ì‚°
                updateTotalAssets();
                
                // Firebaseì— ì €ì¥
                await saveUserPortfolio();
                
                console.log('ğŸ¯ ê±°ë˜ ì²˜ë¦¬ ì™„ì „ ì™„ë£Œ');
                return true;
                
            } catch (error) {
                console.error('âŒ ê±°ë˜ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ê±°ë˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                return false;
            }
        }

        // ì „ì²´ ìì‚° ì¬ê³„ì‚° (ë‹¤ì–‘í•œ ìì‚° ìœ í˜• ì§€ì›)
        function updateTotalAssets() {
            try {
                let totalPortfolioValue = 0;
                
                if (userAssets.portfolio) {
                    Object.values(userAssets.portfolio).forEach(holding => {
                        const assetType = holding.type || 'stock';
                        let assetValue = 0;
                        
                        if (assetType === 'stock' || assetType === 'fund') {
                            // ì£¼ì‹/í€ë“œ: ìˆ˜ëŸ‰ Ã— í˜„ì¬ê°€
                            const currentPrice = holding.currentPrice || holding.price || holding.avgPrice || 0;
                            assetValue = (holding.quantity || 0) * currentPrice;
                        } else if (assetType === 'savings') {
                            // ì˜ˆì ê¸ˆ: íˆ¬ì ê¸ˆì•¡ ê·¸ëŒ€ë¡œ
                            assetValue = holding.avgPrice || 0;
                        } else if (assetType === 'loan') {
                            // ëŒ€ì¶œ: ë¶€ì±„ì´ë¯€ë¡œ ìŒìˆ˜ë¡œ ê³„ì‚°
                            assetValue = -(holding.avgPrice || 0);
                        }
                        
                        totalPortfolioValue += assetValue;
                    });
                }
                
                userAssets.totalAssets = userAssets.cash + totalPortfolioValue;
                userAssets.virtualBalance = userAssets.totalAssets; // ê°€ìƒ ì”ê³ ë„ ì—…ë°ì´íŠ¸
                
                console.log('ğŸ“Š ì „ì²´ ìì‚° ì—…ë°ì´íŠ¸ (ë‹¤ì–‘í•œ ìì‚° ìœ í˜•):', {
                    cash: userAssets.cash,
                    portfolioValue: totalPortfolioValue,
                    totalAssets: userAssets.totalAssets
                });
            } catch (error) {
                console.error('ì „ì²´ ìì‚° ê³„ì‚° ì˜¤ë¥˜:', error);
            }
        }

        // ë™ì  ê°€ê²© ìƒì„± (ì‹¤ì‹œê°„ ë³€ë™)
        function generateDynamicPrice(basePrice, volatility = 0.02) {
            const change = (Math.random() - 0.5) * 2 * volatility;
            return Math.round(basePrice * (1 + change));
        }

        // ì°¨íŠ¸ ë°ì´í„° ìƒì„± (30ì¼ê°„ì˜ ê°€ê²© ë³€ë™)
        function generateChartData(currentPrice, days = 30) {
            const data = [];
            const labels = [];
            let price = currentPrice * 0.9; // ì‹œì‘ê°€ë¥¼ í˜„ì¬ê°€ì˜ 90%ë¡œ ì„¤ì •
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }));
                
                // ëœë¤í•œ ê°€ê²© ë³€ë™ ìƒì„±
                const change = (Math.random() - 0.5) * 0.04; // Â±2% ë³€ë™
                price = Math.max(price * (1 + change), currentPrice * 0.7); // ìµœì†Œ 70%
                data.push(Math.round(price));
            }
            
            // ë§ˆì§€ë§‰ ê°€ê²©ì„ í˜„ì¬ê°€ë¡œ ì¡°ì •
            data[data.length - 1] = currentPrice;
            
            return { labels, data };
        }

        // ì°¨íŠ¸ ëª¨ë‹¬ ìƒì„± ë° í‘œì‹œ (ì‹¤ì œ API ê°€ê²© ì‚¬ìš©)
        async function showAssetChart(symbol, name, passedPrice, assetType = 'stock', currency = 'KRW') {
            console.log(`ğŸ“Š ${name} ì°¨íŠ¸ ëª¨ë‹¬ ì—´ê¸° - ì „ë‹¬ë°›ì€ ê°€ê²©: ${passedPrice}`);
            
            // ì‹¤ì œ ìµœì‹  ê°€ê²© ë‹¤ì‹œ ì¡°íšŒ (ì •í™•ì„±ì„ ìœ„í•´)
            let currentPrice = passedPrice;
            try {
                let yahooSymbol = symbol;
                
                // ETF/í€ë“œì˜ ê²½ìš° Yahoo Finance ì‹¬ë³¼ ì²˜ë¦¬
                if (assetType === 'fund') {
                    // í•œêµ­ ETFëŠ” ì¢…ëª©ì½”ë“œ.KS ë˜ëŠ” .KQ í˜•ì‹
                    const etfSymbolMap = {
                        'KODEX_200': '069500.KS',
                        'TIGER_200': '102110.KS',
                        'KODEX_ì½”ìŠ¤ë‹¥150': '229200.KS',
                        'TIGER_ë‚˜ìŠ¤ë‹¥100': '133690.KS',
                        'KODEX_ë¯¸êµ­S&P500': '360750.KS',
                        'TIGER_ì°¨ì´ë‚˜ì „ê¸°ì°¨SOLACTIVE': '371460.KS',
                        'KODEX_2ì°¨ì „ì§€ì‚°ì—…': '305720.KS',
                        'TIGER_ë°˜ë„ì²´': '091230.KS',
                        'KODEX_ê³¨ë“œì„ ë¬¼': '132030.KS',
                        'TIGER_ì›ìœ ì„ ë¬¼Enhanced': '130680.KS',
                        'KODEX_ì¸ë²„ìŠ¤': '114800.KS',
                        'TIGER_ë¯¸êµ­ì±„10ë…„ì„ ë¬¼': '305080.KS'
                    };
                    
                    yahooSymbol = etfSymbolMap[symbol] || symbol;
                    
                    // .KSê°€ ì—†ìœ¼ë©´ ì¶”ê°€
                    if (!yahooSymbol.includes('.')) {
                        yahooSymbol += '.KS';
                    }
                } else if (!yahooSymbol.includes('.')) {
                    yahooSymbol += '.KS';
                }
                
                const latestData = await getYahooStockPrice(yahooSymbol);
                if (latestData && latestData.price) {
                    currentPrice = latestData.price;
                    currency = latestData.currency || currency;
                    console.log(`âœ… ${name} ìµœì‹  ê°€ê²© ì—…ë°ì´íŠ¸: ${currentPrice} ${currency}`);
                } else {
                    console.log(`âš ï¸ ${name} ìµœì‹  ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨, ì „ë‹¬ë°›ì€ ê°€ê²© ì‚¬ìš©: ${currentPrice}`);
                }
            } catch (error) {
                console.log(`âŒ ${name} ìµœì‹  ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
            }
            
            const chartModal = document.createElement('div');
            chartModal.className = 'chart-modal';
            
            const { labels, data } = generateChartData(currentPrice);
            const previousPrice = data[data.length - 2];
            const priceChange = currentPrice - previousPrice;
            const priceChangePercent = (priceChange / previousPrice * 100).toFixed(2);
            const isPositive = priceChange >= 0;
            
            // í†µí™”ë³„ ê°€ê²© í‘œì‹œ
            const isUSD = currency === 'USD';
            const priceDisplay = isUSD ? formatPrice(currentPrice, 'USD') : formatPrice(currentPrice, 'KRW', 0);
            const changeDisplay = isUSD ? formatPrice(Math.abs(priceChange), 'USD') : formatPrice(Math.abs(priceChange), 'KRW', 0);
            
            // ë³´ìœ  ìˆ˜ëŸ‰ í™•ì¸
            const holding = userAssets.portfolio && userAssets.portfolio[symbol] 
                ? userAssets.portfolio[symbol] 
                : { quantity: 0, avgPrice: 0, totalInvested: 0, currency: currency };
            
            // ìì‚° ìœ í˜•ë³„ ë‹¨ìœ„ ì„¤ì •
            const unitText = assetType === 'fund' ? 'ì¢Œ' : 'ì£¼';
            
            chartModal.innerHTML = `
                <div class="chart-content">
                    <div class="chart-header">
                        <div class="asset-info">
                            <div class="asset-name">${name}</div>
                            <div class="asset-symbol">${symbol} ${assetType === 'fund' ? '(ETF/í€ë“œ)' : ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="current-price" style="color: ${isPositive ? '#dc3545' : '#007bff'}">
                                ${priceDisplay}
                            </div>
                            <div class="price-change" style="color: ${isPositive ? '#dc3545' : '#007bff'}">
                                ${isPositive ? '+' : ''}${changeDisplay} (${isPositive ? '+' : ''}${priceChangePercent}%)
                            </div>
                        </div>
                        <button class="close-btn" onclick="this.closest('.chart-modal').remove()" style="margin-left: 15px;">&times;</button>
                    </div>
                    <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                        
                        ${holding.quantity > 0 ? `
                        <div class="holdings-info">
                            <div class="holdings-title">ë³´ìœ  í˜„í™©</div>
                            <div class="holdings-details">
                                <span>ë³´ìœ ìˆ˜ëŸ‰:</span>
                                <span>${holding.quantity.toLocaleString()}${unitText}</span>
                            </div>
                            <div class="holdings-details">
                                <span>í‰ê· ë‹¨ê°€:</span>
                                <span>${formatPrice(holding.avgPrice, currency, isUSD ? 2 : 0)}</span>
                            </div>
                            <div class="holdings-details">
                                <span>íˆ¬ìê¸ˆì•¡:</span>
                                <span>${formatPrice(holding.totalInvested, currency, isUSD ? 2 : 0)}</span>
                            </div>
                            <div class="holdings-details">
                                <span>í‰ê°€ê¸ˆì•¡:</span>
                                <span>${formatPrice(holding.quantity * currentPrice, currency, isUSD ? 2 : 0)}</span>
                            </div>
                            <div class="holdings-details">
                                <span>ì†ìµ:</span>
                                <span style="color: ${(holding.quantity * currentPrice - holding.totalInvested) >= 0 ? '#dc3545' : '#007bff'}">
                                    ${formatPrice((holding.quantity * currentPrice - holding.totalInvested), currency, isUSD ? 2 : 0)}
                                    (${(((holding.quantity * currentPrice - holding.totalInvested) / holding.totalInvested * 100)).toFixed(2)}%)
                                </span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="trading-buttons">
                            <button class="buy-btn" onclick="showTradeModal('${symbol}', '${name}', ${currentPrice}, 'buy', '${assetType}', '${currency}')">
                                ë§¤ìˆ˜
                            </button>
                            <button class="sell-btn" onclick="showTradeModal('${symbol}', '${name}', ${currentPrice}, 'sell', '${assetType}', '${currency}')" 
                                    ${holding.quantity === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                ë§¤ë„
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                            ğŸ’° ë³´ìœ  í˜„ê¸ˆ: ${userAssets.cash.toLocaleString()}ì›
                            ${isUSD ? `<br>ğŸ’µ ì•½ ${formatPrice(convertCurrency(userAssets.cash, 'KRW', 'USD'), 'USD')}` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(chartModal);
            
            // ì°¨íŠ¸ ìƒì„±
            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ê°€ê²©',
                        data: data,
                        borderColor: isPositive ? '#dc3545' : '#007bff',
                        backgroundColor: isPositive ? 'rgba(220, 53, 69, 0.1)' : 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ì›';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ê±°ë˜ ëª¨ë‹¬ í‘œì‹œ
        function showTradeModal(symbol, name, price, type, assetType = 'stock', currency = 'KRW') {
            const isBuy = type === 'buy';
            const isUSD = currency === 'USD';
            const holding = userAssets.portfolio && userAssets.portfolio[symbol] 
                ? userAssets.portfolio[symbol] 
                : { quantity: 0 };
            
            const maxQuantity = isBuy 
                ? Math.floor(userAssets.cash / price)
                : holding.quantity;
            
            if (maxQuantity === 0) {
                alert(isBuy ? 'ë³´ìœ  í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.' : 'ë³´ìœ  ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const priceDisplay = formatPrice(price, currency, isUSD ? 2 : 0);
            const cashDisplay = userAssets.cash.toLocaleString() + 'ì›';
            const usdCashDisplay = isUSD ? ` (ì•½ ${formatPrice(convertCurrency(userAssets.cash, 'KRW', 'USD'), 'USD')})` : '';
            const unitText = assetType === 'fund' ? 'ì¢Œ' : 'ì£¼';
            
            const quantity = prompt(
                `${name} ${isBuy ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}\n` +
                `í˜„ì¬ê°€: ${priceDisplay}\n` +
                `${isBuy ? 'ë³´ìœ  í˜„ê¸ˆ' : 'ë³´ìœ  ìˆ˜ëŸ‰'}: ${isBuy ? cashDisplay + usdCashDisplay : holding.quantity + unitText}\n` +
                `ìµœëŒ€ ${isBuy ? 'ë§¤ìˆ˜' : 'ë§¤ë„'} ê°€ëŠ¥: ${maxQuantity}${unitText}\n\n` +
                `${isBuy ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}í•  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”:`
            );
            
            if (quantity && parseInt(quantity) > 0 && parseInt(quantity) <= maxQuantity) {
                processTransaction(symbol, name, price, parseInt(quantity), type, assetType, currency);
                
                // ì°¨íŠ¸ ëª¨ë‹¬ ë‹«ê¸° ë° ë‹¤ì‹œ ì—´ê¸° (ì—…ë°ì´íŠ¸ëœ ì •ë³´ í‘œì‹œ)
                const chartModal = document.querySelector('.chart-modal');
                if (chartModal) {
                    chartModal.remove();
                    setTimeout(() => {
                        showAssetChart(symbol, name, price, assetType, currency);
                    }, 100);
                }
            } else if (quantity) {
                alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        // 1. ê°€ê³„ë¶€ ê¸°ëŠ¥
        async function loadAccountBook(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            // ê°€ê³„ë¶€ ë°ì´í„° ë¡œë“œ
            let accountData = {};
            try {
                if (window.firebaseDB && currentUser) {
                    const accountRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}/accountBook`);
                    const snapshot = await window.firebaseGet(accountRef);
                    if (snapshot.exists()) {
                        accountData = snapshot.val();
                    }
                }
            } catch (error) {
                console.error('ê°€ê³„ë¶€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            const today = new Date().toISOString().split('T')[0];
            const todayData = accountData[today] || { income: [], expense: [] };
            
            modalBody.innerHTML = `
                <div class="account-form">
                    <h3>ìˆ˜ì… ì¶”ê°€</h3>
                    <input type="text" id="incomeDesc" placeholder="ìˆ˜ì… ë‚´ìš©" class="account-input">
                    <input type="number" id="incomeAmount" placeholder="ê¸ˆì•¡" class="account-input">
                    <button class="btn-primary" onclick="addAccountItem('income')">ìˆ˜ì… ì¶”ê°€</button>
                </div>
                
                <div class="account-form">
                    <h3>ì§€ì¶œ ì¶”ê°€</h3>
                    <input type="text" id="expenseDesc" placeholder="ì§€ì¶œ ë‚´ìš©" class="account-input">
                    <input type="number" id="expenseAmount" placeholder="ê¸ˆì•¡" class="account-input">
                    <button class="btn-primary" onclick="addAccountItem('expense')">ì§€ì¶œ ì¶”ê°€</button>
                </div>
                
                <div class="account-summary">
                    <h3>ì˜¤ëŠ˜ì˜ ê°€ê³„ë¶€</h3>
                    <div id="account-list">
                        ${generateAccountList(todayData)}
                    </div>
                </div>
            `;
        }

        function generateAccountList(data) {
            let html = '';
            const totalIncome = data.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = data.expense.reduce((sum, item) => sum + item.amount, 0);
            
            html += `<div class="item-card">
                <div class="item-header">
                    <span class="item-title">ì´ ìˆ˜ì…</span>
                    <span class="item-price" style="color: #28a745;">+${totalIncome.toLocaleString()}ì›</span>
                </div>
            </div>`;
            
            html += `<div class="item-card">
                <div class="item-header">
                    <span class="item-title">ì´ ì§€ì¶œ</span>
                    <span class="item-price" style="color: #dc3545;">-${totalExpense.toLocaleString()}ì›</span>
                </div>
            </div>`;
            
            html += `<div class="item-card">
                <div class="item-header">
                    <span class="item-title">ì”ì•¡</span>
                    <span class="item-price">${(totalIncome - totalExpense).toLocaleString()}ì›</span>
                </div>
            </div>`;
            
            data.income.forEach(item => {
                html += `<div class="item-card">
                    <div class="item-header">
                        <span class="item-title">${item.description}</span>
                        <span class="item-price" style="color: #28a745;">+${item.amount.toLocaleString()}ì›</span>
                    </div>
                </div>`;
            });
            
            data.expense.forEach(item => {
                html += `<div class="item-card">
                    <div class="item-header">
                        <span class="item-title">${item.description}</span>
                        <span class="item-price" style="color: #dc3545;">-${item.amount.toLocaleString()}ì›</span>
                    </div>
                </div>`;
            });
            
            return html;
        }

        async function addAccountItem(type) {
            const desc = document.getElementById(`${type}Desc`).value;
            const amount = parseInt(document.getElementById(`${type}Amount`).value);
            
            if (!desc || !amount) {
                alert('ë‚´ìš©ê³¼ ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const item = {
                description: desc,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            
            try {
                if (window.firebaseDB && currentUser) {
                    const accountRef = window.firebaseRef(window.firebaseDB, `users/${currentUser.id}/accountBook/${today}/${type}`);
                    const snapshot = await window.firebaseGet(accountRef);
                    const currentData = snapshot.exists() ? snapshot.val() : [];
                    currentData.push(item);
                    
                    await window.firebaseSet(accountRef, currentData);
                    
                    // ê°€ê³„ë¶€ ë‹¤ì‹œ ë¡œë“œ
                    const modal = document.querySelector('.modal');
                    loadAccountBook(modal);
                }
            } catch (error) {
                console.error('ê°€ê³„ë¶€ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // 2. ì˜ˆì ê¸ˆ ìƒí’ˆ ê¸°ëŠ¥
        async function loadSavingsProducts(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            // ì‹¤ì œ ì˜ˆì ê¸ˆ ìƒí’ˆ ë°ì´í„° (ì€í–‰ë³„)
            const savingsProducts = [
                {
                    bank: 'KBêµ­ë¯¼ì€í–‰',
                    name: 'KB Star ì •ê¸°ì˜ˆê¸ˆ',
                    rate: '3.50%',
                    term: '12ê°œì›”',
                    minAmount: 1000000,
                    description: 'ìš°ëŒ€ê¸ˆë¦¬ ì¡°ê±´ ì‹œ ìµœëŒ€ 3.50%'
                },
                {
                    bank: 'ì‹ í•œì€í–‰',
                    name: 'ì  ì •ê¸°ì˜ˆê¸ˆ',
                    rate: '3.40%',
                    term: '12ê°œì›”',
                    minAmount: 500000,
                    description: 'ì‹ ê·œê³ ê° ìš°ëŒ€ê¸ˆë¦¬ ì ìš©'
                },
                {
                    bank: 'í•˜ë‚˜ì€í–‰',
                    name: 'í•˜ë‚˜ ì›í ì •ê¸°ì˜ˆê¸ˆ',
                    rate: '3.30%',
                    term: '12ê°œì›”',
                    minAmount: 1000000,
                    description: 'ì˜¨ë¼ì¸ ì „ìš© íŠ¹ë³„ê¸ˆë¦¬'
                },
                {
                    bank: 'IBKê¸°ì—…ì€í–‰',
                    name: 'i-ONE ì •ê¸°ì˜ˆê¸ˆ',
                    rate: '3.25%',
                    term: '6ê°œì›”',
                    minAmount: 300000,
                    description: '6ê°œì›” ë‹¨ê¸° ê³ ê¸ˆë¦¬ ìƒí’ˆ'
                },
                {
                    bank: 'ìš°ë¦¬ì€í–‰',
                    name: 'WON ì •ê¸°ì˜ˆê¸ˆ',
                    rate: '3.45%',
                    term: '24ê°œì›”',
                    minAmount: 2000000,
                    description: 'ì¥ê¸° íˆ¬ì ìš°ëŒ€ê¸ˆë¦¬'
                }
            ];
            
            let html = '';
            savingsProducts.forEach(product => {
                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-title">${product.bank}</span>
                            <span class="item-price">${product.rate}</span>
                        </div>
                        <div class="item-desc">
                            <strong>${product.name}</strong><br>
                            ê¸°ê°„: ${product.term} | ìµœì†Œê¸ˆì•¡: ${product.minAmount.toLocaleString()}ì›<br>
                            ${product.description}
                        </div>
                        <button class="btn-primary" onclick="subscribeSavings('${product.name}', '${product.rate}', ${product.minAmount})">
                            ê°€ì…í•˜ê¸°
                        </button>
                    </div>
                `;
            });
            
            modalBody.innerHTML = html;
        }

        async function subscribeSavings(productName, rate, minAmount) {
            const amount = prompt(`${productName} ê°€ì…\nìµœì†Œ ê°€ì…ê¸ˆì•¡: ${minAmount.toLocaleString()}ì›\nê°€ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”:`);
            if (amount && parseInt(amount) >= minAmount) {
                const investAmount = parseInt(amount);
                
                // processTransactionì„ ì‚¬ìš©í•˜ì—¬ Firebaseì— ì €ì¥
                const success = await processTransaction(
                    `SAVINGS_${productName.replace(/\s/g, '_')}`, // ì‹¬ë³¼ ìƒì„±
                    productName,
                    investAmount, // ê°€ê²© (ì „ì²´ íˆ¬ì ê¸ˆì•¡)
                    1, // ìˆ˜ëŸ‰ (1ê°œ ìƒí’ˆ)
                    'buy',
                    'savings', // ìì‚° íƒ€ì…
                    'KRW'
                );
                
                if (success) {
                    alert(`${productName}ì— ${investAmount.toLocaleString()}ì›ìœ¼ë¡œ ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤.\nì—°ì´ìœ¨: ${rate}`);
                }
            } else if (amount) {
                alert(`ìµœì†Œ ê°€ì…ê¸ˆì•¡ì€ ${minAmount.toLocaleString()}ì›ì…ë‹ˆë‹¤.`);
            }
        }

        // 3. ì£¼ì‹ ì‹œì¥ ê¸°ëŠ¥
        async function loadStockMarket(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            try {
                // ê²€ìƒ‰ ê¸°ëŠ¥ í¬í•¨í•œ ì£¼ì‹ ì¸í„°í˜ì´ìŠ¤
                let html = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="stockSearch" placeholder="ì£¼ì‹ëª… ë˜ëŠ” ì¢…ëª©ì½”ë“œ ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì, 005930)" 
                                   style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                                   onkeypress="if(event.key==='Enter') searchStocks()">
                            <button onclick="searchStocks()" style="padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">ê²€ìƒ‰</button>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                            ğŸ’¡ íŒ: ì¢…ëª©ëª…(ì‚¼ì„±ì „ì) ë˜ëŠ” ì¢…ëª©ì½”ë“œ(005930)ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <div id="stockResults">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            ìœ„ì—ì„œ ì£¼ì‹ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <h4 style="margin-bottom: 15px; color: #333;">ì¸ê¸° ì¢…ëª©</h4>
                        <div id="popularStocks">
                            <div style="text-align: center; color: #666;">ì¸ê¸° ì¢…ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                `;
                
                modalBody.innerHTML = html;
                
                // ì¸ê¸° ì¢…ëª© ë¡œë“œ
                loadPopularStocks();
                
            } catch (error) {
                console.error('ì£¼ì‹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                modalBody.innerHTML = `
                    <div class="item-card">
                        <div class="item-desc">ì£¼ì‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                `;
            }
        }

        // ì£¼ì‹ ê²€ìƒ‰ í•¨ìˆ˜
        async function searchStocks() {
            const searchInput = document.getElementById('stockSearch');
            const resultsDiv = document.getElementById('stockResults');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ì‹¤ì‹œê°„ ì£¼ì‹ ì •ë³´ë¥¼ ê²€ìƒ‰ ì¤‘...</div>';
            
            try {
                // í•œêµ­ ì£¼ì‹ ê²€ìƒ‰ (Yahoo Finance ì‚¬ìš©)
                let stocks = await searchKoreanStocks(query);
                
                // ë¯¸êµ­ ì£¼ì‹ë„ ê²€ìƒ‰í•˜ë ¤ë©´ .KS/.KQ ì—†ì´ ê²€ìƒ‰
                if (stocks.length === 0) {
                    stocks = await searchGlobalStocks(query);
                }
                
                displaySearchResults(stocks, resultsDiv);
            } catch (error) {
                console.error('ì£¼ì‹ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
            }
        }

        // í•œêµ­ ì£¼ì‹ ê²€ìƒ‰
        // í•œêµ­ ì£¼ì‹ ê²€ìƒ‰ - Yahoo Finance API ì‚¬ìš©
        async function searchKoreanStocks(query) {
            try {
                console.log('ğŸ” ì‹¤ì œ Yahoo Finance APIë¡œ ê²€ìƒ‰ ì‹œì‘:', query);
                
                // 1ì°¨: ì§ì ‘ ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë§¤ì¹­í•˜ì—¬ ì‹¤ì œ API í˜¸ì¶œ
                const directResult = await searchFromLocalDatabase(query);
                if (directResult && directResult.length > 0) {
                    console.log('âœ… ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ ë§¤ì¹­ + ì‹¤ì œ API ì„±ê³µ:', directResult.length, 'ê°œ');
                    return directResult;
                }
                
                // 2ì°¨: Yahoo Finance ê²€ìƒ‰ API ì‚¬ìš©
                const searchUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=20&newsCount=0&enableFuzzyQuery=false&quotesQueryId=tss_match_phrase_query&multiQuoteQueryId=multi_quote_single_token_query&enableCb=true&enableNavLinks=false&enableEnhancedTrivialQuery=true&region=KR&lang=ko`;
                
                // CORS ìš°íšŒë¥¼ ìœ„í•œ í”„ë¡ì‹œ ì‚¬ìš©
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const searchData = JSON.parse(data.contents);
                
                const stocksWithPrices = [];
                
                if (searchData.quotes && searchData.quotes.length > 0) {
                    console.log('ğŸŒ Yahoo Finance ê²€ìƒ‰ ê²°ê³¼:', searchData.quotes.length, 'ê°œ');
                    
                    // í•œêµ­ ì£¼ì‹ë§Œ í•„í„°ë§ (.KS, .KQë¡œ ëë‚˜ëŠ” ê²ƒ)
                    const koreanStocks = searchData.quotes.filter(quote => 
                        quote.symbol && (quote.symbol.endsWith('.KS') || quote.symbol.endsWith('.KQ'))
                    );
                    
                    console.log('ğŸ‡°ğŸ‡· í•œêµ­ ì£¼ì‹ í•„í„°ë§ ê²°ê³¼:', koreanStocks.length, 'ê°œ');
                    
                    // ê° ì£¼ì‹ì˜ ì‹¤ì‹œê°„ ê°€ê²© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    for (const stock of koreanStocks.slice(0, 10)) { // ìµœëŒ€ 10ê°œ
                        try {
                            const priceData = await getYahooStockPrice(stock.symbol);
                            if (priceData) {
                                stocksWithPrices.push({
                                    symbol: stock.symbol.replace('.KS', '').replace('.KQ', ''),
                                    name: stock.longname || stock.shortname || stock.symbol,
                                    sector: stock.typeDisp || stock.quoteType || 'ì£¼ì‹',
                                    currency: 'KRW',
                                    isUSD: false,
                                    ...priceData
                                });
                            }
                        } catch (error) {
                            console.log(`${stock.symbol} ê°€ê²© ë¡œë“œ ì‹¤íŒ¨`);
                        }
                    }
                }
                
                console.log('âœ… Yahoo Finance API ê²€ìƒ‰ ì™„ë£Œ:', stocksWithPrices.length, 'ê°œ');
                return stocksWithPrices;
                
            } catch (error) {
                console.error('Yahoo Finance ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                console.log('âš ï¸ API ì‹¤íŒ¨ë¡œ ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©');
                // ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš© (ì´ì œ ì‹¤ì œ API ì‹œë„í•¨)
                return await searchFromLocalDatabase(query);
            }
        }

        // Yahoo Financeì—ì„œ ì‹¤ì‹œê°„ ì£¼ê°€ ê°€ì ¸ì˜¤ê¸°
        async function getYahooStockPrice(symbol) {
            // íƒ€ì„ì•„ì›ƒ ê¸°ëŠ¥ì´ ìˆëŠ” fetch í•¨ìˆ˜
            const fetchWithTimeout = async (url, timeout = 5000) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            };

            // ì—¬ëŸ¬ í”„ë¡ì‹œ ì„œë²„ ëª©ë¡ (ìˆœì„œëŒ€ë¡œ ì‹œë„)
            const proxyServers = [
                { url: 'https://cors-anywhere.herokuapp.com/', type: 'direct' },
                { url: 'https://api.allorigins.win/get?url=', type: 'allorigins' },
                { url: 'https://corsproxy.io/?', type: 'direct' }
            ];
            
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
            
            for (let i = 0; i < proxyServers.length; i++) {
                try {
                    console.log(`ğŸ”„ ${symbol} í”„ë¡ì‹œ ${i + 1} ì‹œë„`);
                    
                    let response;
                    let chartData;
                    
                    if (proxyServers[i].type === 'allorigins') {
                        // AllOrigins ë°©ì‹
                        const proxyUrl = `${proxyServers[i].url}${encodeURIComponent(yahooUrl)}`;
                        response = await fetchWithTimeout(proxyUrl, 3000);
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const data = await response.json();
                        if (!data.contents) throw new Error('No contents in response');
                        
                        chartData = JSON.parse(data.contents);
                    } else {
                        // ì§ì ‘ í”„ë¡ì‹œ ë°©ì‹
                        const proxyUrl = `${proxyServers[i].url}${yahooUrl}`;
                        response = await fetchWithTimeout(proxyUrl, 3000);
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        chartData = await response.json();
                    }
                    
                    // ë°ì´í„° íŒŒì‹±
                    if (chartData.chart && chartData.chart.result && chartData.chart.result[0]) {
                        const result = chartData.chart.result[0];
                        const meta = result.meta;
                        const quote = result.indicators.quote[0];
                        
                        const currentPrice = meta.regularMarketPrice || quote.close[quote.close.length - 1];
                        const previousClose = meta.previousClose || meta.chartPreviousClose;
                        const change = currentPrice - previousClose;
                        const changePercent = (change / previousClose) * 100;
                        
                        const currency = meta.currency || 'KRW';
                        const isUSD = currency === 'USD';
                        
                        console.log(`âœ… ${symbol} ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:`, currentPrice, currency);
                        
                        return {
                            price: isUSD ? parseFloat(currentPrice.toFixed(2)) : Math.round(currentPrice),
                            change: change,
                            changePercent: changePercent,
                            volume: quote.volume ? quote.volume[quote.volume.length - 1] : 0,
                            high: meta.regularMarketDayHigh,
                            low: meta.regularMarketDayLow,
                            currency: currency,
                            source: 'yahoo_api'
                        };
                    }
                    
                } catch (error) {
                    // ë§ˆì§€ë§‰ í”„ë¡ì‹œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê°„ë‹¨í•œ ë¡œê·¸
                    if (i === proxyServers.length - 1) {
                        console.log(`âŒ ${symbol} ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨`);
                        throw new Error(`ëª¨ë“  í”„ë¡ì‹œ ì„œë²„ ì‹¤íŒ¨: ${error.message}`);
                    }
                    continue;
                }
            }
        }

        // ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê²€ìƒ‰ (í´ë°±) - ì‹¤ì œ API ìš°ì„  ì‚¬ìš©
        async function searchFromLocalDatabase(query) {
            // ê¸°ì¡´ koreanStocks ë°°ì—´ ì‚¬ìš©
            const koreanStocks = [
                { symbol: '005930', name: 'ì‚¼ì„±ì „ì', sector: 'ë°˜ë„ì²´' },
                { symbol: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', sector: 'ë°˜ë„ì²´' },
                { symbol: '035420', name: 'NAVER', sector: 'ì¸í„°ë„·' },
                { symbol: '005380', name: 'í˜„ëŒ€ì°¨', sector: 'ìë™ì°¨' },
                { symbol: '051910', name: 'LGí™”í•™', sector: 'í™”í•™' },
                { symbol: '035720', name: 'ì¹´ì¹´ì˜¤', sector: 'ì¸í„°ë„·' },
                { symbol: '207940', name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', sector: 'ë°”ì´ì˜¤' },
                { symbol: '068270', name: 'ì…€íŠ¸ë¦¬ì˜¨', sector: 'ë°”ì´ì˜¤' },
                { symbol: '373220', name: 'LGì—ë„ˆì§€ì†”ë£¨ì…˜', sector: 'ë°°í„°ë¦¬' },
                { symbol: '000270', name: 'ê¸°ì•„', sector: 'ìë™ì°¨' },
                { symbol: '006400', name: 'ì‚¼ì„±SDI', sector: 'ë°°í„°ë¦¬' },
                { symbol: '105560', name: 'KBê¸ˆìœµ', sector: 'ê¸ˆìœµ' },
                { symbol: '055550', name: 'ì‹ í•œì§€ì£¼', sector: 'ê¸ˆìœµ' },
                { symbol: '086790', name: 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', sector: 'ê¸ˆìœµ' },
                { symbol: '066570', name: 'LGì „ì', sector: 'ì „ì' },
                { symbol: '003550', name: 'LG', sector: 'í™”í•™' },
                { symbol: '096770', name: 'SKì´ë…¸ë² ì´ì…˜', sector: 'í™”í•™' },
                { symbol: '017670', name: 'SKí…”ë ˆì½¤', sector: 'í†µì‹ ' },
                { symbol: '030200', name: 'KT', sector: 'í†µì‹ ' },
                { symbol: '032830', name: 'ì‚¼ì„±ìƒëª…', sector: 'ë³´í—˜' },
                { symbol: '009150', name: 'ì‚¼ì„±ì „ê¸°', sector: 'ì „ìë¶€í’ˆ' },
                { symbol: '018260', name: 'ì‚¼ì„±ì—ìŠ¤ë””ì—ìŠ¤', sector: 'ITì„œë¹„ìŠ¤' },
                { symbol: '012330', name: 'í˜„ëŒ€ëª¨ë¹„ìŠ¤', sector: 'ìë™ì°¨ë¶€í’ˆ' },
                { symbol: '028260', name: 'ì‚¼ì„±ë¬¼ì‚°', sector: 'ê±´ì„¤' },
                { symbol: '010950', name: 'S-Oil', sector: 'ì •ìœ ' },
                { symbol: '267250', name: 'í˜„ëŒ€ì¤‘ê³µì—…', sector: 'ì¡°ì„ ' },
                { symbol: '009540', name: 'HDí•œêµ­ì¡°ì„ í•´ì–‘', sector: 'ì¡°ì„ ' },
                { symbol: '034730', name: 'SK', sector: 'ì§€ì£¼íšŒì‚¬' },
                { symbol: '323410', name: 'ì¹´ì¹´ì˜¤ë±…í¬', sector: 'ì€í–‰' },
                { symbol: '352820', name: 'í•˜ì´ë¸Œ', sector: 'ì—”í„°í…Œì¸ë¨¼íŠ¸' },
                { symbol: '034020', name: 'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°', sector: 'ë°œì „ì„¤ë¹„' },
                { symbol: '003490', name: 'ëŒ€í•œí•­ê³µ', sector: 'í•­ê³µ' },
                { symbol: '011170', name: 'ë¡¯ë°ì¼€ë¯¸ì¹¼', sector: 'í™”í•™' },
                { symbol: '047050', name: 'í¬ìŠ¤ì½”ì¸í„°ë‚´ì…”ë„', sector: 'ë¬´ì—­' },
                { symbol: '001570', name: 'ê¸ˆì–‘', sector: 'ê±´ì„¤' },
                { symbol: '028050', name: 'ì‚¼ì„±ì—”ì§€ë‹ˆì–´ë§', sector: 'ê±´ì„¤' },
                { symbol: '036570', name: 'ì—”ì”¨ì†Œí”„íŠ¸', sector: 'ê²Œì„' },
                { symbol: '251270', name: 'ë„·ë§ˆë¸”', sector: 'ê²Œì„' },
                { symbol: '112040', name: 'ìœ„ë©”ì´ë“œ', sector: 'ê²Œì„' },
                { symbol: '259960', name: 'í¬ë˜í”„í†¤', sector: 'ê²Œì„' }
            ];
            
            let matchedStocks = koreanStocks.filter(stock => 
                stock.name.includes(query) || 
                stock.symbol.includes(query) ||
                stock.sector.includes(query)
            );
            
            // ì‹¤ì œ Yahoo Finance APIë¡œ ê°€ê²© ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì•ˆì •ì„± í–¥ìƒ)
            const stocksWithRealPrices = [];
            const maxConcurrentRequests = 3; // ë™ì‹œ ìš”ì²­ ìˆ˜ ì œí•œ
            
            for (let i = 0; i < matchedStocks.slice(0, 10).length; i += maxConcurrentRequests) {
                const batch = matchedStocks.slice(i, i + maxConcurrentRequests);
                const batchPromises = batch.map(async stock => {
                    try {
                        console.log(`ğŸ” ${stock.name} (${stock.symbol}) ê°€ê²© ì¡°íšŒ ì‹œë„`);
                        
                        // í•œêµ­ ì£¼ì‹ì€ .KS ë˜ëŠ” .KQ ì ‘ë¯¸ì‚¬ ì‹œë„
                        let priceData = null;
                        
                        // 1ì°¨: .KS (ì½”ìŠ¤í”¼) ì‹œë„
                        try {
                            priceData = await getYahooStockPrice(stock.symbol + '.KS');
                        } catch (error) {
                            console.log(`${stock.symbol}.KS ì‹¤íŒ¨, .KQ ì‹œë„`);
                        }
                        
                        // 2ì°¨: .KQ (ì½”ìŠ¤ë‹¥) ì‹œë„
                        if (!priceData) {
                            try {
                                priceData = await getYahooStockPrice(stock.symbol + '.KQ');
                            } catch (error) {
                                console.log(`${stock.symbol}.KQë„ ì‹¤íŒ¨`);
                            }
                        }
                        
                        if (priceData && priceData.price) {
                            console.log(`âœ… ${stock.name} ì‹¤ì œ API ë°ì´í„° ì‚¬ìš©: ${priceData.price}ì›`);
                            return {
                                symbol: stock.symbol,
                                name: stock.name,
                                sector: stock.sector,
                                price: priceData.price,
                                change: priceData.change || 0,
                                changePercent: priceData.changePercent || 0,
                                volume: priceData.volume || 0,
                                currency: 'KRW',
                                source: 'yahoo_api'
                            };
                        } else {
                            // API ì‹¤íŒ¨ ì‹œ í˜„ì‹¤ì ì¸ ê°€ê²© ìƒì„±
                            console.log(`ğŸ“Š ${stock.name} í˜„ì‹¤ì  ê°€ê²© ìƒì„±`);
                            return generateRealisticPrice(stock);
                        }
                        
                    } catch (error) {
                        console.log(`âš ï¸ ${stock.name} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
                        return generateRealisticPrice(stock);
                    }
                });
                
                // ë°°ì¹˜ ì²˜ë¦¬ ì™„ë£Œ ëŒ€ê¸°
                const batchResults = await Promise.allSettled(batchPromises);
                batchResults.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        stocksWithRealPrices.push(result.value);
                    }
                });
                
                // ì„œë²„ ê³¼ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ ë”œë ˆì´
                if (i + maxConcurrentRequests < matchedStocks.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`ğŸ¯ ${query} ê²€ìƒ‰ ì™„ë£Œ: ${stocksWithRealPrices.length}ê°œ ì¢…ëª©`);
            return stocksWithRealPrices;
        }
        
        // í˜„ì‹¤ì ì¸ ì£¼ì‹ ê°€ê²© ìƒì„±
        function generateRealisticPrice(stock) {
            // ì£¼ìš” ì¢…ëª©ë³„ í˜„ì‹¤ì ì¸ ê°€ê²©ëŒ€
            const realisticPrices = {
                '005930': { base: 75000, volatility: 0.03 },   // ì‚¼ì„±ì „ì
                '000660': { base: 85000, volatility: 0.04 },   // SKí•˜ì´ë‹‰ìŠ¤
                '035420': { base: 200000, volatility: 0.03 },  // NAVER
                '005380': { base: 185000, volatility: 0.04 },  // í˜„ëŒ€ì°¨
                '051910': { base: 420000, volatility: 0.03 },  // LGí™”í•™
                '207940': { base: 155000, volatility: 0.05 },  // ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤
                '035720': { base: 95000, volatility: 0.06 },   // ì¹´ì¹´ì˜¤
                '068270': { base: 180000, volatility: 0.05 }   // ì…€íŠ¸ë¦¬ì˜¨
            };
            
            const priceInfo = realisticPrices[stock.symbol] || { base: 50000, volatility: 0.04 };
            
            // ê¸°ì¤€ê°€ì—ì„œ Â±volatility ë²”ìœ„ì˜ ë³€ë™
            const variation = (Math.random() - 0.5) * 2 * priceInfo.volatility;
            const currentPrice = Math.round(priceInfo.base * (1 + variation));
            
            // ì „ì¼ ëŒ€ë¹„ ë³€ë™ ê³„ì‚°
            const changePercent = variation * 100; // volatilityë¥¼ ê·¸ëŒ€ë¡œ ë³€ë™ë¥ ë¡œ ì‚¬ìš©
            const change = Math.round(currentPrice * (changePercent / 100));
            
            return {
                symbol: stock.symbol,
                name: stock.name,
                sector: stock.sector,
                price: currentPrice,
                change: change,
                changePercent: changePercent,
                volume: Math.floor(Math.random() * 1000000) + 100000,
                currency: 'KRW',
                source: 'realistic_simulation'
            };
        }

        // ê¸€ë¡œë²Œ ì£¼ì‹ ê²€ìƒ‰ (ë¯¸êµ­, ì¼ë³¸ ë“±)
        async function searchGlobalStocks(query) {
            try {
                const searchUrl = `https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=10&newsCount=0`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(searchUrl)}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const searchData = JSON.parse(data.contents);
                
                const stocksWithPrices = [];
                
                if (searchData.quotes) {
                    for (const stock of searchData.quotes.slice(0, 5)) {
                        const priceData = await getYahooStockPrice(stock.symbol);
                        if (priceData) {
                            stocksWithPrices.push({
                                symbol: stock.symbol,
                                name: stock.longname || stock.shortname,
                                sector: stock.exchange || 'í•´ì™¸ì£¼ì‹',
                                ...priceData
                            });
                        }
                    }
                }
                
                return stocksWithPrices;
            } catch (error) {
                console.error('ê¸€ë¡œë²Œ ì£¼ì‹ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                return [];
            }
        }

        // í™˜ìœ¨ ê³„ì‚° í•¨ìˆ˜
        function getExchangeRate() {
            // ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•˜ì§€ë§Œ, ì‹œë®¬ë ˆì´ì…˜ìš© ê³ ì • í™˜ìœ¨ ì‚¬ìš©
            return 1320; // 1ë‹¬ëŸ¬ = 1320ì› (ì˜ˆì‹œ)
        }

        function convertCurrency(amount, fromCurrency, toCurrency) {
            const exchangeRate = getExchangeRate();
            
            if (fromCurrency === 'USD' && toCurrency === 'KRW') {
                return amount * exchangeRate;
            } else if (fromCurrency === 'KRW' && toCurrency === 'USD') {
                return amount / exchangeRate;
            }
            return amount;
        }

        function formatPrice(price, currency, decimals = 2) {
            if (currency === 'USD') {
                return '$' + price.toFixed(decimals);
            } else {
                return price.toLocaleString() + 'ì›';
            }
        }

        // ì£¼ì‹ ê°€ê²© ìƒì„± (ì‹¤ì œ API ëŒ€ì‹  í˜„ì‹¤ì ì¸ ëœë¤ ë°ì´í„°)
        function generateStockPrice(symbol) {
            // ì¢…ëª©ë³„ ê¸°ë³¸ ê°€ê²© ì„¤ì •
            const basePrices = {
                '005930': 70000,  // ì‚¼ì„±ì „ì
                '000660': 120000, // SKí•˜ì´ë‹‰ìŠ¤
                '035420': 180000, // NAVER
                '005380': 45000,  // í˜„ëŒ€ì°¨
                '051910': 85000,  // LGí™”í•™
                '035720': 55000,  // ì¹´ì¹´ì˜¤
                '207940': 850000, // ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤
                '068270': 180000, // ì…€íŠ¸ë¦¬ì˜¨
                '373220': 420000, // LGì—ë„ˆì§€ì†”ë£¨ì…˜
                '000270': 85000   // ê¸°ì•„
            };
            
            const basePrice = basePrices[symbol] || (Math.floor(Math.random() * 50000) + 10000);
            const variation = (Math.random() - 0.5) * 0.1; // Â±10% ë³€ë™
            const price = Math.floor(basePrice * (1 + variation));
            const change = (Math.random() - 0.5) * 10; // Â±5% ë³€ë™ë¥ 
            
            return {
                price: price,
                change: change,
                changePercent: change
            };
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(stocks, container) {
            if (stocks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '';
            stocks.forEach(stock => {
                const isPositive = stock.changePercent >= 0;
                const changeClass = isPositive ? 'positive' : 'negative';
                const changeSymbol = isPositive ? '+' : '';
                
                // í†µí™”ì— ë”°ë¥¸ ê°€ê²© í‘œì‹œ
                const currencySymbol = stock.isUSD ? '$' : '';
                const currencyUnit = stock.isUSD ? '' : 'ì›';
                const priceDisplay = stock.isUSD ? 
                    currencySymbol + stock.price.toLocaleString() : 
                    stock.price.toLocaleString() + currencyUnit;
                
                html += '<div class="stock-card ' + changeClass + '" onclick="buyStock(\'' + stock.symbol + '\', \'' + stock.name + '\', ' + stock.price + ', \'' + (stock.currency || 'KRW') + '\')" style="cursor: pointer; margin-bottom: 10px;">' +
                        '<div class="stock-header">' +
                        '<div>' +
                        '<div class="stock-symbol">' + stock.symbol + '</div>' +
                        '<div style="font-size: 14px; color: #666;">' + stock.name + '</div>' +
                        '<div style="font-size: 12px; color: #999;">' + stock.sector + '</div>' +
                        '</div>' +
                        '<div style="text-align: right;">' +
                        '<div class="stock-price">' + priceDisplay + '</div>' +
                        '<div class="stock-change">' + changeSymbol + stock.changePercent.toFixed(2) + '%</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
            });
            
            container.innerHTML = html;
        }

        // ì¸ê¸° ì¢…ëª© ë¡œë“œ
        async function loadPopularStocks() {
            const popularDiv = document.getElementById('popularStocks');
            if (!popularDiv) return;
            
            try {
                console.log('ğŸ“ˆ ì¸ê¸° ì¢…ëª© ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                
                // ì¸ê¸° ì¢…ëª© ì‹¬ë³¼ë“¤ (ì‹¤ì œ ê±°ë˜ëŸ‰ ê¸°ì¤€)
                const popularSymbols = ['ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'NAVER', 'í˜„ëŒ€ì°¨', 'LGí™”í•™'];
                const popularStocks = [];
                
                for (const stockName of popularSymbols) {
                    try {
                        const results = await searchFromLocalDatabase(stockName);
                        if (results && results.length > 0) {
                            popularStocks.push(results[0]); // ì²« ë²ˆì§¸ ê²°ê³¼ë§Œ
                        }
                    } catch (error) {
                        console.log(`${stockName} ë¡œë“œ ì‹¤íŒ¨`);
                    }
                }
                
                console.log('âœ… ì¸ê¸° ì¢…ëª© ë¡œë“œ ì™„ë£Œ:', popularStocks.length, 'ê°œ');
                displaySearchResults(popularStocks, popularDiv);
            } catch (error) {
                console.error('ì¸ê¸° ì¢…ëª© ë¡œë“œ ì‹¤íŒ¨:', error);
                popularDiv.innerHTML = '<div style="text-align: center; color: #666;">ì¸ê¸° ì¢…ëª©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        function buyStock(symbol, name, price, currency = 'KRW') {
            // ì‹¤ì œ ê°€ê²©ìœ¼ë¡œ ì°¨íŠ¸ ëª¨ë‹¬ í‘œì‹œ (ê°€ìƒ ê°€ê²© ìƒì„± ì œê±°)
            console.log(`ğŸ¯ ${name} ë§¤ìˆ˜/ë§¤ë„ ëª¨ë‹¬ ì—´ê¸° - ì‹¤ì œ ê°€ê²©: ${price} ${currency}`);
            showAssetChart(symbol, name, price, 'stock', currency);
        }

        // 4. ëŒ€ì¶œ ìƒí’ˆ ê¸°ëŠ¥
        async function loadLoanProducts(modal) {
            const modalBody = modal.querySelector('.modal-body');
            const userExp = userAssets.exp || 0;
            const userGrade = calculateUserGrade(userExp);
            
            // ë“±ê¸‰ë³„ ëŒ€ì¶œ ì¡°ê±´
            const loanProducts = [
                {
                    grade: 'red',
                    name: 'ì‹ ìš©ëŒ€ì¶œ',
                    maxAmount: 30000000,
                    rate: '4.5%',
                    term: '60ê°œì›”',
                    description: 'ë¬´ë‹´ë³´ ê°œì¸ì‹ ìš©ëŒ€ì¶œ'
                },
                {
                    grade: 'black',
                    name: 'ì£¼íƒë‹´ë³´ëŒ€ì¶œ',
                    maxAmount: 500000000,
                    rate: '3.2%',
                    term: '360ê°œì›”',
                    description: 'ì£¼íƒë‹´ë³´ ì¥ê¸°ëŒ€ì¶œ'
                },
                {
                    grade: 'black',
                    name: 'ì‚¬ì—…ìëŒ€ì¶œ',
                    maxAmount: 100000000,
                    rate: '3.8%',
                    term: '120ê°œì›”',
                    description: 'ì‚¬ì—…ìê¸ˆ ì „ìš©ëŒ€ì¶œ'
                }
            ];
            
            let html = '';
            loanProducts.forEach(product => {
                const canAccess = userGrade === product.grade || 
                    (product.grade === 'red' && ['red', 'black'].includes(userGrade)) ||
                    (product.grade === 'black' && userGrade === 'black');
                
                html += '<div class="item-card ' + (canAccess ? '' : 'locked') + '">' +
                        '<div class="item-header">' +
                        '<span class="item-title">' + product.name + '</span>' +
                        '<span class="item-price">' + product.rate + '</span>' +
                        '</div>' +
                        '<div class="item-desc">' +
                        'ìµœëŒ€í•œë„: ' + product.maxAmount.toLocaleString() + 'ì›<br>' +
                        'ëŒ€ì¶œê¸°ê°„: ' + product.term + '<br>' +
                        product.description +
                        '</div>' +
                        (canAccess ? 
                            '<button class="btn-primary" onclick="applyLoan(\'' + product.name + '\', ' + product.maxAmount + ', \'' + product.rate + '\')">ì‹ ì²­í•˜ê¸°</button>' :
                            '<div style="color: #999; font-size: 14px;">' + product.grade.toUpperCase() + ' ë“±ê¸‰ í•„ìš”</div>'
                        ) +
                        '</div>';
            });
            
            modalBody.innerHTML = html;
        }

        async function applyLoan(productName, maxAmount, rate) {
            const amount = prompt(productName + ' ì‹ ì²­\nìµœëŒ€í•œë„: ' + maxAmount.toLocaleString() + 'ì›\nëŒ€ì¶œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (amount && parseInt(amount) <= maxAmount && parseInt(amount) > 0) {
                const loanAmount = parseInt(amount);
                
                // ëŒ€ì¶œì€ í¬íŠ¸í´ë¦¬ì˜¤ì— ë¶€ì±„ë¡œ ê¸°ë¡í•˜ê³  í˜„ê¸ˆ ì¦ê°€
                if (!userAssets.portfolio) {
                    userAssets.portfolio = {};
                }
                
                const loanSymbol = `LOAN_${productName.replace(/\s/g, '_')}`;
                userAssets.portfolio[loanSymbol] = {
                    name: productName,
                    symbol: loanSymbol,
                    type: 'loan',
                    currency: 'KRW',
                    quantity: 1,
                    avgPrice: loanAmount,
                    totalInvested: loanAmount,
                    rate: rate,
                    isDebt: true // ë¶€ì±„ í‘œì‹œ
                };
                
                // í˜„ê¸ˆ ì¦ê°€
                userAssets.cash = (userAssets.cash || 0) + loanAmount;
                
                // Firebaseì— ì €ì¥
                await saveUserPortfolio();
                
                alert(productName + ' ' + loanAmount.toLocaleString() + 'ì›ì´ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.\nê¸ˆë¦¬: ' + rate);
            } else if (amount) {
                alert('ëŒ€ì¶œ ê°€ëŠ¥ ê¸ˆì•¡ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\nìµœëŒ€: ' + maxAmount.toLocaleString() + 'ì›');
            }
        }

        // 5. ETF ë° í€ë“œ ê¸°ëŠ¥
        async function loadETFAndFunds(modal) {
            const modalBody = modal.querySelector('.modal-body');
            
            try {
                // ê²€ìƒ‰ ê¸°ëŠ¥ í¬í•¨í•œ ETF/í€ë“œ ì¸í„°í˜ì´ìŠ¤
                let html = '<div style="margin-bottom: 20px;">' +
                          '<div style="display: flex; gap: 10px; margin-bottom: 15px;">' +
                          '<input type="text" id="fundSearch" placeholder="ETF/í€ë“œëª… ê²€ìƒ‰ (ì˜ˆ: KODEX, ì‚¼ì„±)" ' +
                          'style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;" ' +
                          'onkeypress="if(event.key===\'Enter\') searchFunds()">' +
                          '<button onclick="searchFunds()" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">ê²€ìƒ‰</button>' +
                          '</div>' +
                          '<div style="font-size: 12px; color: #666; margin-bottom: 15px;">' +
                          'ğŸ’¡ íŒ: ETFëª…(KODEX 200) ë˜ëŠ” í€ë“œì‚¬ëª…(ì‚¼ì„±ìì‚°ìš´ìš©)ìœ¼ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤' +
                          '</div>' +
                          '</div>' +
                          '<div id="fundResults">' +
                          '<div style="text-align: center; padding: 20px; color: #666;">' +
                          'ìœ„ì—ì„œ ETF/í€ë“œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”' +
                          '</div>' +
                          '</div>' +
                          '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">' +
                          '<h4 style="margin-bottom: 15px; color: #333;">ì¸ê¸° ìƒí’ˆ</h4>' +
                          '<div id="popularFunds">' +
                          '<div style="text-align: center; color: #666;">ì¸ê¸° ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>' +
                          '</div>' +
                          '</div>';
                
                modalBody.innerHTML = html;
                
                // ì¸ê¸° ìƒí’ˆ ë¡œë“œ
                loadPopularFunds();
                
            } catch (error) {
                console.error('ETF/í€ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                modalBody.innerHTML = '<div class="item-card">' +
                                    '<div class="item-desc">ETF ë° í€ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>' +
                                    '</div>';
            }
        }

        // ETF/í€ë“œ ê²€ìƒ‰ í•¨ìˆ˜
        async function searchFunds() {
            const searchInput = document.getElementById('fundSearch');
            const resultsDiv = document.getElementById('fundResults');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ì‹¤ì‹œê°„ ETF/í€ë“œ ì •ë³´ë¥¼ ê²€ìƒ‰ ì¤‘...</div>';
            
            try {
                const funds = await searchKoreanFunds(query);
                displayFundResults(funds, resultsDiv);
            } catch (error) {
                console.error('ETF/í€ë“œ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
            }
        }

        // í•œêµ­ ETF/í€ë“œ ê²€ìƒ‰ - ì‹¤ì œ API ë°ì´í„° ì‚¬ìš©
        async function searchKoreanFunds(query) {
            // í•œêµ­ ì£¼ìš” ETF ë°ì´í„°ë² ì´ìŠ¤ (Yahoo Finance ì‹¬ë³¼ í¬í•¨)
            const koreanETFs = [
                { symbol: '069500', yahooSymbol: '069500.KS', name: 'KODEX 200', type: 'ETF', description: 'KOSPI 200 ì§€ìˆ˜ ì¶”ì¢…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'êµ­ë‚´ì£¼ì‹' },
                { symbol: '102110', yahooSymbol: '102110.KS', name: 'TIGER 200', type: 'ETF', description: 'KOSPI 200 ì§€ìˆ˜ ì¶”ì¢…', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'êµ­ë‚´ì£¼ì‹' },
                { symbol: '229200', yahooSymbol: '229200.KS', name: 'KODEX ì½”ìŠ¤ë‹¥150', type: 'ETF', description: 'KOSDAQ 150 ì§€ìˆ˜ ì¶”ì¢…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'êµ­ë‚´ì£¼ì‹' },
                { symbol: '133690', yahooSymbol: '133690.KS', name: 'TIGER ë‚˜ìŠ¤ë‹¥100', type: 'ETF', description: 'ë‚˜ìŠ¤ë‹¥ 100 ì§€ìˆ˜ ì¶”ì¢…', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'í•´ì™¸ì£¼ì‹' },
                { symbol: '360750', yahooSymbol: '360750.KS', name: 'KODEX ë¯¸êµ­S&P500', type: 'ETF', description: 'S&P 500 ì§€ìˆ˜ ì¶”ì¢…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'í•´ì™¸ì£¼ì‹' },
                { symbol: '371460', yahooSymbol: '371460.KS', name: 'TIGER ì°¨ì´ë‚˜ì „ê¸°ì°¨SOLACTIVE', type: 'ETF', description: 'ì¤‘êµ­ ì „ê¸°ì°¨ í…Œë§ˆ', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'í…Œë§ˆ' },
                { symbol: '305720', yahooSymbol: '305720.KS', name: 'KODEX 2ì°¨ì „ì§€ì‚°ì—…', type: 'ETF', description: '2ì°¨ì „ì§€ ê´€ë ¨ ê¸°ì—…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'í…Œë§ˆ' },
                { symbol: '091230', yahooSymbol: '091230.KS', name: 'TIGER ë°˜ë„ì²´', type: 'ETF', description: 'ë°˜ë„ì²´ ê´€ë ¨ ê¸°ì—…', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'ì„¹í„°' },
                { symbol: '132030', yahooSymbol: '132030.KS', name: 'KODEX ê³¨ë“œì„ ë¬¼', type: 'ETF', description: 'ê¸ˆ ì„ ë¬¼ ì¶”ì¢…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'ì›ìì¬' },
                { symbol: '130680', yahooSymbol: '130680.KS', name: 'TIGER ì›ìœ ì„ ë¬¼Enhanced', type: 'ETF', description: 'ì›ìœ  ì„ ë¬¼ ì¶”ì¢…', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'ì›ìì¬' },
                { symbol: '114800', yahooSymbol: '114800.KS', name: 'KODEX ì¸ë²„ìŠ¤', type: 'ETF', description: 'KOSPI 200 ì¸ë²„ìŠ¤', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'ì¸ë²„ìŠ¤' },
                { symbol: '305080', yahooSymbol: '305080.KS', name: 'TIGER ë¯¸êµ­ì±„10ë…„ì„ ë¬¼', type: 'ETF', description: 'ë¯¸êµ­ êµ­ì±„ 10ë…„ ì¶”ì¢…', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'ì±„ê¶Œ' },
                { symbol: '069660', yahooSymbol: '069660.KS', name: 'KOSEF 200', type: 'ETF', description: 'KOSPI 200 ì§€ìˆ˜ ì¶”ì¢…', company: 'í‚¤ì›€íˆ¬ììì‚°ìš´ìš©', category: 'êµ­ë‚´ì£¼ì‹' },
                { symbol: '278530', yahooSymbol: '278530.KS', name: 'KODEX MSCI Korea', type: 'ETF', description: 'MSCI Korea ì§€ìˆ˜ ì¶”ì¢…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'êµ­ë‚´ì£¼ì‹' },
                { symbol: '143460', yahooSymbol: '143460.KS', name: 'KINDEX ì¤‘êµ­ë³¸í† CSI300', type: 'ETF', description: 'ì¤‘êµ­ CSI300 ì§€ìˆ˜ ì¶”ì¢…', company: 'í•œêµ­íˆ¬ìì‹ íƒìš´ìš©', category: 'í•´ì™¸ì£¼ì‹' },
                { symbol: '300950', yahooSymbol: '300950.KS', name: 'TIGER K-ë‰´ë”œ', type: 'ETF', description: 'í•œêµ­íŒ ë‰´ë”œ í…Œë§ˆ', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'í…Œë§ˆ' },
                { symbol: '276650', yahooSymbol: '276650.KS', name: 'KODEX ë°”ì´ì˜¤', type: 'ETF', description: 'ë°”ì´ì˜¤ ê´€ë ¨ ê¸°ì—…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'ì„¹í„°' },
                { symbol: '315270', yahooSymbol: '315270.KS', name: 'TIGER ì°¨ì´ë‚˜ì „ê¸°ì°¨', type: 'ETF', description: 'ì¤‘êµ­ ì „ê¸°ì°¨ ê´€ë ¨', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'í…Œë§ˆ' },
                { symbol: '157490', yahooSymbol: '157490.KS', name: 'TIGER ì†Œí”„íŠ¸ì›¨ì–´', type: 'ETF', description: 'ì†Œí”„íŠ¸ì›¨ì–´ ê´€ë ¨ ê¸°ì—…', company: 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©', category: 'ì„¹í„°' },
                { symbol: '364970', yahooSymbol: '364970.KS', name: 'KODEX ë¯¸êµ­ë‹¬ëŸ¬ì„ ë¬¼', type: 'ETF', description: 'ë‹¬ëŸ¬ ì„ ë¬¼ ì¶”ì¢…', company: 'ì‚¼ì„±ìì‚°ìš´ìš©', category: 'í†µí™”' }
            ];
            
            // ê²€ìƒ‰ì–´ì™€ ë§¤ì¹­ë˜ëŠ” ETF ì°¾ê¸°
            let matchedFunds = [];
            if (query) {
                matchedFunds = koreanETFs.filter(fund => 
                    fund.name.includes(query) || 
                    fund.company.includes(query) ||
                    fund.category.includes(query) ||
                    fund.description.includes(query) ||
                    fund.symbol.includes(query)
                );
            } else {
                // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì¸ê¸° ìƒí’ˆ ë°˜í™˜
                const popularSymbols = ['069500', '102110', '229200', '133690', '091230'];
                matchedFunds = koreanETFs.filter(fund => 
                    popularSymbols.includes(fund.symbol)
                );
            }
            
            // ì‹¤ì œ Yahoo Finance APIë¡œ ê°€ê²© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const fundsWithRealPrices = [];
            const maxResults = Math.min(matchedFunds.length, 10);
            
            for (let i = 0; i < maxResults; i++) {
                const fund = matchedFunds[i];
                try {
                    console.log(`ğŸ” ${fund.name} (${fund.yahooSymbol}) ì‹¤ì‹œê°„ ê°€ê²© ì¡°íšŒ`);
                    const priceData = await getYahooStockPrice(fund.yahooSymbol);
                    
                    if (priceData && priceData.price) {
                        console.log(`âœ… ${fund.name} ì‹¤ì œ ê°€ê²©: ${priceData.price}ì›`);
                        fundsWithRealPrices.push({
                            ...fund,
                            price: priceData.price,
                            returnRate: priceData.changePercent || 0,
                            change: priceData.change || 0,
                                                        currency: priceData.currency || 'KRW',
                            volume: priceData.volume || 0,
                            source: 'yahoo_api'
                        });
                    } else {
                        // API ì‹¤íŒ¨ ì‹œ í˜„ì‹¤ì ì¸ ê°€ê²© ìƒì„±
                        console.log(`âš ï¸ ${fund.name} API ì‹¤íŒ¨, í˜„ì‹¤ì  ê°€ê²© ìƒì„±`);
                        const generatedPrice = generateRealisticETFPrice(fund);
                        fundsWithRealPrices.push({
                            ...fund,
                            ...generatedPrice
                        });
                    }
                } catch (error) {
                    console.log(`âŒ ${fund.name} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
                    const generatedPrice = generateRealisticETFPrice(fund);
                    fundsWithRealPrices.push({
                        ...fund,
                        ...generatedPrice
                    });
                }
                
                // ì„œë²„ ê³¼ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ ë”œë ˆì´
                if (i < maxResults - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`ğŸ¯ ETF/í€ë“œ ê²€ìƒ‰ ì™„ë£Œ: ${fundsWithRealPrices.length}ê°œ`);
            return fundsWithRealPrices;
        }

        // í˜„ì‹¤ì ì¸ ETF ê°€ê²© ìƒì„±
        function generateRealisticETFPrice(fund) {
            // ETFë³„ í˜„ì‹¤ì ì¸ ê°€ê²©ëŒ€
            const realisticPrices = {
                'KODEX 200': { base: 42000, volatility: 0.02 },
                'TIGER 200': { base: 41000, volatility: 0.02 },
                'KODEX ì½”ìŠ¤ë‹¥150': { base: 8500, volatility: 0.03 },
                'TIGER ë‚˜ìŠ¤ë‹¥100': { base: 18000, volatility: 0.03 },
                'KODEX ë¯¸êµ­S&P500': { base: 15000, volatility: 0.025 },
                'TIGER ë°˜ë„ì²´': { base: 12000, volatility: 0.04 },
                'KODEX 2ì°¨ì „ì§€ì‚°ì—…': { base: 10000, volatility: 0.04 },
                'KODEX ê³¨ë“œì„ ë¬¼': { base: 9000, volatility: 0.02 },
                'TIGER ì›ìœ ì„ ë¬¼Enhanced': { base: 5000, volatility: 0.05 },
                'KODEX ì¸ë²„ìŠ¤': { base: 4500, volatility: 0.03 }
            };
            
            const priceInfo = realisticPrices[fund.name] || { base: 10000, volatility: 0.03 };
            
            // ê¸°ì¤€ê°€ì—ì„œ Â±volatility ë²”ìœ„ì˜ ë³€ë™
            const variation = (Math.random() - 0.5) * 2 * priceInfo.volatility;
            const currentPrice = Math.round(priceInfo.base * (1 + variation));
            
            // ì „ì¼ ëŒ€ë¹„ ë³€ë™ ê³„ì‚°
            const changePercent = variation * 100;
            const change = Math.round(currentPrice * (changePercent / 100));
            
            return {
                price: currentPrice,
                returnRate: changePercent,
                change: change,
                currency: 'KRW',
                volume: Math.floor(Math.random() * 500000) + 50000,
                source: 'realistic_simulation'
            };
        }

        // ETF/í€ë“œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displayFundResults(funds, container) {
            if (funds.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '';
            funds.forEach(fund => {
                const isPositive = fund.returnRate >= 0;
                const returnClass = isPositive ? 'positive' : 'negative';
                const returnSymbol = isPositive ? '+' : '';
                
                // ì‹¤ì œ ê°€ê²©ìœ¼ë¡œ í‘œì‹œ
                html += `
                    <div class="item-card" onclick="investFund('${fund.symbol}', '${fund.name}', ${fund.price}, '${fund.yahooSymbol || fund.symbol}')" style="cursor: pointer; margin-bottom: 10px;">
                        <div class="item-header">
                            <span class="item-title">${fund.name}</span>
                            <span class="item-price ${returnClass}">${returnSymbol}${fund.returnRate.toFixed(2)}%</span>
                        </div>
                        <div class="item-desc">
                            ${fund.description}<br>
                            ê¸°ì¤€ê°€: ${fund.price.toLocaleString()}ì›<br>
                            ìš´ìš©ì‚¬: ${fund.company} | ìœ í˜•: ${fund.type} | ë¶„ë¥˜: ${fund.category}
                            ${fund.source === 'yahoo_api' ? '<br><small style="color: #28a745;">âœ“ ì‹¤ì‹œê°„ ë°ì´í„°</small>' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ì¸ê¸° ETF/í€ë“œ ë¡œë“œ
        async function loadPopularFunds() {
            const popularDiv = document.getElementById('popularFunds');
            if (!popularDiv) return;
            
            try {
                console.log('ğŸ“ˆ ì¸ê¸° ETF ì‹¤ì œ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                const popularFunds = await searchKoreanFunds('');
                displayFundResults(popularFunds, popularDiv);
            } catch (error) {
                console.error('ì¸ê¸° ETF ë¡œë“œ ì‹¤íŒ¨:', error);
                popularDiv.innerHTML = '<div style="text-align: center; color: #666;">ì¸ê¸° ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ETF/í€ë“œ íˆ¬ì í•¨ìˆ˜ ìˆ˜ì • - ì‹¤ì œ ê°€ê²© ì‚¬ìš©
        function investFund(symbol, productName, price, yahooSymbol) {
            // ETF/í€ë“œë„ ì°¨íŠ¸ ëª¨ë‹¬ë¡œ í‘œì‹œ - ì‹¤ì œ ê°€ê²© ì‚¬ìš©
            const displaySymbol = productName.replace(/\s+/g, '_'); // í‘œì‹œìš© ì‹¬ë³¼
            console.log(`ğŸ¯ ${productName} íˆ¬ì ëª¨ë‹¬ ì—´ê¸° - ì‹¤ì œ ê°€ê²©: ${price}ì›`);
            
            // yahooSymbolì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ symbol ì‚¬ìš©
            const apiSymbol = yahooSymbol || symbol;
            
            // showAssetChartì— ì‹¤ì œ ê°€ê²© ì „ë‹¬
            showAssetChart(displaySymbol, productName, price, 'fund', 'KRW');
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ–ï¸ A3 ë“±ê¸‰ í˜ì´ì§€ ë¡œë“œë¨');
            
            if (!checkLoginAndInit()) {
                return;
            }
            
            // Firebase ë°ì´í„° ë¡œë“œ
            setTimeout(() => {
                loadUserDataFromFirebase();
            }, 1000);
            
            // ë“±ê¸‰ ì¹´ë“œì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            const gradeCards = document.querySelectorAll('.grade-card');
            gradeCards.forEach(card => {
                const titleElement = card.querySelector('.grade-title') || card.querySelector('h3');
                if (titleElement) {
                    const title = titleElement.textContent;
                    card.addEventListener('click', () => {
                        handleGradeClick(title);
                    });
                }
            });
        }); // DOMContentLoaded ë‹«ê¸°

        // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
        function goToPage(page) {
            console.log('ğŸ”„ A3ì—ì„œ í˜ì´ì§€ ì´ë™:', page);
            
            // í˜„ì¬ í˜ì´ì§€ í™•ì¸
            if (page === 'a3.html') {
                console.log('í˜„ì¬ í˜ì´ì§€(a3)ì—ì„œ ë™ì¼ í˜ì´ì§€ë¡œ ì´ë™ ì‹œë„ - ë¬´ì‹œ');
                return;
            }
            
            try {
                // ë„¤ë¹„ê²Œì´ì…˜ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // í˜ì´ì§€ ì´ë™
                console.log('í˜ì´ì§€ ì´ë™ ì‹¤í–‰:', page);
                window.location.href = page;
            } catch (error) {
                console.error('í˜ì´ì§€ ì´ë™ ì˜¤ë¥˜:', error);
                alert('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê¸°íƒ€ í•¨ìˆ˜ë“¤
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('fineu_current_user');
                window.location.href = 'index.html';
            }
        }

        function showNotifications() {
            alert('ì•Œë¦¼ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡)
        window.addAccountItem = addAccountItem;
        window.subscribeSavings = subscribeSavings;
        window.searchStocks = searchStocks;
        window.buyStock = buyStock;
        window.applyLoan = applyLoan;
        window.searchFunds = searchFunds;
        window.investFund = investFund;
        window.showTradeModal = showTradeModal;
        window.closeModal = closeModal;
    </script>
</body>
</html>
